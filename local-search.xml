<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>企业级NOSQL数据库-Redis部署</title>
    <link href="/2024/05/10/%E4%BC%81%E4%B8%9A%E7%BA%A7NOSQL%E6%95%B0%E6%8D%AE%E5%BA%93-redis%E9%83%A8%E7%BD%B2/"/>
    <url>/2024/05/10/%E4%BC%81%E4%B8%9A%E7%BA%A7NOSQL%E6%95%B0%E6%8D%AE%E5%BA%93-redis%E9%83%A8%E7%BD%B2/</url>
    
    <content type="html"><![CDATA[<ul><li><p>Redis 官网：<a href="https://redis.io/">https://redis.io/</a></p></li><li><p>环境：Ubuntu 2204</p></li></ul><h3 id="使用仓库安装redis"><a href="#使用仓库安装redis" class="headerlink" title="使用仓库安装redis"></a>使用仓库安装redis</h3><p>查看仓库中的redis版本</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs shell">root@xcjyc:~# apt update ; apt info redis<br>Package: redis<br>Version: 5:6.0.16-1ubuntu1<br>Priority: optional<br>Section: universe/database<br>Origin: Ubuntu<br>Maintainer: Ubuntu Developers &lt;ubuntu-devel-discuss@lists.ubuntu.com&gt;<br>Original-Maintainer: Chris Lamb &lt;lamby@debian.org&gt;<br>Bugs: https://bugs.launchpad.net/ubuntu/+filebug<br>Installed-Size: 67.6 kB<br>Depends: redis-server (&lt;&lt; 5:6.0.16-1ubuntu1.1~), redis-server (&gt;= 5:6.0.16-1ubuntu1)<br>Homepage: https://redis.io/<br>Download-Size: 2930 B<br>APT-Sources: https://mirrors.aliyun.com/ubuntu jammy/universe amd64 Packages<br>Description: Persistent key-value database with network interface (metapackage)<br> Redis is a key-value database in a similar vein to memcache but the dataset<br> is non-volatile. Redis additionally provides native support for atomically<br> manipulating and querying data structures such as lists and sets.<br> .<br> The dataset is stored entirely in memory and periodically flushed to disk.<br> .<br> This package installs the main redis-server package.<br></code></pre></td></tr></table></figure><p>安装redis，redis默认使用6379端口</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs sh">root@xcjyc:~<span class="hljs-comment"># apt install -y redis </span><br><br>root@xcjyc:~<span class="hljs-comment"># ss -ntlp</span><br>State       Recv-Q      Send-Q           Local Address:Port           Peer Address:Port     Process                                         <br>LISTEN      0           511                  127.0.0.1:6379                0.0.0.0:*         <span class="hljs-built_in">users</span>:((&quot;redis-server&quot;,pid=<span class="hljs-number">1086</span>,fd=<span class="hljs-number">6</span>))         <br>LISTEN      0           4096             127.0.0.53%lo:53                  0.0.0.0:*         <span class="hljs-built_in">users</span>:((&quot;systemd-resolve&quot;,pid=<span class="hljs-number">611</span>,fd=<span class="hljs-number">14</span>))      <br>LISTEN      0           128                    0.0.0.0:22                  0.0.0.0:*         <span class="hljs-built_in">users</span>:((&quot;sshd&quot;,pid=<span class="hljs-number">659</span>,fd=<span class="hljs-number">3</span>))                  <br>LISTEN      0           511                      [::1]:6379                   [::]:*         <span class="hljs-built_in">users</span>:((&quot;redis-server&quot;,pid=<span class="hljs-number">1086</span>,fd=<span class="hljs-number">7</span>))         <br>LISTEN      0           128                       [::]:22                     [::]:*         <span class="hljs-built_in">users</span>:((&quot;sshd&quot;,pid=<span class="hljs-number">659</span>,fd=<span class="hljs-number">4</span>))                  <br><br>root@xcjyc:~<span class="hljs-comment"># redis-cli </span><br>127.0.0.1:6379&gt; ping<br>PONG<br></code></pre></td></tr></table></figure><h3 id="编译安装redis最新稳定版"><a href="#编译安装redis最新稳定版" class="headerlink" title="编译安装redis最新稳定版"></a>编译安装redis最新稳定版</h3><p>源码下载地址：<a href="https://download.redis.io/releases/">https://download.redis.io/releases/</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">下载解压源码包</span><br>root@ubuntu2204:~# wget https://download.redis.io/releases/redis-7.2.4.tar.gz<br>root@ubuntu2204:~# tar xvf redis-7.2.4.tar.gz <br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">安装依赖包</span><br>root@ubuntu2204:~# apt update ; apt  install gcc make libjemalloc-dev libsystemd-dev<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">检查环境安装状态</span><br>root@ubuntu2204:~# apt  install gcc make libjemalloc-dev libsystemd-dev<br>Reading package lists... Done<br>Building dependency tree... Done<br>Reading state information... Done<br>gcc is already the newest version (4:11.2.0-1ubuntu1).<br>make is already the newest version (4.3-4.1build1).<br>libjemalloc-dev is already the newest version (5.2.1-4ubuntu1).<br>libsystemd-dev is already the newest version (249.11-0ubuntu3.12).<br>0 upgraded, 0 newly installed, 0 to remove and 56 not upgraded.<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">准备安装目录</span><br>root@ubuntu2204:~# mkdir -p /apps/redis <br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">查看安装说明</span><br>root@ubuntu2204:~# cd redis-7.2.4/<br>root@ubuntu2204:~/redis-7.2.4# ls <br>00-RELEASENOTES     CONTRIBUTING.md  MANIFESTO  SECURITY.md  redis.conf       runtest-moduleapi  src<br>BUGS                COPYING          Makefile   TLS.md       runtest          runtest-sentinel   tests<br>CODE_OF_CONDUCT.md  INSTALL          README.md  deps         runtest-cluster  sentinel.conf      utils<br><br>root@ubuntu2204:~/redis-7.2.4# cat README.md <br>-- 使用systemd,可在编译时添加参数 USE_SYSTEMD=yes (提应安装环境包)--<br>...<br>To build with systemd support, you&#x27;ll need systemd development libraries (such <br>as libsystemd-dev on Debian/Ubuntu or systemd-devel on CentOS) and run:<br><br>    % make USE_SYSTEMD=yes<br>...<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">编译安装</span><br>root@ubuntu2204:~/redis-7.2.4# make -j 2 PREFIX=/apps/redis USE_SYSTEMD=yes install <br>root@ubuntu2204:~/redis-7.2.4# tree /apps/redis/<br>/apps/redis/<br>└── bin<br>    ├── redis-benchmark<br>    ├── redis-check-aof -&gt; redis-server<br>    ├── redis-check-rdb -&gt; redis-server<br>    ├── redis-cli<br>    ├── redis-sentinel -&gt; redis-server<br>    └── redis-server<br><br>1 directory, 6 files<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">配置环境变量</span><br>root@ubuntu2204:~/redis-7.2.4# echo &#x27;PATH=/apps/redis/bin:$PATH&#x27; &gt; /etc/profile.d/redis.sh<br>root@ubuntu2204:~/redis-7.2.4# . /etc/profile.d/redis.sh<br><br>root@ubuntu2204:~/redis-7.2.4# echo $PATH<br>/apps/redis/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">准备redis相关目录和配置文件</span><br>root@ubuntu2204:~/redis-7.2.4# mkdir /apps/redis/&#123;etc,log,data,run&#125;<br>root@ubuntu2204:~/redis-7.2.4# cp redis.conf  /apps/redis/etc/<br><br>root@ubuntu2204:~/redis-7.2.4# tree /apps/redis/<br>/apps/redis/<br>├── bin<br>│   ├── redis-benchmark<br>│   ├── redis-check-aof -&gt; redis-server<br>│   ├── redis-check-rdb -&gt; redis-server<br>│   ├── redis-cli<br>│   ├── redis-sentinel -&gt; redis-server<br>│   └── redis-server<br>├── data<br>├── etc<br>│   └── redis.conf<br>├── log<br>└── run<br></code></pre></td></tr></table></figure><p>前台启动redis</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">查看启动帮助</span><br>root@ubuntu2204:~# redis-server --help<br>Usage: ./redis-server [/path/to/redis.conf] [options] [-]<br>       ./redis-server - (read config from stdin)<br>       ./redis-server -v or --version<br>       ./redis-server -h or --help<br>       ./redis-server --test-memory &lt;megabytes&gt;<br>       ./redis-server --check-system<br><br>Examples:<br>       ./redis-server (run the server with default conf)<br>       echo &#x27;maxmemory 128mb&#x27; | ./redis-server -<br>       ./redis-server /etc/redis/6379.conf<br>       ./redis-server --port 7777<br>       ./redis-server --port 7777 --replicaof 127.0.0.1 8888<br>       ./redis-server /etc/myredis.conf --loglevel verbose -<br>       ./redis-server /etc/myredis.conf --loglevel verbose<br><br>Sentinel mode:<br>       ./redis-server /etc/sentinel.conf --sentinel<br>       <br><span class="hljs-meta prompt_"># </span><span class="language-bash">前台启动测试</span><br>root@ubuntu2204:~# redis-server /apps/redis/etc/redis.conf <br>8030:C 14 May 2024 07:54:18.370 # WARNING Memory overcommit must be enabled! Without it, a background save or replication may fail under low memory condition. Being disabled, it can also cause failures without low memory condition, see https://github.com/jemalloc/jemalloc/issues/1328. To fix this issue add &#x27;vm.overcommit_memory = 1&#x27; to /etc/sysctl.conf and then reboot or run the command &#x27;sysctl vm.overcommit_memory=1&#x27; for this to take effect.<br>8030:C 14 May 2024 07:54:18.370 * oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo<br>8030:C 14 May 2024 07:54:18.370 * Redis version=7.2.4, bits=64, commit=00000000, modified=0, pid=8030, just started<br>8030:C 14 May 2024 07:54:18.370 * Configuration loaded<br>8030:M 14 May 2024 07:54:18.371 * Increased maximum number of open files to 10032 (it was originally set to 1024).<br>8030:M 14 May 2024 07:54:18.371 * monotonic clock: POSIX clock_gettime<br>                _._                                                  <br>           _.-``__ &#x27;&#x27;-._                                             <br>      _.-``    `.  `_.  &#x27;&#x27;-._           Redis 7.2.4 (00000000/0) 64 bit<br>  .-`` .-```.  ```\/    _.,_ &#x27;&#x27;-._                                  <br> (    &#x27;      ,       .-`  | `,    )     Running in standalone mode<br> |`-._`-...-` __...-.``-._|&#x27;` _.-&#x27;|     Port: 6379<br> |    `-._   `._    /     _.-&#x27;    |     PID: 8030<br>  `-._    `-._  `-./  _.-&#x27;    _.-&#x27;                                   <br> |`-._`-._    `-.__.-&#x27;    _.-&#x27;_.-&#x27;|                                  <br> |    `-._`-._        _.-&#x27;_.-&#x27;    |           https://redis.io       <br>  `-._    `-._`-.__.-&#x27;_.-&#x27;    _.-&#x27;                                   <br> |`-._`-._    `-.__.-&#x27;    _.-&#x27;_.-&#x27;|                                  <br> |    `-._`-._        _.-&#x27;_.-&#x27;    |                                  <br>  `-._    `-._`-.__.-&#x27;_.-&#x27;    _.-&#x27;                                   <br>      `-._    `-.__.-&#x27;    _.-&#x27;                                       <br>          `-._        _.-&#x27;                                           <br>              `-.__.-&#x27;                                               <br><br>8030:M 14 May 2024 07:54:18.373 * Server initialized<br>8030:M 14 May 2024 07:54:18.373 * Ready to accept connections tcp<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">消除启动警告信息，添加内核参数</span><br>WARNING Memory overcommit must be enabled! Without it, a background save or replication may fail under low memory condition. Being disabled, it can also cause failures without low memory condition, see https://github.com/jemalloc/jemalloc/issues/1328. To fix this issue add &#x27;vm.overcommit_memory = 1&#x27; to /etc/sysctl.conf and then reboot or run the command &#x27;sysctl vm.overcommit_memory=1&#x27; for this to take effect.<br><br>root@ubuntu2204:~# echo “vm.overcommit_memory = 1” &gt;&gt; /etc/sysctl.conf <br>root@ubuntu2204:~# sysctl -p<br>vm.overcommit_memory = 1<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">重新测试启动（警告信息消除）</span><br>root@ubuntu2204:~# redis-server /apps/redis/etc/redis.conf <br>1024:C 15 May 2024 06:11:01.266 * oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo<br>1024:C 15 May 2024 06:11:01.266 * Redis version=7.2.4, bits=64, commit=00000000, modified=0, pid=1024, just started<br>1024:C 15 May 2024 06:11:01.266 * Configuration loaded<br>1024:M 15 May 2024 06:11:01.266 * Increased maximum number of open files to 10032 (it was originally set to 1024).<br>1024:M 15 May 2024 06:11:01.266 * monotonic clock: POSIX clock_gettime<br>                _._                                                  <br>           _.-``__ &#x27;&#x27;-._                                             <br>      _.-``    `.  `_.  &#x27;&#x27;-._           Redis 7.2.4 (00000000/0) 64 bit<br>  .-`` .-```.  ```\/    _.,_ &#x27;&#x27;-._                                  <br> (    &#x27;      ,       .-`  | `,    )     Running in standalone mode<br> |`-._`-...-` __...-.``-._|&#x27;` _.-&#x27;|     Port: 6379<br> |    `-._   `._    /     _.-&#x27;    |     PID: 1024<br>  `-._    `-._  `-./  _.-&#x27;    _.-&#x27;                                   <br> |`-._`-._    `-.__.-&#x27;    _.-&#x27;_.-&#x27;|                                  <br> |    `-._`-._        _.-&#x27;_.-&#x27;    |           https://redis.io       <br>  `-._    `-._`-.__.-&#x27;_.-&#x27;    _.-&#x27;                                   <br> |`-._`-._    `-.__.-&#x27;    _.-&#x27;_.-&#x27;|                                  <br> |    `-._`-._        _.-&#x27;_.-&#x27;    |                                  <br>  `-._    `-._`-.__.-&#x27;_.-&#x27;    _.-&#x27;                                   <br>      `-._    `-.__.-&#x27;    _.-&#x27;                                       <br>          `-._        _.-&#x27;                                           <br>              `-.__.-&#x27;                                               <br><br>1024:M 15 May 2024 06:11:01.269 * Server initialized<br>1024:M 15 May 2024 06:11:01.270 * Loading RDB produced by version 7.2.4<br>1024:M 15 May 2024 06:11:01.270 * RDB age 77247 seconds<br>1024:M 15 May 2024 06:11:01.270 * RDB memory usage when created 0.83 Mb<br>1024:M 15 May 2024 06:11:01.270 * Done loading RDB, keys loaded: 0, keys expired: 0.<br>1024:M 15 May 2024 06:11:01.270 * DB loaded from disk: 0.001 seconds<br>1024:M 15 May 2024 06:11:01.270 * Ready to accept connections tcp<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">新开一个窗口，检查端口状态（redis默认使用6379端口）使用redis-cli测试</span><br>root@ubuntu2204:~# ss -ntpl<br>State     Recv-Q     Send-Q         Local Address:Port         Peer Address:Port    Process                                       <br>LISTEN    0          128                  0.0.0.0:22                0.0.0.0:*        users:((&quot;sshd&quot;,pid=809,fd=3))                <br>LISTEN    0          511                127.0.0.1:6379              0.0.0.0:*        users:((&quot;redis-server&quot;,pid=1024,fd=6))       <br>LISTEN    0          4096           127.0.0.53%lo:53                0.0.0.0:*        users:((&quot;systemd-resolve&quot;,pid=761,fd=14))    <br>LISTEN    0          128                     [::]:22                   [::]:*        users:((&quot;sshd&quot;,pid=809,fd=4))                <br>LISTEN    0          511                    [::1]:6379                 [::]:*        users:((&quot;redis-server&quot;,pid=1024,fd=7)) <br><br>root@ubuntu2204:~# redis-cli <br>127.0.0.1:6379&gt; ping<br>PONG<br>127.0.0.1:6379&gt; <br></code></pre></td></tr></table></figure><p>创建redis服务启动账户并授权</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs shell">root@ubuntu2204:~# useradd -r -s /sbin/nologin redis<br>root@ubuntu2204:~# chown -R redis.redis /apps/redis/<br><br>root@ubuntu2204:~# ll /apps/redis/<br>total 28<br>drwxr-xr-x 7 redis redis 4096 May 14 07:49 ./<br>drwxr-xr-x 3 root  root  4096 May 14 07:10 ../<br>drwxr-xr-x 2 redis redis 4096 May 14 07:26 bin/<br>drwxr-xr-x 2 redis redis 4096 May 14 07:49 data/<br>drwxr-xr-x 2 redis redis 4096 May 14 07:49 etc/<br>drwxr-xr-x 2 redis redis 4096 May 14 07:49 log/<br>drwxr-xr-x 2 redis redis 4096 May 14 07:49 run/<br></code></pre></td></tr></table></figure><p>创建 systemd service 文件，可以参考编译包中的service模板，也可参考yum安装生成的systemd service文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs shell">root@ubuntu2204:~# ls ./redis-7.2.4/utils/systemd-redis_server.service <br>./redis-7.2.4/utils/systemd-redis_server.service<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">修改好的redis.service文件内容</span><br>root@ubuntu2204:~# vim /etc/systemd/system/redis.service<br>[Unit]<br>Description=Redis data structure server<br>Documentation=https://redis.io/documentation<br>Wants=network-online.target<br>After=network-online.target<br><br>[Service]<br>ExecStart=/apps/redis/bin/redis-server /apps/redis/etc/redis.conf --supervised systemd<br>ExecStop=/bin/kill -s QUIT $MAINPID<br>LimitNOFILE=1000000<br>NoNewPrivileges=yes<br>Type=notify<br>TimeoutStartSec=infinity<br>TimeoutStopSec=infinity<br>User=redis<br>Group=redis<br>RuntimeDirectory=redis<br>RuntimeDirectoryMode=0755<br><br>[Install]<br>WantedBy=multi-user.target<br></code></pre></td></tr></table></figure><p>修改redis配置文件，设置服务IP，PID文件目录，连接密码</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">修改配置文件（先更改如下三项，其它配置参考文档修改）</span><br>root@ubuntu2204:~# vim /apps/redis/etc/redis.conf <br>bind 0.0.0.0# 监听端口<br>pidfile /apps/redis/run/redis_6379.pid# PID文件，由于使用redis用户启动服务，需更改到有权限的目录<br>requirepass &quot;12345678&quot;# 客户端连接密码（若有特殊字符使用引号）<br></code></pre></td></tr></table></figure><p>测试systemd启动服务配置</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs shell">root@ubuntu2204:~# systemctl enable --now redis.service <br>Created symlink /etc/systemd/system/multi-user.target.wants/redis.service → /etc/systemd/system/redis.service.<br><br>root@ubuntu2204:~# systemctl status redis.service <br>● redis.service - Redis data structure server<br>     Loaded: loaded (/etc/systemd/system/redis.service; enabled; vendor preset: enabled)<br>     Active: active (running) since Wed 2024-05-15 07:21:59 UTC; 25s ago<br>       Docs: https://redis.io/documentation<br>   Main PID: 23950 (redis-server)<br>     Status: &quot;Ready to accept connections&quot;<br>      Tasks: 5 (limit: 4515)<br>     Memory: 2.1M<br>        CPU: 97ms<br>     CGroup: /system.slice/redis.service<br>             └─23950 &quot;/apps/redis/bin/redis-server 0.0.0.0:6379&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot;<br> &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot;<br><br>May 15 07:21:59 ubuntu2204 systemd[1]: Starting Redis data structure server...<br>May 15 07:21:59 ubuntu2204 redis-server[23950]: 23950:C 15 May 2024 07:21:59.143 * Supervised by systemd. Please make sure you set<br> appropriate values for TimeoutStartSec and TimeoutStopSec in your service unit.<br>May 15 07:21:59 ubuntu2204 redis-server[23950]: 23950:C 15 May 2024 07:21:59.143 * oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo<br>May 15 07:21:59 ubuntu2204 redis-server[23950]: 23950:C 15 May 2024 07:21:59.143 * Redis version=7.2.4, bits=64, commit=00000000, <br>modified=0, pid=23950, just started<br>May 15 07:21:59 ubuntu2204 redis-server[23950]: 23950:C 15 May 2024 07:21:59.143 * Configuration loaded<br>May 15 07:21:59 ubuntu2204 redis-server[23950]: 23950:M 15 May 2024 07:21:59.144 * monotonic clock: POSIX clock_gettime<br>May 15 07:21:59 ubuntu2204 redis-server[23950]: 23950:M 15 May 2024 07:21:59.145 * Running mode=standalone, port=6379.<br>May 15 07:21:59 ubuntu2204 redis-server[23950]: 23950:M 15 May 2024 07:21:59.146 * Server initialized<br>May 15 07:21:59 ubuntu2204 redis-server[23950]: 23950:M 15 May 2024 07:21:59.146 * Ready to accept connections tcp<br>May 15 07:21:59 ubuntu2204 systemd[1]: Started Redis data structure server.<br><br></code></pre></td></tr></table></figure><p>验证</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br></pre></td><td class="code"><pre><code class="hljs shell">root@ubuntu2204:~# ss -ntlp<br>State     Recv-Q     Send-Q         Local Address:Port         Peer Address:Port    Process                                       <br>LISTEN    0          511                  0.0.0.0:6379              0.0.0.0:*        users:((&quot;redis-server&quot;,pid=23950,fd=6))      <br>LISTEN    0          128                  0.0.0.0:22                0.0.0.0:*        users:((&quot;sshd&quot;,pid=809,fd=3))                <br>LISTEN    0          4096           127.0.0.53%lo:53                0.0.0.0:*        users:((&quot;systemd-resolve&quot;,pid=761,fd=14))    <br>LISTEN    0          128                     [::]:22                   [::]:*        users:((&quot;sshd&quot;,pid=809,fd=4))     <br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">使用redis-cli测试</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">格式：redis-cli -h &lt;redis服务器&gt; -p &lt;PORT&gt; -a &lt;PASSWORD&gt;</span><br><br>root@ubuntu2204:~# redis-cli -h 10.0.0.7 -p 6379 -a 12345678<br>Warning: Using a password with &#x27;-a&#x27; or &#x27;-u&#x27; option on the command line interface may not be safe.<br>10.0.0.7:6379&gt; ping<br>PONG<br>10.0.0.7:6379&gt; info<br><span class="hljs-meta prompt_"># </span><span class="language-bash">Server</span><br>redis_version:7.2.4<br>redis_git_sha1:00000000<br>redis_git_dirty:0<br>redis_build_id:cfa841a5bc8661c5<br>redis_mode:standalone<br>os:Linux 5.15.0-102-generic x86_64<br>arch_bits:64<br>monotonic_clock:POSIX clock_gettime<br>multiplexing_api:epoll<br>atomicvar_api:c11-builtin<br>gcc_version:11.4.0<br>process_id:23986<br>process_supervised:systemd<br>run_id:a1f26808d76b9e2b984e46979c55d9af2bd8a161<br>tcp_port:6379<br>server_time_usec:1715758640316473<br>uptime_in_seconds:132<br>uptime_in_days:0<br>hz:10<br>configured_hz:10<br>lru_clock:4482608<br>executable:/apps/redis/bin/redis-server<br>config_file:/apps/redis/etc/redis.conf<br>io_threads_active:0<br>listener0:name=tcp,bind=0.0.0.0,port=6379<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">Clients</span><br>connected_clients:1<br>cluster_connections:0<br>maxclients:10000<br>client_recent_max_input_buffer:20480<br>client_recent_max_output_buffer:0<br>blocked_clients:0<br>tracking_clients:0<br>clients_in_timeout_table:0<br>total_blocking_keys:0<br>total_blocking_keys_on_nokey:0<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">Memory</span><br>used_memory:965424<br>used_memory_human:942.80K<br>used_memory_rss:7987200<br>used_memory_rss_human:7.62M<br>used_memory_peak:1158792<br>used_memory_peak_human:1.11M<br>used_memory_peak_perc:83.31%<br>used_memory_overhead:888576<br>used_memory_startup:865992<br>used_memory_dataset:76848<br>used_memory_dataset_perc:77.29%<br>allocator_allocated:1811968<br>allocator_active:1966080<br>allocator_resident:4943872<br>total_system_memory:4064628736<br>total_system_memory_human:3.79G<br>used_memory_lua:31744<br>used_memory_vm_eval:31744<br>used_memory_lua_human:31.00K<br>used_memory_scripts_eval:0<br>number_of_cached_scripts:0<br>number_of_functions:0<br>number_of_libraries:0<br>used_memory_vm_functions:32768<br>used_memory_vm_total:64512<br>used_memory_vm_total_human:63.00K<br>used_memory_functions:184<br>used_memory_scripts:184<br>used_memory_scripts_human:184B<br>maxmemory:0<br>maxmemory_human:0B<br>maxmemory_policy:noeviction<br>allocator_frag_ratio:1.09<br>allocator_frag_bytes:154112<br>allocator_rss_ratio:2.51<br>allocator_rss_bytes:2977792<br>rss_overhead_ratio:1.62<br>rss_overhead_bytes:3043328<br>mem_fragmentation_ratio:8.29<br>mem_fragmentation_bytes:7024192<br>mem_not_counted_for_evict:0<br>mem_replication_backlog:0<br>mem_total_replication_buffers:0<br>mem_clients_slaves:0<br>mem_clients_normal:22400<br>mem_cluster_links:0<br>mem_aof_buffer:0<br>mem_allocator:jemalloc-5.3.0<br>active_defrag_running:0<br>lazyfree_pending_objects:0<br>lazyfreed_objects:0<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">Persistence</span><br>loading:0<br>async_loading:0<br>current_cow_peak:0<br>current_cow_size:0<br>current_cow_size_age:0<br>current_fork_perc:0.00<br>current_save_keys_processed:0<br>current_save_keys_total:0<br>rdb_changes_since_last_save:0<br>rdb_bgsave_in_progress:0<br>rdb_last_save_time:1715758508<br>rdb_last_bgsave_status:ok<br>rdb_last_bgsave_time_sec:-1<br>rdb_current_bgsave_time_sec:-1<br>rdb_saves:0<br>rdb_last_cow_size:0<br>rdb_last_load_keys_expired:0<br>rdb_last_load_keys_loaded:0<br>aof_enabled:0<br>aof_rewrite_in_progress:0<br>aof_rewrite_scheduled:0<br>aof_last_rewrite_time_sec:-1<br>aof_current_rewrite_time_sec:-1<br>aof_last_bgrewrite_status:ok<br>aof_rewrites:0<br>aof_rewrites_consecutive_failures:0<br>aof_last_write_status:ok<br>aof_last_cow_size:0<br>module_fork_in_progress:0<br>module_fork_last_cow_size:0<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">Stats</span><br>total_connections_received:1<br>total_commands_processed:3<br>instantaneous_ops_per_sec:0<br>total_net_input_bytes:83<br>total_net_output_bytes:205217<br>total_net_repl_input_bytes:0<br>total_net_repl_output_bytes:0<br>instantaneous_input_kbps:0.00<br>instantaneous_output_kbps:0.00<br>instantaneous_input_repl_kbps:0.00<br>instantaneous_output_repl_kbps:0.00<br>rejected_connections:0<br>sync_full:0<br>sync_partial_ok:0<br>sync_partial_err:0<br>expired_keys:0<br>expired_stale_perc:0.00<br>expired_time_cap_reached_count:0<br>expire_cycle_cpu_milliseconds:4<br>evicted_keys:0<br>evicted_clients:0<br>total_eviction_exceeded_time:0<br>current_eviction_exceeded_time:0<br>keyspace_hits:0<br>keyspace_misses:0<br>pubsub_channels:0<br>pubsub_patterns:0<br>pubsubshard_channels:0<br>latest_fork_usec:0<br>total_forks:0<br>migrate_cached_sockets:0<br>slave_expires_tracked_keys:0<br>active_defrag_hits:0<br>active_defrag_misses:0<br>active_defrag_key_hits:0<br>active_defrag_key_misses:0<br>total_active_defrag_time:0<br>current_active_defrag_time:0<br>tracking_total_keys:0<br>tracking_total_items:0<br>tracking_total_prefixes:0<br>unexpected_error_replies:0<br>total_error_replies:0<br>dump_payload_sanitizations:0<br>total_reads_processed:4<br>total_writes_processed:5<br>io_threaded_reads_processed:0<br>io_threaded_writes_processed:0<br>reply_buffer_shrinks:1<br>reply_buffer_expands:0<br>eventloop_cycles:1315<br>eventloop_duration_sum:313813<br>eventloop_duration_cmd_sum:1688<br>instantaneous_eventloop_cycles_per_sec:9<br>instantaneous_eventloop_duration_usec:268<br>acl_access_denied_auth:0<br>acl_access_denied_cmd:0<br>acl_access_denied_key:0<br>acl_access_denied_channel:0<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">Replication</span><br>role:master<br>connected_slaves:0<br>master_failover_state:no-failover<br>master_replid:cbcfc8bbb3ca49ffe80f7d402ae7d55fb280400d<br>master_replid2:0000000000000000000000000000000000000000<br>master_repl_offset:0<br>second_repl_offset:-1<br>repl_backlog_active:0<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:0<br>repl_backlog_histlen:0<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">CPU</span><br>used_cpu_sys:0.102829<br>used_cpu_user:0.331917<br>used_cpu_sys_children:0.000000<br>used_cpu_user_children:0.000000<br>used_cpu_sys_main_thread:0.090418<br>used_cpu_user_main_thread:0.343591<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">Modules</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">Errorstats</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">Cluster</span><br>cluster_enabled:0<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">Keyspace</span><br>10.0.0.7:6379&gt; <br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Redis</category>
      
    </categories>
    
    
    <tags>
      
      <tag>NoSQL</tag>
      
      <tag>Redis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>为cp和mv命令添加进度条</title>
    <link href="/2024/05/09/%E4%B8%BAcp%E5%92%8Cmv%E5%91%BD%E4%BB%A4%E6%B7%BB%E5%8A%A0%E8%BF%9B%E5%BA%A6%E6%9D%A1/"/>
    <url>/2024/05/09/%E4%B8%BAcp%E5%92%8Cmv%E5%91%BD%E4%BB%A4%E6%B7%BB%E5%8A%A0%E8%BF%9B%E5%BA%A6%E6%9D%A1/</url>
    
    <content type="html"><![CDATA[<p>Advanced Copy 是<code>GNU cp</code> 和 <code>GNU mv</code> 程序的 mod  。它添加了一个进度条，并提供有关复制或移动文件和文件夹时发生的情况的一些信息。不仅是进度条，它还显示数据传输速率、估计剩余时间和当前正在复制的文件名。</p><h4 id="安装高级复制补丁-向-cp-和-mv-命令添加进度条"><a href="#安装高级复制补丁-向-cp-和-mv-命令添加进度条" class="headerlink" title="安装高级复制补丁,向 cp 和 mv 命令添加进度条"></a><strong>安装高级复制补丁,向 cp 和 mv 命令添加进度条</strong></h4><p>cp 和 mv 命令是<code>GNU coreutils</code>提供。默认安装是的8.32-34版本。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@rocky9 ~]# rpm -qf /usr/bin/cp /usr/bin/mv <br>coreutils-8.32-34.el9.x86_64<br>coreutils-8.32-34.el9.x86_64<br><br>[root@rocky9 ~]# rpm -qi coreutils<br>Name        : coreutils<br>Version     : 8.32<br>Release     : 34.el9<br>Architecture: x86_64<br>Install Date: Tue Apr  9 11:18:00 2024<br>Group       : Unspecified<br>Size        : 5966362<br>License     : GPLv3+<br>Signature   : RSA/SHA256, Mon Apr 24 07:30:21 2023, Key ID 702d426d350d275d<br>Source RPM  : coreutils-8.32-34.el9.src.rpm<br>Build Date  : Mon Apr 24 07:25:45 2023<br>Build Host  : pb-b87dc2e4-4d0e-4d7e-a608-9273f3ddebe5-b-x86-64<br>Packager    : Rocky Linux Build System (Peridot) &lt;releng@rockylinux.org&gt;<br>Vendor      : Rocky Enterprise Software Foundation<br>URL         : https://www.gnu.org/software/coreutils/<br>Summary     : A set of basic GNU tools commonly used in shell scripts<br>Description :<br>These are the GNU core utilities.  This package is the combination of<br>the old GNU fileutils, sh-utils, and textutils packages.<br></code></pre></td></tr></table></figure><p>可以从<code>GNU coreutils</code>下载新的版本，本次以最新的coreutils-9.5为例。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># 安装需要的工具</span></span><br>[root@rocky9 ~]# yum install -y tar patch wget gcc gcc-c++<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># 下载解压coreutils-9.5</span></span><br>[root@rocky9 ~]# wget http://ftp.gnu.org/gnu/coreutils/coreutils-9.5.tar.xz<br>[root@rocky9 ~]# tar xvJf coreutils-9.5.tar.xz<br>[root@rocky9 ~]# cd coreutils-9.5/<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># 下载补丁包advcpmv-0.9-9.5，并应用</span></span><br>[root@rocky9 coreutils-9.5]# wget https://raw.githubusercontent.com/jarun/advcpmv/master/advcpmv-0.9-9.5.patch<br>[root@rocky9 coreutils-9.5]# patch -p1 -i advcpmv-0.9-9.5.patch<br>patching file src/copy.c<br>Hunk #1 succeeded at 114 (offset -7 lines).<br>Hunk #2 succeeded at 437 (offset -7 lines).<br>Hunk #3 succeeded at 468 (offset -7 lines).<br>Hunk #4 succeeded at 607 (offset -7 lines).<br>Hunk #5 succeeded at 625 (offset -7 lines).<br>Hunk #6 succeeded at 809 (offset -7 lines).<br>Hunk #7 succeeded at 888 (offset -7 lines).<br>Hunk #8 succeeded at 966 (offset -7 lines).<br>Hunk #9 succeeded at 1942 (offset -3 lines).<br>Hunk #10 succeeded at 2023 (offset -3 lines).<br>Hunk #11 succeeded at 2044 (offset -3 lines).<br>patching file src/copy.h<br>Hunk #1 succeeded at 256 (offset 7 lines).<br>Hunk #2 succeeded at 333 (offset 1 line).<br>patching file src/cp.c<br>Hunk #1 succeeded at 141 with fuzz 2 (offset 1 line).<br>Hunk #2 succeeded at 186 (offset 3 lines).<br>Hunk #3 succeeded at 686 (offset 16 lines).<br>Hunk #4 succeeded at 902 with fuzz 1 (offset 17 lines).<br>Hunk #5 succeeded at 987 (offset 17 lines).<br>Hunk #6 succeeded at 1128 (offset 19 lines).<br>Hunk #7 succeeded at 1190 (offset 19 lines).<br>Hunk #8 succeeded at 1383 (offset 35 lines).<br>patching file src/mv.c<br>Hunk #1 succeeded at 80 with fuzz 1 (offset 1 line).<br>Hunk #2 succeeded at 172 (offset 1 line).<br>Hunk #3 succeeded at 401 (offset 4 lines).<br>Hunk #4 succeeded at 465 (offset 5 lines).<br>Hunk #5 succeeded at 478 (offset 5 lines).<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># 编译coreutils-9.5</span></span><br>[root@rocky9 coreutils-9.5]# export FORCE_UNSAFE_CONFIGURE=1<br>[root@rocky9 coreutils-9.5]# ./configure<br>[root@rocky9 coreutils-9.5]# make<br></code></pre></td></tr></table></figure><p>拷贝编译好的cp和mv命令到$PATH路径中，重命名为gcp和gmv</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@rocky9 coreutils-9.5]# cp ./src/cp /usr/local/bin/gcp<br>[root@rocky9 coreutils-9.5]# cp ./src/mv /usr/local/bin/gmv<br></code></pre></td></tr></table></figure><p>为新命令设置别名</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@rocky9 coreutils-9.5]# echo &quot;alias cp=&#x27;/usr/local/bin/gcp -ig&#x27;&quot; &gt;&gt; /etc/profile<br>[root@rocky9 coreutils-9.5]# echo &quot;alias mv=&#x27;/usr/local/bin/gmv -ig&#x27;&quot; &gt;&gt; /etc/profile<br><br>[root@rocky9 coreutils-9.5]# source ~/.bashrc<br></code></pre></td></tr></table></figure><p>测试</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@rocky9 ~]# which cp <br>alias cp=&#x27;/usr/local/bin/gcp -g&#x27;<br>/usr/local/bin/gcp<br>[root@rocky9 ~]# which mv<br>alias mv=&#x27;/usr/local/bin/gmv -g&#x27;<br>/usr/local/bin/gmv<br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@rocky9 ~]# cp ubuntu-20.04.4-live-server-amd64.iso  /tmp<br>copying at  64.6 MiB/s (about  0h  0m 12s remaining)<br>ubuntu-20.04.4-live-server-amd64.iso                                                                                         176.8 MiB /   1.2 GiB<br>[==================&gt;                                                                                                                      ] 13.9 %<br></code></pre></td></tr></table></figure><p>现cp命令是高版本中的二进制文件，可看到cp命令选项</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@rocky9 ~]# cp --help<br>Usage: /usr/local/bin/gcp [OPTION]... [-T] SOURCE DEST<br>  or:  /usr/local/bin/gcp [OPTION]... SOURCE... DIRECTORY<br>  or:  /usr/local/bin/gcp [OPTION]... -t DIRECTORY SOURCE...<br>Copy SOURCE to DEST, or multiple SOURCE(s) to DIRECTORY.<br><br>Mandatory arguments to long options are mandatory for short options too.<br>  -a, --archive                same as -dR --preserve=all<br>      --attributes-only        don&#x27;t copy the file data, just the attributes<br>      --backup[=CONTROL]       make a backup of each existing destination file<br>  -b                           like --backup but does not accept an argument<br>      --copy-contents          copy contents of special files when recursive<br>  -d                           same as --no-dereference --preserve=links<br>      --debug                  explain how a file is copied.  Implies -v<br>  -f, --force                  if an existing destination file cannot be<br>                                 opened, remove it and try again (this option<br>                                 is ignored when the -n option is also used)<br>  -g, --progress-bar           add a progress bar.<br>                                 Note that this doesn&#x27;t work with reflink,<br>                                 reflink will be automatically disabled<br>  -i, --interactive            prompt before overwrite (overrides a previous -n<br>                                  option)<br>  -H                           follow command-line symbolic links in SOURCE<br>  -l, --link                   hard link files instead of copying<br>  -L, --dereference            always follow symbolic links in SOURCE<br>  -n, --no-clobber             (deprecated) silently skip existing files.<br>                                 See also --update<br>  -P, --no-dereference         never follow symbolic links in SOURCE<br>  -p                           same as --preserve=mode,ownership,timestamps<br>      --preserve[=ATTR_LIST]   preserve the specified attributes<br>      --no-preserve=ATTR_LIST  don&#x27;t preserve the specified attributes<br>      --parents                use full source file name under DIRECTORY<br>  -R, -r, --recursive          copy directories recursively<br>      --reflink[=WHEN]         control clone/CoW copies. See below<br>      --remove-destination     remove each existing destination file before<br>                                 attempting to open it (contrast with --force)<br>      --sparse=WHEN            control creation of sparse files. See below<br>      --strip-trailing-slashes  remove any trailing slashes from each SOURCE<br>                                 argument<br>  -s, --symbolic-link          make symbolic links instead of copying<br>  -S, --suffix=SUFFIX          override the usual backup suffix<br>  -t, --target-directory=DIRECTORY  copy all SOURCE arguments into DIRECTORY<br>  -T, --no-target-directory    treat DEST as a normal file<br>  --update[=UPDATE]            control which existing files are updated;<br>                                 UPDATE=&#123;all,none,none-fail,older(default)&#125;.<br>  -u                           equivalent to --update[=older].  See below<br>  -v, --verbose                explain what is being done<br>      --keep-directory-symlink  follow existing symlinks to directories<br>  -x, --one-file-system        stay on this file system<br>  -Z                           set SELinux security context of destination<br>                                 file to default type<br>      --context[=CTX]          like -Z, or if CTX is specified then set the<br>                                 SELinux or SMACK security context to CTX<br>      --help        display this help and exit<br>      --version     output version information and exit<br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Linux基础</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Linux</tag>
      
      <tag>init</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>OpenVPN安装与配置</title>
    <link href="/2024/04/29/OpenVPN%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/"/>
    <url>/2024/04/29/OpenVPN%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/</url>
    
    <content type="html"><![CDATA[<h5 id="采用Hyper-V虚拟机模拟环境，配置如下"><a href="#采用Hyper-V虚拟机模拟环境，配置如下" class="headerlink" title="采用Hyper-V虚拟机模拟环境，配置如下"></a>采用Hyper-V虚拟机模拟环境，配置如下</h5><p><img src="https://xcj-typora-img.oss-cn-hangzhou.aliyuncs.com/img/20240507163511.png" alt="20240507163511"></p><table><thead><tr><th>角色</th><th>os版本</th><th>网络链接</th><th>ip</th><th></th></tr></thead><tbody><tr><td>clients 客户端</td><td>windows 11</td><td>局域网</td><td>192.168.23.220</td><td>物理机</td></tr><tr><td>openvpn 服务器</td><td>rocky9</td><td>局域网(桥接网络)</td><td>192.168.23.40</td><td>hyperv虚拟机</td></tr><tr><td></td><td></td><td>内部网络</td><td>192.168.200.10</td><td>hyperv虚拟机</td></tr><tr><td>内部服务器1</td><td>ubuntu2204</td><td>内部网络</td><td>192.168.200.20</td><td>hyperv虚拟机</td></tr><tr><td>内部服务器2</td><td>windows server 2019</td><td>内部网络</td><td>192.168.200.30</td><td>hyperv虚拟机</td></tr></tbody></table><h3 id="查看并安装软件版本"><a href="#查看并安装软件版本" class="headerlink" title="查看并安装软件版本"></a>查看并安装软件版本</h3><ul><li>openvpn: OpenVPN服务器端</li><li>easy-rsa: 证书管理工具</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@rocky9 ~]# yum list openvpn easy-rsa<br>Last metadata expiration check: 0:01:03 ago on Mon 29 Apr 2024 04:56:08 PM CST.<br>Available Packages<br>easy-rsa.noarch                                                          3.1.6-1.el9                                                           epel<br>openvpn.x86_64                                                           2.5.9-2.el9                                                           epel<br><br>[root@rocky9 ~]# yum install -y openvpn easy-rsa<br></code></pre></td></tr></table></figure><h3 id="准备证书生成环境"><a href="#准备证书生成环境" class="headerlink" title="准备证书生成环境"></a>准备证书生成环境</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@rocky9 ~]# rpm -ql easy-rsa<br>/usr/share/doc/easy-rsa<br>/usr/share/doc/easy-rsa/COPYING.md<br>/usr/share/doc/easy-rsa/ChangeLog<br>/usr/share/doc/easy-rsa/README.md<br>/usr/share/doc/easy-rsa/README.quickstart.md<br>/usr/share/doc/easy-rsa/vars.example<br>/usr/share/easy-rsa<br>/usr/share/easy-rsa/3<br>/usr/share/easy-rsa/3.0<br>/usr/share/easy-rsa/3.1.6<br>/usr/share/easy-rsa/3.1.6/easyrsa<br>/usr/share/easy-rsa/3.1.6/openssl-easyrsa.cnf<br>/usr/share/easy-rsa/3.1.6/x509-types<br>/usr/share/easy-rsa/3.1.6/x509-types/COMMON<br>/usr/share/easy-rsa/3.1.6/x509-types/ca<br>/usr/share/easy-rsa/3.1.6/x509-types/client<br>/usr/share/easy-rsa/3.1.6/x509-types/code-signing<br>/usr/share/easy-rsa/3.1.6/x509-types/email<br>/usr/share/easy-rsa/3.1.6/x509-types/kdc<br>/usr/share/easy-rsa/3.1.6/x509-types/server<br>/usr/share/easy-rsa/3.1.6/x509-types/serverClient<br>/usr/share/licenses/easy-rsa<br>/usr/share/licenses/easy-rsa/COPYING.md<br>/usr/share/licenses/easy-rsa/gpl-2.0.txt<br><br>[root@rocky9 ~]# ll /usr/share/easy-rsa/<br>total 0<br>lrwxrwxrwx 1 root root  5 Aug 24  2023 3 -&gt; 3.1.6<br>lrwxrwxrwx 1 root root  5 Aug 24  2023 3.0 -&gt; 3.1.6<br>drwxr-xr-x 3 root root 66 Apr 29 17:00 3.1.6<br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># 准备证书生成目录</span></span><br>[root@rocky9 3]# mkdir /etc/openvpn/easy-rsa-server<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># 准备证书颁发文件</span></span><br>[root@rocky9 3]# cp -r /usr/share/easy-rsa/3/*  /etc/openvpn/easy-rsa-server<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># 准备颁发证书相关变量配置文件</span></span><br>[root@rocky9 3]# cp /usr/share/doc/easy-rsa/vars.example  /etc/openvpn/easy-rsa-server/vars<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># 修改CA证书和OpenVPN服务器证书有效期时长，可适当加长</span></span><br>[root@rocky9 3]# vim /etc/openvpn/easy-rsa-server/vars<br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># 可更改证书的默认签名配置信息（可选）</span></span><br>set_var EASYRSA_REQ_COUNTRY     &quot;CN&quot;<br>set_var EASYRSA_REQ_PROVINCE    &quot;HuBei&quot;<br>set_var EASYRSA_REQ_CITY        &quot;YC&quot;<br>set_var EASYRSA_REQ_ORG         &quot;xcjyc.top&quot;<br>set_var EASYRSA_REQ_EMAIL       &quot;mail@xcjyc.top&quot;<br>set_var EASYRSA_REQ_OU          &quot;My Website Unit&quot;<br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># ca证书默认有效期3650，可适当延长</span></span><br>set_var EASYRSA_CA_EXPIRE       36500<br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># 服务器证书默认825天，可适当延长</span></span><br>set_var EASYRSA_CERT_EXPIRE     18250<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># 生成openvpn服务器配置文件</span></span><br>[root@rocky9 3]# cp /usr/share/doc/openvpn/sample/sample-config-files/server.conf /etc/openvpn/<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># 目录结构如下</span></span><br>[root@rocky9 ~]# tree /etc/openvpn/<br>/etc/openvpn/<br>├── client<br>├── easy-rsa-server<br>│   ├── easyrsa<br>│   ├── openssl-easyrsa.cnf<br>│   ├── vars<br>│   └── x509-types<br>│       ├── COMMON<br>│       ├── ca<br>│       ├── client<br>│       ├── code-signing<br>│       ├── email<br>│       ├── kdc<br>│       ├── server<br>│       └── serverClient<br>├── server<br>└── server.conf<br><br>4 directories, 12 files<br></code></pre></td></tr></table></figure><h3 id="初始化PKI环境"><a href="#初始化PKI环境" class="headerlink" title="初始化PKI环境"></a>初始化PKI环境</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># 进入准备好的easyrsa目录</span></span><br>[root@rocky9 ~]# cd /etc/openvpn/easy-rsa-server/<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># easyrsa脚本帮助</span></span><br>[root@rocky9 easy-rsa-server]# ./easyrsa <br><br>Easy-RSA 3 usage and overview<br><br>USAGE: easyrsa [global-options] COMMAND [command-options]<br><br>To get detailed usage and help for a command, use:<br>  ./easyrsa help COMMAND<br><br>For a list of global-options, use:<br>  ./easyrsa help options<br><br>A list of commands is shown below:<br>  init-pki [ cmd-opts ]<br>  build-ca [ cmd-opts ]<br>  gen-dh<br>  gen-req &lt;file_name_base&gt; [ cmd-opts ]<br>  sign-req &lt;type&gt; &lt;file_name_base&gt; [ cmd-opts ]<br>  build-client-full &lt;file_name_base&gt; [ cmd-opts ]<br>  build-server-full &lt;file_name_base&gt; [ cmd-opts ]<br>  build-serverClient-full &lt;file_name_base&gt; [ cmd-opts ]<br>  inline &lt;file_name_base&gt;<br>  revoke &lt;file_name_base&gt; [ cmd-opts ]<br>  renew &lt;file_name_base&gt;<br>  revoke-renewed &lt;file_name_base&gt; [ cmd-opts ]<br>  rewind-renew &lt;certificate_serial_number&gt;<br>  rebuild &lt;file_name_base&gt; [ cmd-opts ]<br>  gen-crl<br>  update-db<br>  make-safe-ssl<br>  show-req &lt;file_name_base&gt; [ cmd-opts ]<br>  show-cert &lt;file_name_base&gt; [ cmd-opts ]<br>  show-ca [ cmd-opts ]<br>  show-crl<br>  show-expire &lt;file_name_base&gt; (Optional)<br>  show-revoke &lt;file_name_base&gt; (Optional)<br>  show-renew &lt;file_name_base&gt; (Optional)<br>  verify-cert &lt;file_name_base&gt;<br>  import-req &lt;request_file_path&gt; &lt;short_name_base&gt;<br>  export-p1 &lt;file_name_base&gt; [ cmd-opts ]<br>  export-p7 &lt;file_name_base&gt; [ cmd-opts ]<br>  export-p8 &lt;file_name_base&gt; [ cmd-opts ]<br>  export-p12 &lt;file_name_base&gt; [ cmd-opts ]<br>  set-pass &lt;file_name_base&gt; [ cmd-opts ]<br>  upgrade &lt;type&gt;<br><br>DIRECTORY STATUS (commands would take effect on these locations)<br>     EASYRSA: /etc/openvpn/easy-rsa-server<br>         PKI: /etc/openvpn/easy-rsa-server/pki<br>   vars-file: /etc/openvpn/easy-rsa-server/vars<br>  x509-types: /etc/openvpn/easy-rsa-server/x509-types<br>   CA status: CA has not been built<br><br>IMPORTANT:<br>  The preferred location for &#x27;vars&#x27; is within the PKI folder.<br>  To silence this message move your &#x27;vars&#x27; file to your PKI<br>  or declare your &#x27;vars&#x27; file with option: --vars=&lt;FILE&gt;<br><span class="hljs-meta prompt_">  </span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># 初始化PKI ，在当前目录下生成PKI目录及相关文件</span></span><br>[root@rocky9 easy-rsa-server]# ./easyrsa  init-pki<br><br>Notice<br>------<br>&#x27;init-pki&#x27; complete; you may now create a CA or requests.<br><br>Your newly created PKI dir is:<br>* /etc/openvpn/easy-rsa-server/pki<br><br>Using Easy-RSA configuration:<br>* /etc/openvpn/easy-rsa-server/vars<br><br>IMPORTANT:<br>  The preferred location for &#x27;vars&#x27; is within the PKI folder.<br>  To silence this message move your &#x27;vars&#x27; file to your PKI<br>  or declare your &#x27;vars&#x27; file with option: --vars=&lt;FILE&gt;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># 生成的PKI</span></span><br>[root@rocky9 easy-rsa-server]# tree <br>.<br>├── easyrsa<br>├── openssl-easyrsa.cnf<br>├── pki<br>│   ├── inline<br>│   ├── openssl-easyrsa.cnf<br>│   ├── private<br>│   ├── reqs<br>│   └── vars.example<br>├── vars<br>└── x509-types<br>    ├── COMMON<br>    ├── ca<br>    ├── client<br>    ├── code-signing<br>    ├── email<br>    ├── kdc<br>    ├── server<br>    └── serverClient<br><br>5 directories, 13 files<br></code></pre></td></tr></table></figure><h3 id="创建CA环境"><a href="#创建CA环境" class="headerlink" title="创建CA环境"></a>创建CA环境</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># 创建CA ，若不想使用密码，可以添加 “nopass”参数，例：[root@rocky9 easy-rsa-server]# ./easyrsa build-ca nopass</span></span><br><br>[root@rocky9 easy-rsa-server]# ./easyrsa build-ca <br>Using Easy-RSA &#x27;vars&#x27; configuration:<br>* /etc/openvpn/easy-rsa-server/vars<br><br>IMPORTANT:<br>  The preferred location for &#x27;vars&#x27; is within the PKI folder.<br>  To silence this message move your &#x27;vars&#x27; file to your PKI<br>  or declare your &#x27;vars&#x27; file with option: --vars=&lt;FILE&gt;<br><br>Using SSL:<br>* openssl OpenSSL 3.0.7 1 Nov 2022 (Library: OpenSSL 3.0.7 1 Nov 2022)<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># （在此处设置CA密码）</span></span><br>Enter New CA Key Passphrase:              <br><br>Confirm New CA Key Passphrase: <br>....+.+..............+.+...+..+....+.....+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*...........+.+..............+...+................+..+...+.+.........+......+.....+......+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*..+.....+......+.......+...+.....+.+........+......+....+...........+.+...+..+................+...+......+.....+.........................+......+..+................+..+.........+............................+...+..+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++<br>.+.+.....+.........+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*.........+...+..+.+.........+..+....+..+....+...+......+...........+....+......+......+..+.+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*..+...+...+...+.......+...+.....+...................+..+...+......+.+...........+....+......+...+...........+...+.+..............+...+.......+........+...............+.......+...............+.....+......+....+..+....+...........+.+..+.+............+........+.+...+..+................+............+..+......+...+.+........+.+......+..........................+....+...+.....+.......+...+..+.+...+...........+.+.........+...+..+................+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++<br>-----<br>You are about to be asked to enter information that will be incorporated<br>into your certificate request.<br>What you are about to enter is what is called a Distinguished Name or a DN.<br>There are quite a few fields but you can leave some blank<br>For some fields there will be a default value,<br>If you enter &#x27;.&#x27;, the field will be left blank.<br>-----<br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># （在此外回车接受默认值）</span></span><br>Common Name (eg: your user, host, or server name) [Easy-RSA CA]:<br><br>Notice<br>------<br>CA creation complete. Your new CA certificate is at:<br>* /etc/openvpn/easy-rsa-server/pki/ca.crt<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#  查看创建的CA文件</span></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">## 自签名证书文件：./pki/ca.crt</span></span>   <br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">## 私钥文件：     ./pki/private/ca.key</span></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">## 证书索引信息：  ./pki/index.txt</span></span><br>[root@rocky9 easy-rsa-server]# tree <br>.<br>├── easyrsa<br>├── openssl-easyrsa.cnf<br>├── pki<br>│   ├── ca.crt<br>│   ├── certs_by_serial<br>│   ├── index.txt<br>│   ├── index.txt.attr<br>│   ├── inline<br>│   ├── issued<br>│   ├── openssl-easyrsa.cnf<br>│   ├── private<br>│   │   └── ca.key<br>│   ├── reqs<br>│   ├── revoked<br>│   │   ├── certs_by_serial<br>│   │   ├── private_by_serial<br>│   │   └── reqs_by_serial<br>│   ├── serial<br>│   └── vars.example<br>├── vars<br>└── x509-types<br>    ├── COMMON<br>    ├── ca<br>    ├── client<br>    ├── code-signing<br>    ├── email<br>    ├── kdc<br>    ├── server<br>    └── serverClient<br><br>11 directories, 18 files<br></code></pre></td></tr></table></figure><h3 id="创建服务端证书"><a href="#创建服务端证书" class="headerlink" title="创建服务端证书"></a>创建服务端证书</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#  创建服务器端证书申请，nopass表示不加密文件,server表示文件命名前缀为server。</span></span><br><br>[root@rocky9 easy-rsa-server]# ./easyrsa gen-req server nopass<br>Using Easy-RSA &#x27;vars&#x27; configuration:<br>* /etc/openvpn/easy-rsa-server/vars<br><br>IMPORTANT:<br>  The preferred location for &#x27;vars&#x27; is within the PKI folder.<br>  To silence this message move your &#x27;vars&#x27; file to your PKI<br>  or declare your &#x27;vars&#x27; file with option: --vars=&lt;FILE&gt;<br><br>Using SSL:<br>* openssl OpenSSL 3.0.7 1 Nov 2022 (Library: OpenSSL 3.0.7 1 Nov 2022)<br>......+.+......+........+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*....+....+...+......+....................+.+.....+.+........+.+...+...............+..+.+........+....+...+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*.....+.+...+..+........................+......+..........+.....+....+..............+....+.....+...+....+...+...+........+......+......+.......+...+............+..+....+.....+......+.+.........+.....+...+...+.......+.....+.+...............+......+.....+.+.........+...+..+.+........+.+.....+......+.........+.............+..+...+...+..........+........+.+...+.....+.+...........+.+...+..............+......+.....................+.+..+...+....+........+..................+....+.....+....+......+........+.......+...+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++<br>.....+......+...+.+......+.........+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*...+..............+.............+.....+....+.....+.+.....+...+.......+..+.+......+.........+.....+.........+.............+...+..............+.+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*.+...+..+......+...+....+..+.+............+.....+.+...............+..+.......+...+..+.+..+...+...............+.......+....................+..........+...............+..............+....+......+......+...+..+............+.......+.....+....+...........+......+....+..............+............+....+...+..+......+...+.......+..+.......+...+.....+............+...+...+....+.....+..........+.........+............+..+..........+......+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++<br>-----<br>You are about to be asked to enter information that will be incorporated<br>into your certificate request.<br>What you are about to enter is what is called a Distinguished Name or a DN.<br>There are quite a few fields but you can leave some blank<br>For some fields there will be a default value,<br>If you enter &#x27;.&#x27;, the field will be left blank.<br>-----<br>Common Name (eg: your user, host, or server name) [server]:<br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># 回车确认</span></span><br>Notice<br>------<br>Private-Key and Public-Certificate-Request files created.<br>Your files are:<br>* req: /etc/openvpn/easy-rsa-server/pki/reqs/server.req<br>* key: /etc/openvpn/easy-rsa-server/pki/private/server.key<br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#  颁发服务器证书，第一个server表示证书类型，第二个server表示文件名前缀</span></span><br><br>[root@rocky9 easy-rsa-server]# ./easyrsa sign server server<br>Using Easy-RSA &#x27;vars&#x27; configuration:<br>* /etc/openvpn/easy-rsa-server/vars<br><br>IMPORTANT:<br>  The preferred location for &#x27;vars&#x27; is within the PKI folder.<br>  To silence this message move your &#x27;vars&#x27; file to your PKI<br>  or declare your &#x27;vars&#x27; file with option: --vars=&lt;FILE&gt;<br><br>Using SSL:<br>* openssl OpenSSL 3.0.7 1 Nov 2022 (Library: OpenSSL 3.0.7 1 Nov 2022)<br>You are about to sign the following certificate:<br>Please check over the details shown below for accuracy. Note that this request<br>has not been cryptographically verified. Please be sure it came from a trusted<br>source or that you have verified the request checksum with the sender.<br>Request subject, to be signed as a server certificate <br>for &#x27;18250&#x27; days:<br><br>subject=<br>    commonName                = server<br><br>Type the word &#x27;yes&#x27; to continue, or any other input to abort.<br>  Confirm request details: yes<br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#  输入yes确认</span></span><br>Using configuration from /etc/openvpn/easy-rsa-server/pki/openssl-easyrsa.cnf<br>Enter pass phrase for /etc/openvpn/easy-rsa-server/pki/private/ca.key:<br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#  输入设置的CA密码</span></span><br>Check that the request matches the signature<br>Signature ok<br>The Subject&#x27;s Distinguished Name is as follows<br>commonName            :ASN.1 12:&#x27;server&#x27;<br>Certificate is to be certified until Apr 18 05:24:37 2074 GMT (18250 days)<br><br>Write out database with 1 new entries<br>Data Base Updated<br><br>Notice<br>------<br>Certificate created at:<br>* /etc/openvpn/easy-rsa-server/pki/issued/server.crt<br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@rocky9 easy-rsa-server]# tree pki<br>pki<br>├── ca.crt<br>├── certs_by_serial<br>│   └── ACF621E40DAD89940B729F78FAEA3824.pem<br>├── index.txt<br>├── index.txt.attr<br>├── index.txt.attr.old<br>├── index.txt.old<br>├── inline<br>├── issued<br>│   └── server.crt<br>├── openssl-easyrsa.cnf<br>├── private<br>│   ├── ca.key<br>│   └── server.key<br>├── reqs<br>│   └── server.req<br>├── revoked<br>│   ├── certs_by_serial<br>│   ├── private_by_serial<br>│   └── reqs_by_serial<br>├── serial<br>├── serial.old<br>└── vars.example<br><br>9 directories, 14 files<br></code></pre></td></tr></table></figure><h3 id="创建Diffie-Hellman密钥"><a href="#创建Diffie-Hellman密钥" class="headerlink" title="创建Diffie-Hellman密钥"></a>创建Diffie-Hellman密钥</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@rocky9 easy-rsa-server]# ./easyrsa gen-dh<br>Using Easy-RSA &#x27;vars&#x27; configuration:<br>* /etc/openvpn/easy-rsa-server/vars<br><br>IMPORTANT:<br>  The preferred location for &#x27;vars&#x27; is within the PKI folder.<br>  To silence this message move your &#x27;vars&#x27; file to your PKI<br>  or declare your &#x27;vars&#x27; file with option: --vars=&lt;FILE&gt;<br><br>Using SSL:<br>* openssl OpenSSL 3.0.7 1 Nov 2022 (Library: OpenSSL 3.0.7 1 Nov 2022)<br>Generating DH parameters, 2048 bit long safe prime<br>......................................................+..................................+...........................................................................................................................+...............................................................................................................................................................................+....................................................................................+........................+.............+..................................+.......+......+.........................................................................................................................................................................+.............................+........................................+.......................................................+..........................................................................................................................................................+.............................................+......................................................................................................................................................................+........................................................................................................................................................................................................................+...........................................................................................................................................................................................................................+.........................+......................+....................................................................+..........................................................................................................+......................................................................................................................................................................+...........................................................................................................................................................................................................................................................................................................................................................+....+............................................................................................................................................+.................................................................................+..........+.....................................................................................................................................................................................................................+............++*++*++*++*++*++*++*++*++*++*++*++*++*++*++*++*++*++*++*++*++*++*++*++*++*++*++*++*++*++*++*++*++*++*++*++*++*++*++*++*++*++*++*++*++*++*++*++*++*++*++*++*++*++*++*++*++*++*++*++*++*++*++*++*<br>DH parameters appear to be ok.<br><br>Notice<br>------<br><br>DH parameters of size 2048 created at:<br>* /etc/openvpn/easy-rsa-server/pki/dh.pem<br></code></pre></td></tr></table></figure><h3 id="创建客户端证书和私钥"><a href="#创建客户端证书和私钥" class="headerlink" title="创建客户端证书和私钥"></a>创建客户端证书和私钥</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#  修改客户端证书的有效期设置</span></span><br><br>[root@rocky9 easy-rsa-server]# vim vars <br>set_var EASYRSA_CERT_EXPIRE     180<br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#  创建客户端证书申请文件，</span></span><br>[root@rocky9 easy-rsa-server]# ./easyrsa gen-req xcjyc nopass<br>Using Easy-RSA &#x27;vars&#x27; configuration:<br>* /etc/openvpn/easy-rsa-server/vars<br><br>IMPORTANT:<br>  The preferred location for &#x27;vars&#x27; is within the PKI folder.<br>  To silence this message move your &#x27;vars&#x27; file to your PKI<br>  or declare your &#x27;vars&#x27; file with option: --vars=&lt;FILE&gt;<br><br>Using SSL:<br>* openssl OpenSSL 3.0.7 1 Nov 2022 (Library: OpenSSL 3.0.7 1 Nov 2022)<br>.+.........+..+.......+..+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*...+........+...+.+.....+.+...+...........+....+......+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*.+..................+...+....+...+...+..+..........+..+.......+.........+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++<br>..+.+...+...+..+...+.............+..............+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*.....+.....+.......+.....+.......+..+....+.....+....+..+...+.+...........+.........+.+......+........................+......+...+..+...+.+...+.....+.......+......+.....+...+......+..........+...+......+..+....+...+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*..............+...+............+....+...+........+.............+.........+......+...........+...+..........+...+..+.......+...........+.........+...+...+....+...+.....+......+.+...........+....+.........+......+........+......+.......+..+..........+...+.....+.........+.+.....+............+.+.....+....+...+...+......+...+......+......+........+............+.+..+................+..+...+.......+............+.....+................+......+...+...+..+.+......+.....+....+..+.......+..+......+.......+...+...+.....+.......+...+..+......................+.....+...+...+......+..........+...........+...+.......+..+.......+.........+.........+.....+............+...................+.............................+.+..+....+.....+.+..+.......+...+..+.+.....+..............................+...+.......+.....+...+.+...+...+...+...........+...+.+...........+..........+...+...+.....+.........+...+.......+........+.+...............+......+.....+..........+...............+......+..+...+...+....+...+............+......+...............+..+...+....+...+.....+.......+..+...+......+.......+..............+................+.....+..........+...+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++<br>-----<br>You are about to be asked to enter information that will be incorporated<br>into your certificate request.<br>What you are about to enter is what is called a Distinguished Name or a DN.<br>There are quite a few fields but you can leave some blank<br>For some fields there will be a default value,<br>If you enter &#x27;.&#x27;, the field will be left blank.<br>-----<br>Common Name (eg: your user, host, or server name) [xcjyc]:<br><br>Notice<br>------<br>Private-Key and Public-Certificate-Request files created.<br>Your files are:<br>* req: /etc/openvpn/easy-rsa-server/pki/reqs/xcjyc.req<br>* key: /etc/openvpn/easy-rsa-server/pki/private/xcjyc.key<br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#  颁发客户端证书</span></span><br>[root@rocky9 easy-rsa-server]# ./easyrsa sign client xcjyc<br>Using Easy-RSA &#x27;vars&#x27; configuration:<br>* /etc/openvpn/easy-rsa-server/vars<br><br>IMPORTANT:<br>  The preferred location for &#x27;vars&#x27; is within the PKI folder.<br>  To silence this message move your &#x27;vars&#x27; file to your PKI<br>  or declare your &#x27;vars&#x27; file with option: --vars=&lt;FILE&gt;<br><br>Using SSL:<br>* openssl OpenSSL 3.0.7 1 Nov 2022 (Library: OpenSSL 3.0.7 1 Nov 2022)<br>You are about to sign the following certificate:<br>Please check over the details shown below for accuracy. Note that this request<br>has not been cryptographically verified. Please be sure it came from a trusted<br>source or that you have verified the request checksum with the sender.<br>Request subject, to be signed as a client certificate <br>for &#x27;180&#x27; days:<br><br>subject=<br>    commonName                = xcjyc<br><br>Type the word &#x27;yes&#x27; to continue, or any other input to abort.<br>  Confirm request details: yes<br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># 输入yes确认</span></span><br>Using configuration from /etc/openvpn/easy-rsa-server/pki/openssl-easyrsa.cnf<br>Enter pass phrase for /etc/openvpn/easy-rsa-server/pki/private/ca.key:<br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># 输入CA的密码</span></span><br>Check that the request matches the signature<br>Signature ok<br>The Subject&#x27;s Distinguished Name is as follows<br>commonName            :ASN.1 12:&#x27;xcjyc&#x27;<br>Certificate is to be certified until Oct 27 05:43:16 2024 GMT (180 days)<br><br>Write out database with 1 new entries<br>Data Base Updated<br><br>Notice<br>------<br>Certificate created at:<br>* /etc/openvpn/easy-rsa-server/pki/issued/xcjyc.crt<br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#  查看生成的文件树</span></span><br>[root@rocky9 easy-rsa-server]# tree<br>.<br>├── easyrsa                                                       ## 管理命令<br>├── openssl-easyrsa.cnf<br>├── pki<br>│   ├── ca.crt                                                    ## CA根证书，服务端和客户端都需要<br>│   ├── certs_by_serial<br>│   │   ├── 05C5204F013F6E6EF029F21E2D9ABFE6.pem<br>│   │   └── ACF621E40DAD89940B729F78FAEA3824.pem<br>│   ├── dh.pem                                                    ## 认证算法，服务端需要<br>│   ├── index.txt                                                 ## 证书索引文件<br>│   ├── index.txt.attr<br>│   ├── index.txt.attr.old<br>│   ├── index.txt.old<br>│   ├── inline<br>│   ├── issued<br>│   │   ├── server.crt                                            ## 服务端证书<br>│   │   └── xcjyc.crt                                             ## 客户端证书<br>│   ├── openssl-easyrsa.cnf<br>│   ├── private<br>│   │   ├── ca.key<br>│   │   ├── server.key                                            ## 服务端私钥<br>│   │   └── xcjyc.key                                             ## 客户端私钥<br>│   ├── reqs<br>│   │   ├── server.req<br>│   │   └── xcjyc.req<br>│   ├── revoked<br>│   │   ├── certs_by_serial<br>│   │   ├── private_by_serial<br>│   │   └── reqs_by_serial<br>│   ├── serial<br>│   ├── serial.old<br>│   └── vars.example<br>├── vars<br>└── x509-types<br>    ├── COMMON<br>    ├── ca<br>    ├── client<br>    ├── code-signing<br>    ├── email<br>    ├── kdc<br>    ├── server<br>    └── serverClient<br><br>11 directories, 30 files<br></code></pre></td></tr></table></figure><h3 id="将CA和服务端证书复制到OpenVPN相关目录"><a href="#将CA和服务端证书复制到OpenVPN相关目录" class="headerlink" title="将CA和服务端证书复制到OpenVPN相关目录"></a>将CA和服务端证书复制到OpenVPN相关目录</h3><p>&#x3D;&#x3D;此步骤也可省略而在OpenVPN配置文件中指定具体位置&#x3D;&#x3D;</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@rocky9 easy-rsa-server]# mkdir /etc/openvpn/server/certs<br>[root@rocky9 easy-rsa-server]# cp ./pki/ca.crt ./pki/issued/server.crt ./pki/private/server.key ./pki/dh.pem /etc/openvpn/server/certs<br><br>[root@rocky9 easy-rsa-server]# ll /etc/openvpn/server/certs/<br>total 20<br>-rw------- 1 root root 1204 Apr 30 13:58 ca.crt<br>-rw------- 1 root root  424 Apr 30 13:58 dh.pem<br>-rw------- 1 root root 4613 Apr 30 13:58 server.crt<br>-rw------- 1 root root 1704 Apr 30 13:58 server.key<br></code></pre></td></tr></table></figure><h3 id="将客户端证书复制到OpenVPN相关目录统一管理"><a href="#将客户端证书复制到OpenVPN相关目录统一管理" class="headerlink" title="将客户端证书复制到OpenVPN相关目录统一管理"></a>将客户端证书复制到OpenVPN相关目录统一管理</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@rocky9 easy-rsa-server]# mkdir /etc/openvpn/client/xcjyc<br>[root@rocky9 easy-rsa-server]# cp ./pki/ca.crt ./pki/issued/xcjyc.crt ./pki/private/xcjyc.key /etc/openvpn/client/xcjyc <br>[root@rocky9 easy-rsa-server]# ll /etc/openvpn/client/xcjyc<br>total 16<br>-rw------- 1 root root 1204 Apr 30 14:03 ca.crt<br>-rw------- 1 root root 4488 Apr 30 14:03 xcjyc.crt<br>-rw------- 1 root root 1704 Apr 30 14:03 xcjyc.key<br></code></pre></td></tr></table></figure><h3 id="准备OpenVPN的配置文件"><a href="#准备OpenVPN的配置文件" class="headerlink" title="准备OpenVPN的配置文件"></a>准备OpenVPN的配置文件</h3><p>服务端配置文件范本：&#x2F;usr&#x2F;share&#x2F;doc&#x2F;openvpn&#x2F;sample&#x2F;sample-config-files&#x2F;server.conf</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#  主要配置项含义</span></span><br>port 1194                                  #端口<br>proto udp                                  #协议<br>dev tun                                    #采用路由隧道模式<br>ca /opt/easy-rsa/pki/ca.crt                #ca证书的位置<br>cert /opt/easy-rsa/pki/issued/server.crt   #服务端公钥的位置<br>key /opt/easy-rsa/pki/private/server.key   #服务端私钥的位置<br>dh /opt/easy-rsa/pki/dh.pem                #证书校验算法  <br>server 10.8.0.0 255.255.255.0              #给客户端分配的地址池<br>push &quot;route 172.16.1.0 255.255.255.0&quot;      #允许客户端访问的内网网段<br>ifconfig-pool-persist ipp.txt              #地址池记录文件位置，未来让openvpn客户端固定ip地址使用的<br>keepalive 10 120                           #存活时间，10秒ping一次，120秒如果未收到响应则视为短线<br>max-clients 100                            #最多允许100个客户端连接<br>status openvpn-status.log                  #日志位置，记录openvpn状态<br>log /var/log/openvpn.log                   #openvpn日志记录位置<br>verb 3                                     #openvpn版本<br>client-to-client                           #允许客户端与客户端之间通信<br>persist-key                                #通过keepalive检测超时后，重新启动VPN，不重新读取<br>persist-tun                                #检测超时后，重新启动VPN，一直保持tun是linkup的，否则网络会先linkdown然后再linkup<br>duplicate-cn                               #客户端密钥（证书和私钥）是否可以重复<br>comp-lzo                                   #启动lzo数据压缩格式<br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#  准备配置文件</span></span><br>[root@rocky9 ~]# cd /etc/openvpn/<br>[root@rocky9 openvpn]# vim server.conf <br><br>[root@rocky9 openvpn]# grep  &#x27;^[a-z,A-Z].*&#x27; server.conf<br>port 1194<br>proto tcp<br>dev tun<br>ca /etc/openvpn/server/certs/ca.crt<br>cert /etc/openvpn/server/certs/server.crt<br>key /etc/openvpn/server/certs/server.key  <br>dh /etc/openvpn/server/certs/dh.pem<br>server 10.8.0.0 255.255.255.0<br>ifconfig-pool-persist ipp.txt<br>push &quot;route 192.168.200.0 255.255.255.0&quot;<br>keepalive 10 120<br>cipher AES-256-CBC<br>compress lz4-v2<br>push &quot;compress lz4-v2&quot;<br>max-clients 2048<br>user openvpn<br>group openvpn<br>status /var/log/openvpn/openvpn-status.log<br>log-append  /var/log/openvpn/openvpn.log<br>verb 3<br>mute 20<br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#  准备日志目录</span></span><br>[root@rocky9 easy-rsa-server]# mkdir /var/log/openvpn<br>[root@rocky9 easy-rsa-server]# chown openvpn.openvpn /var/log/openvpn<br><br>[root@rocky9 openvpn]# ll /var/log/openvpn -d<br>drwxr-xr-x 2 openvpn openvpn 6 Apr 30 14:23 /var/log/openvpn<br></code></pre></td></tr></table></figure><h3 id="准备systemd启动配置文件并启动"><a href="#准备systemd启动配置文件并启动" class="headerlink" title="准备systemd启动配置文件并启动"></a>准备systemd启动配置文件并启动</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># 由于缺少/usr/lib/systemd/system/openvpn@.service启动文件，可以参考centos7下的文件自已创建</span></span><br>[root@rocky9 openvpn]# rpm -ql openvpn | grep systemd<br>/usr/lib/systemd/system/openvpn-client@.service<br>/usr/lib/systemd/system/openvpn-server@.service<br>/usr/share/doc/openvpn/README.systemd<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># 注意文件名比较特殊（openvpn@.service）</span></span><br>[root@rocky9 ~]# cat /usr/lib/systemd/system/openvpn@.service<br>[Unit]<br>Description=OpenVPN Robust And Highly Flexible Tunneling Application On %I<br>After=network.target<br><br>[Service]<br>Type=notify<br>PrivateTmp=true<br>ExecStart=/usr/sbin/openvpn --cd /etc/openvpn/ --config %i.conf<br><br>[Install]<br>WantedBy=multi-user.target<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># 启动服务，注意服务名称（openvpn@server）</span></span><br>[root@rocky9 ~]# systemctl enable --now openvpn@server<br>Created symlink /etc/systemd/system/multi-user.target.wants/openvpn@server.service → /usr/lib/systemd/system/openvpn@.service.<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># 检查服务状态及1194端口</span></span><br>[root@rocky9 ~]# systemctl status openvpn@server<br>● openvpn@server.service - OpenVPN Robust And Highly Flexible Tunneling Application On server<br>     Loaded: loaded (/usr/lib/systemd/system/openvpn@.service; enabled; preset: disabled)<br>     Active: active (running) since Tue 2024-04-30 15:28:49 CST; 3min 4s ago<br>   Main PID: 3331 (openvpn)<br>     Status: &quot;Initialization Sequence Completed&quot;<br>      Tasks: 1 (limit: 24718)<br>     Memory: 1.5M<br>        CPU: 12ms<br>     CGroup: /system.slice/system-openvpn.slice/openvpn@server.service<br>             └─3331 /usr/sbin/openvpn --cd /etc/openvpn/ --config server.conf<br><br>Apr 30 15:28:49 rocky9 systemd[1]: Starting OpenVPN Robust And Highly Flexible Tunneling Application On server...<br>Apr 30 15:28:49 rocky9 openvpn[3331]: 2024-04-30 15:28:49 WARNING: Compression for receiving enabled. Compression has been used in the past to bre&gt;<br>Apr 30 15:28:49 rocky9 systemd[1]: Started OpenVPN Robust And Highly Flexible Tunneling Application On server.<br>lines 1-14/14 (END)<br><br>[root@rocky9 ~]# ss -ntl<br>State            Recv-Q           Send-Q                     Local Address:Port                      Peer Address:Port           Process           <br>LISTEN           0                128                              0.0.0.0:22                             0.0.0.0:*                                <br>LISTEN           0                4096                             0.0.0.0:111                            0.0.0.0:*                                <br>LISTEN           0                32                               0.0.0.0:1194                           0.0.0.0:*                                <br>LISTEN           0                128                                 [::]:22                                [::]:*                                <br>LISTEN           0                4096                                [::]:111                               [::]:*  <br></code></pre></td></tr></table></figure><h3 id="准备客户端配置文件"><a href="#准备客户端配置文件" class="headerlink" title="准备客户端配置文件"></a>准备客户端配置文件</h3><p>客户端配置文件范本：&#x2F;usr&#x2F;share&#x2F;doc&#x2F;openvpn&#x2F;sample&#x2F;sample-config-files&#x2F;client.conf</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@rocky9 ~]# grep &#x27;^[[:alpha:]].*&#x27; /usr/share/doc/openvpn/sample/sample-config-files/client.conf &gt; /etc/openvpn/client/xcjyc/client.ovpn<br><br>[root@rocky9 ~]# vim /etc/openvpn/client/xcjyc/client.ovpn<br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># 修改配置项和服务端保持一致</span></span><br><br>[root@rocky9 ~]# cat /etc/openvpn/client/xcjyc/client.ovpn<br>client<br>dev tun<br>proto tcp<br>remote 192.168.23.40 1194<br>resolv-retry infinite<br>nobind<br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#persist-key</span></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#persist-tun</span></span><br>ca ca.crt<br>cert xcjyc.crt<br>key xcjyc.key<br>remote-cert-tls server<br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#tls-auth ta.key 1</span></span><br>cipher AES-256-CBC<br>verb 3<br>compress lz4-v2<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># 打包配置文件给客户端</span></span><br>[root@rocky9 ~]# cd  /etc/openvpn/client/xcjyc/<br>[root@rocky9 xcjyc]# zip /root/openvpn-xcjyc.zip *<br>  adding: ca.crt (deflated 26%)<br>  adding: client.ovpn (deflated 27%)<br>  adding: xcjyc.crt (deflated 46%)<br>  adding: xcjyc.key (deflated 23%)<br>  <br>[root@rocky9 xcjyc]# sz /root/openvpn-xcjyc.zip <br><br></code></pre></td></tr></table></figure><h3 id="安装客户端，连接测试"><a href="#安装客户端，连接测试" class="headerlink" title="安装客户端，连接测试"></a>安装客户端，连接测试</h3><p>拷贝解压打包的配置文件到 C:\Program Files\OpenVPN\config</p><p><img src="https://xcj-typora-img.oss-cn-hangzhou.aliyuncs.com/img/openvpn-client.png" alt="openvpn-client"></p><p><img src="https://xcj-typora-img.oss-cn-hangzhou.aliyuncs.com/img/openvpn-client-conn.png" alt="openvpn-client-conn"></p><h3 id="实现访问openvpn内网主机"><a href="#实现访问openvpn内网主机" class="headerlink" title="实现访问openvpn内网主机"></a>实现访问openvpn内网主机</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># 在服务器开启ip_forward功能</span></span><br>[root@rocky9 ~]# echo net.ipv4.ip_forward = 1 &gt;&gt; /etc/sysctl.conf<br>[root@rocky9 ~]# sysctl -p<br>net.ipv4.ip_forward = 1<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># 配置内网服务器回应远程客户端的路由</span></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">## 方法一：在主机上配置路由</span></span><br>[root@rocky9 ~]# route add -net 10.8.0.0/24 gw 192.168.200.10<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">## 方法二：在网络设备中添加路由</span></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">## 方法三：在openvpn服务器上添加防火墙NAT规则进行地址转换</span></span><br>[root@rocky9 ~]# iptables -vnL<br>Chain INPUT (policy ACCEPT 0 packets, 0 bytes)<br> pkts bytes target     prot opt in     out     source               destination         <br><br>Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)<br> pkts bytes target     prot opt in     out     source               destination         <br><br>Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)<br> pkts bytes target     prot opt in     out     source               destination  <br><span class="hljs-meta prompt_"> </span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">####  添加iptable 方法一：</span></span><br>[root@rocky9 ~]# iptables -t nat -A POSTROUTING -s 10.8.0.0/24 ! -d 10.8.0.0/24 -j MASQUERADE<br>[root@rocky9 ~]# iptables -vnL -t nat<br>Chain PREROUTING (policy ACCEPT 0 packets, 0 bytes)<br> pkts bytes target     prot opt in     out     source               destination         <br><br>Chain INPUT (policy ACCEPT 0 packets, 0 bytes)<br> pkts bytes target     prot opt in     out     source               destination         <br><br>Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)<br> pkts bytes target     prot opt in     out     source               destination         <br><br>Chain POSTROUTING (policy ACCEPT 0 packets, 0 bytes)<br> pkts bytes target     prot opt in     out     source               destination         <br>    0     0 MASQUERADE  all  --  *      *       10.8.0.0/24         !10.8.0.0/24  <br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">####  添加iptable 方法二：</span></span><br>[root@rocky9 ~]# iptables -t nat -A POSTROUTING -s 10.8.0.0/24 ! -d 10.8.0.0/24 -j SNAT --to 192.168.200.10<br>[root@rocky9 ~]# iptables -vnL -t nat<br>Chain PREROUTING (policy ACCEPT 0 packets, 0 bytes)<br> pkts bytes target     prot opt in     out     source               destination         <br><br>Chain INPUT (policy ACCEPT 0 packets, 0 bytes)<br> pkts bytes target     prot opt in     out     source               destination         <br><br>Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)<br> pkts bytes target     prot opt in     out     source               destination         <br><br>Chain POSTROUTING (policy ACCEPT 0 packets, 0 bytes)<br> pkts bytes target     prot opt in     out     source               destination         <br>    0     0 SNAT       all  --  *      *       10.8.0.0/24         !10.8.0.0/24          to:192.168.200.10<br></code></pre></td></tr></table></figure><h3 id="测试连接内网服务器"><a href="#测试连接内网服务器" class="headerlink" title="测试连接内网服务器"></a>测试连接内网服务器</h3><h5 id="ubuntu2204：192-168-200-20"><a href="#ubuntu2204：192-168-200-20" class="headerlink" title="ubuntu2204：192.168.200.20"></a>ubuntu2204：192.168.200.20</h5><p><img src="https://xcj-typora-img.oss-cn-hangzhou.aliyuncs.com/img/20240506093133.png" alt="20240506093133"></p><p><img src="https://xcj-typora-img.oss-cn-hangzhou.aliyuncs.com/img/20240506100128.png" alt="20240506100128"></p><h5 id="windows-server：192-168-200-30"><a href="#windows-server：192-168-200-30" class="headerlink" title="##  windows server：192.168.200.30"></a>##  windows server：192.168.200.30</h5><p><img src="https://xcj-typora-img.oss-cn-hangzhou.aliyuncs.com/img/20240506100556.png" alt="20240506100556"></p><p><img src="https://xcj-typora-img.oss-cn-hangzhou.aliyuncs.com/img/20240506100950.png" alt="20240506100950"></p><p><img src="https://xcj-typora-img.oss-cn-hangzhou.aliyuncs.com/img/20240506101243.png" alt="20240506101243"></p><p>源码包：</p><p><a href="https://github.com/OpenVPN/openvpn/releases/download/v2.6.10/openvpn-2.6.10.tar.gz">https://github.com/OpenVPN/openvpn/releases/download/v2.6.10/openvpn-2.6.10.tar.gz</a></p><p><a href="https://github.com/OpenVPN/easy-rsa/releases/download/v3.1.7/EasyRSA-3.1.7.tgz">https://github.com/OpenVPN/easy-rsa/releases/download/v3.1.7/EasyRSA-3.1.7.tgz</a></p>]]></content>
    
    
    <categories>
      
      <category>安全</category>
      
    </categories>
    
    
    <tags>
      
      <tag>OpenVPN</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Ubuntu2204初始化</title>
    <link href="/2024/04/18/Ubuntu%E5%88%9D%E5%A7%8B%E5%8C%96/"/>
    <url>/2024/04/18/Ubuntu%E5%88%9D%E5%A7%8B%E5%8C%96/</url>
    
    <content type="html"><![CDATA[<h3 id="配置允许root登录"><a href="#配置允许root登录" class="headerlink" title="配置允许root登录"></a>配置允许root登录</h3><p>Ubuntu安装后默认root不允许登录，需要使用普通用户登录后配置</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># sudo 切换到root</span></span><br>xcjyc@ubuntu2204:~$ sudo -i<br>[sudo] password for xcjyc: <br>root@ubuntu2204:~# <br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># 设置root密码</span></span><br>root@ubuntu2204:~# passwd root<br>New password: <br>Retype new password: <br>passwd: password updated successfully<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># 修改ssh配置，允许root ssh登录</span></span><br>root@ubuntu2204:~# vim /etc/ssh/sshd_config<br><span class="hljs-meta prompt_">#</span><span class="language-bash">Port 22                               <span class="hljs-comment">## 建议修改端口</span></span><br>PermitRootLogin yes<br>PasswordAuthentication yes<br><span class="hljs-meta prompt_">#</span><span class="language-bash">UseDNS no                             <span class="hljs-comment">## 设置为NO，可加速登录</span></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">GSSAPIAuthentication no               <span class="hljs-comment">## 设置为NO，可加速登录</span></span><br></code></pre></td></tr></table></figure><h3 id="更改软件安装源"><a href="#更改软件安装源" class="headerlink" title="更改软件安装源"></a>更改软件安装源</h3><p>Ubuntu 默认使用的软件源位于国外，如果要获得更快的下载速度，我们可以通过更改软件源来解决这个问题。打开<a href="https://developer.aliyun.com/mirror/ubuntu">https://developer.aliyun.com/mirror/ubuntu</a> ，根据ubuntu版本，复制相应的源配置。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs shell">root@ubuntu2204:~# cp /etc/apt/sources.list /etc/apt/sources.list.bak<br><br>root@ubuntu2204:~# vim /etc/apt/sources.list<br>deb https://mirrors.aliyun.com/ubuntu/ jammy main restricted universe multiverse<br>deb-src https://mirrors.aliyun.com/ubuntu/ jammy main restricted universe multiverse<br><br>deb https://mirrors.aliyun.com/ubuntu/ jammy-security main restricted universe multiverse<br>deb-src https://mirrors.aliyun.com/ubuntu/ jammy-security main restricted universe multiverse<br><br>deb https://mirrors.aliyun.com/ubuntu/ jammy-updates main restricted universe multiverse<br>deb-src https://mirrors.aliyun.com/ubuntu/ jammy-updates main restricted universe multiverse<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">deb https://mirrors.aliyun.com/ubuntu/ jammy-proposed main restricted universe multiverse</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">deb-src https://mirrors.aliyun.com/ubuntu/ jammy-proposed main restricted universe multiverse</span><br><br>deb https://mirrors.aliyun.com/ubuntu/ jammy-backports main restricted universe multiverse<br>deb-src https://mirrors.aliyun.com/ubuntu/ jammy-backports main restricted universe multiverse<br><br></code></pre></td></tr></table></figure><p>更新源列表,运行 “apt update”</p><p>&#x3D;&#x3D;安装软件前，更新源后再安装！&#x3D;&#x3D;</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs shell">root@ubuntu2204:~# apt update<br>Hit:1 https://mirrors.aliyun.com/ubuntu jammy InRelease<br>Get:2 https://mirrors.aliyun.com/ubuntu jammy-security InRelease [110 kB]<br>Get:3 https://mirrors.aliyun.com/ubuntu jammy-updates InRelease [119 kB]<br>Hit:4 https://mirrors.aliyun.com/ubuntu jammy-backports InRelease<br>Get:5 https://mirrors.aliyun.com/ubuntu jammy-updates/restricted Sources [65.0 kB]<br>Get:6 https://mirrors.aliyun.com/ubuntu jammy-updates/multiverse Sources [19.0 kB]<br>Ign:7 https://mirrors.aliyun.com/ubuntu jammy-updates/main amd64 Packages<br>Get:8 https://mirrors.aliyun.com/ubuntu jammy-updates/restricted amd64 Packages [1754 kB]<br>Get:9 https://mirrors.aliyun.com/ubuntu jammy-updates/restricted Translation-en [295 kB]<br>Ign:10 https://mirrors.aliyun.com/ubuntu jammy-updates/universe amd64 Packages<br>Get:11 https://mirrors.aliyun.com/ubuntu jammy-updates/multiverse amd64 Packages [42.7 kB]<br>Get:12 https://mirrors.aliyun.com/ubuntu jammy-updates/multiverse Translation-en [10.4 kB]<br>Get:7 https://mirrors.aliyun.com/ubuntu jammy-updates/main amd64 Packages [1562 kB]<br>Get:10 https://mirrors.aliyun.com/ubuntu jammy-updates/universe amd64 Packages [1075 kB]                                               <br>Fetched 5053 kB in 9s (561 kB/s)                                                                                                       <br>Reading package lists... Done<br>Building dependency tree... Done<br>Reading state information... Done<br>52 packages can be upgraded. Run &#x27;apt list --upgradable&#x27; to see them.<br></code></pre></td></tr></table></figure><h3 id="修改网卡名称为eth0"><a href="#修改网卡名称为eth0" class="headerlink" title="修改网卡名称为eth0"></a>修改网卡名称为eth0</h3><p>修改&#x2F;etc&#x2F;default&#x2F;grub文件，在GRUB_CMDLINE_LINUX增加“net.ifnames&#x3D;0”</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs shell">root@ubuntu2204:~# vim /etc/default/grub<br>GRUB_DEFAULT=0<br>GRUB_TIMEOUT_STYLE=hidden<br>GRUB_TIMEOUT=0<br>GRUB_DISTRIBUTOR=`lsb_release -i -s 2&gt; /dev/null || echo Debian`<br>GRUB_CMDLINE_LINUX_DEFAULT=&quot;&quot;<br>GRUB_CMDLINE_LINUX=&quot;net.ifnames=0&quot;<br><br>root@ubuntu2204:~# grub-mkconfig -o /boot/grub/grub.cfg <br>Sourcing file `/etc/default/grub&#x27;<br>Sourcing file `/etc/default/grub.d/init-select.cfg&#x27;<br>Generating grub configuration file ...<br>Found linux image: /boot/vmlinuz-5.15.0-102-generic<br>Found initrd image: /boot/initrd.img-5.15.0-102-generic<br>Warning: os-prober will not be executed to detect other bootable partitions.<br>Systems on them will not be added to the GRUB boot configuration.<br>Check GRUB_DISABLE_OS_PROBER documentation entry.<br>done<br><br>root@ubuntu2204:~# reboot<br><br>root@ubuntu2204:~# ip addr<br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000<br>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>    inet6 ::1/128 scope host <br>       valid_lft forever preferred_lft forever<br>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000<br>    link/ether 00:0c:29:fb:bc:2d brd ff:ff:ff:ff:ff:ff<br>    altname enp2s1<br>    altname ens33<br>    inet 10.0.0.131/24 metric 100 brd 10.0.0.255 scope global dynamic eth0<br>       valid_lft 1782sec preferred_lft 1782sec<br>    inet6 fe80::20c:29ff:fefb:bc2d/64 scope link <br>       valid_lft forever preferred_lft forever<br></code></pre></td></tr></table></figure><h3 id="配置IP地址"><a href="#配置IP地址" class="headerlink" title="配置IP地址"></a>配置IP地址</h3><p>网上配置文件为YAML格式，存放在&#x2F;etc&#x2F;netplan&#x2F;**.yaml文件中</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs shell">root@ubuntu2204:~# ls /etc/netplan/<br>00-installer-config.yaml<br><br>root@ubuntu2204:~# vim /etc/netplan/00-installer-config.yaml<br><span class="hljs-meta prompt_"># </span><span class="language-bash">This is the network config written by <span class="hljs-string">&#x27;subiquity&#x27;</span></span><br>network:<br>  ethernets:<br>    eth0:<br>      dhcp4: false<br>      addresses:<br>        - 10.0.0.7/24<br>      gateway4: 10.0.0.2<br>      nameservers:<br>        addresses:<br>          - 10.0.0.2<br>          - 223.5.5.5<br>  version: 2<br></code></pre></td></tr></table></figure><p>检查配置：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#  DNS检查</span></span><br>root@ubuntu2204:~# resolvectl status<br>Global<br>       Protocols: -LLMNR -mDNS -DNSOverTLS DNSSEC=no/unsupported<br>resolv.conf mode: stub<br><br>Link 2 (eth0)<br>    Current Scopes: DNS<br>         Protocols: +DefaultRoute +LLMNR -mDNS -DNSOverTLS DNSSEC=no/unsupported<br>Current DNS Server: 10.0.0.2<br>       DNS Servers: 10.0.0.2 223.5.5.5<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#  网关检查</span></span><br>root@ubuntu2204:~# route -n<br>Kernel IP routing table<br>Destination     Gateway         Genmask         Flags Metric Ref    Use Iface<br>0.0.0.0         10.0.0.2        0.0.0.0         UG    0      0        0 eth0<br>10.0.0.0        0.0.0.0         255.255.255.0   U     0      0        0 eth0<br><br></code></pre></td></tr></table></figure><p>若找不到ping命令，先安装net-toools,inetutils-ping工具包</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs shell">root@ubuntu2204:~# apt update <br><br>root@ubuntu2204:~# apt search net-tools<br>Sorting... Done<br>Full Text Search... Done<br>atm-tools/jammy 1:2.5.1-4build2 amd64<br>  Base programs for ATM in Linux, the net-tools for ATM<br><br>ddnet-tools/jammy 15.9.1-1 amd64<br>  Tools for DDNet<br><br>hobbit-plugins/jammy 20201127 all<br>  plugins for the Xymon network monitor<br><br>iproute2/jammy,now 5.15.0-1ubuntu2 amd64 [installed,automatic]<br>  networking and traffic control tools<br><br>net-tools/jammy,now 1.60+git20181103.0eebece-1ubuntu5 amd64 [installed]<br>  NET-3 networking toolkit<br><br>root@ubuntu2204:~# apt search inetutils-ping<br>Sorting... Done<br>Full Text Search... Done<br>inetutils-ping/jammy-security,jammy-updates,now 2:2.2-2ubuntu0.1 amd64 [installed]<br>  ICMP echo tool<br><br><br><br>root@ubuntu2204:~# ping www.baidu.com<br>PING www.a.shifen.com (183.2.172.42): 56 data bytes<br>64 bytes from 183.2.172.42: icmp_seq=0 ttl=128 time=57.860 ms<br></code></pre></td></tr></table></figure><h3 id="修改时区"><a href="#修改时区" class="headerlink" title="修改时区"></a>修改时区</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">root@ubuntu2204:~# timedatectl set-timezone Asia/Shanghai<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Linux基础</category>
      
    </categories>
    
    
    <tags>
      
      <tag>init</tag>
      
      <tag>Ubuntu</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Rocky9初始化</title>
    <link href="/2024/04/18/Rocky9%E5%88%9D%E5%A7%8B%E5%8C%96/"/>
    <url>/2024/04/18/Rocky9%E5%88%9D%E5%A7%8B%E5%8C%96/</url>
    
    <content type="html"><![CDATA[<h3 id="更改网卡IP"><a href="#更改网卡IP" class="headerlink" title="更改网卡IP"></a>更改网卡IP</h3><p>先使用查询网卡名字，以下命令均以root用户执行，所以无需加sudo(管理员运行)</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@rocky9 ~]# ip addr <br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000<br>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>    inet6 ::1/128 scope host <br>       valid_lft forever preferred_lft forever<br>2: ens160: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP group default qlen 1000<br>    link/ether 00:0c:29:bb:9e:00 brd ff:ff:ff:ff:ff:ff<br>    altname enp3s0<br>    inet 10.0.0.9/24 brd 10.0.0.255 scope global noprefixroute ens160<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::20c:29ff:febb:9e00/64 scope link noprefixroute <br>       valid_lft forever preferred_lft forever<br></code></pre></td></tr></table></figure><p>然后编辑网卡配置文件: rocky9版本使用NetworkManager管理网络，配置文件位置在：&#x2F;etc&#x2F;NetworkManager&#x2F;system-connections&#x2F;</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@rocky9 ~]# vi /etc/NetworkManager/system-connections/ens160.nmconnection <br>[connection]<br>id=ens160<br>uuid=04298268-66be-3b77-92da-5a525b463a2f<br>type=ethernet<br>autoconnect-priority=-999<br>interface-name=ens160<br>timestamp=1713346642<br><br>[ethernet]<br><br>[ipv4]<br>method=manual<br>address1=10.0.0.9/24,10.0.0.2<br>dns=10.0.0.2;223.5.5.5;<br><br>[ipv6]<br>addr-gen-mode=eui64<br>method=auto<br><br>[proxy]<br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># 使配置生效：</span></span><br>[root@rocky9 ~]# nmcli connection reload <br><br>[root@rocky9 ~]# nmcli connection down ens160<br><br>[root@rocky9 ~]# nmcli connection up ens160<br></code></pre></td></tr></table></figure><p>&#x3D;&#x3D;注意：DNS地址后面的”;”&#x3D;&#x3D;</p><p>使用nmcli命令设置IP地址</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># 查看设备信息</span></span><br>[root@rocky9 ~]# nmcli device <br>DEVICE  TYPE      STATE                   CONNECTION <br>eth0    ethernet  connected               eth0       <br>lo      loopback  connected (externally)  lo         <br>[root@rocky9 ~]# nmcli conn show <br>NAME  UUID                                  TYPE      DEVICE <br>eth0  04298268-66be-3b77-92da-5a525b463a2f  ethernet  eth0   <br>lo    99ab0b1b-9e30-4808-8fd1-e63143b7a539  loopback  lo     <br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># 配置 IPv4 地址</span></span><br>[root@rocky9 ~]# nmcli connection modify eth0 ipv4.method manual <br>[root@rocky9 ~]# nmcli connection modify eth0 ipv4.addresses 10.0.0.9/24<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># 配置 IPv4网关</span></span><br>[root@rocky9 ~]# nmcli connection modify eth0 ipv4.gateway 10.0.0.2<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># 配置 IPv4 DNS，多个 DNS IP 之间使用双引号 + 空格</span></span><br>[root@rocky9 ~]# nmcli connection modify eth0 ipv4.dns &quot;223.5.5.5 180.76.76.76&quot;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># 设置 DNS 基础搜索，多个域名之间使用双引号 + 空格</span></span><br>[root@rocky9 ~]# nmcli connection modify eth0 ipv4.dns &quot;223.5.5.5 180.76.76.76&quot;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># 查看配置结果</span></span><br>[root@rocky9 ~]# cat /etc/NetworkManager/system-connections/eth0.nmconnection <br>[connection]<br>id=eth0<br>uuid=04298268-66be-3b77-92da-5a525b463a2f<br>type=ethernet<br>autoconnect-priority=-999<br>interface-name=eth0<br>timestamp=1714355424<br><br>[ethernet]<br><br>[ipv4]<br>address1=10.0.0.9/24,10.0.0.2<br>dns=223.5.5.5;180.76.76.76;<br>dns-search=rocky9.com;rocky9.cn;<br>method=manual<br><br>[ipv6]<br>addr-gen-mode=eui64<br>method=auto<br><br>[proxy]<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># 重新加载网络配置</span></span><br>[root@rocky9 ~]# nmcli connection reload <br>[root@rocky9 ~]# nmcli connection up eth0 <br>Connection successfully activated (D-Bus active path: /org/freedesktop/NetworkManager/ActiveConnection/3)<br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">nmcli con mod &#x27;eth0&#x27; ipv4.method manual ipv4.addresses 172.25.250.100/24 ipv4.gateway 172.25.250.254 ipv4.dns 172.25.250.254 autoconnect yes<br></code></pre></td></tr></table></figure><p>检查配置：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># ip地址</span></span><br>[root@rocky9 ~]# ip addr<br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000<br>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>    inet6 ::1/128 scope host <br>       valid_lft forever preferred_lft forever<br>2: ens160: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP group default qlen 1000<br>    link/ether 00:0c:29:bb:9e:00 brd ff:ff:ff:ff:ff:ff<br>    altname enp3s0<br>    inet 10.0.0.9/24 brd 10.0.0.255 scope global noprefixroute ens160<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::20c:29ff:febb:9e00/64 scope link noprefixroute <br>       valid_lft forever preferred_lft forever<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># 网关</span></span><br>[root@rocky9 ~]# route -n<br>Kernel IP routing table<br>Destination     Gateway         Genmask         Flags Metric Ref    Use Iface<br>0.0.0.0         10.0.0.2        0.0.0.0         UG    100    0        0 ens160<br>10.0.0.0        0.0.0.0         255.255.255.0   U     100    0        0 ens160<br><br>[root@rocky9 ~]# ip route <br>default via 10.0.0.2 dev ens160 proto static metric 100 <br>10.0.0.0/24 dev ens160 proto kernel scope link src 10.0.0.9 metric 100 <br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># dns</span></span><br>[root@rocky9 ~]# cat /etc/resolv.conf <br><span class="hljs-meta prompt_"># </span><span class="language-bash">Generated by NetworkManager</span><br>nameserver 10.0.0.2<br>nameserver 223.5.5.5<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># 网络联通性</span></span><br>[root@rocky9 ~]# ping 10.0.0.2<br>[root@rocky9 ~]# ping www.baidu.com<br></code></pre></td></tr></table></figure><h3 id="创建基本的目录"><a href="#创建基本的目录" class="headerlink" title="创建基本的目录"></a>创建基本的目录</h3><ul><li><code>/backup_scripts</code>脚本存放路径</li><li><code>/backup_conf</code>系统配置存放路径</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@rocky9 ~]# mkdir /backup_scripts<br>[root@rocky9 ~]# mkdir /backup_conf<br></code></pre></td></tr></table></figure><h3 id="关闭selinux"><a href="#关闭selinux" class="headerlink" title="关闭selinux"></a>关闭selinux</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@rocky9 ~]# setenforce 0<br><br>[root@rocky9 ~]# sed -i &#x27;s/SELINUX=enforcing/SELINUX=disabled/g&#x27;  /etc/selinux/config<br>[root@rocky9 ~]# vi /etc/selinux/config <br></code></pre></td></tr></table></figure><p>验证：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@rocky9 ~]# getenforce <br>Disabled<br><br>[root@rocky9 ~]# sestatus <br>SELinux status:                 disabled<br></code></pre></td></tr></table></figure><h3 id="关闭防火墙"><a href="#关闭防火墙" class="headerlink" title="关闭防火墙"></a>关闭防火墙</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@rocky9 ~]#  systemctl stop firewalld &amp;&amp; systemctl disable firewalld<br></code></pre></td></tr></table></figure><p>验证：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@rocky9 ~]# systemctl status firewalld.service <br></code></pre></td></tr></table></figure><h3 id="设置-SSH-密码登录，登录加速"><a href="#设置-SSH-密码登录，登录加速" class="headerlink" title="设置 SSH 密码登录，登录加速"></a>设置 SSH 密码登录，登录加速</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@rocky9 ~]# vi /etc/ssh/sshd_config<br><span class="hljs-meta prompt_">#</span><span class="language-bash">Port 22                               <span class="hljs-comment">## 建议修改端口</span></span><br>PermitRootLogin yes<br>PasswordAuthentication yes<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">UseDNS no                             <span class="hljs-comment">## 设置为NO，可加速登录</span></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">GSSAPIAuthentication no               <span class="hljs-comment">## 设置为NO，可加速登录</span></span><br><br>[root@rocky9 ~]# systemctl restart sshd.service <br></code></pre></td></tr></table></figure><h3 id="设置-SSH-key-互信"><a href="#设置-SSH-key-互信" class="headerlink" title="设置 SSH key 互信"></a>设置 SSH key 互信</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@rocky9 ~]# ssh-keygen<br><br>[root@rocky9 ~]# ssh-copy-id  ip地址<br></code></pre></td></tr></table></figure><p><strong>PubkeyAuthentication</strong> 设置为 “yes” 以启用密钥认证，同时将 <strong>PasswordAuthentication</strong> 设置为 “no” 以禁用密码认证</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@rocky9 ~]# vi /etc/ssh/sshd_config<br>PubkeyAuthentication yes<br>PasswordAuthentication no<br><br>[root@rocky9 ~]# systemctl restart sshd.service <br></code></pre></td></tr></table></figure><h3 id="配置yum源"><a href="#配置yum源" class="headerlink" title="配置yum源"></a>配置yum源</h3><p>备份国外源，并修改为aliyun源，执行如下命令</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">sed -e &#x27;s|^mirrorlist=|#mirrorlist=|g&#x27; \<br>    -e &#x27;s|^#baseurl=http://dl.rockylinux.org/$contentdir|baseurl=https://mirrors.aliyun.com/rockylinux|g&#x27; \<br>    -i.bak \<br>    /etc/yum.repos.d/rocky*.repo<br></code></pre></td></tr></table></figure><p>安装 epel-release-latest-9</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#  备份旧的EPEL</span></span><br>mv /etc/yum.repos.d/epel.repo /etc/yum.repos.d/epel.repo.backup<br>mv /etc/yum.repos.d/epel-testing.repo /etc/yum.repos.d/epel-testing.repo.backup<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#  安装EPEL9 的aliyun镜像源</span></span><br>yum install -y https://mirrors.aliyun.com/epel/epel-release-latest-9.noarch.rpm<br><br>sed -i &#x27;s|^#baseurl=https://download.example/pub|baseurl=https://mirrors.aliyun.com|&#x27; /etc/yum.repos.d/epel.repo /etc/yum.repos.d/epel-testing.repo<br>sed -i &#x27;s|^metalink|#metalink|&#x27; /etc/yum.repos.d/epel.repo /etc/yum.repos.d/epel-testing.repo<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#  makecache</span></span><br>dnf makecache<br></code></pre></td></tr></table></figure><p>检查软件源仓库信息 yum repoinfo</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@rocky9 ~]# yum repoinfo<br>Ignoring repositories: epel-cisco-openh264<br>Last metadata expiration check: 0:15:40 ago on Fri 19 Apr 2024 11:25:39 AM CST.<br>Repo-id            : appstream<br>Repo-name          : Rocky Linux 9 - AppStream<br>Repo-revision      : 1712887500<br>Repo-updated       : Fri 12 Apr 2024 10:05:00 AM CST<br>Repo-pkgs          : 5,659<br>Repo-available-pkgs: 5,524<br>Repo-size          : 7.6 G<br>Repo-baseurl       : https://mirrors.aliyun.com/rockylinux/9/AppStream/x86_64/os/<br>Repo-expire        : 21,600 second(s) (last: Fri 19 Apr 2024 11:25:38 AM CST)<br>Repo-filename      : /etc/yum.repos.d/rocky.repo<br><br>Repo-id            : baseos<br>Repo-name          : Rocky Linux 9 - BaseOS<br>Repo-revision      : 1712887533<br>Repo-updated       : Fri 12 Apr 2024 10:05:33 AM CST<br>Repo-pkgs          : 1,157<br>Repo-available-pkgs: 1,157<br>Repo-size          : 1.2 G<br>Repo-baseurl       : https://mirrors.aliyun.com/rockylinux/9/BaseOS/x86_64/os/<br>Repo-expire        : 21,600 second(s) (last: Fri 19 Apr 2024 11:25:37 AM CST)<br>Repo-filename      : /etc/yum.repos.d/rocky.repo<br><br>Repo-id            : epel<br>Repo-name          : Extra Packages for Enterprise Linux 9 - x86_64<br>Repo-revision      : 1713321643<br>Repo-updated       : Wed 17 Apr 2024 10:41:40 AM CST<br>Repo-pkgs          : 20,862<br>Repo-available-pkgs: 20,862<br>Repo-size          : 18 G<br>Repo-baseurl       : https://mirrors.aliyun.com/epel/9/Everything/x86_64/<br>Repo-expire        : 172,800 second(s) (last: Wed 17 Apr 2024 04:50:05 PM CST)<br>Repo-filename      : /etc/yum.repos.d/epel.repo<br><br>Repo-id            : extras<br>Repo-name          : Rocky Linux 9 - Extras<br>Repo-revision      : 1708531863<br>Repo-updated       : Thu 22 Feb 2024 12:11:03 AM CST<br>Repo-pkgs          : 46<br>Repo-available-pkgs: 46<br>Repo-size          : 3.0 M<br>Repo-baseurl       : https://mirrors.aliyun.com/rockylinux/9/extras/x86_64/os/<br>Repo-expire        : 21,600 second(s) (last: Fri 19 Apr 2024 11:25:39 AM CST)<br>Repo-filename      : /etc/yum.repos.d/rocky-extras.repo<br>Total packages: 27,724<br></code></pre></td></tr></table></figure><h3 id="修改时区"><a href="#修改时区" class="headerlink" title="修改时区"></a>修改时区</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@rocky9 ~]# timedatectl set-timezone Asia/Shanghai<br></code></pre></td></tr></table></figure><h3 id="内核参数优化"><a href="#内核参数优化" class="headerlink" title="内核参数优化"></a>内核参数优化</h3><p>内核参数系统优化 路径在&#x2F;etc&#x2F;sysctl.conf，根据需要修改</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">启用TCP时间戳，可能有助于性能</span><br>net.ipv4.tcp_timestamps = 1<br><span class="hljs-meta prompt_"> </span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">启用TCP TIME-WAIT回收和重用</span><br>net.ipv4.tcp_tw_recycle = 1<br>net.ipv4.tcp_tw_reuse = 1<br><span class="hljs-meta prompt_"> </span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">启用TCP窗口缩放和SACK</span><br>net.ipv4.tcp_window_scaling = 1<br>net.ipv4.tcp_sack = 1<br><span class="hljs-meta prompt_"> </span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">启用TCP SYN Cookies以防止SYN洪水攻击</span><br>net.ipv4.tcp_syncookies = 1<br><span class="hljs-meta prompt_"> </span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">重试次数配置</span><br>net.ipv4.tcp_retries2 = 5<br>net.ipv4.tcp_syn_retries = 2<br>net.ipv4.tcp_synack_retries = 2<br><span class="hljs-meta prompt_"> </span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">设置TCP FIN超时时间（秒）</span><br>net.ipv4.tcp_fin_timeout = 15<br><span class="hljs-meta prompt_"> </span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">TCP保活设置（秒）</span><br>net.ipv4.tcp_keepalive_time = 120<br>net.ipv4.tcp_keepalive_intvl = 5<br>net.ipv4.tcp_keepalive_probes = 2<br><span class="hljs-meta prompt_"> </span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">设置TCP最大SYN队列长度和TIME-WAIT套接字数量</span><br>net.ipv4.tcp_max_syn_backlog = 65535<br>net.ipv4.tcp_max_tw_buckets = 655350<br><span class="hljs-meta prompt_"> </span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">设置TCP内存参数</span><br>net.ipv4.tcp_mem = 3097431 4129911 6194862<br>net.ipv4.tcp_rmem = 4096 87380 6291456<br>net.ipv4.tcp_wmem = 4096 65536 4194304<br><span class="hljs-meta prompt_"> </span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">限制TCP输出缓冲区的最大大小（字节）</span><br>net.ipv4.tcp_limit_output_bytes = 262144<br><span class="hljs-meta prompt_"> </span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">限制本地端口范围</span><br>net.ipv4.ip_local_port_range = 1024 65535<br><span class="hljs-meta prompt_"> </span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">忽略广播ICMP和虚假错误响应</span><br>net.ipv4.icmp_echo_ignore_broadcasts = 1<br>net.ipv4.icmp_ignore_bogus_error_responses = 1<br><span class="hljs-meta prompt_"> </span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">记录有关不正常网络包的信息</span><br>net.ipv4.conf.all.log_martians = 1<br>net.ipv4.conf.default.log_martians = 1<br><span class="hljs-meta prompt_"> </span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">禁用TCP的统计信息保存</span><br>net.ipv4.tcp_no_metrics_save = 1<br><span class="hljs-meta prompt_"> </span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">设置TCP最大孤立时间</span><br>net.ipv4.tcp_max_orphans = 262144<br><span class="hljs-meta prompt_"> </span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">禁用IPv6</span><br>net.ipv6.conf.all.disable_ipv6 = 1<br><span class="hljs-meta prompt_"> </span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">设置系统的最大连接数和网络设备队列大小</span><br>net.core.somaxconn = 65535<br>net.core.netdev_max_backlog = 262144<br><span class="hljs-meta prompt_"> </span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">设置内核消息参数</span><br>kernel.msgmni=16384<br>kernel.msgmax=65536<br>kernel.msgmnb=4203520<br><span class="hljs-meta prompt_"> </span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">禁用交换分区</span><br>vm.swappiness = 0<br><span class="hljs-meta prompt_"> </span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">内存过度分配检查</span><br>vm.overcommit_memory = 1<br><span class="hljs-meta prompt_"> </span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">设置系统文件句柄限制</span><br>fs.file-max = 1020000<br></code></pre></td></tr></table></figure><p>修改完成后使之生效</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@rocky9 ~]# sysctl -p<br></code></pre></td></tr></table></figure><h3 id="配置资源限制"><a href="#配置资源限制" class="headerlink" title="配置资源限制"></a>配置资源限制</h3><p>修改资源配置限制　路径在&#x2F;etc&#x2F;security&#x2F;limits.conf</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@rocky9 ~]# cat &gt;&gt; /etc/security/limits.conf<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">以下命令使用文本重定向将配置追加到 /etc/security/limits.conf 文件中</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">设置所有用户的软限制和硬限制的最大文件描述符数为 1000000</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">设置所有用户的软限制和硬限制的内存锁定（memlock）大小为无限（unlimited）</span><br><br>*        soft        nofile        1000000<br>*        hard        nofile        1000000<br>*        soft        memlock       unlimited<br>*        hard        memlock       unlimited<br></code></pre></td></tr></table></figure><p>&#x2F;etc&#x2F;security&#x2F;limits.d&#x2F;20-nproc.conf 子配置文件　如果没有就创建一个</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@rocky9 limits.d]# vim /etc/security/limits.d/20-nproc.conf<br><br>*    -     nproc   65535<br>root soft  nproc  unlimited<br>root hard  nproc  unlimited<br></code></pre></td></tr></table></figure><p>可用sed更改数值 ：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@rocky9 ~]#  sed -i &quot;s/4096/65535/g&quot; /etc/security/limits.d/20-nproc.conf<br></code></pre></td></tr></table></figure><h3 id="禁用核心转储，以防应用程序崩溃"><a href="#禁用核心转储，以防应用程序崩溃" class="headerlink" title="禁用核心转储，以防应用程序崩溃"></a>禁用核心转储，以防应用程序崩溃</h3><p>配置文件路径&#x2F;etc&#x2F;security&#x2F;limits.conf</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">cat &lt;&lt; EOF &gt;&gt;/etc/security/limits.conf<br>* hard core 0<br>EOF<br>sysctl -w fs.suid_dumpable=0<br></code></pre></td></tr></table></figure><h3 id="安装常用软件"><a href="#安装常用软件" class="headerlink" title="安装常用软件"></a>安装常用软件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">yum -y install autofs  vim vim-enhanced tcpdump autofs chrony lrzsz tree telnet ftp lftp  bash-completion net-tools postfix wget bzip2 zip unzip xz lsof mlocate man-pages rsync gcc  autoconf gcc-c++  iotop iftop htop nfs-utils openssl-devel pcre-devel systemd-devel tmux dos2unix nmap nc psmisc sysstat  httpd-tools <br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Linux基础</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Linux</tag>
      
      <tag>init</tag>
      
      <tag>RockyLinux</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Nginx配置文件nginx.conf</title>
    <link href="/2024/04/18/Nginx%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6nginx-conf/"/>
    <url>/2024/04/18/Nginx%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6nginx-conf/</url>
    
    <content type="html"><![CDATA[<h3 id="nginx配置文件解析"><a href="#nginx配置文件解析" class="headerlink" title="nginx配置文件解析"></a>nginx配置文件解析</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><code class="hljs shell">user nginx; # Nginx 进程的运行用户<br>worker_processes auto;  # 工作进程数，默认为 CPU 核数<br>pid /run/nginx.pid;  # nginx 进程 ID 文件所在位置<br> <br>events &#123;<br>worker_connections 768;  # 每个工作进程能处理的最大连接数<br><span class="hljs-meta prompt_"># </span><span class="language-bash">multi_accept on;  <span class="hljs-comment"># 支持同时接受多个连接</span></span><br>&#125;<br> <br>http &#123;<br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#</span></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">Basic Settings</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#</span></span><br> <br>sendfile on;  # 开启 sendfile，提高文件传输速度<br>tcp_nopush on;  # 开启 tcp_nopush，优化网络性能<br>tcp_nodelay on;  # 开启 tcp_nodelay，优化网络性能<br>keepalive_timeout 65;  # 连接超时时间<br>types_hash_max_size 2048;  # MIME 类型哈希表大小限制<br><span class="hljs-meta prompt_"># </span><span class="language-bash">server_tokens off;  <span class="hljs-comment"># 隐藏 nginx 版本信息</span></span><br>server &#123;<br>        listen 80; # 监听的端口<br>        server_name example.com; # 域名或 IP 地址<br>        root /usr/share/nginx/html; # 网站根目录<br>        index index.php index.html index.htm; # 默认首页<br> <br>        location / &#123;<br>            try_files $uri $uri/ /index.php$is_args$args; # 检查请求的文件是否存在，否则重定向到 index.php<br>        &#125;<br> <br>        location ~ \.php$ &#123;<br>            try_files $uri =404;<br>            fastcgi_pass unix:/run/php-fpm/php-fpm.sock; # 使用 Unix 域套接字连接到 PHP-FPM<br>            fastcgi_index index.php;<br>            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;<br>            include fastcgi_params;<br>        &#125;<br>location /nginx_status &#123;<br>    # 开启 nginx 状态页面<br>    stub_status on;<br>    # 允许本地 IP 访问 nginx 的状态页面<br>   allow 127.0.0.1;<br>#禁止其他 IP 访问 nginx 的状态页面<br>    deny all;<br>&#125;<br> <br>        error_page 404 /404.html; # 自定义 404 页面<br>        location = /404.html &#123;<br>            internal;<br>        &#125;<br> <br>        error_page 500 502 503 504 /50x.html; # 自定义 50x 错误页面<br>        location = /50x.html &#123;<br>            internal;<br>        &#125;<br>    &#125;<br><span class="hljs-meta prompt_"># </span><span class="language-bash">server_names_hash_bucket_size 64;  <span class="hljs-comment"># server_name 哈希表大小限制</span></span><br> <br>include /etc/nginx/mime.types;  # 包含 MIME 类型定义文件<br>default_type application/octet-stream;  # 默认 MIME 类型<br><span class="hljs-meta prompt_"> </span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#</span></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">SSL Settings</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#</span></span><br><span class="hljs-meta prompt_"> </span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">ssl_protocols TLSv1 TLSv1.1 TLSv1.2; <span class="hljs-comment"># 包含支持的 SSL/TLS 协议版本</span></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">ssl_prefer_server_ciphers on;  <span class="hljs-comment"># 开启优先使用服务端定义的密码套件</span></span><br><span class="hljs-meta prompt_"> </span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#</span></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">Logging Settings</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#</span></span><br> <br>access_log /var/log/nginx/access.log;  # 访问日志所在位置<br>error_log /var/log/nginx/error.log;  # 错误日志所在位置<br><span class="hljs-meta prompt_"> </span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#</span></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">Gzip Settings</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#</span></span><br> <br>gzip on;  # 开启 gzip 压缩<br>gzip_disable &quot;msie6&quot;;  # 禁止对 MSIE6 进行 gzip 压缩<br>gzip_vary on;  # 根据请求头中的 Vary 字段启用压缩<br>gzip_proxied any;  # 启用代理服务器压缩传输<br>gzip_comp_level 6;  # 压缩级别<br>gzip_buffers 16 8k;  # 压缩缓存大小<br>gzip_http_version 1.1;  # 启用压缩的 HTTP 版本<br><span class="hljs-meta prompt_"> </span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#</span></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">Virtual Host Configs</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#</span></span><br> <br>include /etc/nginx/conf.d/*.conf;  # 包含虚拟主机配置文件<br>include /etc/nginx/sites-enabled/*;  # 包含站点配置文件<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Nginx</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Nginx</tag>
      
      <tag>.conf</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>PostgreSQL日志管理</title>
    <link href="/2024/01/16/PostgreSQL%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86/"/>
    <url>/2024/01/16/PostgreSQL%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86/</url>
    
    <content type="html"><![CDATA[<h3 id="PostgreSQL日志分类："><a href="#PostgreSQL日志分类：" class="headerlink" title="PostgreSQL日志分类："></a>PostgreSQL日志分类：</h3><ul><li>运行日志：$PGDATA&#x2F;log 默认未开启，需在配置文件中关掉注释开启</li><li>在线重做日志：$PGDATA&#x2F;pg_wal </li><li>事务提交日志：$PGDATA&#x2F;pg_xact</li><li>服务器日志：启动服务时指定日志文件生成的日志</li></ul><h3 id="运行日志"><a href="#运行日志" class="headerlink" title="运行日志"></a>运行日志</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">运行日志默认未开启，修改配置文开启日志</span><br>[root@Rocky8-2 ~]# vim /pgsql/data/postgresql.conf <br>logging_collector = on                  # Enable capturing of stderr, jsonlog,<br>                                        # and csvlog into log files. Required<br>                                        # to be on for csvlogs and jsonlogs.<br>                                        # (change requires restart)<br>[root@Rocky8-2 ~]# systemctl restart postgresql.service <br>[root@Rocky8-2 ~]# ll $PGDATA/log<br>total 4<br>-rw------- 1 postgres postgres 919 Jan 16 14:24 postgresql-2024-01-16_141938.log<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">主要记录数据库的运行状况和监听端口</span><br>[root@Rocky8-2 ~]# tail $PGDATA/log/postgresql-2024-01-16_141938.log <br>2024-01-16 14:19:38.032 CST [2980] LOG:  starting PostgreSQL 15.3 on x86_64-pc-linux-gnu, compiled by gcc (GCC) 8.5.0 20210514 (Red Hat 8.5.0-18), 64-bit<br>2024-01-16 14:19:38.035 CST [2980] LOG:  listening on IPv6 address &quot;::1&quot;, port 5432<br>2024-01-16 14:19:38.035 CST [2980] LOG:  listening on IPv4 address &quot;127.0.0.1&quot;, port 5432<br>2024-01-16 14:19:38.042 CST [2980] LOG:  listening on Unix socket &quot;/tmp/.s.PGSQL.5432&quot;<br>2024-01-16 14:19:38.061 CST [2984] LOG:  database system was shut down at 2024-01-16 14:19:37 CST<br>2024-01-16 14:19:38.078 CST [2980] LOG:  database system is ready to accept connections<br>2024-01-16 14:24:38.073 CST [2982] LOG:  checkpoint starting: time<br>2024-01-16 14:24:38.092 CST [2982] LOG:  checkpoint complete: wrote 3 buffers (0.0%); 0 WAL file(s) added, 0 removed, 0 recycled; write=0.003 s, sync=0.004 s, total=0.020 s; sync files=2, longest=0.003 s, average=0.002 s; distance=0 kB, estimate=0 kB<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">开启系统日志后，多了一个logger进程</span><br>[root@Rocky8-2 ~]# ps aux |grep postgres<br>postgres    2980  1.0  0.8 175808 17760 ?        Ss   14:19   0:00 /apps/pgsql/bin/postgres -D /pgsql/data<br>postgres    2981  0.0  0.1  27684  2856 ?        Ss   14:19   0:00 postgres: logger <br>postgres    2982  0.0  0.1 175808  2744 ?        Ss   14:19   0:00 postgres: checkpointer <br>postgres    2983  0.0  0.2 175948  4248 ?        Ss   14:19   0:00 postgres: background writer <br>postgres    2985  0.0  0.4 175808  8116 ?        Ss   14:19   0:00 postgres: walwriter <br>postgres    2986  0.0  0.2 177396  5244 ?        Ss   14:19   0:00 postgres: autovacuum launcher <br>postgres    2987  0.0  0.2 177376  5104 ?        Ss   14:19   0:00 postgres: logical replication launcher <br>root        2991  0.0  0.0  12144  1200 pts/5    S+   14:19   0:00 grep --color=auto postgres<br></code></pre></td></tr></table></figure><h3 id="在线WAL日志"><a href="#在线WAL日志" class="headerlink" title="在线WAL日志"></a>在线WAL日志</h3><p>WAL日志是为了保证数据库崩溃后的数据安全，如果系统崩溃，可以“重放”从最后一次检查以来的日志项来恢复数据库的一致性。</p><p>WAL日志文件存放在$PGDATA&#x2F;pg_wal下</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@Rocky8-2 ~]# ll $PGDATA/pg_wal<br>total 16384<br>-rw------- 1 postgres postgres 16777216 Jan 16 14:24 000000010000000000000001<br>drwx------ 2 postgres postgres        6 Aug  7 14:06 archive_status<br></code></pre></td></tr></table></figure><p>WAL日志相关配置</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">日志文件总大小（默认值）</span><br>[root@Rocky8-2 ~]# vim /pgsql/data/postgresql.conf <br>max_wal_size = 1GB<br>min_wal_size = 80MB<br></code></pre></td></tr></table></figure><p>LSN:Log Sequence Number 用于记录WAL文件当前的位置，是WAL日志的唯一的、全局的标识。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">查看当前LSN号：</span><br>postgres=# select pg_current_wal_lsn();<br> pg_current_wal_lsn <br>--------------------<br> 0/18D6FD8<br>(1 row)<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">查看光前LSN对应的WAL日志文件</span><br>postgres=# select pg_walfile_name(pg_current_wal_lsn());<br>     pg_walfile_name      <br>--------------------------<br> 000000010000000000000001<br>(1 row)<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">查看当前事务ID</span><br>postgres=# select txid_current();<br> txid_current <br>--------------<br>          749<br>(1 row)<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">查看当前WAL日志偏移量</span><br>postgres=# select pg_walfile_NAME_OFFSET(pg_current_wal_lsn());<br>       pg_walfile_name_offset       <br>------------------------------------<br> (000000010000000000000001,9269536)<br>(1 row)<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">切换wal日志（默认文件达到16M时会自动切换wal日志）</span><br>postgres=# select pg_switch_wal();<br> pg_switch_wal <br>---------------<br> 0/18D7138<br>(1 row)<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">按时间顺序显示wal文件</span><br>postgres=# select * from pg_ls_waldir() order by modification asc;<br>           name           |   size   |      modification      <br>--------------------------+----------+------------------------<br> 000000010000000000000003 | 16777216 | 2024-01-22 11:39:38+08<br> 000000010000000000000002 | 16777216 | 2024-01-22 11:41:10+08<br>(2 rows)<br></code></pre></td></tr></table></figure><p>使用命令pg_waldump查看wal日志内容，执行结果中 tx: 后面的数字即事务id,同一个事务的id是相同的</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@Rocky8-2 ~]# pg_waldump /pgsql/data/pg_wal/000000010000000000000002<br>rmgr: Standby     len (rec/tot):     50/    50, tx:          0, lsn: 0/02000028, prev 0/018D7120, desc: RUNNING_XACTS nextXid 750 latestCompletedXid 749 oldestRunningXid 750<br>rmgr: Standby     len (rec/tot):     50/    50, tx:          0, lsn: 0/02000060, prev 0/02000028, desc: RUNNING_XACTS nextXid 750 latestCompletedXid 749 oldestRunningXid 750<br>rmgr: XLOG        len (rec/tot):    114/   114, tx:          0, lsn: 0/02000098, prev 0/02000060, desc: CHECKPOINT_ONLINE redo 0/2000060; tli 1; prev tli 1; fpw true; xid 0:750; oid 16426; multi 1; offset 0; oldest xid 717 in DB 1; oldest multi 1 in DB 1; oldest/newest commit timestamp xid: 0/0; oldest running xid 750; online<br>rmgr: Standby     len (rec/tot):     50/    50, tx:          0, lsn: 0/02000110, prev 0/02000098, desc: RUNNING_XACTS nextXid 750 latestCompletedXid 749 oldestRunningXid 750<br></code></pre></td></tr></table></figure><p>创建恢复点（相当于快照，可用于还原）</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">postgres=# select pg_create_restore_point(&#x27;test-restore-point&#x27;);<br> pg_create_restore_point <br>-------------------------<br> 0/20001B0<br>(1 row)<br></code></pre></td></tr></table></figure><h3 id="归档wal日志"><a href="#归档wal日志" class="headerlink" title="归档wal日志"></a>归档wal日志</h3><p>归档日志记录的是checkpoint前的WAL日志，即数据的历史日志，把pg_wal里面的在线日志备份出来，相当于mysql的二进制日志。为了保证数据高可用性，需要开启归档，当系统故障后可以通过归档的日志文件恢复数据。</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"># 配置wal归档<br><br># 开启日志级别，建议使用默认<span class="hljs-keyword">replica</span>级别（<span class="hljs-number">10</span>版本以上）<br>wal_level = <span class="hljs-keyword">replica</span>                     # minimal, <span class="hljs-keyword">replica</span>, <span class="hljs-keyword">or</span> logical  日志建议使用默认<span class="hljs-keyword">replica</span>级别（<span class="hljs-number">10</span>版本以上）<br>                                        # (change requires <span class="hljs-keyword">restart</span>)<br># 开启归档，默认值为<span class="hljs-keyword">off</span>                                        <br>archive_mode = <span class="hljs-keyword">on</span>               # enables archiving; <span class="hljs-keyword">off</span>, <span class="hljs-keyword">on</span>, <span class="hljs-keyword">or</span> <span class="hljs-keyword">always</span><br>                                # (change requires <span class="hljs-keyword">restart</span>)<br>                                <br># 配置archive_command,可以是一个命令，此命令把日志文档拷贝到其它地方<br>archive_command = <span class="hljs-string">&#x27;&#x27;</span><br># archive_command = <span class="hljs-string">&#x27;&#x27;</span>           # command <span class="hljs-keyword">to</span> use <span class="hljs-keyword">to</span> archive a logfile segment<br>                                 # placeholders: %p = <span class="hljs-type">path</span> <span class="hljs-keyword">of</span> file <span class="hljs-keyword">to</span> archive  <br>                                 # %p 表示包含完整路径信息的文件名<br>                                 #               %f = file <span class="hljs-type">name</span> <span class="hljs-keyword">only</span><br>                                 # %f 表示不包含路径信息的文件名<br>                                 # e.g. <span class="hljs-string">&#x27;test ! -f /mnt/server/archivedir/%f &amp;&amp; cp %p /mnt/server/archivedir/%f&#x27;</span><br></code></pre></td></tr></table></figure><h4 id="archive-command-配置示例："><a href="#archive-command-配置示例：" class="headerlink" title="archive_command 配置示例："></a>archive_command 配置示例：</h4><p><strong>1、本地归档</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@Rocky8-2 ~]# mkdir /archive<br>[root@Rocky8-2 ~]# chown -R postgres. /archive<br>[root@Rocky8-2 ~]# ll -d /archive<br>drwxr-xr-x 2 postgres postgres 6 Jan 22 13:32 /archive<br><br>[root@Rocky8-2 ~]# vim /pgsql/data/postgresql.conf <br>archive_mode = on<br>archive_command = &#x27;DIR=/archive/`date +%F`; [ -d $DIR ] || mkdir -p $DIR; cp %p $DIR/%f&#x27;<br><br>[root@Rocky8-2 ~]# systemctl restart postgresql.service <br><span class="hljs-meta prompt_"># </span><span class="language-bash">插入数据</span><br>postgres=#  \c testdb1<br>testdb1=# create table t1(id int);<br>testdb1=# insert into t1 values(generate_series(1,100000));<br>testdb1=# select ctid,* from t1;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">触发检查点，切换日志，自动触发归档</span><br>testdb1=# checkpoint;<br>CHECKPOINT<br>testdb1=# select pg_switch_wal();<br> pg_switch_wal <br>---------------<br> 0/92046D0<br>(1 row)<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">检查归档文件</span><br>[root@Rocky8-2 ~]# tree /archive/<br>/archive/<br>└── 2024-01-22<br>    └── 00000001000000000000000B<br><br>1 directory, 1 file<br></code></pre></td></tr></table></figure><p><strong>2、远程归档（在10.0.0.13保存归档）</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">创建归档保存目录，并授权postgres</span><br>[root@Rocky8-3 ~]# mkdir -p /pgsql/backup<br>[root@Rocky8-3 ~]# chown postgres. /pgsql/backup/<br>[root@Rocky8-3 ~]# ll -d /pgsql/backup/<br>drwxr-xr-x 2 postgres postgres 6 Jan 22 14:40 /pgsql/backup/<br><br>[postgres@postgres ~]# ssh-keygen <br>[postgres@postgres ~]# ssh-copy-id postgres@10.0.0.13<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">修改配置</span><br>[root@postgres ~]# vim /pgsql/data/postgresql.conf <br>archive_mode = on  <br>archive_command = &#x27;scp %p 10.0.0.13:/pgspl/backup/%f&#x27;<br><br>[root@postgres ~]# systemctl restart postgresql.service <br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>PostgreSQL</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Backup</tag>
      
      <tag>PostgreSQL</tag>
      
      <tag>pg_dump</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>PostgreSQL备份恢复</title>
    <link href="/2023/07/31/PostgreSQL%E5%A4%87%E4%BB%BD%E6%81%A2%E5%A4%8D/"/>
    <url>/2023/07/31/PostgreSQL%E5%A4%87%E4%BB%BD%E6%81%A2%E5%A4%8D/</url>
    
    <content type="html"><![CDATA[<h3 id="PostgreSQL备份的内容包括："><a href="#PostgreSQL备份的内容包括：" class="headerlink" title="PostgreSQL备份的内容包括："></a>PostgreSQL备份的内容包括：</h3><ul><li>数据（配置文件）</li><li>归档WAL日志</li><li>表空间目录</li></ul><h3 id="备份方式："><a href="#备份方式：" class="headerlink" title="备份方式："></a>备份方式：</h3><ul><li>逻辑备份：适用于跨版本和跨平台的备份恢复，postgresql提供了pg_dump和pg_dumpall命令进行数据库的逻辑备份。</li><li>物理备份：适用于小版本的恢复，但不支持跨平台和大版本</li></ul><h3 id="逻辑备份："><a href="#逻辑备份：" class="headerlink" title="逻辑备份："></a>逻辑备份：</h3><p>pg_dump: 可以将数据库备份成一个文本文件或归档文件，包含多个 create 和 insert 语句，使用这些语句可以重新创建表并插入数据</p><p>pg_dumpall: 可以存储一个数据库集群里的所有数据库到一个脚本文件，本质上是通过对集群的每个数据库执行pg_dump实现这一功能</p><p>pg_restore: 配合pg_dump生成的文件，可以恢复数据库</p><h4 id="使用pg-dump备份和pg-restore恢复范例："><a href="#使用pg-dump备份和pg-restore恢复范例：" class="headerlink" title="使用pg_dump备份和pg_restore恢复范例："></a>使用pg_dump备份和pg_restore恢复范例：</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">查看当前数据库</span><br>[postgres@Rocky8-2 ~]$ psql  -h 10.0.0.12 -p 5432 -U postgres<br>Password for user postgres: <br>psql (15.3)<br>Type &quot;help&quot; for help.<br><br>postgres=# \l<br>                                            List of databases<br>   Name    |  Owner   | Encoding | Collate | Ctype | ICU Locale | Locale Provider |   Access privileges   <br>-----------+----------+----------+---------+-------+------------+-----------------+-----------------------<br> hellodb   | postgres | UTF8     | C       | C     |            | libc            | <br> postgres  | postgres | UTF8     | C       | C     |            | libc            | <br> template0 | postgres | UTF8     | C       | C     |            | libc            | =c/postgres          +<br>           |          |          |         |       |            |                 | postgres=CTc/postgres<br> template1 | postgres | UTF8     | C       | C     |            | libc            | =c/postgres          +<br>           |          |          |         |       |            |                 | postgres=CTc/postgres<br> testdb1   | postgres | UTF8     | C       | C     |            | libc            | <br> testdb2   | postgres | UTF8     | C       | C     |            | libc            | <br>(6 rows)<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># pg_dump备份</span></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">备份hellodb数据库(备份时可以-C选项在备份文件中生成创建数据库语句)</span><br>[root@Rocky8-2 ~]# mkdir /backup <br>[root@Rocky8-2 ~]# pg_dump -Fc -h 10.0.0.12 -U postgres  -f /backup/hellodb_backup hellodb<br>Password: <br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">查看备份的文件内容</span><br>[root@Rocky8-2 ~]# pg_restore -l /backup/hellodb_backup <br>;<br>; Archive created at 2024-01-15 13:19:49 CST<br>;     dbname: hellodb<br>;     TOC Entries: 25<br>;     Compression: -1<br>;     Dump Version: 1.14-0<br>;     Format: CUSTOM<br>;     Integer: 4 bytes<br>;     Offset: 8 bytes<br>;     Dumped from database version: 15.3<br>;     Dumped by pg_dump version: 15.3<br>;<br>;<br>; Selected TOC Entries:<br>;<br>214; 1259 16420 TABLE public classes postgres<br>215; 1259 16426 TABLE public coc postgres<br>216; 1259 16431 TABLE public courses postgres<br>217; 1259 16436 TABLE public scores postgres<br>218; 1259 16441 TABLE public students postgres<br>219; 1259 16446 TABLE public teachers postgres<br>220; 1259 16452 TABLE public toc postgres<br>2625; 0 16420 TABLE DATA public classes postgres<br>2626; 0 16426 TABLE DATA public coc postgres<br>2627; 0 16431 TABLE DATA public courses postgres<br>2628; 0 16436 TABLE DATA public scores postgres<br>2629; 0 16441 TABLE DATA public students postgres<br>2630; 0 16446 TABLE DATA public teachers postgres<br>2631; 0 16452 TABLE DATA public toc postgres<br>2470; 2606 16425 CONSTRAINT public classes classes_pkey postgres<br>2472; 2606 16430 CONSTRAINT public coc coc_pkey postgres<br>2474; 2606 16435 CONSTRAINT public courses courses_pkey postgres<br>2476; 2606 16440 CONSTRAINT public scores scores_pkey postgres<br>2478; 2606 16445 CONSTRAINT public students students_pkey postgres<br>2480; 2606 16451 CONSTRAINT public teachers teachers_pkey postgres<br>2482; 2606 16456 CONSTRAINT public toc toc_pkey postgres<br>[root@Rocky8-2 ~]# ls /backup<br>testdb1_backup<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># pg_restore 还原</span></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">先创建一个数据库才能开始还原</span><br>[root@Rocky8-2 ~]# psql -U postgres -h 10.0.0.12 -c &quot;create database hellodb2&quot;<br>Password for user postgres: <br>CREATE DATABASE<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">将备份还原到hellodb2中</span><br>[root@Rocky8-2 ~]# pg_restore -h 10.0.0.12 -U postgres -d hellodb2 /backup/hellodb_backup<br>Password: <br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看恢复的数据库hellodb2</span><br>[root@Rocky8-2 ~]# psql  -h 10.0.0.12 -p 5432 -U postgres hellodb2<br>Password for user postgres: <br>psql (15.3)<br>Type &quot;help&quot; for help.<br><br>hellodb2=# \l<br>                                            List of databases<br>   Name    |  Owner   | Encoding | Collate | Ctype | ICU Locale | Locale Provider |   Access privileges   <br>-----------+----------+----------+---------+-------+------------+-----------------+-----------------------<br> hellodb   | postgres | UTF8     | C       | C     |            | libc            | <br> hellodb2  | postgres | UTF8     | C       | C     |            | libc            | <br> postgres  | postgres | UTF8     | C       | C     |            | libc            | <br> template0 | postgres | UTF8     | C       | C     |            | libc            | =c/postgres          +<br>           |          |          |         |       |            |                 | postgres=CTc/postgres<br> template1 | postgres | UTF8     | C       | C     |            | libc            | =c/postgres          +<br>           |          |          |         |       |            |                 | postgres=CTc/postgres<br> testdb1   | postgres | UTF8     | C       | C     |            | libc            | <br> testdb2   | postgres | UTF8     | C       | C     |            | libc            | <br>(7 rows)<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">hellodb2-# </span><span class="language-bash">\d</span><br>          List of relations<br> Schema |   Name   | Type  |  Owner   <br>--------+----------+-------+----------<br> public | classes  | table | postgres<br> public | coc      | table | postgres<br> public | courses  | table | postgres<br> public | scores   | table | postgres<br> public | students | table | postgres<br> public | teachers | table | postgres<br> public | toc      | table | postgres<br>(7 rows)<br></code></pre></td></tr></table></figure><h3 id="物理备份"><a href="#物理备份" class="headerlink" title="物理备份"></a>物理备份</h3><h4 id="冷备份"><a href="#冷备份" class="headerlink" title="冷备份"></a>冷备份</h4><p>数据库实例有关的配置文件和数据文件都存放在 $PGDATA 目录下，只需停止数据库，然后将pgdata目录拷贝备份即可。</p><p><strong>范例：利用逻辑卷快照功能实现数据库冷备份（快照生成快，停服时间相对较短）</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">检查数据是否在逻辑巻上，查询得知 / 在rl-root 逻辑卷上，确保空间足够</span><br>[root@Rocky8-2 ~]# lvs<br>  LV              VG Attr       LSize   Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert<br>  pgdata_snapshot rl swi-a-s---   1.00g      root   0.09                                   <br>  root            rl owi-aos--- &lt;32.00g                                                    <br>  swap            rl -wi-ao----   2.00g                                                    <br><br>[root@Rocky8-2 ~]# df <br>Filesystem          1K-blocks    Used Available Use% Mounted on<br>devtmpfs               972852       0    972852   0% /dev<br>tmpfs                  992912    1052    991860   1% /dev/shm<br>tmpfs                  992912    8956    983956   1% /run<br>tmpfs                  992912       0    992912   0% /sys/fs/cgroup<br>/dev/mapper/rl-root  17811456 2634612  15176844  15% /<br>/dev/nvme0n1p1        1038336  197780    840556  20% /boot<br>tmpfs                  198580       0    198580   0% /run/user/0<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">创建逻辑卷快照（保证空间足够）</span><br>[root@Rocky8-2 ~]# systemctl stop postgresql.service ; lvcreate -n pgdata_snapshot -s -L 1G /dev/mapper/rl-root ; systemctl start postgresql.service <br>  Logical volume &quot;pgdata_snapshot&quot; created.<br><span class="hljs-meta prompt_"> </span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">挂载逻辑卷快照备份文件</span><br>[root@Rocky8-2 ~]# mount /dev/rl/pgdata_snapshot /mnt<br>mount: /mnt: wrong fs type, bad option, bad superblock on /dev/mapper/rl-pgdata_snapshot, missing codepage or helper program, or other error.<br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">##  这里有报错提示，是因为XFS不允许相同的UUID</span></span><br>[root@Rocky8-2 ~]# dmesg | tail<br>[   14.618902] vmxnet3 0000:03:00.0 eth0: NIC Link is Up 10000 Mbps<br>[   30.227772] hub 2-2:1.0: hub_ext_port_status failed (err = -110)<br>[  269.246498]  nvme0n2: p1<br>[ 1282.253483] XFS (dm-4): Filesystem has duplicate UUID 8642e5bc-1edc-40d9-ac92-fef3ba887b4f - can&#x27;t mount<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">重新挂载，指定 nouuid 参数</span><br>[root@Rocky8-2 ~]# mount -o nouuid /dev/rl/pgdata_snapshot /mnt<br>[root@Rocky8-2 ~]# ls /mnt<br>apps  bin  boot  dev  etc  home  lib  lib64  media  mnt  opt  pgsql  proc  root  run  sbin  srv  sys  tmp  usr  var<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">备份数据库相关文件</span><br>[root@Rocky8-2 ~]# cp -a  /mnt/pgsql/data/* /back/<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">删除LVM快照</span> <br>[root@Rocky8-2 ~]# umount /mnt<br>[root@Rocky8-2 ~]# lvremove /dev/rl/pgdata_snapshot <br>Do you really want to remove active logical volume rl/pgdata_snapshot? [y/n]: y<br>  Logical volume &quot;pgdata_snapshot&quot; successfully removed.<br></code></pre></td></tr></table></figure><h4 id="PITR备份"><a href="#PITR备份" class="headerlink" title="PITR备份"></a>PITR备份</h4><p>point in time recovery 基于时间点的备份</p><p>pg_basebackup 基于流复制协议可以实现完全备份，并支持热备份。这个工具是备份整个数据库实例，便用 replication 协议连接数据库，必须在 pg_hba.conf 中对其授权。</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"># 在 pg_hba 配置文件中授权，增加一行，对所有地址采用MD5验证授权<br>[root@Rocky8<span class="hljs-number">-2</span> ~]# vim /pgsql/data/pg_hba.conf <br>host    <span class="hljs-keyword">replication</span>     <span class="hljs-keyword">all</span>             <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span>              md5<br></code></pre></td></tr></table></figure><p><strong>范例：用 pg_basebackup 和pg_ba工具进行热备份，模拟故障并还原</strong></p><p><img src="https://xcj-typora-img.oss-cn-hangzhou.aliyuncs.com/img/20240116102707.png" alt="20240116102707"></p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs 1c"><span class="hljs-meta"># 在pg服务器上开启归档</span><br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>PostgreSQL</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Backup</tag>
      
      <tag>PostgreSQL</tag>
      
      <tag>pg_dump</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>PostgreSQL体系架构</title>
    <link href="/2023/07/22/PostgreSQL%E4%BD%93%E7%B3%BB%E6%9E%B6%E6%9E%84/"/>
    <url>/2023/07/22/PostgreSQL%E4%BD%93%E7%B3%BB%E6%9E%B6%E6%9E%84/</url>
    
    <content type="html"><![CDATA[<h3 id="PostgreSQL数据组织结构"><a href="#PostgreSQL数据组织结构" class="headerlink" title="PostgreSQL数据组织结构"></a>PostgreSQL数据组织结构</h3><p><img src="https://xcj-typora-img.oss-cn-hangzhou.aliyuncs.com/img/20230907164950.png"></p><p>在PostgreSQL数据库系统中，数据的组结结构分为以下五层：</p><ul><li>实例：一个安装的数据目录$PGDATA,即一个实例</li><li>数据库：一个数据库服务下可以管理多个数据库</li><li>模式：一个数据库可以创建多个不同的名称空间Schema，用于分隔不同的业务数据</li><li>表和索引：一个数据库可以有多个表和索引，PostgreSQL中表的术语称为Relation </li><li>行和列：每张表中有很多列和行数据，PostgreSQL中术语为Tuple</li></ul><h3 id="PostgreSQL是进程架构模型，MySQL是线程架构模型"><a href="#PostgreSQL是进程架构模型，MySQL是线程架构模型" class="headerlink" title="PostgreSQL是进程架构模型，MySQL是线程架构模型"></a>PostgreSQL是进程架构模型，MySQL是线程架构模型</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@Rocky8-2 ~]# pstree -p<br>systemd(1)─┬─NetworkManager(831)─┬─&#123;NetworkManager&#125;(857)<br>           │                     └─&#123;NetworkManager&#125;(861)<br>           ├─VGAuthService(832)<br>           ├─agetty(907)<br>           ├─anacron(1326)<br>           ├─atd(898)<br>           ├─auditd(805)───&#123;auditd&#125;(806)<br>           ├─chronyd(847)<br>           ├─crond(903)<br>           ├─dbus-daemon(830)<br>           ├─gssproxy(874)─┬─&#123;gssproxy&#125;(877)<br>           │               ├─&#123;gssproxy&#125;(878)<br>           │               ├─&#123;gssproxy&#125;(879)<br>           │               ├─&#123;gssproxy&#125;(880)<br>           │               └─&#123;gssproxy&#125;(881)<br>           ├─irqbalance(835)───&#123;irqbalance&#125;(849)<br>           ├─polkitd(1293)─┬─&#123;polkitd&#125;(1299)<br>           │               ├─&#123;polkitd&#125;(1302)<br>           │               ├─&#123;polkitd&#125;(1303)<br>           │               ├─&#123;polkitd&#125;(1304)<br>           │               ├─&#123;polkitd&#125;(1305)<br>           │               ├─&#123;polkitd&#125;(1306)<br>           │               └─&#123;polkitd&#125;(1311)<br>           ├─postgres(855)─┬─postgres(914)<br>           │               ├─postgres(915)<br>           │               ├─postgres(920)<br>           │               ├─postgres(921)<br>           │               └─postgres(922)<br>           ├─rpcbind(803)<br>           ├─rsyslogd(946)─┬─&#123;rsyslogd&#125;(962)<br>           │               └─&#123;rsyslogd&#125;(964)<br>           ├─sshd(871)─┬─sshd(1338)───sshd(1350)───bash(1351)───pstree(1484)<br>           │           └─sshd(1352)───sshd(1369)───sftp-server(1382)<br>           ├─systemd(1343)───(sd-pam)(1344)<br>           ├─systemd-journal(676)<br>           ├─systemd-logind(839)<br>           ├─systemd-udevd(715)<br>           ├─tuned(867)─┬─&#123;tuned&#125;(1292)<br>           │            ├─&#123;tuned&#125;(1307)<br>           │            ├─&#123;tuned&#125;(1308)<br>           │            └─&#123;tuned&#125;(1309)<br>           └─vmtoolsd(833)─┬─&#123;vmtoolsd&#125;(936)<br>                           ├─&#123;vmtoolsd&#125;(937)<br>                           └─&#123;vmtoolsd&#125;(950)<br></code></pre></td></tr></table></figure><h3 id="PSQL客户端工具"><a href="#PSQL客户端工具" class="headerlink" title="PSQL客户端工具"></a>PSQL客户端工具</h3><p>psql是PostgreSQL中的一个命令行交互式客户端工具，类似于Mysql中的mysql和Oracle中的sqlplus，PostgreSQL图形化客户端工具（pgadmin）</p><ul><li>可以使用上下键把使用过的命令或SQL语句调出来</li><li>连续按两个TAB键，表示把命令补全或给出提示输入</li></ul><p>命令格式：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">psql -h &lt;hostname/ip&gt;  -p &lt;端口&gt; [数据库名称] -U [用户名称]<br><br>[root@Rocky8-2 ~]# psql -h 10.0.0.12  -p 5432  hellodb  postgres<br></code></pre></td></tr></table></figure><p>-h## 指定要连接的数据库主机或IP地址，默认local socket登录（unix_socket_directories指定）</p><p>-p## 指定连接的数据库端口</p><p>这些连接参数也可用环境变量指定，如：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">export PGDATABASE=testdb<br>export PGHOST=10.0.0.12<br>export PGPOFT=5432<br>export PGUSER=postgres<br></code></pre></td></tr></table></figure><h5 id="psql帮助"><a href="#psql帮助" class="headerlink" title="psql帮助"></a>psql帮助</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs shell">postgres=# \help<br>You are using psql, the command-line interface to PostgreSQL.<br>Type:  \copyright for distribution terms<br>       \h for help with SQL commands<br>       \? for help with psql commands<br>       \g or terminate with semicolon to execute query<br>       \q to quit<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">postgres-# </span><span class="language-bash">\?</span><br>General<br>  \copyright             show PostgreSQL usage and distribution terms<br>  \crosstabview [COLUMNS] execute query and display result in crosstab<br>  \errverbose            show most recent error message at maximum verbosity<br>  \g [(OPTIONS)] [FILE]  execute query (and send result to file or |pipe);<br>                         \g with no arguments is equivalent to a semicolon<br>  \gdesc                 describe result of query, without executing it<br>  \gexec                 execute query, then execute each value in its result<br>  \gset [PREFIX]         execute query and store result in psql variables<br>  \gx [(OPTIONS)] [FILE] as \g, but forces expanded output mode<br>  \q                     quit psql<br>  \watch [SEC]           execute query every SEC seconds<br><br>Help<br>  \? [commands]          show help on backslash commands<br>  \? options             show help on psql command-line options<br>  \? variables           show help on special variables<br>  \h [NAME]              help on syntax of SQL commands, * for all commands<br><br></code></pre></td></tr></table></figure><h3 id="PostgreSQL数据库目录介绍"><a href="#PostgreSQL数据库目录介绍" class="headerlink" title="PostgreSQL数据库目录介绍"></a>PostgreSQL数据库目录介绍</h3><p><img src="https://xcj-typora-img.oss-cn-hangzhou.aliyuncs.com/img/20230901153453.png" alt="20230901153453"></p><p>数据库数据存放在变量PGDATA指向的目录，安装数据库时需要指定一个合适的目录做为数据目录的根目录，目录的初始化使用initdb来完成。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@Rocky8-2 ~]# ll $PGDATA<br>total 64<br>drwx------ 5 postgres postgres    33 Aug  7 14:06 base<br>drwx------ 2 postgres postgres  4096 Aug 31 16:01 global<br>drwx------ 2 postgres postgres     6 Aug  7 14:06 pg_commit_ts<br>drwx------ 2 postgres postgres     6 Aug  7 14:06 pg_dynshmem<br>-rw------- 1 postgres postgres  4535 Aug  7 14:06 pg_hba.conf<br>-rw------- 1 postgres postgres  1636 Aug  7 14:06 pg_ident.conf<br>drwx------ 4 postgres postgres    68 Aug 31 16:05 pg_logical<br>drwx------ 4 postgres postgres    36 Aug  7 14:06 pg_multixact<br>drwx------ 2 postgres postgres     6 Aug  7 14:06 pg_notify<br>drwx------ 2 postgres postgres     6 Aug  7 14:06 pg_replslot<br>drwx------ 2 postgres postgres     6 Aug  7 14:06 pg_serial<br>drwx------ 2 postgres postgres     6 Aug  7 14:06 pg_snapshots<br>drwx------ 2 postgres postgres     6 Aug 31 16:00 pg_stat<br>drwx------ 2 postgres postgres     6 Aug  7 14:06 pg_stat_tmp<br>drwx------ 2 postgres postgres    18 Aug  7 14:06 pg_subtrans<br>drwx------ 2 postgres postgres     6 Aug  7 14:06 pg_tblspc<br>drwx------ 2 postgres postgres     6 Aug  7 14:06 pg_twophase<br>-rw------- 1 postgres postgres     3 Aug  7 14:06 PG_VERSION<br>drwx------ 3 postgres postgres    60 Aug  7 14:06 pg_wal<br>drwx------ 2 postgres postgres    18 Aug  7 14:06 pg_xact<br>-rw------- 1 postgres postgres    88 Aug  7 14:06 postgresql.auto.conf<br>-rw------- 1 postgres postgres 29412 Aug  7 14:06 postgresql.conf<br>-rw------- 1 postgres postgres    44 Aug 31 16:00 postmaster.opts<br>-rw------- 1 postgres postgres    76 Aug 31 16:00 postmaster.pid<br></code></pre></td></tr></table></figure><h4 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h4><p>初始化完成后，PGDATA目录下会生成三个配置文件：</p><ul><li>postgresql.conf   #  数据库实例的主配置文件，基本所有的配置参数都在此文件中</li><li>pg_hba.conf   #  认证配置文件，配置允许哪此IP主机访问数据库，认证的方法等信息</li><li>pg_ident.conf     #  认证方式ident的用户映射文件。</li></ul><h5 id="postgresql-conf"><a href="#postgresql-conf" class="headerlink" title="postgresql.conf"></a>postgresql.conf</h5><blockquote><p>postgresql.conf 优先级低于 postgresql.auto.conf</p></blockquote><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">listen_addresses=‘*’        #监听客户端的地址，默认是本地的localhost，需要修改为*或者<span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span><br>port = <span class="hljs-number">5432</span>               #pg端口，默认是<span class="hljs-number">5432</span><br>max_connections = <span class="hljs-number">2000</span>       #最大连接数，默认<span class="hljs-number">100</span><br>unix_socket_directories     #socket文件的位置，默认在/tmp下面<br>shared_buffers              #数据缓存区，建议值<span class="hljs-number">1</span>/<span class="hljs-number">4</span><span class="hljs-comment">--1/2主机内存，和oracle的buffer cache类似</span><br>maintenance_work_mem        #维护工作内存，用于<span class="hljs-keyword">vacuum</span> , <span class="hljs-keyword">create</span> <span class="hljs-keyword">index</span>, <span class="hljs-keyword">reindex</span>等。建议值(<span class="hljs-number">1</span>/<span class="hljs-number">4</span>主机内存)/autovacuum_max_workers<br>max_worker_processes        #总worker数<br>max_parallel_workers_per_gather #单条QUERY中，每个node最多允许开启的并行计算wORKER数<br>wal_level                   #wa1级别，版本<span class="hljs-number">11</span>+默认是<span class="hljs-keyword">replica</span><br>wal_buffers                 #类似oracle的<span class="hljs-number">1</span>og buffer<br>checkpoint_timeout          #<span class="hljs-keyword">checkpoint</span>时间间隔<br>max_wal_size                #控制wa1的最大数量<br>min_wal_size                #控制wa1的最小数量<br>archive_command             #开启归档命令，示例: <span class="hljs-string">&#x27;test ! -f /arch/%f &amp;&amp; cp %p /arch/%f&#x27;</span><br>autovacuum                  #开启自动<span class="hljs-keyword">vacuum</span><br></code></pre></td></tr></table></figure><h5 id="pg-ident-conf"><a href="#pg-ident-conf" class="headerlink" title="pg_ident.conf"></a>pg_ident.conf</h5><blockquote><p>用户映身配置文件，结合pg_hba.conf文件，’method‘为‘ident’可以用特定的操作系统用户以指定的数据库用户身份登录数据库</p><p>这个文件记录着与操作系统用户匹配的数据库用户，如果某操作系统用户在本文件中没有映射用户，则默认的映射数据据主用户与操作系统用户同名</p></blockquote><h5 id="pg-hba-conf"><a href="#pg-hba-conf" class="headerlink" title="pg_hba.conf"></a>pg_hba.conf</h5><blockquote><p>HBA:host-based authentication，基于主机的认证，实现防火墙功能，可以控制允许哪些IP的机器访问数据库服务器</p></blockquote><p>pg_hba.conf文件每行由5部分组成</p><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs oxygene"><span class="hljs-keyword">TYPE</span>    DATABASE        USER            ADDRESS                 <span class="hljs-keyword">METHOD</span><br></code></pre></td></tr></table></figure><h4 id="数据文件"><a href="#数据文件" class="headerlink" title="数据文件"></a>数据文件</h4><p>每一个索引和表都是一个单独文件，称为Segment.文件大小可以在initdb时通过选项–with-segsize&#x3D;SEGSIZE指定</p><p>物理位置：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-variable">$PGDATA</span><span class="hljs-regexp">/BASE/</span>DATABASE_OID/PG_CLASS.RELFILENODE<br></code></pre></td></tr></table></figure><h4 id="控制文件"><a href="#控制文件" class="headerlink" title="控制文件"></a>控制文件</h4><p>控制文件存放当前数据库的状态，存放在 $PGDATA&#x2F;global&#x2F;pg_control 下</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@Rocky8-2 ~]# pg_controldata $PGDATA<br>pg_control version number:            1300<br>Catalog version number:               202209061<br>Database system identifier:           7264457813843350549<br>Database cluster state:               in production<br>pg_control last modified:             Mon 18 Sep 2023 05:05:40 PM CST<br>Latest checkpoint location:           0/64ED35A8<br>Latest checkpoint&#x27;s REDO location:    0/64ED3570<br>Latest checkpoint&#x27;s REDO WAL file:    000000010000000000000064<br>Latest checkpoint&#x27;s TimeLineID:       1<br>Latest checkpoint&#x27;s PrevTimeLineID:   1<br>Latest checkpoint&#x27;s full_page_writes: on<br>Latest checkpoint&#x27;s NextXID:          0:749<br>Latest checkpoint&#x27;s NextOID:          24580<br>Latest checkpoint&#x27;s NextMultiXactId:  1<br>Latest checkpoint&#x27;s NextMultiOffset:  0<br>Latest checkpoint&#x27;s oldestXID:        717<br>Latest checkpoint&#x27;s oldestXID&#x27;s DB:   1<br>Latest checkpoint&#x27;s oldestActiveXID:  749<br>Latest checkpoint&#x27;s oldestMultiXid:   1<br>Latest checkpoint&#x27;s oldestMulti&#x27;s DB: 1<br>Latest checkpoint&#x27;s oldestCommitTsXid:0<br>Latest checkpoint&#x27;s newestCommitTsXid:0<br>Time of latest checkpoint:            Mon 18 Sep 2023 05:05:39 PM CST<br>Fake LSN counter for unlogged rels:   0/3E8<br>Minimum recovery ending location:     0/0<br>Min recovery ending loc&#x27;s timeline:   0<br>Backup start location:                0/0<br>Backup end location:                  0/0<br>End-of-backup record required:        no<br>wal_level setting:                    replica<br>wal_log_hints setting:                off<br>max_connections setting:              100<br>max_worker_processes setting:         8<br>max_wal_senders setting:              10<br>max_prepared_xacts setting:           0<br>max_locks_per_xact setting:           64<br>track_commit_timestamp setting:       off<br>Maximum data alignment:               8<br>Database block size:                  8192<br>Blocks per segment of large relation: 131072<br>WAL block size:                       8192<br>Bytes per WAL segment:                16777216<br>Maximum length of identifiers:        64<br>Maximum columns in an index:          32<br>Maximum size of a TOAST chunk:        1996<br>Size of a large-object chunk:         2048<br>Date/time type storage:               64-bit integers<br>Float8 argument passing:              by value<br>Data page checksum version:           0<br>Mock authentication nonce:            04dab1c27ec1349493a9e5db6327dd88cc59873f0486b64c238c1c1e47d28d69<br></code></pre></td></tr></table></figure><h4 id="日志文件"><a href="#日志文件" class="headerlink" title="日志文件"></a>日志文件</h4><ul><li><p>运行日志：$PGDATA&#x2F;log 默认不存在，需要开启配置项loggin_collector</p></li><li><p>在线重做日志：$PGDATA&#x2F;pg_wal</p></li><li><p>事务提交日志：$PGDATA&#x2F;pg_xact</p></li><li><p>服务器日志：可以在服务启动时指定 pg_ctl start -l .&#x2F;logfile</p></li></ul><h3 id="开启远程连接"><a href="#开启远程连接" class="headerlink" title="开启远程连接"></a>开启远程连接</h3><p>默认安装完成后，postgresql只监听local,需要添加监听对外提供服务的ip地址</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># 修改postgres用户密码</span></span><br>[root@Rocky8-2 ~]# psql<br>postgres=# alter user postgres with password &#x27;123456&#x27;;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># 修改监听地址和端口</span></span><br>[root@Rocky8-2 ~]# vim /pgsql/data/postgresql.conf <br>listen_addresses = &#x27;*&#x27;                  # what IP address(es) to listen on;<br><span class="hljs-meta prompt_">#</span><span class="language-bash">listen_addresses = <span class="hljs-string">&#x27;localhost&#x27;</span>         <span class="hljs-comment"># what IP address(es) to listen on;</span></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># 在pg_hba.conf中添加一行</span></span><br>host    all             all             0.0.0.0/0               md5<br><br>[root@Rocky8-2 ~]# vim /pgsql/data/pg_hba.conf<br><span class="hljs-meta prompt_"># </span><span class="language-bash">IPv4 <span class="hljs-built_in">local</span> connections:</span><br>host    all             all             127.0.0.1/32            md5<br>host    all             all             0.0.0.0/0               md5<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># 重启服务</span></span><br>[root@Rocky8-2 ~]# su - postgres <br>[postgres@Rocky8-2 ~]$  pg_ctl restart -mf<br>waiting for server to shut down.... done<br>server stopped<br>waiting for server to start....2023-09-11 17:24:21.580 CST [1611] LOG:  starting PostgreSQL 15.3 on x86_64-pc-linux-gnu, compiled by gcc (GCC) 8.5.0 20210514 (Red Hat 8.5.0-18), 64-bit<br>2023-09-11 17:24:21.581 CST [1611] LOG:  listening on IPv4 address &quot;0.0.0.0&quot;, port 5432<br>2023-09-11 17:24:21.581 CST [1611] LOG:  listening on IPv6 address &quot;::&quot;, port 5432<br>2023-09-11 17:24:21.583 CST [1611] LOG:  listening on Unix socket &quot;/tmp/.s.PGSQL.5432&quot;<br>2023-09-11 17:24:21.588 CST [1614] LOG:  database system was shut down at 2023-09-11 17:24:21 CST<br>2023-09-11 17:24:21.592 CST [1611] LOG:  database system is ready to accept connections<br> done<br>server started<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># 查看监听端口</span></span><br>[postgres@Rocky8-2 ~]$ ss -ntl<br>State              Recv-Q             Send-Q                         Local Address:Port                         Peer Address:Port            Process             <br>LISTEN             0                  128                                  0.0.0.0:111                               0.0.0.0:*                                   <br>LISTEN             0                  128                                  0.0.0.0:22                                0.0.0.0:*                                   <br>LISTEN             0                  244                                  0.0.0.0:5432                              0.0.0.0:*                                   <br>LISTEN             0                  128                                     [::]:111                                  [::]:*                                   <br>LISTEN             0                  128                                     [::]:22                                   [::]:*                                   <br>LISTEN             0                  244                                     [::]:5432                                 [::]:*   <br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># 在远程机器测试连接</span></span><br>[root@Rocky8-1 ~]# psql  -h 10.0.0.12 -p 5432 -U postgres<br>Password for user postgres: <br>psql (15.3)<br>Type &quot;help&quot; for help.<br><br>postgres=# <br></code></pre></td></tr></table></figure><h3 id="设置显示信息的格式"><a href="#设置显示信息的格式" class="headerlink" title="设置显示信息的格式"></a>设置显示信息的格式</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># 调整横向和纵向显示</span></span><br>postgres=# \x<br>Expanded display is on.<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># 显示命令执行的时长</span></span><br>postgres=# timing on <br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># 显示详细信息，可打印出报出问题的源代码位置</span></span><br><span class="hljs-meta prompt_">postgres-# </span><span class="language-bash">\<span class="hljs-built_in">set</span> VERBOSITY verbose</span><br><br></code></pre></td></tr></table></figure><h3 id="查看和连接数据库"><a href="#查看和连接数据库" class="headerlink" title="查看和连接数据库"></a>查看和连接数据库</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># 列出数据库，相当于Mysql的 show databases</span></span><br>postgres=# \l<br>                                            List of databases<br>   Name    |  Owner   | Encoding | Collate | Ctype | ICU Locale | Locale Provider |   Access privileges   <br>-----------+----------+----------+---------+-------+------------+-----------------+-----------------------<br> postgres  | postgres | UTF8     | C       | C     |            | libc            | <br> template0 | postgres | UTF8     | C       | C     |            | libc            | =c/postgres          +<br>           |          |          |         |       |            |                 | postgres=CTc/postgres<br> template1 | postgres | UTF8     | C       | C     |            | libc            | =c/postgres          +<br>           |          |          |         |       |            |                 | postgres=CTc/postgres<br> testdb1   | postgres | UTF8     | C       | C     |            | libc            | <br>(4 rows)<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># 显示数据为详细信息</span></span><br>postgres=# \l+<br>                                                                              List of databases<br>   Name    |  Owner   | Encoding | Collate | Ctype | ICU Locale | Locale Provider |   Access privileges   |  Size   | Tablespace |                Description    <br>             <br>-----------+----------+----------+---------+-------+------------+-----------------+-----------------------+---------+------------+-------------------------------<br>-------------<br> postgres  | postgres | UTF8     | C       | C     |            | libc            |                       | 7229 kB | pg_default | default administrative connect<br>ion database<br> template0 | postgres | UTF8     | C       | C     |            | libc            | =c/postgres          +| 7073 kB | pg_default | unmodifiable empty database<br>           |          |          |         |       |            |                 | postgres=CTc/postgres |         |            | <br> template1 | postgres | UTF8     | C       | C     |            | libc            | =c/postgres          +| 7301 kB | pg_default | default template for new datab<br>ases<br>           |          |          |         |       |            |                 | postgres=CTc/postgres |         |            | <br> testdb1   | postgres | UTF8     | C       | C     |            | libc            |                       | 7145 kB | pg_default | <br>(4 rows)<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># 查看当前连接</span></span><br>postgres=# \c<br>You are now connected to database &quot;postgres&quot; as user &quot;postgres&quot;.<br>postgres=# \conninfo<br>You are connected to database &quot;postgres&quot; as user &quot;postgres&quot; via socket in &quot;/tmp&quot; at port &quot;5432&quot;.<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># 使用数据库</span></span><br>postgres=# \c testdb1<br>You are now connected to database &quot;testdb1&quot; as user &quot;postgres&quot;.<br>testdb1=# <br></code></pre></td></tr></table></figure><h3 id="创建数据库"><a href="#创建数据库" class="headerlink" title="创建数据库"></a>创建数据库</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># 方法1</span></span><br>postgres=# create database testdb1;<br>CREATE DATABASE<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># 方法2</span></span><br>[root@Rocky8-2 ~]# createdb  -h 10.0.0.12 -p 5432 -U postgres testdb2<br>Password: <br><br>postgres=# \l<br>                                            List of databases<br>   Name    |  Owner   | Encoding | Collate | Ctype | ICU Locale | Locale Provider |   Access privileges   <br>-----------+----------+----------+---------+-------+------------+-----------------+-----------------------<br> postgres  | postgres | UTF8     | C       | C     |            | libc            | <br> template0 | postgres | UTF8     | C       | C     |            | libc            | =c/postgres          +<br>           |          |          |         |       |            |                 | postgres=CTc/postgres<br> template1 | postgres | UTF8     | C       | C     |            | libc            | =c/postgres          +<br>           |          |          |         |       |            |                 | postgres=CTc/postgres<br> testdb1   | postgres | UTF8     | C       | C     |            | libc            | <br> testdb2   | postgres | UTF8     | C       | C     |            | libc            | <br>(5 rows)<br></code></pre></td></tr></table></figure><h3 id="删除数据库"><a href="#删除数据库" class="headerlink" title="删除数据库"></a>删除数据库</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs shell">postgres=# drop database testdb2;<br>DROP DATABASE<br><br>postgres=# \l<br>                                            List of databases<br>   Name    |  Owner   | Encoding | Collate | Ctype | ICU Locale | Locale Provider |   Access privileges   <br>-----------+----------+----------+---------+-------+------------+-----------------+-----------------------<br> postgres  | postgres | UTF8     | C       | C     |            | libc            | <br> template0 | postgres | UTF8     | C       | C     |            | libc            | =c/postgres          +<br>           |          |          |         |       |            |                 | postgres=CTc/postgres<br> template1 | postgres | UTF8     | C       | C     |            | libc            | =c/postgres          +<br>           |          |          |         |       |            |                 | postgres=CTc/postgres<br> testdb1   | postgres | UTF8     | C       | C     |            | libc            | <br>(4 rows)<br></code></pre></td></tr></table></figure><h3 id="创建表和表数据的CRUD操作"><a href="#创建表和表数据的CRUD操作" class="headerlink" title="创建表和表数据的CRUD操作"></a>创建表和表数据的CRUD操作</h3><p>CRUD即：insert  update  delete  select </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs shell">postgres=# \c testdb1 <br>You are now connected to database &quot;testdb1&quot; as user &quot;postgres&quot;.<br>testdb1=# create table tb2 (id serial primary key,name text);<br>CREATE TABLE<br><br>testdb1=# \d tb2;<br>                            Table &quot;public.tb1&quot;<br> Column |  Type   | Collation | Nullable |             Default             <br>--------+---------+-----------+----------+---------------------------------<br> id     | integer |           | not null | nextval(&#x27;tb1_id_seq&#x27;::regclass)<br> name   | text    |           |          | <br>Indexes:<br>    &quot;tb1_pkey&quot; PRIMARY KEY, btree (id)<br>    <br>testdb1=# insert into tb2 (name) values (&#x27;wang&#x27;);<br><br>testdb1=# select * from tb2;<br><br>testdb1=# update tb2 set name=&#x27;zhang&#x27; where id=2;<br><br>testdb1=# delete from tb2 where id=2;<br><br>testdb1=# drop table tb1;<br></code></pre></td></tr></table></figure><h3 id="查看数据库用户"><a href="#查看数据库用户" class="headerlink" title="查看数据库用户"></a>查看数据库用户</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs shell">postgres=# \du<br>                                   List of roles<br> Role name |                         Attributes                         | Member of <br>-----------+------------------------------------------------------------+-----------<br> postgres  | Superuser, Create role, Create DB, Replication, Bypass RLS | &#123;&#125;<br><br>postgres=# \dg<br>                                   List of roles<br> Role name |                         Attributes                         | Member of <br>-----------+------------------------------------------------------------+-----------<br> postgres  | Superuser, Create role, Create DB, Replication, Bypass RLS | &#123;&#125;<br></code></pre></td></tr></table></figure><h3 id="事务管理"><a href="#事务管理" class="headerlink" title="事务管理"></a>事务管理</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># 开始事务</span></span><br>  BEGIN <br><span class="hljs-meta prompt_">testdb1-# </span><span class="language-bash">\h begin</span> <br>Command:     BEGIN<br>Description: start a transaction block<br>Syntax:<br>BEGIN [ WORK | TRANSACTION ] [ transaction_mode [, ...] ]<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># 提交事务</span></span><br>  COMMIT | END<br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># 取消事务   需要在关闭自动提交状态下：\set AUTOCOMMIT OFF</span></span> <br>  ROLLBACK<br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># 查看事务ID</span></span><br>  select txid_current();<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>PostgreSQL</category>
      
    </categories>
    
    
    <tags>
      
      <tag>PostgreSQL</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>PostgreSQL安装初始化</title>
    <link href="/2023/07/18/PostgreSQL%E5%AE%89%E8%A3%85%E5%88%9D%E5%A7%8B%E5%8C%96/"/>
    <url>/2023/07/18/PostgreSQL%E5%AE%89%E8%A3%85%E5%88%9D%E5%A7%8B%E5%8C%96/</url>
    
    <content type="html"><![CDATA[<p>PostgreSQL 是一个免费的对象-关系数据库服务器(ORDBMS)，在灵活的BSD许可证下发行。</p><p>PostgreSQL 开发者把它念作 post-gress-Q-L。</p><p>PostgreSQL 的 Slogan 是 “世界上最先进的开源关系型数据库”。</p><blockquote><p>数据库排名：<a href="https://db-engines.com/en/ranking">DB-Engines Ranking - popularity ranking of database management systems</a></p></blockquote><blockquote><p>PostgreSQL 与 MySQL 对比：<a href="http://bbs.chinaunix.net/thread-1688208-1-1.html">PostgreSQL与MySQL比较 - PostgreSQL-Chinaunix</a></p></blockquote><h3 id="PostgreSQL-安装初始化"><a href="#PostgreSQL-安装初始化" class="headerlink" title="PostgreSQL 安装初始化"></a>PostgreSQL 安装初始化</h3><h4 id="二进制安装包"><a href="#二进制安装包" class="headerlink" title="二进制安装包"></a>二进制安装包</h4><blockquote><p>Rocky8 用官方源安装 PostgreSQL 15，参考官方文档：<a href="https://www.postgresql.org/download/">PostgreSQL: Downloads</a></p></blockquote><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">##  安装仓库 repository RPM</span><br>[root@Rocky8-1 ~]<span class="hljs-comment"># dnf install -y https://download.postgresql.org/pub/repos/yum/reporpms/EL-8-x86_64/pgdg-redhat-repo-latest.noarch.rpm</span><br>Installed:<br>  pgdg-redhat-repo-42.0-32.noarch                                                                                                                     <br>Complete!<br><br><span class="hljs-comment">##  禁用内置的postgresql</span><br>[root@Rocky8-1 ~]<span class="hljs-comment"># dnf -qy module disable postgresql</span><br><br><span class="hljs-comment">##  安装postgresql</span><br>[root@Rocky8-1 ~]<span class="hljs-comment"># dnf install -y postgresql15-server</span><br>Installed:<br>  lz4-1.8.3-3.el8_4.x86_64  postgresql15-15.3-2PGDG.rhel8.x86_64  postgresql15-libs-15.3-2PGDG.rhel8.x86_64  postgresql15-server-15.3-2PGDG.rhel8.x86_64 <br>Complete!<br><br><span class="hljs-comment">##  初始化数据库并设置自动启动</span><br>[root@Rocky8-1 ~]<span class="hljs-comment"># /usr/pgsql-15/bin/postgresql-15-setup initdb</span><br>Initializing database ... OK<br><br>[root@Rocky8-1 ~]<span class="hljs-comment"># systemctl enable postgresql-15</span><br>Created symlink /etc/systemd/system/multi-user.target.wants/postgresql-15.service → /usr/lib/systemd/system/postgresql-15.service.<br><br>[root@Rocky8-1 ~]<span class="hljs-comment"># systemctl start postgresql-15</span><br><br><span class="hljs-comment">##  验证</span><br>[root@Rocky8-1 ~]<span class="hljs-comment"># sudo -u postgres psql -c &quot;select version();&quot;</span><br>could not change directory to <span class="hljs-string">&quot;/root&quot;</span>: Permission denied<br>                                                 version                                                 <br>---------------------------------------------------------------------------------------------------------<br> PostgreSQL 15.3 on x86_64-pc-linux-gnu, compiled by gcc (GCC) 8.5.0 20210514 (Red Hat 8.5.0-18), 64-bit<br>(1 row)<br><br><span class="hljs-comment">##  切换postgres用户，进入数据库</span><br>[root@Rocky8-1 ~]<span class="hljs-comment"># su - postgres</span><br>[postgres@Rocky8-1 ~]$ psql<br>psql (15.3)<br>Type <span class="hljs-string">&quot;help&quot;</span> <span class="hljs-keyword">for</span> <span class="hljs-built_in">help</span>.<br><br>postgres=<span class="hljs-comment"># help </span><br>You are using psql, the command-line interface to PostgreSQL.<br>Type:  \copyright <span class="hljs-keyword">for</span> distribution terms<br>       \h <span class="hljs-keyword">for</span> <span class="hljs-built_in">help</span> with SQL commands<br>       \? <span class="hljs-keyword">for</span> <span class="hljs-built_in">help</span> with psql commands<br>       \g or terminate with semicolon to execute query<br>       \q to quit<br>postgres=<span class="hljs-comment"># </span><br><br><span class="hljs-comment">##  PostgreSQL数据库目录</span><br>[root@Rocky8-1 ~]<span class="hljs-comment"># ls /var/lib/pgsql/15/data/</span><br>base              <span class="hljs-built_in">log</span>           pg_hba.conf    pg_multixact  pg_serial     pg_stat_tmp  pg_twophase  pg_xact               postmaster.opts<br>current_logfiles  pg_commit_ts  pg_ident.conf  pg_notify     pg_snapshots  pg_subtrans  PG_VERSION   postgresql.auto.conf  postmaster.pid<br>global            pg_dynshmem   pg_logical     pg_replslot   pg_stat       pg_tblspc    pg_wal       postgresql.conf<br></code></pre></td></tr></table></figure><h4 id="源码编译安装"><a href="#源码编译安装" class="headerlink" title="源码编译安装"></a>源码编译安装</h4><blockquote><p>参考官方文档：<a href="https://www.postgresql.org/docs/current/install-procedure.html">PostgreSQL: Documentation: 15: 17.4. Installation Procedure</a></p></blockquote><h5 id="安装步骤"><a href="#安装步骤" class="headerlink" title="安装步骤"></a>安装步骤</h5><blockquote><ol><li>下载源码：<a href="https://www.postgresql.org/ftp/source/">https://www.postgresql.org/ftp/source/</a></li><li>编译：<ul><li>.&#x2F;configure</li><li>make</li><li>makeinstall</li></ul></li><li>初始化数据库，创建启动服务</li></ol></blockquote><h5 id="环境初始化"><a href="#环境初始化" class="headerlink" title="环境初始化"></a>环境初始化</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">##  关闭防火强和SElinux</span><br>[root@Rocky8-2 ~]<span class="hljs-comment"># systemctl status firewalld</span><br>● firewalld.service - firewalld - dynamic firewall daemon<br>   Loaded: loaded (/usr/lib/systemd/system/firewalld.service; disabled; vendor preset: enabled)<br>   Active: inactive (dead)<br>     Docs: man:firewalld(1)<br>[root@Rocky8-2 ~]<span class="hljs-comment"># getenforce </span><br>Disabled<br><br><span class="hljs-comment">##  内核优化</span><br>[root@Rocky8-2 ~]<span class="hljs-comment"># </span><br></code></pre></td></tr></table></figure><h5 id="安装依赖包"><a href="#安装依赖包" class="headerlink" title="安装依赖包"></a>安装依赖包</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@Rocky8-2 ~]# yum install -y  gcc make readline-devel zlib-devel<br></code></pre></td></tr></table></figure><h5 id="下载解压"><a href="#下载解压" class="headerlink" title="下载解压"></a>下载解压</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@Rocky8-2 ~]# wget https://ftp.postgresql.org/pub/source/v15.3/postgresql-15.3.tar.gz<br>[root@Rocky8-2 ~]# tar xf postgresql-15.3.tar.gz <br><br>[root@Rocky8-2 ~]# cd postgresql-15.3/<br>[root@Rocky8-2 postgresql-15.3]# ll<br>total 780<br>-rw-r--r--  1 1107 1107    397 May  9 05:13 aclocal.m4<br>drwxrwxrwx  2 1107 1107   4096 May  9 05:25 config<br>-rwxr-xr-x  1 1107 1107 601977 May  9 05:13 configure<br>-rw-r--r--  1 1107 1107  89369 May  9 05:13 configure.ac<br>drwxrwxrwx 61 1107 1107   4096 May  9 05:24 contrib<br>-rw-r--r--  1 1107 1107   1192 May  9 05:13 COPYRIGHT<br>drwxrwxrwx  3 1107 1107     87 May  9 05:25 doc<br>-rw-r--r--  1 1107 1107   4264 May  9 05:13 GNUmakefile.in<br>-rw-r--r--  1 1107 1107    277 May  9 05:13 HISTORY<br>-rw-r--r--  1 1107 1107  63842 May  9 05:26 INSTALL<br>-rw-r--r--  1 1107 1107   1875 May  9 05:13 Makefile<br>-rw-r--r--  1 1107 1107   1213 May  9 05:13 README<br>drwxrwxrwx 16 1107 1107   4096 May  9 05:26 src<br></code></pre></td></tr></table></figure><h5 id="查看官方安装说明"><a href="#查看官方安装说明" class="headerlink" title="查看官方安装说明"></a>查看官方安装说明</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@Rocky8-2 postgresql-15.3]# cat INSTALL | less<br>....<br>Short Version<br><br>    ./configure<br>    make<br>    su<br>    make install<br>    adduser postgres<br>    mkdir -p /usr/local/pgsql/data<br>    chown postgres /usr/local/pgsql/data<br>    su - postgres<br>    /usr/local/pgsql/bin/initdb -D /usr/local/pgsql/data<br>    /usr/local/pgsql/bin/pg_ctl -D /usr/local/pgsql/data -l logfile start<br>    /usr/local/pgsql/bin/createdb test<br>    /usr/local/pgsql/bin/psql test<br><br>The long version is the rest of this document.<br>....<br></code></pre></td></tr></table></figure><h5 id="开始编译安装三步曲"><a href="#开始编译安装三步曲" class="headerlink" title="开始编译安装三步曲"></a>开始编译安装三步曲</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#  编译时加上安装路径（默认安装在/usr/local/pgsql下）、端口等设置（默认端口5432，也可在编译后修改配置文件）</span></span><br>[root@Rocky8-2 postgresql-15.3]# ./configure --prefix=/apps/pgsql --with-pgport=5432<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#  查看CPU个数，-j指定编译的CPU数量，world 同时编译帮助文档</span></span><br>[root@Rocky8-2 postgresql-15.3]# lscpu<br>Architecture:        x86_64<br>CPU op-mode(s):      32-bit, 64-bit<br>Byte Order:          Little Endian<br>CPU(s):              4<br><br>[root@Rocky8-2 postgresql-15.3]# make -j 4 world<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#  安装时同步安装帮助文档</span></span><br>[root@Rocky8-2 postgresql-15.3]# make install-world <br><br>[root@Rocky8-2 postgresql-15.3]# tree /apps/pgsql<br></code></pre></td></tr></table></figure><h5 id="创建pgsql的数据库用户和组"><a href="#创建pgsql的数据库用户和组" class="headerlink" title="创建pgsql的数据库用户和组"></a>创建pgsql的数据库用户和组</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#  注意用户需要可以交互登录</span></span><br>[root@Rocky8-2 postgresql-15.3]# useradd -s /bin/bash -m -d /home/postgres postgres<br>[root@Rocky8-2 postgresql-15.3]# echo -e &#x27;123456\n123456&#x27; | passwd postgres<br></code></pre></td></tr></table></figure><h5 id="创建数据目录并授权"><a href="#创建数据目录并授权" class="headerlink" title="创建数据目录并授权"></a>创建数据目录并授权</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#  数据目录</span></span><br>[root@Rocky8-2 postgresql-15.3]# mkdir -pv /pgsql/data/<br>mkdir: created directory &#x27;/pgsql&#x27;<br>mkdir: created directory &#x27;/pgsql/data/&#x27;<br>[root@Rocky8-2 postgresql-15.3]# chown postgres.postgres /pgsql/data/<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#  日志目录</span></span><br>[root@Rocky8-2 ~]# mkdir -pv /pgsql/log<br>[root@Rocky8-2 ~]# chown postgres.postgres /pgsql/log/<br><br>[root@Rocky8-2 ~]# ll /pgsql/<br>total 4<br>drwx------ 19 postgres postgres 4096 Aug  7 14:06 data<br>drwxr-xr-x  2 postgres postgres    6 Aug  7 14:12 log<br></code></pre></td></tr></table></figure><h5 id="设置环境变量"><a href="#设置环境变量" class="headerlink" title="设置环境变量"></a>设置环境变量</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@Rocky8-2 postgresql-15.3]# vim /etc/profile.d/pgsql.sh<br>export PGHOME=/apps/pgsql<br>export PATH=$PGHOME/bin/:$PATH<br>export PGDATA=/pgsql/data<br>export PGUSER=postgres<br>export MANPATH=/apps/pgsql/share/man:$MANPATH<br><br>[root@Rocky8-2 postgresql-15.3]# . /etc/profile.d/pgsql.sh<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># 验证</span></span><br>[root@Rocky8-2 postgresql-15.3]# psql --version<br>psql (PostgreSQL) 15.3<br></code></pre></td></tr></table></figure><h5 id="初始化数据库"><a href="#初始化数据库" class="headerlink" title="初始化数据库"></a>初始化数据库</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#  生产环境建议初始化方式</span></span><br>[root@Rocky8-2 postgresql-15.3]# su - postgres <br>[postgres@Rocky8-2 ~]$ initdb  -A md5  -D $PGDATA  -E utf8  --locale=C  -U postgres -W <br>The files belonging to this database system will be owned by user &quot;postgres&quot;.<br>This user must also own the server process.<br><br>The database cluster will be initialized with locale &quot;C&quot;.<br>The default text search configuration will be set to &quot;english&quot;.<br><br>Data page checksums are disabled.<br><br>Enter new superuser password: <br>Enter it again: <br><br>fixing permissions on existing directory /pgsql/data ... ok<br>creating subdirectories ... ok<br>selecting dynamic shared memory implementation ... posix<br>selecting default max_connections ... 100<br>selecting default shared_buffers ... 128MB<br>selecting default time zone ... Asia/Shanghai<br>creating configuration files ... ok<br>running bootstrap script ... ok<br>performing post-bootstrap initialization ... ok<br>syncing data to disk ... ok<br><br>Success. You can now start the database server using:<br><br>    pg_ctl -D /pgsql/data -l logfile start<br><br></code></pre></td></tr></table></figure><blockquote><p>-A指定local connections默认的身份验证方法</p><p>-D指定数据目录</p><p>-E指定字符集</p><p>–local&#x3D;C 指定语言环境</p><p>-U指定数据库superuser用户名</p><p>-W指定数据库superuser密码</p></blockquote><h5 id="启动和关闭服务"><a href="#启动和关闭服务" class="headerlink" title="启动和关闭服务"></a>启动和关闭服务</h5><blockquote><p>需要使用 postgres 用户</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#  启动数据库</span></span><br>[postgres@Rocky8-2 ~]$ pg_ctl -D /pgsql/data -l /pgsql/log/logfile  start<br>waiting for server to start.... done<br>server started<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#  关闭数据库</span></span><br>1、smart 关闭：等所有连接中止后，关闭数据库。如果客户端连接不终止，则无法关闭数据库<br>[postgres@Rocky8-2 ~]$ pg_ctl  stop  -D /pgsql/data/ -ms<br><br>2、fast 关闭：快速关闭数据库，断开客户端的连接，让已有的事务回滚，然后正常关闭数据库。此项为默认值，建议使用<br>[postgres@Rocky8-2 ~]$ pg_ctl  stop  -D /pgsql/data/ -mf<br>waiting for server to shut down.... done<br>server stopped<br><br>3、immediate: 相当于 kill -9,立即关闭数据库，数据库进程立即停止，直接退出，下次启动数据库需要进行恢复。<br>[postgres@Rocky8-2 ~]$ pg_ctl  stop  -D /pgsql/data/ -mi<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#  重启数据库</span></span> <br>[postgres@Rocky8-2 ~]$ pg_ctl  restart  -l /pgsql/log/logfile  -mf<br>pg_ctl: PID file &quot;/pgsql/data/postmaster.pid&quot; does not exist<br>Is server running?<br>trying to start server anyway<br>waiting for server to start.... done<br>server started<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#  修改配置后重新加载配置</span></span><br>[postgres@Rocky8-2 ~]$ pg_ctl  reload  -D /pgsql/data <br></code></pre></td></tr></table></figure><h5 id="开机启动脚本"><a href="#开机启动脚本" class="headerlink" title="开机启动脚本"></a>开机启动脚本</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#  源码包中自带的启动服务脚本</span></span><br>[root@Rocky8-2 ~]# cat ./postgresql-15.3/contrib/start-scripts/linux <br><br>[root@Rocky8-2 ~]# cp ./postgresql-15.3/contrib/start-scripts/linux /etc/init.d/postgresql<br>[root@Rocky8-2 ~]# ll /etc/init.d/postgresql<br>-rw-r--r-- 1 root root 3552 Aug  7 14:54 /etc/init.d/postgresql<br>[root@Rocky8-2 ~]# chmod +x /etc/init.d/postgresql<br>[root@Rocky8-2 ~]# chkconfig --add postgresql <br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#  修改启动参数</span></span><br>[root@Rocky8-2 ~]# vim /etc/init.d/postgresql<br><span class="hljs-meta prompt_"># </span><span class="language-bash">Installation prefix</span><br>prefix=/apps/pgsql<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">Data directory</span><br>PGDATA=&quot;/pgsql/data&quot;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">Who to run the postmaster as, usually <span class="hljs-string">&quot;postgres&quot;</span>.  (NOT <span class="hljs-string">&quot;root&quot;</span>)</span><br>PGUSER=postgres<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">Where to keep a <span class="hljs-built_in">log</span> file</span><br>PGLOG=&quot;/pgsql/log/logfile&quot;<br><br><br>[root@Rocky8-2 ~]# service postgresql start <br>Starting PostgreSQL: ok<br></code></pre></td></tr></table></figure><h5 id="service-启动文件"><a href="#service-启动文件" class="headerlink" title="service 启动文件"></a>service 启动文件</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@Rocky8-2 ~]# cat  &gt; /lib/systemd/system/postgresql.service &lt;&lt;EOF<br>[Unit]<br>Description=PostgreSQL database server<br><br>[Service]<br>Type=forking<br>User=postgres<br>Group=postgres<br>ExecStart=/apps/pgsql/bin/pg_ctl start -D /pgsql/data -l /pgsql/log/logfile  -s -w -t 300<br>ExecStop=/apps/pgsql/bin/pg_ctl stop -D /pgsql/data -s -m fast<br>ExecReload=/apps/pgsql/bin/pg_ctl reload -D /pgsql/data -s<br>TimeoutSec=300<br><br>[Install]<br>WantedBy=multi-user.target<br><br>EOF<br><br><br>[root@Rocky8-2 ~]# cat /usr/lib/systemd/system/postgresql.service<br>[Unit]<br>Description=PostgreSQL database server<br><br>[Service]<br>Type=forking<br>User=postgres<br>Group=postgres<br>ExecStart=/apps/pgsql/bin/pg_ctl start -D /pgsql/data -l /pgsql/log/logfile  -s -w -t 300<br>ExecStop=/apps/pgsql/bin/pg_ctl stop -D /pgsql/data -s -m fast<br>ExecReload=/apps/pgsql/bin/pg_ctl reload -D /pgsql/data -s<br>TimeoutSec=300<br><br>[Install]<br>WantedBy=multi-user.target<br><br>[root@Rocky8-2 ~]# systemctl daemon-reload <br>[root@Rocky8-2 ~]# ss -ntl <br>State                 Recv-Q                Send-Q                               Local Address:Port                                Peer Address:Port                Process                <br>LISTEN                0                     128                                        0.0.0.0:111                                      0.0.0.0:*                                          <br>LISTEN                0                     128                                        0.0.0.0:22                                       0.0.0.0:*                                          <br>LISTEN                0                     128                                           [::]:111                                         [::]:*                                          <br>LISTEN                0                     128                                           [::]:22                                          [::]:*                                          <br>[root@Rocky8-2 ~]# systemctl start postgresql.service <br>[root@Rocky8-2 ~]# systemctl status  postgresql.service <br>● postgresql.service - PostgreSQL database server<br>   Loaded: loaded (/usr/lib/systemd/system/postgresql.service; enabled; vendor preset: disabled)<br>   Active: active (running) since Wed 2023-08-16 17:09:56 CST; 10s ago<br>  Process: 2433 ExecStop=/apps/pgsql/bin/pg_ctl stop -D /pgsql/data -s -m fast (code=exited, status=0/SUCCESS)<br>  Process: 2430 ExecReload=/apps/pgsql/bin/pg_ctl reload -D /pgsql/data -s (code=exited, status=0/SUCCESS)<br>  Process: 2439 ExecStart=/apps/pgsql/bin/pg_ctl start -D /pgsql/data -l /pgsql/log/logfile -s -w -t 300 (code=exited, status=0/SUCCESS)<br> Main PID: 2441 (postgres)<br>    Tasks: 6 (limit: 12160)<br>   Memory: 14.8M<br>   CGroup: /system.slice/postgresql.service<br>           ├─2441 /apps/pgsql/bin/postgres -D /pgsql/data<br>           ├─2442 postgres: checkpointer <br>           ├─2443 postgres: background writer <br>           ├─2445 postgres: walwriter <br>           ├─2446 postgres: autovacuum launcher <br>           └─2447 postgres: logical replication launcher <br><br>Aug 16 17:09:56 Rocky8-2.xcjyc.top systemd[1]: Starting PostgreSQL database server...<br>Aug 16 17:09:56 Rocky8-2.xcjyc.top systemd[1]: Started PostgreSQL database server.<br>[root@Rocky8-2 ~]# ss -ntlp <br>State           Recv-Q          Send-Q                   Local Address:Port                   Peer Address:Port         Process                       <br>LISTEN          0               128                            0.0.0.0:111                         0.0.0.0:*             users:((&quot;rpcbind&quot;,pid=832,fd=4),(&quot;systemd&quot;,pid=1,fd=88))          <br>LISTEN          0               128                            0.0.0.0:22                          0.0.0.0:*             users:((&quot;sshd&quot;,pid=900,fd=3))                                     <br>LISTEN          0               244                          127.0.0.1:5432                        0.0.0.0:*             users:((&quot;postgres&quot;,pid=2441,fd=6))                                <br>LISTEN          0               128                               [::]:111                            [::]:*             users:((&quot;rpcbind&quot;,pid=832,fd=6),(&quot;systemd&quot;,pid=1,fd=90))          <br>LISTEN          0               128                               [::]:22                             [::]:*             users:((&quot;sshd&quot;,pid=900,fd=4))                                     <br>LISTEN          0               244                              [::1]:5432                           [::]:*             users:((&quot;postgres&quot;,pid=2441,fd=5))                                <br><br></code></pre></td></tr></table></figure><h5 id="查看编译参数"><a href="#查看编译参数" class="headerlink" title="查看编译参数"></a>查看编译参数</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@Rocky8-2 ~]# pg_config <br>BINDIR = /apps/pgsql/bin<br>DOCDIR = /apps/pgsql/share/doc<br>HTMLDIR = /apps/pgsql/share/doc<br>INCLUDEDIR = /apps/pgsql/include<br>PKGINCLUDEDIR = /apps/pgsql/include<br>INCLUDEDIR-SERVER = /apps/pgsql/include/server<br>LIBDIR = /apps/pgsql/lib<br>PKGLIBDIR = /apps/pgsql/lib<br>LOCALEDIR = /apps/pgsql/share/locale<br>MANDIR = /apps/pgsql/share/man<br>SHAREDIR = /apps/pgsql/share<br>SYSCONFDIR = /apps/pgsql/etc<br>PGXS = /apps/pgsql/lib/pgxs/src/makefiles/pgxs.mk<br>CONFIGURE =  &#x27;--prefix=/apps/pgsql&#x27; &#x27;--with-pgport=5432&#x27;<br>CC = gcc<br>CPPFLAGS = -D_GNU_SOURCE<br>CFLAGS = -Wall -Wmissing-prototypes -Wpointer-arith -Wdeclaration-after-statement -Werror=vla -Wendif-labels -Wmissing-format-attribute -Wimplicit-fallthrough=3 -Wcast-function-type -Wformat-security -fno-strict-aliasing -fwrapv -fexcess-precision=standard -Wno-format-truncation -Wno-stringop-truncation -O2<br>CFLAGS_SL = -fPIC<br>LDFLAGS = -Wl,--as-needed -Wl,-rpath,&#x27;/apps/pgsql/lib&#x27;,--enable-new-dtags<br>LDFLAGS_EX = <br>LDFLAGS_SL = <br>LIBS = -lpgcommon -lpgport -lz -lreadline -lpthread -lrt -ldl -lm <br>VERSION = PostgreSQL 15.3<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>PostgreSQL</category>
      
    </categories>
    
    
    <tags>
      
      <tag>init</tag>
      
      <tag>PostgreSQL</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>PXC(Percona XtraDB Cluster)8.0.32集群</title>
    <link href="/2023/07/14/MySQl%E5%A4%9A%E4%B8%BB%E9%9B%86%E7%BE%A4PXC/"/>
    <url>/2023/07/14/MySQl%E5%A4%9A%E4%B8%BB%E9%9B%86%E7%BE%A4PXC/</url>
    
    <content type="html"><![CDATA[<h3 id="PXC简介"><a href="#PXC简介" class="headerlink" title="PXC简介"></a>PXC简介</h3><p>PXC是Percona XtraDB Cluster的缩写，是 Percona 公司出品的免费MySQL集群产品。PXC的作用是通过mysql自带的Galera集群技术，将不同的mysql实例连接起来，实现多主集群。在PXC集群中每个mysql节点都是可读可写的，也就是主从概念中的主节点，不存在只读的节点。<br>Percona Server是MySQL的改进版本，使用 XtraDB 存储引擎，在功能和性能上较 MySQL 有着很显著的提升，如提升了在高负载情况下的 InnoDB 的性能，为 DBA 提供了一些非常有用的性能诊断工具，另外有更多的参数和命令来控制服务器行为。<br>PXC 是一套 MySQL 高可用集群解决方案，与传统的基于主从复制模式的集群架构相比 PXC 最突出特点就是解决了诟病已久的数据复制延迟问题，基本上可以达到实时同步。而且节点与节点之间，他们相互的关系是对等的。PXC 最关注的是数据的一致性，对待事物的行为时，要么在所有节点上执行，要么都不执行，它的实现机制决定了它对待一致性的行为非常严格，这也能非常完美的保证 MySQL 集群的数据一致性；</p><h3 id="PXC特性和优点"><a href="#PXC特性和优点" class="headerlink" title="PXC特性和优点"></a>PXC特性和优点</h3><p>A. 完全兼容 MySQL。<br>B. 同步复制，事务要么在所有节点提交或不提交。<br>C. 多主复制，可以在任意节点进行写操作。<br>D. 在从服务器上并行应用事件，真正意义上的并行复制。<br>E. 节点自动配置，数据一致性，不再是异步复制。<br>F. 故障切换：因为支持多点写入，所以在出现数据库故障时可以很容易的进行故障切换。<br>G. 自动节点克隆：在新增节点或停机维护时，增量数据或基础数据不需要人工手动备份提供，galera cluster会自动拉取在线节点数据，集群最终会变为一致；</p><p>PXC最大的优势：强一致性、无同步延迟</p><h3 id="PXC的局限和劣势"><a href="#PXC的局限和劣势" class="headerlink" title="PXC的局限和劣势"></a>PXC的局限和劣势</h3><ol><li>复制只支持InnoDB 引擎，其他存储引擎的更改不复制</li><li>写入效率取决于节点中最慢的一台</li></ol><h3 id="PXC-常用端口"><a href="#PXC-常用端口" class="headerlink" title="PXC 常用端口"></a>PXC 常用端口</h3><ol><li>3306：数据库对外服务的端口号。</li><li>4444：请求SST的端口。</li><li>4567：组成员之间进行沟通的一个端口号</li><li>4568：用于传输IST。</li></ol><p>名词解释：<br>SST(State Snapshot Transfer): 全量传输<br>IST(Incremental state Transfer):增量传输</p><h3 id="实验环境"><a href="#实验环境" class="headerlink" title="实验环境"></a>实验环境</h3><table><thead><tr><th align="center">节点</th><th align="center">主机名</th><th align="center">IP</th><th>描述</th></tr></thead><tbody><tr><td align="center">节点1</td><td align="center">Rocky8-1</td><td align="center">10.0.0.11</td><td>PXC集群节点1</td></tr><tr><td align="center">节点2</td><td align="center">Rocky8-2</td><td align="center">10.0.0.12</td><td>PXC集群节点1</td></tr><tr><td align="center">节点3</td><td align="center">Rocky8-3</td><td align="center">10.0.0.13</td><td>PXC集群节点1</td></tr></tbody></table><h4 id="检查初始环境："><a href="#检查初始环境：" class="headerlink" title="检查初始环境："></a>检查初始环境：</h4><p>三个节点均采用最小化安装，配置好yum源，关掉防火墙和selinux</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">## Linux版本</span><br>[root@Rocky8-2 ~]<span class="hljs-comment"># cat /etc/centos-release</span><br>Rocky Linux release 8.8 (Green Obsidian)<br><br><span class="hljs-comment">## 防火墙</span><br>[root@Rocky8-2 ~]<span class="hljs-comment"># systemctl status firewalld</span><br>● firewalld.service - firewalld - dynamic firewall daemon<br>   Loaded: loaded (/usr/lib/systemd/system/firewalld.service; disabled; vendor preset: enabled)<br>   Active: inactive (dead)<br>     Docs: man:firewalld(1)<br>     <br><span class="hljs-comment">## selinux     </span><br>[root@Rocky8-2 ~]<span class="hljs-comment"># sestatus</span><br>SELinux status:                 disabled<br></code></pre></td></tr></table></figure><h4 id="从-Percona-仓库安装"><a href="#从-Percona-仓库安装" class="headerlink" title="从 Percona 仓库安装"></a>从 Percona 仓库安装</h4><p>三个节点同时安装，以下以节点3为例</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">## 配置yum源</span><br>[root@Rocky8-3 ~]<span class="hljs-comment"># yum install -y https://repo.percona.com/yum/percona-release-latest.noarch.rpm</span><br>......<br>Installed:<br>  percona-release-1.0-27.noarch                                                                                                                       <br>Complete!<br><br><span class="hljs-comment">## 设置仓库</span><br>[root@Rocky8-3 ~]<span class="hljs-comment"># percona-release setup pxc80</span><br>Complete!<br>DNF mysql module was disabled<br>* Enabling the Percona XtraDB Cluster 8.0 repository<br>* Enabling the Percona Tools repository<br>&lt;*&gt; All <span class="hljs-keyword">done</span>!<br><br>[root@Rocky8-3 ~]<span class="hljs-comment"># yum clean all ; yum makecache</span><br><br><span class="hljs-comment">## 安装</span><br>[root@Rocky8-1 ~]<span class="hljs-comment"># yum install -y  percona-xtradb-cluster</span><br>Installed:<br>  checkpolicy-2.9-1.el8.x86_64                                                         compat-openssl10-1:1.0.2o-4.el8_6.x86_64                       <br>  mariadb-connector-c-3.1.11-2.el8_3.x86_64                                            percona-xtradb-cluster-8.0.32-24.2.el8.x86_64                   <br>  percona-xtradb-cluster-client-8.0.32-24.2.el8.x86_64                                 percona-xtradb-cluster-icu-data-files-8.0.32-24.2.el8.x86_64   <br>  percona-xtradb-cluster-server-8.0.32-24.2.el8.x86_64                                 percona-xtradb-cluster-shared-8.0.32-24.2.el8.x86_64           <br>  percona-xtradb-cluster-shared-compat-8.0.32-24.2.el8.x86_64                          perl-DBD-MySQL-4.046-3.module+el8.6.0+904+ef468285.x86_64       <br>  perl-DBI-1.641-4.module+el8.6.0+891+677074cb.x86_64                                  perl-Math-BigInt-1:1.9998.11-7.el8.noarch                       <br>  perl-Math-Complex-1.59-422.el8.noarch                                                policycoreutils-python-utils-2.9-24.el8.noarch                 <br>  python2-2.7.18-13.module+el8.8.0+1314+be03569e.1.rocky.0.2.x86_64                    python2-libs-2.7.18-13.module+el8.8.0+1314+be03569e.1.rocky.0.2.x86_64   <br>  python2-pip-9.0.3-19.module+el8.6.0+793+57002515.noarch                              python2-pip-wheel-9.0.3-19.module+el8.6.0+793+57002515.noarch   <br>  python2-setuptools-39.0.1-13.module+el8.4.0+403+9ae17a31.noarch                      python2-setuptools-wheel-39.0.1-13.module+el8.4.0+403+9ae17a31.noarch                    <br>  python3-audit-3.0.7-4.el8.x86_64                                                     python3-libsemanage-2.9-9.el8_6.x86_64                         <br>  python3-policycoreutils-2.9-24.el8.noarch                                            python3-setools-4.3.0-3.el8.x86_64                             <br>  qpress-20220819-3.el8.x86_64                                                         socat-1.7.4.1-1.el8.x86_64                                     <br>Complete!<br></code></pre></td></tr></table></figure><h4 id="初始化第一个节点的mysql服务"><a href="#初始化第一个节点的mysql服务" class="headerlink" title="初始化第一个节点的mysql服务"></a>初始化第一个节点的mysql服务</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">## 启动 Percona XtraDB Cluster 服务</span><br>[root@Rocky8-1 ~]<span class="hljs-comment"># systemctl start mysqld</span><br><br><span class="hljs-comment">## 查找 mysql 数据库的 root 的临时密码</span><br>[root@Rocky8-1 ~]<span class="hljs-comment"># grep &#x27;temporary password&#x27; /var/log/mysqld.log</span><br>2023-07-14T03:27:22.398733Z 6 [Note] [MY-010454] [Server] A temporary password is generated <span class="hljs-keyword">for</span> root@localhost: msobz!t<span class="hljs-comment">#q18J</span><br><br><span class="hljs-comment">## 使用临时密码登录 MySQL</span><br>[root@Rocky8-1 ~]<span class="hljs-comment"># mysql -uroot -p&#x27;msobz!t#q18J&#x27;</span><br><br><span class="hljs-comment">## 更改 root 用户的密码</span><br>mysql&gt; ALTER USER <span class="hljs-string">&#x27;root&#x27;</span>@<span class="hljs-string">&#x27;localhost&#x27;</span> IDENTIFIED BY <span class="hljs-string">&#x27;123456&#x27;</span>;<br>Query OK, 0 rows affected (0.04 sec)<br><br><span class="hljs-comment">## 重新登录mysql</span><br>[root@Rocky8-1 ~]<span class="hljs-comment"># mysql -uroot -p&#x27;123456&#x27;</span><br>mysql: [Warning] Using a password on the <span class="hljs-built_in">command</span> line interface can be insecure.<br>Welcome to the MySQL monitor.  Commands end with ; or \g.<br>Your MySQL connection <span class="hljs-built_in">id</span> is 20<br>Server version: 8.0.32-24.2 Percona XtraDB Cluster (GPL), Release rel24, Revision 2119e75, WSREP version 26.1.4.3<br><br>Copyright (c) 2009-2023 Percona LLC and/or its affiliates<br>Copyright (c) 2000, 2023, Oracle and/or its affiliates.<br><br>Oracle is a registered trademark of Oracle Corporation and/or its<br>affiliates. Other names may be trademarks of their respective<br>owners.<br><br>Type <span class="hljs-string">&#x27;help;&#x27;</span> or <span class="hljs-string">&#x27;\h&#x27;</span> <span class="hljs-keyword">for</span> <span class="hljs-built_in">help</span>. Type <span class="hljs-string">&#x27;\c&#x27;</span> to clear the current input statement.<br><br>mysql&gt; <br><br><span class="hljs-comment">## 关闭 MySQL 服务</span><br>[root@Rocky8-1 ~]<span class="hljs-comment"># systemctl stop mysqld</span><br></code></pre></td></tr></table></figure><h4 id="初始化PXC的配置文件"><a href="#初始化PXC的配置文件" class="headerlink" title="初始化PXC的配置文件"></a>初始化PXC的配置文件</h4><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs autoit">[root<span class="hljs-symbol">@Rocky8</span><span class="hljs-number">-1</span> ~]<span class="hljs-meta"># vim /etc/my.cnf</span><br></code></pre></td></tr></table></figure><p><img src="https://xcj-typora-img.oss-cn-hangzhou.aliyuncs.com/img/20230714133543.png" alt="20230714133543"></p><p>主要修改如下配置</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 集群通讯地址</span><br>wsrep_cluster_address=gcomm://10.0.0.11,10.0.0.12,10.0.0.13<br><span class="hljs-comment"># 本节点的地址</span><br>wsrep_node_address=10.0.0.11<br><span class="hljs-comment"># 本节点的名称</span><br>wsrep_node_name=pxc-cluster-node-1<br><br><span class="hljs-comment">## 在配置最后加上一行如下配置，作用是关闭传输加密</span><br>pxc-encrypt-cluster-traffic=OFF<br></code></pre></td></tr></table></figure><blockquote><p>注意：关闭传输加密，参考 <a href="https://www.percona.com/doc/percona-xtradb-cluster/8.0/security/encrypt-traffic.html">Encrypting PXC Traffic</a><br>pxc-encrypt-cluster-traffic&#x3D;OFF</p></blockquote><blockquote><h4 id="配置文件参考："><a href="#配置文件参考：" class="headerlink" title="配置文件参考："></a>配置文件参考：</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs sh">[root@Rocky8-1 ~]<span class="hljs-comment"># cat /etc/my.cnf</span><br><span class="hljs-comment"># Template my.cnf for PXC</span><br><span class="hljs-comment"># Edit to your requirements.</span><br>[client]<br>socket=/var/lib/mysql/mysql.sock<br><br>[mysqld]<br>server-id=1<br>datadir=/var/lib/mysql<br>socket=/var/lib/mysql/mysql.sock<br>log-error=/var/log/mysqld.log<br>pid-file=/var/run/mysqld/mysqld.pid<br><br><span class="hljs-comment"># Binary log expiration period is 604800 seconds, which equals 7 days</span><br>binlog_expire_logs_seconds=604800<br><br><span class="hljs-comment">######## wsrep ###############</span><br><span class="hljs-comment"># Path to Galera library</span><br>wsrep_provider=/usr/lib64/galera4/libgalera_smm.so<br><br><span class="hljs-comment"># Cluster connection URL contains IPs of nodes</span><br><span class="hljs-comment">#If no IP is found, this implies that a new cluster needs to be created,</span><br><span class="hljs-comment">#in order to do that you need to bootstrap this node</span><br>wsrep_cluster_address=gcomm://10.0.0.11,10.0.0.12,10.0.0.13<br><br><span class="hljs-comment"># In order for Galera to work correctly binlog format should be ROW</span><br>binlog_format=ROW<br><br><span class="hljs-comment"># Slave thread to use</span><br>wsrep_slave_threads=8<br><br>wsrep_log_conflicts<br><br><span class="hljs-comment"># This changes how InnoDB autoincrement locks are managed and is a requirement for Galera</span><br>innodb_autoinc_lock_mode=2<br><br><span class="hljs-comment"># Node IP address</span><br>wsrep_node_address=10.0.0.11<br><span class="hljs-comment"># Cluster name</span><br>wsrep_cluster_name=pxc-mysql<br><br><span class="hljs-comment">#If wsrep_node_name is not specified,  then system hostname will be used</span><br>wsrep_node_name=pxc-mysql-node-1<br><br><span class="hljs-comment">#pxc_strict_mode allowed values: DISABLED,PERMISSIVE,ENFORCING,MASTER</span><br>pxc_strict_mode=ENFORCING<br><br><span class="hljs-comment"># SST method</span><br>wsrep_sst_method=xtrabackup-v2<br><br>pxc-encrypt-cluster-traffic=OFF<br>[root@Rocky8-1 ~]<span class="hljs-comment"># </span><br></code></pre></td></tr></table></figure></blockquote><h4 id="启动集群第一个节点"><a href="#启动集群第一个节点" class="headerlink" title="启动集群第一个节点"></a>启动集群第一个节点</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">## 启动集群第一个node（在前面初始化过mysql的节点执行）</span><br>[root@Rocky8-1 ~]<span class="hljs-comment"># systemctl start mysql@bootstrap</span><br><br><span class="hljs-comment">## 登录mysql,查看集群状态</span><br>[root@Rocky8-1 ~]<span class="hljs-comment"># mysql -uroot -p123456</span><br><br>mysql&gt; show status like <span class="hljs-string">&#x27;wsrep%&#x27;</span>;<br>+----------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------+<br>| Variable_name                    | Value                                                                                                                                          |<br>+----------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------+<br>| wsrep_local_state_uuid           | 5dcd8a83-21f6-11ee-a89b-1b2bd4cfd52b                                                                                                           |<br>| wsrep_protocol_version           | 10                                                                                                                                             |<br>| wsrep_last_applied               | 3                                                                                                                                              |<br>| wsrep_last_committed             | 3                                                                                                                                              |<br>| wsrep_monitor_status (L/A/C)     | [ (2, 2), (3, 3), (3, 3) ]                                                                                                                     |<br>| wsrep_replicated                 | 0                                                                                                                                              |<br>| wsrep_replicated_bytes           | 0                                                                                                                                              |<br>| wsrep_repl_keys                  | 0                                                                                                                                              |<br>| wsrep_repl_keys_bytes            | 0                                                                                                                                              |<br>| wsrep_repl_data_bytes            | 0                                                                                                                                              |<br>| wsrep_repl_other_bytes           | 0                                                                                                                                              |<br>| wsrep_received                   | 2                                                                                                                                              |<br>| wsrep_received_bytes             | 152                                                                                                                                            |<br>| wsrep_local_commits              | 0                                                                                                                                              |<br>| wsrep_local_cert_failures        | 0                                                                                                                                              |<br>| wsrep_local_replays              | 0                                                                                                                                              |<br>| wsrep_local_send_queue           | 0                                                                                                                                              |<br>| wsrep_local_send_queue_max       | 2                                                                                                                                              |<br>| wsrep_local_send_queue_min       | 0                                                                                                                                              |<br>| wsrep_local_send_queue_avg       | 0.5                                                                                                                                            |<br>| wsrep_local_recv_queue           | 0                                                                                                                                              |<br>| wsrep_local_recv_queue_max       | 2                                                                                                                                              |<br>| wsrep_local_recv_queue_min       | 0                                                                                                                                              |<br>| wsrep_local_recv_queue_avg       | 0.5                                                                                                                                            |<br>| wsrep_local_cached_downto        | 1                                                                                                                                              |<br>| wsrep_flow_control_paused_ns     | 0                                                                                                                                              |<br>| wsrep_flow_control_paused        | 0                                                                                                                                              |<br>| wsrep_flow_control_sent          | 0                                                                                                                                              |<br>| wsrep_flow_control_recv          | 0                                                                                                                                              |<br>| wsrep_flow_control_active        | <span class="hljs-literal">false</span>                                                                                                                                          |<br>| wsrep_flow_control_requested     | <span class="hljs-literal">false</span>                                                                                                                                          |<br>| wsrep_flow_control_interval      | [ 100, 100 ]                                                                                                                                   |<br>| wsrep_flow_control_interval_low  | 100                                                                                                                                            |<br>| wsrep_flow_control_interval_high | 100                                                                                                                                            |<br>| wsrep_flow_control_status        | OFF                                                                                                                                            |<br>| wsrep_cert_deps_distance         | 0                                                                                                                                              |<br>| wsrep_apply_oooe                 | 0                                                                                                                                              |<br>| wsrep_apply_oool                 | 0                                                                                                                                              |<br>| wsrep_apply_window               | 0                                                                                                                                              |<br>| wsrep_apply_waits                | 0                                                                                                                                              |<br>| wsrep_commit_oooe                | 0                                                                                                                                              |<br>| wsrep_commit_oool                | 0                                                                                                                                              |<br>| wsrep_commit_window              | 0                                                                                                                                              |<br>| wsrep_local_state                | 4                                                                                                                                              |<br>| wsrep_local_state_comment        | Synced                                                                                                                                         |<br>| wsrep_cert_index_size            | 0                                                                                                                                              |<br>| wsrep_cert_bucket_count          | 1                                                                                                                                              |<br>| wsrep_gcache_pool_size           | 1912                                                                                                                                           |<br>| wsrep_causal_reads               | 0                                                                                                                                              |<br>| wsrep_cert_interval              | 0                                                                                                                                              |<br>| wsrep_open_transactions          | 0                                                                                                                                              |<br>| wsrep_open_connections           | 0                                                                                                                                              |<br>| wsrep_ist_receive_status         |                                                                                                                                                |<br>| wsrep_ist_receive_seqno_start    | 0                                                                                                                                              |<br>| wsrep_ist_receive_seqno_current  | 0                                                                                                                                              |<br>| wsrep_ist_receive_seqno_end      | 0                                                                                                                                              |<br>| wsrep_incoming_addresses         | 10.0.0.11:3306                                                                                                                                 |<br>| wsrep_cluster_weight             | 1                                                                                                                                              |<br>| wsrep_desync_count               | 0                                                                                                                                              |<br>| wsrep_evs_delayed                |                                                                                                                                                |<br>| wsrep_evs_evict_list             |                                                                                                                                                |<br>| wsrep_evs_repl_latency           | 0/0/0/0/0                                                                                                                                      |<br>| wsrep_evs_state                  | OPERATIONAL                                                                                                                                    |<br>| wsrep_gcomm_uuid                 | aa3fd407-2209-11ee-bbf7-c23e28e1454d                                                                                                           |<br>| wsrep_gmcast_segment             | 0                                                                                                                                              |<br>| wsrep_cluster_capabilities       |                                                                                                                                                |<br>| wsrep_cluster_conf_id            | 1                                                                                                                                              |<br>| wsrep_cluster_size               | 1                                                                                                                                              |<br>| wsrep_cluster_state_uuid         | 5dcd8a83-21f6-11ee-a89b-1b2bd4cfd52b                                                                                                           |<br>| wsrep_cluster_status             | Primary                                                                                                                                        |<br>| wsrep_connected                  | ON                                                                                                                                             |<br>| wsrep_local_bf_aborts            | 0                                                                                                                                              |<br>| wsrep_local_index                | 0                                                                                                                                              |<br>| wsrep_provider_capabilities      | :MULTI_MASTER:CERTIFICATION:PARALLEL_APPLYING:TRX_REPLAY:ISOLATION:PAUSE:CAUSAL_READS:INCREMENTAL_WRITESET:UNORDERED:PREORDERED:STREAMING:NBO: |<br>| wsrep_provider_name              | Galera                                                                                                                                         |<br>| wsrep_provider_vendor            | Codership Oy &lt;info@codership.com&gt; (modified by Percona &lt;https://percona.com/&gt;)                                                                 |<br>| wsrep_provider_version           | 4.14(779b689)                                                                                                                                  |<br>| wsrep_ready                      | ON                                                                                                                                             |<br>| wsrep_thread_count               | 9                                                                                                                                              |<br>+----------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------+<br>79 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.05 sec)<br><br><span class="hljs-comment">## 查看当前节点数量、状态</span><br>mysql&gt; show status like <span class="hljs-string">&#x27;wsrep_cluster_size&#x27;</span>;<br>+--------------------+-------+<br>| Variable_name      | Value |<br>+--------------------+-------+<br>| wsrep_cluster_size | 1     |<br>+--------------------+-------+<br>1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br><br>mysql&gt; show status like <span class="hljs-string">&#x27;wsrep_cluster_status&#x27;</span>;<br>+----------------------+---------+<br>| Variable_name        | Value   |<br>+----------------------+---------+<br>| wsrep_cluster_status | Primary |<br>+----------------------+---------+<br>1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.01 sec)<br><br>mysql&gt; show status like <span class="hljs-string">&#x27;wsrep_connected&#x27;</span>;<br>+-----------------+-------+<br>| Variable_name   | Value |<br>+-----------------+-------+<br>| wsrep_connected | ON    |<br>+-----------------+-------+<br>1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br></code></pre></td></tr></table></figure><h4 id="添加其它节点"><a href="#添加其它节点" class="headerlink" title="添加其它节点"></a>添加其它节点</h4><ol><li>所有其他节点的数据和配置都会被第一个节点的数据覆盖</li><li>不要同时加入多个节点，避免数据或网络开销过大</li></ol><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">[root@Rocky8-2 ~]<span class="hljs-comment"># systemctl start mysqld</span><br></code></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">[root@Rocky8-3 ~]<span class="hljs-comment"># systemctl start mysqld</span><br></code></pre></td></tr></table></figure><h4 id="查看集群状态"><a href="#查看集群状态" class="headerlink" title="查看集群状态"></a>查看集群状态</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sh">mysql&gt; show status like <span class="hljs-string">&#x27;wsrep_cluster_size&#x27;</span>;<br>+--------------------+-------+<br>| Variable_name      | Value |<br>+--------------------+-------+<br>| wsrep_cluster_size | 3     |<br>+--------------------+-------+<br>1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br><br></code></pre></td></tr></table></figure><h4 id="停止从节点"><a href="#停止从节点" class="headerlink" title="停止从节点"></a>停止从节点</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sh">[root@Rocky8-3 ~]<span class="hljs-comment"># systemctl stop mysqld</span><br><br><span class="hljs-comment">##  集群状态</span><br>mysql&gt; show status like <span class="hljs-string">&#x27;wsrep_cluster_size&#x27;</span>;<br>+--------------------+-------+<br>| Variable_name      | Value |<br>+--------------------+-------+<br>| wsrep_cluster_size | 2     |<br>+--------------------+-------+<br>1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br></code></pre></td></tr></table></figure><h4 id="停止主节点"><a href="#停止主节点" class="headerlink" title="停止主节点"></a>停止主节点</h4><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ruby">[root<span class="hljs-variable">@Rocky8</span>-<span class="hljs-number">1</span> ~]<span class="hljs-comment"># systemctl stop mysql<span class="hljs-doctag">@bootstrap</span></span><br></code></pre></td></tr></table></figure><blockquote><p>参考：</p><p>官方文档：<a href="https://docs.percona.com/percona-xtradb-cluster/8.0/install/index.html">Install Percona XtraDB Cluster - Percona XtraDB Cluster</a></p><p><a href="https://qizhanming.com/blog/2020/06/22/how-to-install-percona-xtradb-cluster-on-centos-8">CentOS 8 安装 Percona XtraDB Cluster 8.0 - Zhanming’s blog (qizhanming.com)</a></p><p><a href="https://segmentfault.com/a/1190000037760128">分布式高可用Mysql数据库Percona XtraDB Cluster 8.0 与 Proxysql 史上最详尽用法指南 - 个人文章 - SegmentFault 思否</a></p></blockquote>]]></content>
    
    
    <categories>
      
      <category>MySQL</category>
      
    </categories>
    
    
    <tags>
      
      <tag>MariaDB</tag>
      
      <tag>MySQL</tag>
      
      <tag>PXC</tag>
      
      <tag>Cluster</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MySQL主从架构GTID复制</title>
    <link href="/2023/07/12/Mysql%E4%B8%BB%E4%BB%8E%E6%9E%B6%E6%9E%84GTID%E5%A4%8D%E5%88%B6/"/>
    <url>/2023/07/12/Mysql%E4%B8%BB%E4%BB%8E%E6%9E%B6%E6%9E%84GTID%E5%A4%8D%E5%88%B6/</url>
    
    <content type="html"><![CDATA[<h2 id="GTID（全局事务标识符）-MySQL-5-6开始支持，MySQL-5-7以上版本建议启用GTID功能"><a href="#GTID（全局事务标识符）-MySQL-5-6开始支持，MySQL-5-7以上版本建议启用GTID功能" class="headerlink" title="GTID（全局事务标识符）,MySQL 5.6开始支持，MySQL 5.7以上版本建议启用GTID功能"></a>GTID（全局事务标识符）,MySQL 5.6开始支持，MySQL 5.7以上版本建议启用GTID功能</h2><h3 id="GTID优点："><a href="#GTID优点：" class="headerlink" title="GTID优点："></a>GTID优点：</h3><ul><li>保证事务全局统一</li><li>截取日志更加方便。跨多文件，判断起点终点更加方便</li><li>判断主从工作状态更加方便</li><li>传输日志，可以并发传输。SQL回放可以更高并发</li><li>主从复制构建更加方便</li></ul><h3 id="相关选项："><a href="#相关选项：" class="headerlink" title="相关选项："></a>相关选项：</h3><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs clean">gtid_mode ## gtid模式<br>enforce_gtid_consistency ## 保证GTID安全的参数<br></code></pre></td></tr></table></figure><h4 id="配置案例："><a href="#配置案例：" class="headerlink" title="配置案例："></a>配置案例：</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">##  主节点配置</span><br>[root@Rocky8-2 ~]<span class="hljs-comment"># vim /etc/my.cnf.d/mysql.cnf </span><br>[mysqld]<br>server-id=12<br>gtid_mode=ON<br>enforce_gtid_consistency<br>log-bin=/binlog/mysql-bin<br><br><span class="hljs-comment">##  从节点配置</span><br>[root@Rocky8-3 ~]<span class="hljs-comment"># vim /etc/my.cnf.d/mysql.cnf</span><br>[mysqld]<br>server-id=13<br>gtid_mode=ON<br>enforce_gtid_consistency<br>log-bin=/binlog/mysql-bin<br>read-only<br><br><span class="hljs-comment">##  如果数据不一至，需要备份主库数据并还原到从库，</span><br>[root@Rocky8-2 ~]<span class="hljs-comment"># mysqldump -A -F --master-data=1 --single-transaction &gt; /data/all.sql</span><br>[root@Rocky8-2 ~]<span class="hljs-comment"># scp /data/all.sql  10.0.0.13:/data/</span><br><br>[root@Rocky8-3 ~]<span class="hljs-comment"># mysql</span><br>mysql&gt; <span class="hljs-built_in">set</span> sql_log_bin=off;<br>mysql&gt; <span class="hljs-built_in">source</span> /data/all.sql;<br>mysql&gt; <span class="hljs-built_in">set</span> sql_log_bin=on;<br><br><span class="hljs-comment">##  执行change master to</span><br>mysql&gt; CHANGE MASTER TO MASTER_HOST=<span class="hljs-string">&#x27;10.0.0.12&#x27;</span>,<br>    -&gt;     MASTER_USER=<span class="hljs-string">&#x27;repluser&#x27;</span>,<br>    -&gt;     MASTER_PASSWORD=<span class="hljs-string">&#x27;123456&#x27;</span>,<br>    -&gt;     MASTER_PORT=3306,<br>    -&gt;     MASTER_AUTO_POSITION=1;<br>Query OK, 0 rows affected, 8 warnings (0.03 sec)<br><br>mysql&gt; start slave;<br>Query OK, 0 rows affected, 1 warning (0.04 sec)<br><br><span class="hljs-comment">##  检查复制状态</span><br><span class="hljs-comment">##  观察 Slave_IO_Running: Yes 和 Slave_SQL_Running: Yes</span><br><br>mysql&gt; show  slave status \G<br>*************************** 1. row ***************************<br>               Slave_IO_State: Waiting <span class="hljs-keyword">for</span> <span class="hljs-built_in">source</span> to send event<br>                  Master_Host: 10.0.0.12<br>                  Master_User: repluser<br>                  Master_Port: 3306<br>                Connect_Retry: 60<br>              Master_Log_File: mysql-bin.000006<br>          Read_Master_Log_Pos: 157<br>               Relay_Log_File: Rocky8-3-relay-bin.000002<br>                Relay_Log_Pos: 373<br>        Relay_Master_Log_File: mysql-bin.000006<br>             Slave_IO_Running: Yes<br>            Slave_SQL_Running: Yes<br>...<br><br><span class="hljs-comment">##  主节点新建一个数据库：</span><br>mysql&gt; create database test1;<br>Query OK, 1 row affected (0.02 sec)<br><br><span class="hljs-comment">##  从节点同步</span><br>mysql&gt; show databases;<br>+--------------------+<br>| Database           |<br>+--------------------+<br>| hellodb            |<br>| information_schema |<br>| mysql              |<br>| performance_schema |<br>| sys                |<br>| test1              |<br>+--------------------+<br>6 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.01 sec)<br><br><span class="hljs-comment">##  主节点更新数据，观察同步状态，主要以观以下两个状态值</span><br><span class="hljs-comment">##  Retrieved_Gtid_Set</span><br><span class="hljs-comment">##  Executed_Gtid_Set</span><br><br><span class="hljs-comment">##  主节点观察状态</span><br>mysql&gt; show master status \G<br>*************************** 1. row ***************************<br>             File: mysql-bin.000006<br>         Position: 345<br>     Binlog_Do_DB: <br> Binlog_Ignore_DB: <br>Executed_Gtid_Set: 18bbcaa5-1fb3-11ee-bcd2-000c295891d3:1<br>1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.01 sec)<br><br><span class="hljs-comment">##  从节点观察状态</span><br>mysql&gt; show  slave status \G<br>*************************** 1. row ***************************<br>               Slave_IO_State: Waiting <span class="hljs-keyword">for</span> <span class="hljs-built_in">source</span> to send event<br>                  Master_Host: 10.0.0.12<br>                  Master_User: repluser<br>                  Master_Port: 3306<br>                Connect_Retry: 60<br>              Master_Log_File: mysql-bin.000006<br>          Read_Master_Log_Pos: 345<br>               Relay_Log_File: Rocky8-3-relay-bin.000002<br>                Relay_Log_Pos: 561<br>        Relay_Master_Log_File: mysql-bin.000006<br>             Slave_IO_Running: Yes<br>            Slave_SQL_Running: Yes<br>              Replicate_Do_DB: <br>          Replicate_Ignore_DB: <br>           Replicate_Do_Table: <br>       Replicate_Ignore_Table: <br>      Replicate_Wild_Do_Table: <br>  Replicate_Wild_Ignore_Table: <br>                   Last_Errno: 0<br>                   Last_Error: <br>                 Skip_Counter: 0<br>          Exec_Master_Log_Pos: 345<br>              Relay_Log_Space: 774<br>              Until_Condition: None<br>               Until_Log_File: <br>                Until_Log_Pos: 0<br>           Master_SSL_Allowed: No<br>           Master_SSL_CA_File: <br>           Master_SSL_CA_Path: <br>              Master_SSL_Cert: <br>            Master_SSL_Cipher: <br>               Master_SSL_Key: <br>        Seconds_Behind_Master: 0<br>Master_SSL_Verify_Server_Cert: No<br>                Last_IO_Errno: 0<br>                Last_IO_Error: <br>               Last_SQL_Errno: 0<br>               Last_SQL_Error: <br>  Replicate_Ignore_Server_Ids: <br>             Master_Server_Id: 12<br>                  Master_UUID: 18bbcaa5-1fb3-11ee-bcd2-000c295891d3<br>             Master_Info_File: mysql.slave_master_info<br>                    SQL_Delay: 0<br>          SQL_Remaining_Delay: NULL<br>      Slave_SQL_Running_State: Replica has <span class="hljs-built_in">read</span> all relay <span class="hljs-built_in">log</span>; waiting <span class="hljs-keyword">for</span> more updates<br>           Master_Retry_Count: 86400<br>                  Master_Bind: <br>      Last_IO_Error_Timestamp: <br>     Last_SQL_Error_Timestamp: <br>               Master_SSL_Crl: <br>           Master_SSL_Crlpath: <br>           Retrieved_Gtid_Set: 18bbcaa5-1fb3-11ee-bcd2-000c295891d3:1<br>            Executed_Gtid_Set: 18bbcaa5-1fb3-11ee-bcd2-000c295891d3:1<br>                Auto_Position: 1<br>         Replicate_Rewrite_DB: <br>                 Channel_Name: <br>           Master_TLS_Version: <br>       Master_public_key_path: <br>        Get_master_public_key: 0<br>            Network_Namespace: <br>1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span>, 1 warning (0.00 sec)<br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>MySQL</category>
      
    </categories>
    
    
    <tags>
      
      <tag>MariaDB</tag>
      
      <tag>MySQL</tag>
      
      <tag>Cluster</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Mycat实现MySQL读写分离</title>
    <link href="/2023/07/11/Mycat%E5%AE%9E%E7%8E%B0MySQL%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/"/>
    <url>/2023/07/11/Mycat%E5%AE%9E%E7%8E%B0MySQL%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/</url>
    
    <content type="html"><![CDATA[<h2 id="Mycat-数据库中间件，开源、面向企业的数据库集群。高可用集群方式有："><a href="#Mycat-数据库中间件，开源、面向企业的数据库集群。高可用集群方式有：" class="headerlink" title="Mycat:数据库中间件，开源、面向企业的数据库集群。高可用集群方式有："></a>Mycat:数据库中间件，开源、面向企业的数据库集群。高可用集群方式有：</h2><ul><li>keepalived + mycat + mysql</li><li>keepalived + lvs + mycat + mysql</li><li>keepalived + haproxy + mycat + mysql</li></ul><h2 id="实验：mycat-mysql实现数据库集群（mycat-1-6-7-6-release-版本）"><a href="#实验：mycat-mysql实现数据库集群（mycat-1-6-7-6-release-版本）" class="headerlink" title="实验：mycat + mysql实现数据库集群（mycat 1.6.7.6 release 版本）"></a>实验：mycat + mysql实现数据库集群（mycat 1.6.7.6 release 版本）</h2><p><img src="https://xcj-typora-img.oss-cn-hangzhou.aliyuncs.com/img/mycat.png" alt="mycat"></p><h4 id=""><a href="#" class="headerlink" title=""></a></h4><h4 id="安装数据库环境："><a href="#安装数据库环境：" class="headerlink" title="安装数据库环境："></a>安装数据库环境：</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sh">[root@Rocky8-2 ~]<span class="hljs-comment"># systemctl  status firewalld.service</span><br>● firewalld.service - firewalld - dynamic firewall daemon<br>   Loaded: loaded (/usr/lib/systemd/system/firewalld.service; disabled; vendor preset: enabled)<br>   Active: inactive (dead)<br>     Docs: man:firewalld(1)<br>[root@Rocky8-2 ~]<span class="hljs-comment"># getenforce </span><br>Disabled<br>[root@Rocky8-2 ~]<span class="hljs-comment"># yum install -y mysql-server</span><br></code></pre></td></tr></table></figure><h4 id="修改-master-和-slave-上的配置，配置主从数据库："><a href="#修改-master-和-slave-上的配置，配置主从数据库：" class="headerlink" title="修改 master 和 slave 上的配置，配置主从数据库："></a>修改 master 和 slave 上的配置，配置主从数据库：</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">##  master</span><br>[root@Rocky8-2 ~]<span class="hljs-comment"># mkdir /binlog</span><br>[root@Rocky8-2 ~]<span class="hljs-comment"># chown mysql. /binlog/</span><br>[root@Rocky8-2 ~]<span class="hljs-comment"># vim /etc/my.cnf.d/mysql.cnf</span><br>[mysqld]<br>server-id=12<br>log-bin=/binlog/mysql-bin<br><br><span class="hljs-comment">## 完全备份</span><br>[root@Rocky8-2 ~]<span class="hljs-comment"># mkdir /data</span><br>[root@Rocky8-2 ~]<span class="hljs-comment"># mysqldump -A -F --master-data=1 --single-transaction &gt; /data/all.sql</span><br>WARNING: --master-data is deprecated and will be removed <span class="hljs-keyword">in</span> a future version. Use --source-data instead.<br>[root@Rocky8-2 ~]<span class="hljs-comment"># ll /data/</span><br>total 1264<br>-rw-r--r-- 1 root root 1292872 Jul 11 14:33 all.sql<br><br>[root@Rocky8-2 ~]<span class="hljs-comment"># scp /data/all.sql  10.0.0.13:/data/</span><br><br><span class="hljs-comment">## 创建用户与授权</span><br>mysql&gt; create user repluser@<span class="hljs-string">&#x27;10.0.0.%&#x27;</span> identified by <span class="hljs-string">&quot;123456&quot;</span>;<br>Query OK, 0 rows affected (0.02 sec)<br><br>mysql&gt;  grant replication slave on *.* to repluser@<span class="hljs-string">&#x27;10.0.0.%&#x27;</span>;<br>Query OK, 0 rows affected (0.00 sec)<br><br><br><br><span class="hljs-comment">## slave</span><br>[root@Rocky8-3 ~]<span class="hljs-comment"># mkdir /binlog</span><br>[root@Rocky8-3 ~]<span class="hljs-comment"># chown mysql. /binlog/</span><br>[root@Rocky8-3 ~]<span class="hljs-comment"># vim /etc/my.cnf.d/mysql.cnf</span><br>[mysqld]<br>server-id=13<br>log-bin=/binlog/mysql-bin<br>read-only<br><br><span class="hljs-comment">## 修改备份文件</span><br>[root@Rocky8-12 ~]<span class="hljs-comment"># vim /data/all.sql</span><br>CHANGE MASTER TO <br>    MASTER_HOST=<span class="hljs-string">&#x27;10.0.0.12&#x27;</span>,<br>    MASTER_PORT=3306,<br>    MASTER_USER=<span class="hljs-string">&#x27;repluser&#x27;</span>,<br>    MASTER_PASSWORD=<span class="hljs-string">&#x27;123456&#x27;</span>,<br>    MASTER_LOG_FILE=<span class="hljs-string">&#x27;mysql-bin.000003&#x27;</span>, <br>    MASTER_LOG_POS=157;<br>    <br><span class="hljs-comment">## 还原数据库</span><br>[root@Rocky8-12 ~]<span class="hljs-comment"># mysql </span><br>mysql&gt; <span class="hljs-built_in">set</span> sql_log_bin=0;<br>mysql&gt; <span class="hljs-built_in">set</span> sql_log_bin=1;<br>mysql&gt; start slave;<br><br><span class="hljs-comment">## 查看主从状态</span><br>mysql&gt; show slave status\G<br>*************************** 1. row ***************************<br>               Slave_IO_State: Waiting <span class="hljs-keyword">for</span> <span class="hljs-built_in">source</span> to send event<br>                  Master_Host: 10.0.0.12<br>                  Master_User: repluser<br>                  Master_Port: 3306<br>                Connect_Retry: 60<br>              Master_Log_File: mysql-bin.000003<br>          Read_Master_Log_Pos: 682<br>               Relay_Log_File: Rocky8-3-relay-bin.000002<br>                Relay_Log_Pos: 851<br>        Relay_Master_Log_File: mysql-bin.000003<br>             Slave_IO_Running: Yes<br>            Slave_SQL_Running: Yes<br>......<br></code></pre></td></tr></table></figure><h4 id="安装mycat-1-6-7-6"><a href="#安装mycat-1-6-7-6" class="headerlink" title="安装mycat 1.6.7.6"></a>安装mycat 1.6.7.6</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">## 安装java环境</span><br>[root@Rocky8-1 ~]<span class="hljs-comment"># yum install -y java</span><br>[root@Rocky8-1 ~]<span class="hljs-comment"># java -version</span><br>openjdk version <span class="hljs-string">&quot;1.8.0_372&quot;</span><br>OpenJDK Runtime Environment (build 1.8.0_372-b07)<br>OpenJDK 64-Bit Server VM (build 25.372-b07, mixed mode)<br><br><span class="hljs-comment">## 下载准备 mycat</span><br>[root@Rocky8-1 ~]<span class="hljs-comment"># wget http://dl.mycat.org.cn/1.6.7.6/20220524101549/Mycat-server-1.6.7.6-release-20220524173810-linux.tar.gz</span><br>[root@Rocky8-1 ~]<span class="hljs-comment"># mkdir /apps</span><br>[root@Rocky8-1 ~]<span class="hljs-comment"># tar xvf Mycat-server-1.6.7.6-release-20220524173810-linux.tar.gz -C /apps/</span><br><br><span class="hljs-comment">## 准备环境变量</span><br>[root@Rocky8-1 ~]<span class="hljs-comment"># echo &#x27;PATH=/apps/mycat/bin:$PATH&#x27; &gt; /etc/profile.d/mycat.sh</span><br>[root@Rocky8-1 ~]<span class="hljs-comment"># source /etc/profile.d/mycat.sh</span><br><br><span class="hljs-comment">## 启动mycat </span><br>[root@Rocky8-1 ~]<span class="hljs-comment"># ll /apps/mycat/bin/mycat</span><br>-rwxr-xr-x 1 root root 15678 May 24  2022 /apps/mycat/bin/mycat<br>[root@Rocky8-1 ~]<span class="hljs-comment"># mycat</span><br>Usage: /apps/mycat/bin/mycat &#123; console | start | stop | restart | status | dump &#125;<br>[root@Rocky8-1 ~]<span class="hljs-comment"># mycat start</span><br>Starting Mycat-server...<br><br><span class="hljs-comment">## 查看监听端口与日志</span><br>[root@Rocky8-1 ~]<span class="hljs-comment"># ss -ntlp</span><br>State         Recv-Q        Send-Q               Local Address:Port                Peer Address:Port       Process                                                         <br>LISTEN        0             128                        0.0.0.0:22                       0.0.0.0:*           <span class="hljs-built_in">users</span>:((&quot;sshd&quot;,pid=<span class="hljs-number">874</span>,fd=<span class="hljs-number">3</span>))                                  <br>LISTEN        0             1                        127.0.0.1:32000                    0.0.0.0:*           <span class="hljs-built_in">users</span>:((&quot;java&quot;,pid=<span class="hljs-number">2239</span>,fd=<span class="hljs-number">4</span>))                                 <br>LISTEN        0             128                        0.0.0.0:111                      0.0.0.0:*           <span class="hljs-built_in">users</span>:((&quot;rpcbind&quot;,pid=<span class="hljs-number">804</span>,fd=<span class="hljs-number">4</span>),(&quot;systemd&quot;,pid=<span class="hljs-number">1</span>,fd=<span class="hljs-number">37</span>))       <br>LISTEN        0             50                               *:37425                          *:*           <span class="hljs-built_in">users</span>:((&quot;java&quot;,pid=<span class="hljs-number">2239</span>,fd=<span class="hljs-number">78</span>))                                <br>LISTEN        0             128                           [::]:22                          [::]:*           <span class="hljs-built_in">users</span>:((&quot;sshd&quot;,pid=<span class="hljs-number">874</span>,fd=<span class="hljs-number">4</span>))                                  <br>LISTEN        0             50                               *:1984                           *:*           <span class="hljs-built_in">users</span>:((&quot;java&quot;,pid=<span class="hljs-number">2239</span>,fd=<span class="hljs-number">77</span>))                                <br>LISTEN        0             2048                             *:8066                           *:*           <span class="hljs-built_in">users</span>:((&quot;java&quot;,pid=<span class="hljs-number">2239</span>,fd=<span class="hljs-number">104</span>))                               <br>LISTEN        0             50                               *:34085                          *:*           <span class="hljs-built_in">users</span>:((&quot;java&quot;,pid=<span class="hljs-number">2239</span>,fd=<span class="hljs-number">76</span>))                                <br>LISTEN        0             2048                             *:9066                           *:*           <span class="hljs-built_in">users</span>:((&quot;java&quot;,pid=<span class="hljs-number">2239</span>,fd=<span class="hljs-number">102</span>))                               <br>LISTEN        0             128                           [::]:111                         [::]:*           <span class="hljs-built_in">users</span>:((&quot;rpcbind&quot;,pid=<span class="hljs-number">804</span>,fd=<span class="hljs-number">6</span>),(&quot;systemd&quot;,pid=<span class="hljs-number">1</span>,fd=<span class="hljs-number">39</span>))       <br><br>[root@Rocky8-1 ~]<span class="hljs-comment"># tail /apps/mycat/logs/wrapper.log </span><br>STATUS | wrapper  | 2023/07/11 16:58:28 | --&gt; Wrapper Started as Daemon<br>STATUS | wrapper  | 2023/07/11 16:58:28 | Launching a JVM...<br>INFO   | jvm 1    | 2023/07/11 16:58:29 | Wrapper (Version 3.2.3) http://wrapper.tanukisoftware.org<br>INFO   | jvm 1    | 2023/07/11 16:58:29 |   Copyright 1999-2006 Tanuki Software, Inc.  All Rights Reserved.<br>INFO   | jvm 1    | 2023/07/11 16:58:29 | <br>INFO   | jvm 1    | 2023/07/11 16:58:29 | Loading class `com.mysql.jdbc.Driver<span class="hljs-string">&#x27;. This is deprecated. The new driver class is `com.mysql.cj.jdbc.Driver&#x27;</span>. The driver is automatically registered via the SPI and manual loading of the driver class is generally unnecessary.<br>INFO   | jvm 1    | 2023/07/11 16:58:31 | MyCAT Server startup successfully. see logs <span class="hljs-keyword">in</span> logs/mycat.log<br><br>观察是否出现  MyCAT Server startup successfully. see logs <span class="hljs-keyword">in</span> logs/mycat.log<br></code></pre></td></tr></table></figure><h4 id="停止mycat-修改-apps-mycat-conf-server-xml服务端口号为3306"><a href="#停止mycat-修改-apps-mycat-conf-server-xml服务端口号为3306" class="headerlink" title="停止mycat ,修改&#x2F;apps&#x2F;mycat&#x2F;conf&#x2F;server.xml服务端口号为3306"></a>停止mycat ,修改&#x2F;apps&#x2F;mycat&#x2F;conf&#x2F;server.xml服务端口号为3306</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs swift">[root<span class="hljs-meta">@Rocky8</span><span class="hljs-operator">-</span><span class="hljs-number">1</span> conf]# vim <span class="hljs-regexp">/apps/</span>mycat<span class="hljs-regexp">/conf/</span>server.xml <br></code></pre></td></tr></table></figure><h4 id="端口号：复制注释的配置行，修改端口号为3306："><a href="#端口号：复制注释的配置行，修改端口号为3306：" class="headerlink" title="端口号：复制注释的配置行，修改端口号为3306："></a>端口号：复制注释的配置行，修改端口号为3306：</h4><p><img src="https://xcj-typora-img.oss-cn-hangzhou.aliyuncs.com/img/20230712110202.png" alt="20230712110202"></p><h4 id="创建-mycat-连接到-mysql-数据库的用户名和密码（在mysql-主服务器上创建账号并授权）"><a href="#创建-mycat-连接到-mysql-数据库的用户名和密码（在mysql-主服务器上创建账号并授权）" class="headerlink" title="创建 mycat 连接到 mysql 数据库的用户名和密码（在mysql 主服务器上创建账号并授权）"></a>创建 mycat 连接到 mysql 数据库的用户名和密码（在mysql 主服务器上创建账号并授权）</h4><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">mysql</span>&gt; create user admin@&#x27;<span class="hljs-number">10</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>.%&#x27; identified by &#x27;<span class="hljs-number">123456</span>&#x27;;<br><span class="hljs-attribute">Query</span> OK, <span class="hljs-number">0</span> rows affected (<span class="hljs-number">0</span>.<span class="hljs-number">23</span> sec)<br><br><span class="hljs-attribute">mysql</span>&gt; grant <span class="hljs-literal">all</span> <span class="hljs-literal">on</span> hellodb.* to admin@&#x27;<span class="hljs-number">10</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>.%&#x27;;<br><span class="hljs-attribute">Query</span> OK, <span class="hljs-number">0</span> rows affected (<span class="hljs-number">0</span>.<span class="hljs-number">03</span> sec)<br></code></pre></td></tr></table></figure><h4 id="修改-apps-mycat-conf-schema-xml-配置文件："><a href="#修改-apps-mycat-conf-schema-xml-配置文件：" class="headerlink" title="修改&#x2F;apps&#x2F;mycat&#x2F;conf&#x2F;schema.xml 配置文件："></a>修改&#x2F;apps&#x2F;mycat&#x2F;conf&#x2F;schema.xml 配置文件：</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs swift">[root<span class="hljs-meta">@Rocky8</span><span class="hljs-operator">-</span><span class="hljs-number">1</span> conf]# vim <span class="hljs-regexp">/apps/</span>mycat<span class="hljs-regexp">/conf/</span>schema.xml <br></code></pre></td></tr></table></figure><p><img src="https://xcj-typora-img.oss-cn-hangzhou.aliyuncs.com/img/20230712114436.png" alt="20230712114436"></p><h4 id="启动mycat-查看端口和日志"><a href="#启动mycat-查看端口和日志" class="headerlink" title="启动mycat ,查看端口和日志"></a>启动mycat ,查看端口和日志</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs sh">[root@Rocky8-1 conf]<span class="hljs-comment"># mycat start </span><br>Starting Mycat-server...<br><br>[root@Rocky8-1 conf]<span class="hljs-comment"># ss -ntlp</span><br>State         Recv-Q        Send-Q               Local Address:Port                Peer Address:Port       Process                                                         <br>LISTEN        0             128                        0.0.0.0:22                       0.0.0.0:*           <span class="hljs-built_in">users</span>:((&quot;sshd&quot;,pid=<span class="hljs-number">874</span>,fd=<span class="hljs-number">3</span>))                                  <br>LISTEN        0             1                        127.0.0.1:32000                    0.0.0.0:*           <span class="hljs-built_in">users</span>:((&quot;java&quot;,pid=<span class="hljs-number">2760</span>,fd=<span class="hljs-number">4</span>))                                 <br>LISTEN        0             128                        0.0.0.0:111                      0.0.0.0:*           <span class="hljs-built_in">users</span>:((&quot;rpcbind&quot;,pid=<span class="hljs-number">804</span>,fd=<span class="hljs-number">4</span>),(&quot;systemd&quot;,pid=<span class="hljs-number">1</span>,fd=<span class="hljs-number">37</span>))       <br>LISTEN        0             50                               *:41649                          *:*           <span class="hljs-built_in">users</span>:((&quot;java&quot;,pid=<span class="hljs-number">2760</span>,fd=<span class="hljs-number">76</span>))                                <br>LISTEN        0             50                               *:37107                          *:*           <span class="hljs-built_in">users</span>:((&quot;java&quot;,pid=<span class="hljs-number">2760</span>,fd=<span class="hljs-number">78</span>))                                <br>LISTEN        0             128                           [::]:22                          [::]:*           <span class="hljs-built_in">users</span>:((&quot;sshd&quot;,pid=<span class="hljs-number">874</span>,fd=<span class="hljs-number">4</span>))                                  <br>LISTEN        0             50                               *:1984                           *:*           <span class="hljs-built_in">users</span>:((&quot;java&quot;,pid=<span class="hljs-number">2760</span>,fd=<span class="hljs-number">77</span>))                                <br>LISTEN        0             2048                             *:3306                           *:*           <span class="hljs-built_in">users</span>:((&quot;java&quot;,pid=<span class="hljs-number">2760</span>,fd=<span class="hljs-number">107</span>))                               <br>LISTEN        0             2048                             *:9066                           *:*           <span class="hljs-built_in">users</span>:((&quot;java&quot;,pid=<span class="hljs-number">2760</span>,fd=<span class="hljs-number">103</span>))                               <br>LISTEN        0             128                           [::]:111                         [::]:*           <span class="hljs-built_in">users</span>:((&quot;rpcbind&quot;,pid=<span class="hljs-number">804</span>,fd=<span class="hljs-number">6</span>),(&quot;systemd&quot;,pid=<span class="hljs-number">1</span>,fd=<span class="hljs-number">39</span>))<br><br>[root@Rocky8-1 conf]<span class="hljs-comment"># cat /apps/mycat/logs/wrapper.log </span><br>STATUS | wrapper  | 2023/07/12 11:48:34 | --&gt; Wrapper Started as Daemon<br>STATUS | wrapper  | 2023/07/12 11:48:35 | Launching a JVM...<br>INFO   | jvm 1    | 2023/07/12 11:48:37 | Wrapper (Version 3.2.3) http://wrapper.tanukisoftware.org<br>INFO   | jvm 1    | 2023/07/12 11:48:37 |   Copyright 1999-2006 Tanuki Software, Inc.  All Rights Reserved.<br>INFO   | jvm 1    | 2023/07/12 11:48:37 | <br>INFO   | jvm 1    | 2023/07/12 11:48:40 | MyCAT Server startup successfully. see logs <span class="hljs-keyword">in</span> logs/mycat.log<br>[root@Rocky8-1 conf]<span class="hljs-comment"># </span><br></code></pre></td></tr></table></figure><h4 id="连接-mycat-验证服务"><a href="#连接-mycat-验证服务" class="headerlink" title="连接 mycat ,验证服务"></a>连接 mycat ,验证服务</h4><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">[root@Rocky8-3 ~]# mysql -uroot -p123456 -h 10.0.0.11<br><span class="hljs-section">mysql&gt; show databases;</span><br><span class="hljs-section">+----------+</span><br><span class="hljs-section">| DATABASE |</span><br><span class="hljs-section">+----------+</span><br><span class="hljs-section">| TESTDB   |</span><br><span class="hljs-section">+----------+</span><br>1 row in set (0.00 sec)<br><br>mysql&gt; use TESTDB;<br>Reading table information for completion of table and column names<br>You can turn off this feature to get a quicker startup with -A<br><br>Database changed<br><span class="hljs-section">mysql&gt; SHOW TABLES;</span><br><span class="hljs-section">+-------------------+</span><br><span class="hljs-section">| Tables_in_hellodb |</span><br><span class="hljs-section">+-------------------+</span><br>| classes           |<br>| coc               |<br>| courses           |<br>| scores            |<br>| students          |<br>| teachers          |<br><span class="hljs-section">| toc               |</span><br><span class="hljs-section">+-------------------+</span><br><br></code></pre></td></tr></table></figure><h4 id="验证读写分离，开启-mysql-主、从节点的通用用志，并跟踪目志"><a href="#验证读写分离，开启-mysql-主、从节点的通用用志，并跟踪目志" class="headerlink" title="验证读写分离，开启 mysql 主、从节点的通用用志，并跟踪目志"></a>验证读写分离，开启 mysql 主、从节点的通用用志，并跟踪目志</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs sh">mysql&gt; <span class="hljs-keyword">select</span> @@general_log;<br>+---------------+<br>| @@general_log |<br>+---------------+<br>|             0 |<br>+---------------+<br>1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.01 sec)<br><br>mysql&gt; <span class="hljs-built_in">set</span> global general_log=ON;<br>Query OK, 0 rows affected (0.03 sec)<br><br><span class="hljs-comment">## 主节点</span><br>[root@Rocky8-2 ~]<span class="hljs-comment"># tail -f /var/lib/mysql/Rocky8-2.log </span><br><br><span class="hljs-comment">## 从节点</span><br>[root@Rocky8-3 ~]<span class="hljs-comment"># tail -f /var/lib/mysql/Rocky8-3.log </span><br></code></pre></td></tr></table></figure><h4 id="查询数据库表在从节点看到"><a href="#查询数据库表在从节点看到" class="headerlink" title="查询数据库表在从节点看到"></a>查询数据库表在从节点看到</h4><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs subunit">[root@Rocky8<span class="hljs-string">-3</span> ~]# tail -f /var/lib/mysql/Rocky8<span class="hljs-string">-3</span>.log <br>2023<span class="hljs-string">-07</span><span class="hljs-string">-12</span>T04:46:04.218262Z   21 Queryselect user()<br>2023<span class="hljs-string">-07</span><span class="hljs-string">-12</span>T04:45:56.918773Z   23 QuerySELECT * FROM teachers<br>2023<span class="hljs-string">-07</span><span class="hljs-string">-12</span>T04:46:04.218262Z   21 Queryselect user()<br></code></pre></td></tr></table></figure><h4 id="添加记录在主节点看到"><a href="#添加记录在主节点看到" class="headerlink" title="添加记录在主节点看到"></a>添加记录在主节点看到</h4><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">[root@Rocky8<span class="hljs-number">-2</span> ~]# tail -f /var/lib/mysql/Rocky8<span class="hljs-number">-2.</span><span class="hljs-keyword">log</span> <br><span class="hljs-number">2023</span><span class="hljs-number">-07</span><span class="hljs-number">-12</span>T04:<span class="hljs-number">49</span>:<span class="hljs-number">44.219452</span>Z   <span class="hljs-number">19</span> Query<span class="hljs-keyword">select</span> <span class="hljs-keyword">user</span>()<br><span class="hljs-number">2023</span><span class="hljs-number">-07</span><span class="hljs-number">-12</span>T04:<span class="hljs-number">49</span>:<span class="hljs-number">45.114385</span>Z   <span class="hljs-number">17</span> Query<span class="hljs-keyword">insert</span> teachers(<span class="hljs-type">name</span>,age,gender) <span class="hljs-keyword">values</span>(<span class="hljs-string">&#x27;B1&#x27;</span>,<span class="hljs-number">33</span>,<span class="hljs-string">&#x27;M&#x27;</span>)<br><span class="hljs-number">2023</span><span class="hljs-number">-07</span><span class="hljs-number">-12</span>T04:<span class="hljs-number">49</span>:<span class="hljs-number">54.217873</span>Z   <span class="hljs-number">23</span> Query<span class="hljs-keyword">select</span> <span class="hljs-keyword">user</span>()<br></code></pre></td></tr></table></figure><h4 id="注：select-user-为-mycat-服务检测数据库存活性产生的记录，通过select-user-指令，查询当前用户身份"><a href="#注：select-user-为-mycat-服务检测数据库存活性产生的记录，通过select-user-指令，查询当前用户身份" class="headerlink" title="注：select user() 为 mycat 服务检测数据库存活性产生的记录，通过select user()指令，查询当前用户身份"></a>注：select user() 为 mycat 服务检测数据库存活性产生的记录，通过select user()指令，查询当前用户身份</h4><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc"><span class="hljs-section">mysql&gt; select user() ;</span><br><span class="hljs-section">+----------------+</span><br><span class="hljs-section">| USER()         |</span><br><span class="hljs-section">+----------------+</span><br><span class="hljs-section">| root@10.0.0.13 |</span><br><span class="hljs-section">+----------------+</span><br>1 row in set (0.01 sec)<br></code></pre></td></tr></table></figure><h4 id="注：停止从节点，自动将读操作转到主节点；停止主节点，不会将写操作转到从节点。"><a href="#注：停止从节点，自动将读操作转到主节点；停止主节点，不会将写操作转到从节点。" class="headerlink" title="注：停止从节点，自动将读操作转到主节点；停止主节点，不会将写操作转到从节点。"></a>注：停止从节点，自动将读操作转到主节点；停止主节点，不会将写操作转到从节点。</h4>]]></content>
    
    
    <categories>
      
      <category>MySQL</category>
      
    </categories>
    
    
    <tags>
      
      <tag>MariaDB</tag>
      
      <tag>init</tag>
      
      <tag>MySQL</tag>
      
      <tag>Cluster</tag>
      
      <tag>Mycat</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MySQL主从复制</title>
    <link href="/2023/05/25/MySQL%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/"/>
    <url>/2023/05/25/MySQL%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/</url>
    
    <content type="html"><![CDATA[<h3 id="MySQL-主从复制原理"><a href="#MySQL-主从复制原理" class="headerlink" title="MySQL 主从复制原理"></a>MySQL 主从复制原理</h3><p>主从复制（也称 AB 复制）是指一台服务器充当主数据库服务器，另一台或多台服务器充当从数据库服务器，主服务器中的数据自动复制到从服务器之中。对于多级复制，数据库服务器既可充当主机，也可充当从机。MySQL默认采用异步复制方式。</p><h5 id="主从复制的过程及原理可以总结如下："><a href="#主从复制的过程及原理可以总结如下：" class="headerlink" title="主从复制的过程及原理可以总结如下："></a>主从复制的过程及原理可以总结如下：</h5><ul><li>master服务器将数据的改变记录二进制binlog日志，当master上的数据发生改变时，则将其改变写入二进制日志中。</li><li>slave服务器会在一定时间间隔内对master二进制日志进行探测其是否发生改变，如果发生改变，则开始一个I&#x2F;OThread请求master二进制事件。</li><li>同时主节点为每个I&#x2F;O线程启动一个dump线程，用于向其发送二进制事件，并保存至从节点本地的中继日志中，从节点将启动SQL线程从中继日志中读取二进制日志，在本地重放，使得其数据和主节点的保持一致。</li></ul><h5 id="主从复制所需要的条件："><a href="#主从复制所需要的条件：" class="headerlink" title="主从复制所需要的条件："></a>主从复制所需要的条件：</h5><ul><li>开启二进制日志</li><li>设置server-id </li><li>创建同步账号</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs sh">CHANGE MASTER TO <br>  MASTER_HOST=<span class="hljs-string">&#x27;10.0.0.11&#x27;</span>,<br>  MASTER_USER=<span class="hljs-string">&#x27;repluser&#x27;</span>,<br>  MASTER_PASSWORD=<span class="hljs-string">&#x27;replpass&#x27;</span>,<br>  MASTER_LOG_FILE=<span class="hljs-string">&#x27;mariadb-bin.xxxxXX,</span><br><span class="hljs-string">  MASTER_LOG_POS=1567,</span><br><span class="hljs-string">  MASTER_DELAY=interva1;       #可指定延迟复制实现访问误操作，单位秒</span><br><span class="hljs-string">  </span><br><span class="hljs-string">START SLAVE [IO THREAD SQL THREAD];    #</span><br><span class="hljs-string">STOP SLAVE;</span><br><span class="hljs-string">RESET SLAVE ALL;</span><br><span class="hljs-string"></span><br><span class="hljs-string">SHOW SLAVE STATUS;</span><br><span class="hljs-string"></span><br><span class="hljs-string">#查看 relaylog 事件，mysql8.0已取消中继日志</span><br><span class="hljs-string">SHOW RELAYLOG EVENTS in &#x27;</span>relay-bin.00000x<span class="hljs-string">&#x27;;</span><br><span class="hljs-string"></span><br><span class="hljs-string"></span><br></code></pre></td></tr></table></figure><h3 id="例一：将已有的mysql8-0单机变成主从复制架构"><a href="#例一：将已有的mysql8-0单机变成主从复制架构" class="headerlink" title="例一：将已有的mysql8.0单机变成主从复制架构"></a>例一：将已有的mysql8.0单机变成主从复制架构</h3><h5 id="主节点-Rocky8-11-配置"><a href="#主节点-Rocky8-11-配置" class="headerlink" title="主节点 Rocky8-11 配置"></a>主节点 Rocky8-11 配置</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">## 配置主节点配置文件，启用二进制日志，配置server-id</span><br>[root@Rocky8-11 ~]<span class="hljs-comment"># mkdir /binlog/</span><br>[root@Rocky8-11 ~]<span class="hljs-comment"># chown mysql. /binlog/</span><br>[root@Rocky8-11 ~]<span class="hljs-comment"># vim /etc/my.cnf</span><br>[mysqld]<br>server-id=11<br>log-bin=/binlog/mysql-bin<br>[root@Rocky8-11 ~]<span class="hljs-comment"># systemctl restart mysqld</span><br><br><span class="hljs-comment">## 完全备份</span><br>[root@Rocky8-11 ~]<span class="hljs-comment"># mkdir /data</span><br>[root@Rocky8-11 ~]<span class="hljs-comment"># mysqldump -A -F --master-data=1 --single-transaction &gt; /data/all.sql </span><br>[root@Rocky8-11 ~]<span class="hljs-comment"># ls /data/</span><br>all.sql<br><br><span class="hljs-comment">## 创建复制用户并授权</span><br>[root@Rocky8-11 ~]<span class="hljs-comment"># mysql </span><br>01:28:55(root@localhost) [(none)] create user repluser@<span class="hljs-string">&#x27;10.0.0.%&#x27;</span> identified by <span class="hljs-string">&quot;123456&quot;</span>;<br>01:30:11(root@localhost) [(none)] grant replication slave on *.* to repluser@<span class="hljs-string">&#x27;10.0.0.%&#x27;</span>;<br><br><span class="hljs-comment">## 将备份复制到从节点</span><br>[root@Rocky8-11 ~]<span class="hljs-comment"># scp /data/all.sql  10.0.0.12:/data/</span><br></code></pre></td></tr></table></figure><h5 id="从节点-Rocky8-12-配置"><a href="#从节点-Rocky8-12-配置" class="headerlink" title="从节点 Rocky8-12 配置"></a>从节点 Rocky8-12 配置</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">## 安装数据库、启用二进制日志，修改日志路径、设置server-id、启用数据库只读</span><br>[root@Rocky8-12 ~]<span class="hljs-comment"># yum install mysql-server</span><br>[root@Rocky8-12 ~]<span class="hljs-comment"># mkdir /binlog</span><br>[root@Rocky8-12 ~]<span class="hljs-comment"># chown mysql. /binlog/</span><br>[root@Rocky8-12 ~]<span class="hljs-comment"># vim /etc/my.cnf</span><br>[mysqld]<br>server-id=12<br>log-bin=/binlog/mysql-bin<br>read-only<br><br><span class="hljs-comment">## 修改备份文件</span><br>[root@Rocky8-12 ~]<span class="hljs-comment"># vim /data/all.sql</span><br>CHANGE MASTER TO<br>    MASTER_HOST=<span class="hljs-string">&#x27;10.0.0.11&#x27;</span>,<br>    MASTER_PORT=3306,<br>    MASTER_USER=<span class="hljs-string">&#x27;repluser&#x27;</span>,<br>    MASTER_PASSWORD=<span class="hljs-string">&#x27;123456&#x27;</span>,<br>    MASTER_LOG_FILE=<span class="hljs-string">&#x27;mysql-bin.000002&#x27;</span>, <br>    MASTER_LOG_POS=157;<br><br><span class="hljs-comment">## 还原数据库</span><br>[root@Rocky8-12 ~]<span class="hljs-comment"># mysql </span><br>mysql&gt; <span class="hljs-built_in">set</span> sql_log_bin=0;<br>mysql&gt; <span class="hljs-built_in">source</span> /data/all.sql<br><br>mysql&gt; <span class="hljs-built_in">set</span> sql_log_bin=1;<br>mysql&gt; start slave;<br></code></pre></td></tr></table></figure><h5 id="查看主从服务状态"><a href="#查看主从服务状态" class="headerlink" title="查看主从服务状态"></a>查看主从服务状态</h5><p>主要观察以下两项，确保状态为 Yes:</p><p>  Slave_IO_Running: Yes<br>  Slave_SQL_Running: Yes</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs sh">mysql&gt; show slave status\G<br>*************************** 1. row ***************************<br>               Slave_IO_State: Waiting <span class="hljs-keyword">for</span> <span class="hljs-built_in">source</span> to send event<br>                  Master_Host: 10.0.0.11<br>                  Master_User: repluser<br>                  Master_Port: 3306<br>                Connect_Retry: 60<br>              Master_Log_File: mysql-bin.000003<br>          Read_Master_Log_Pos: 573<br>               Relay_Log_File: Rocky8-12-relay-bin.000004<br>                Relay_Log_Pos: 789<br>        Relay_Master_Log_File: mysql-bin.000003<br>             Slave_IO_Running: Yes<br>            Slave_SQL_Running: Yes<br>              Replicate_Do_DB: <br>          Replicate_Ignore_DB: <br>           Replicate_Do_Table: <br>       Replicate_Ignore_Table: <br>      Replicate_Wild_Do_Table: <br>  Replicate_Wild_Ignore_Table: <br>                   Last_Errno: 0<br>                   Last_Error: <br>                 Skip_Counter: 0<br>          Exec_Master_Log_Pos: 573<br>              Relay_Log_Space: 1050<br>              Until_Condition: None<br>               Until_Log_File: <br>                Until_Log_Pos: 0<br>           Master_SSL_Allowed: No<br>           Master_SSL_CA_File: <br>           Master_SSL_CA_Path: <br>              Master_SSL_Cert: <br>            Master_SSL_Cipher: <br>               Master_SSL_Key: <br>        Seconds_Behind_Master: 0<br>Master_SSL_Verify_Server_Cert: No<br>                Last_IO_Errno: 0<br>                Last_IO_Error: <br>               Last_SQL_Errno: 0<br>               Last_SQL_Error: <br>  Replicate_Ignore_Server_Ids: <br>             Master_Server_Id: 11<br>                  Master_UUID: f41fb64d-fb87-11ed-afcd-000c29bb093a<br>             Master_Info_File: mysql.slave_master_info<br>                    SQL_Delay: 0<br>          SQL_Remaining_Delay: NULL<br>      Slave_SQL_Running_State: Replica has <span class="hljs-built_in">read</span> all relay <span class="hljs-built_in">log</span>; waiting <span class="hljs-keyword">for</span> more updates<br>           Master_Retry_Count: 86400<br>                  Master_Bind: <br>      Last_IO_Error_Timestamp: <br>     Last_SQL_Error_Timestamp: <br>               Master_SSL_Crl: <br>           Master_SSL_Crlpath: <br>           Retrieved_Gtid_Set: <br>            Executed_Gtid_Set: <br>                Auto_Position: 0<br>         Replicate_Rewrite_DB: <br>                 Channel_Name: <br>           Master_TLS_Version: <br>       Master_public_key_path: <br>        Get_master_public_key: 0<br>            Network_Namespace: <br>1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span>, 1 warning (0.00 sec)<br></code></pre></td></tr></table></figure><h3 id="例二：当Master节点故障，提升一个Slave做为新的Master"><a href="#例二：当Master节点故障，提升一个Slave做为新的Master" class="headerlink" title="例二：当Master节点故障，提升一个Slave做为新的Master"></a>例二：当Master节点故障，提升一个Slave做为新的Master</h3><p>新master（10.0.0.12）：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">## 找到一个数据最新的节点，关闭readonly</span><br>[root@Rocky8-12 ~]<span class="hljs-comment"># vim /etc/my.cnf</span><br>[mysqld]<br>server-id=12<br>log-bin=/binlog/mysql-bin<br>read-only=off<br><br><span class="hljs-comment">## 清除旧的master复制信息</span><br>[root@Rocky8-12 ~]<span class="hljs-comment"># mysql </span><br>mysql&gt; <span class="hljs-built_in">set</span> global read_only=off;<br>mysql&gt; stop slave;<br>mysql&gt; reset slave all;<br><br><span class="hljs-comment">## 完全备份</span><br>[root@Rocky8-12 ~]<span class="hljs-comment"># mysqldump -A -F --single-transaction --master-data=1 &gt; /data/backup.sql</span><br><br><span class="hljs-comment">## 分析旧master上的二进制日志，将未同步的二进制导出来，尽可能的恢复数据到新的master;</span><br><br><span class="hljs-comment">## 将备份传到其它slave</span><br>[root@Rocky8-12 ~]<span class="hljs-comment"># scp /data/backup.sql 10.0.0.11:/data/</span><br></code></pre></td></tr></table></figure><p>slave：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><code class="hljs sh">[root@Rocky8-11 ~]<span class="hljs-comment"># vim /data/backup.sql </span><br>CHANGE MASTER TO <br>    MASTER_HOST=<span class="hljs-string">&#x27;10.0.0.12&#x27;</span>,<br>    MASTER_PORT=3306,<br>    MASTER_USER=<span class="hljs-string">&#x27;repluser&#x27;</span>,<br>    MASTER_PASSWORD=<span class="hljs-string">&#x27;123456&#x27;</span>,<br>    MASTER_LOG_FILE=<span class="hljs-string">&#x27;mysql-bin.000003&#x27;</span>, <br>    MASTER_LOG_POS=157;<br><br>[root@Rocky8-11 ~]<span class="hljs-comment"># mysql </span><br>(root@localhost) [(none)] stop slave;<br>(root@localhost) [(none)] reset slave all;<br>(root@localhost) [(none)] <span class="hljs-built_in">set</span> sql_log_bin=off;<br>(root@localhost) [(none)] <span class="hljs-built_in">source</span> /data/backup.sql;<br>(root@localhost) [(none)] <span class="hljs-built_in">set</span> sql_log_bin=on;<br>(root@localhost) [(none)] show slave status\G<br>*************************** 1. row ***************************<br>               Slave_IO_State: Waiting <span class="hljs-keyword">for</span> <span class="hljs-built_in">source</span> to send event<br>                  Master_Host: 10.0.0.12<br>                  Master_User: repluser<br>                  Master_Port: 3306<br>                Connect_Retry: 60<br>              Master_Log_File: mysql-bin.000003<br>          Read_Master_Log_Pos: 157<br>               Relay_Log_File: Rocky8-11-relay-bin.000002<br>                Relay_Log_Pos: 326<br>        Relay_Master_Log_File: mysql-bin.000003<br>             Slave_IO_Running: Yes<br>            Slave_SQL_Running: Yes<br>              Replicate_Do_DB: <br>          Replicate_Ignore_DB: <br>           Replicate_Do_Table: <br>       Replicate_Ignore_Table: <br>      Replicate_Wild_Do_Table: <br>  Replicate_Wild_Ignore_Table: <br>                   Last_Errno: 0<br>                   Last_Error: <br>                 Skip_Counter: 0<br>          Exec_Master_Log_Pos: 157<br>              Relay_Log_Space: 540<br>              Until_Condition: None<br>               Until_Log_File: <br>                Until_Log_Pos: 0<br>           Master_SSL_Allowed: No<br>           Master_SSL_CA_File: <br>           Master_SSL_CA_Path: <br>              Master_SSL_Cert: <br>            Master_SSL_Cipher: <br>               Master_SSL_Key: <br>        Seconds_Behind_Master: 0<br>Master_SSL_Verify_Server_Cert: No<br>                Last_IO_Errno: 0<br>                Last_IO_Error: <br>               Last_SQL_Errno: 0<br>               Last_SQL_Error: <br>  Replicate_Ignore_Server_Ids: <br>             Master_Server_Id: 12<br>                  Master_UUID: e0a8221e-fde2-11ed-a771-000c29df68f9<br>             Master_Info_File: mysql.slave_master_info<br>                    SQL_Delay: 0<br>          SQL_Remaining_Delay: NULL<br>      Slave_SQL_Running_State: Replica has <span class="hljs-built_in">read</span> all relay <span class="hljs-built_in">log</span>; waiting <span class="hljs-keyword">for</span> more updates<br>           Master_Retry_Count: 86400<br>                  Master_Bind: <br>      Last_IO_Error_Timestamp: <br>     Last_SQL_Error_Timestamp: <br>               Master_SSL_Crl: <br>           Master_SSL_Crlpath: <br>           Retrieved_Gtid_Set: <br>            Executed_Gtid_Set: <br>                Auto_Position: 0<br>         Replicate_Rewrite_DB: <br>                 Channel_Name: <br>           Master_TLS_Version: <br>       Master_public_key_path: <br>        Get_master_public_key: 0<br>            Network_Namespace: <br>1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span>, 1 warning (0.01 sec)<br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>MySQL</category>
      
    </categories>
    
    
    <tags>
      
      <tag>MariaDB</tag>
      
      <tag>MySQL</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MySQL备份与恢复</title>
    <link href="/2023/05/17/MySQL%E5%A4%87%E4%BB%BD%E4%B8%8E%E6%81%A2%E5%A4%8D/"/>
    <url>/2023/05/17/MySQL%E5%A4%87%E4%BB%BD%E4%B8%8E%E6%81%A2%E5%A4%8D/</url>
    
    <content type="html"><![CDATA[<h3 id="备份类型"><a href="#备份类型" class="headerlink" title="备份类型"></a>备份类型</h3><p>完全备份：备份整个数据集</p><p>部分备份：只备份数据子集（如部分库或表）</p><p>增量备份：仅备份最近一次完全备份或增量备份以来变化的数据，备份较快，还原复杂</p><p>差异备份：仅备份最近一次完全备份以来变化的数据，备份较快，还原简单</p><h3 id="冷备份与还原"><a href="#冷备份与还原" class="headerlink" title="冷备份与还原"></a>冷备份与还原</h3><blockquote><p>需要停止数据库服务</p></blockquote><p>备份步骤：停止数据库服务–&gt;备份数据库文件、配置、日志</p><p>还原步骤：安装数据库服务（最好版本一致）–&gt;复制相应文件（数据文件、配置文件、日志文件）并保留属性–&gt;启动服务</p><h4 id="mysql-8-0"><a href="#mysql-8-0" class="headerlink" title="mysql 8.0:"></a>mysql 8.0:</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">## 备份</span><br>[root@Rocky8-11 ~]<span class="hljs-comment"># systemctl stop mysqld</span><br>[root@Rocky8-11 ~]<span class="hljs-comment"># mkdir /backup</span><br>[root@Rocky8-11 ~]<span class="hljs-comment"># rsync -av /var/lib/mysql 10.0.0.11:/backup/</span><br>[root@Rocky8-11 ~]<span class="hljs-comment"># rsync -arv /etc/my*  10.0.0.11:/backup/</span><br>[root@Rocky8-11 ~]<span class="hljs-comment"># rsync -arv /data/binlog  10.0.0.11:/backup/</span><br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">## 还原</span><br>[root@Rocky8-12 ~]<span class="hljs-comment"># yum install -y mysql-server</span><br>[root@Rocky8-12 ~]<span class="hljs-comment"># rsync -arv 10.0.0.11:/backup/mysql/ /var/lib/mysql/</span><br>[root@Rocky8-12 ~]<span class="hljs-comment"># rsync -arv 10.0.0.11:/backup/my.cnf* /etc/</span><br>[root@Rocky8-12 ~]<span class="hljs-comment"># rsync -arv 10.0.0.11:/backup/binlog /data/</span><br>[root@Rocky8-12 ~]<span class="hljs-comment"># systemctl enable --now mysqld</span><br>[root@Rocky8-12 ~]<span class="hljs-comment"># ss -ntl </span><br>[root@Rocky8-12 ~]<span class="hljs-comment"># mysql </span><br>01:43:07(root@localhost) [(none)] show databases;<br>+--------------------+<br>| Database           |<br>+--------------------+<br>| hellodb            |<br>| information_schema |<br>| mysql              |<br>| performance_schema |<br>| sys                |<br>| <span class="hljs-built_in">test</span>               |<br>+--------------------+<br>6 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.01 sec)<br></code></pre></td></tr></table></figure><h4 id="mariadb-10-3"><a href="#mariadb-10-3" class="headerlink" title="mariadb 10.3"></a>mariadb 10.3</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">## 备份+还原（源主机：Rocky8-12  目标主机：Rocky8-13）</span><br>[root@Rocky8-13 ~]<span class="hljs-comment"># dnf install -y  mariadb-server</span><br>[root@Rocky8-13 ~]<span class="hljs-comment"># mkdir -p /data/binlog</span><br><br>[root@Rocky8-12 ~]<span class="hljs-comment"># systemctl stop mariadb</span><br>[root@Rocky8-12 ~]<span class="hljs-comment"># rsync -arv /etc/my.cnf*  10.0.0.13:/etc/</span><br>[root@Rocky8-12 ~]<span class="hljs-comment"># rsync -arv /var/lib/mysql/ 10.0.0.13:/var/lib/mysql/</span><br>[root@Rocky8-12 ~]<span class="hljs-comment"># rsync -arv /data/binlog/ 10.0.0.13:/data/binlog</span><br><br>[root@Rocky8-13 data]<span class="hljs-comment"># chown -R mysql.mysql /var/lib/mysql/</span><br>[root@Rocky8-13 data]<span class="hljs-comment"># chown -R mysql.mysql /data/binlog/</span><br>[root@Rocky8-13 data]<span class="hljs-comment"># systemctl start mariadb</span><br>[root@Rocky8-13 data]<span class="hljs-comment"># mysql </span><br>Welcome to the MariaDB monitor.  Commands end with ; or \g.<br>Your MariaDB connection <span class="hljs-built_in">id</span> is 9<br>Server version: 10.3.35-MariaDB-<span class="hljs-built_in">log</span> MariaDB Server<br><br>Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.<br><br>Type <span class="hljs-string">&#x27;help;&#x27;</span> or <span class="hljs-string">&#x27;\h&#x27;</span> <span class="hljs-keyword">for</span> <span class="hljs-built_in">help</span>. Type <span class="hljs-string">&#x27;\c&#x27;</span> to clear the current input statement.<br><br>MariaDB [(none)]&gt;<br></code></pre></td></tr></table></figure><h3 id="MysqlDump工具"><a href="#MysqlDump工具" class="headerlink" title="MysqlDump工具"></a>MysqlDump工具</h3><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">Dumping structure <span class="hljs-keyword">and</span> contents <span class="hljs-keyword">of</span> MySQL databases <span class="hljs-keyword">and</span> <span class="hljs-keyword">tables</span>.<br><span class="hljs-keyword">Usage</span>: mysqldump [<span class="hljs-keyword">OPTIONS</span>] <span class="hljs-keyword">database</span> [<span class="hljs-keyword">tables</span>]<br><span class="hljs-keyword">OR</span>     mysqldump [<span class="hljs-keyword">OPTIONS</span>] <span class="hljs-comment">--databases DB1 [DB2 DB3...]</span><br><span class="hljs-keyword">OR</span>     mysqldump [<span class="hljs-keyword">OPTIONS</span>] <span class="hljs-comment">--all-databases</span><br><span class="hljs-keyword">OR</span>     mysqldump [<span class="hljs-keyword">OPTIONS</span>] <span class="hljs-comment">--system=[SYSTEMOPTIONS]]</span><br></code></pre></td></tr></table></figure><p>常用参数：</p><p>  -u, –user&#x3D;name     登录用户名</p><p>  -p, –password[&#x3D;name]   登录密码</p><p>  -A, –all-databases 备份所有数据库</p><p>  -B, –databases     备份指定数据库</p><p>  -E, –events        备份相关的所有事件调度器（计划任务）</p><p>  -R, –routines      备份存储过程和自定义函数</p><p>  –master-data[&#x3D;#]   默认为&#x3D;1，&#x3D;1 适合于主从复制（数据之前加一个非注释的CHANGE MASTER TO语句） &#x3D;2适合于单机备份还原（记录为被注释的CHANGE MASTER TO语句）CHANGE MASTER TO 记录的为备份时间点的二进制日志位置 </p><p>  -F, –flush-logs    备份前生成新的二进制文件</p><h4 id="建议备份策略："><a href="#建议备份策略：" class="headerlink" title="建议备份策略："></a>建议备份策略：</h4><p>innoDB</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">mysqldump -uroot -p -A -F -E -R --triggers --single-transaction --master-data=1 --flush-privileges --default-character-set=utf8 --hex-blob&gt;<span class="hljs-variable">$&#123;BACKuP&#125;</span>/fu11bak_<span class="hljs-variable">$&#123;BACKUP_TIME&#125;</span>.sql<br></code></pre></td></tr></table></figure><p>myisam</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">mysqldump -uroot -p -A -F -E -R -x --master-data=1 --flush-privileges  --triggers --defau1t-character-set=utf8 --hex-b1ob &gt;<span class="hljs-variable">$&#123;BACKUP&#125;</span>/fu11bak_<span class="hljs-variable">$&#123;BACKUP_TIME&#125;</span>.sql<br></code></pre></td></tr></table></figure><h4 id="例一：完全备份和还原（冷备份）"><a href="#例一：完全备份和还原（冷备份）" class="headerlink" title="例一：完全备份和还原（冷备份）"></a>例一：完全备份和还原（冷备份）</h4><p>备份</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@Rocky8-11 ~]<span class="hljs-comment"># cat /etc/my.cnf</span><br>[mysqld]<br>log_bin=/data/binlog/mysql-bin<br>[root@Rocky8-11 ~]<span class="hljs-comment"># mkdir /backup</span><br>[root@Rocky8-11 ~]<span class="hljs-comment"># mysqldump -u root -A -F --single-transaction --master-data=2 | gzip &gt; /backup/all-`date +%F`.sql.gz</span><br>WARNING: --master-data is deprecated and will be removed <span class="hljs-keyword">in</span> a future version. Use --source-data instead.<br>[root@Rocky8-11 ~]<span class="hljs-comment"># scp /backup/all-2023-05-25.sql.gz 10.0.0.16:/backup</span><br></code></pre></td></tr></table></figure><p>还原</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@Rocky8-16 ~]<span class="hljs-comment"># yum -y install mysql-server</span><br>[root@Rocky8-16 ~]<span class="hljs-comment"># systemctl start mysqld</span><br>[root@Rocky8-16 ~]<span class="hljs-comment"># gzip -d /backup/all-2023-05-25.sql.gz</span><br>[root@Rocky8-16 ~]<span class="hljs-comment"># mysql </span><br>mysql&gt; <span class="hljs-built_in">set</span> sql_log_bin=off;<br>mysql&gt; <span class="hljs-built_in">source</span> /backup/all-2023-05-25.sql<br>mysql&gt; <span class="hljs-built_in">set</span> sql_log_bin=on;<br>mysql&gt; show databases;<br>+--------------------+<br>| Database           |<br>+--------------------+<br>| hellodb            |<br>| information_schema |<br>| mysql              |<br>| performance_schema |<br>| sys                |<br>| <span class="hljs-built_in">test</span>               |<br>+--------------------+<br>6 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.01 sec)<br></code></pre></td></tr></table></figure><h4 id="例二：利用二进制日志，恢复误删除的表"><a href="#例二：利用二进制日志，恢复误删除的表" class="headerlink" title="例二：利用二进制日志，恢复误删除的表"></a>例二：利用二进制日志，恢复误删除的表</h4><p><strong>误删除数据</strong></p><p>二进制日志文件独立位置</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@Rocky8-11 ~]<span class="hljs-comment"># cat /etc/my.cnf</span><br>[mysqld]<br>log_bin=/data/binlog/mysql-bin<br></code></pre></td></tr></table></figure><p>完全备份</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@Rocky8-11 ~]<span class="hljs-comment"># mysqldump -uroot -p -A -F --single-transaction --master-data=2  &gt; /backup/all-backup-`date +%F`.sql</span><br>WARNING: --master-data is deprecated and will be removed <span class="hljs-keyword">in</span> a future version. Use --source-data instead.<br>Enter password: <br>[root@Rocky8-11 ~]<span class="hljs-comment"># ll /backup/</span><br>total 1264<br>-rw-r--r-- 1 root root 1292875 May 25 21:02 all-backup-2023-05-25.sql<br></code></pre></td></tr></table></figure><p>完全备份后数据库继续更新</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">09:03:45(root@localhost) [hellodb] insert students (name,age,gender) value (<span class="hljs-string">&#x27;x1&#x27;</span>,20,<span class="hljs-string">&#x27;m&#x27;</span>);<br>Query OK, 1 row affected (0.01 sec)<br><br>09:03:56(root@localhost) [hellodb] insert students (name,age,gender) value (<span class="hljs-string">&#x27;y2&#x27;</span>,22,<span class="hljs-string">&#x27;m&#x27;</span>);<br>Query OK, 1 row affected (0.00 sec)<br></code></pre></td></tr></table></figure><p>破坏数据库，误删除了一张表</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">09:04:05(root@localhost) [hellodb] drop table students;<br>Query OK, 0 rows affected (0.09 sec)<br></code></pre></td></tr></table></figure><p>其它表继续更新</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs sh">09:05:34(root@localhost) [hellodb] insert teachers (name,age,gender) values (<span class="hljs-string">&#x27;A1&#x27;</span>,30,<span class="hljs-string">&#x27;M&#x27;</span>);<br>Query OK, 1 row affected (0.01 sec)<br><br>09:08:38(root@localhost) [hellodb] insert teachers (name,age,gender) values (<span class="hljs-string">&#x27;b2&#x27;</span>,33,<span class="hljs-string">&#x27;M&#x27;</span>);<br>Query OK, 1 row affected (0.01 sec)<br><br>09:09:04(root@localhost) [hellodb] <span class="hljs-keyword">select</span> * from teachers;<br>+-----+---------------+-----+--------+<br>| TID | Name          | Age | Gender |<br>+-----+---------------+-----+--------+<br>|   1 | Song Jiang    |  45 | M      |<br>|   2 | Zhang Sanfeng |  94 | M      |<br>|   3 | Miejue Shitai |  77 | F      |<br>|   4 | Lin Chaoying  |  93 | F      |<br>|   5 | A1            |  30 | M      |<br>|   6 | b2            |  33 | M      |<br>+-----+---------------+-----+--------+<br>6 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br></code></pre></td></tr></table></figure><p><strong>还原过程</strong></p><p>从最新的完全备份中找到change master to 位置</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@Rocky8-11 ~]<span class="hljs-comment"># grep &#x27;\-\- CHANGE MASTER TO&#x27;  /backup/all-backup-2023-05-25.sql </span><br>-- CHANGE MASTER TO MASTER_LOG_FILE=<span class="hljs-string">&#x27;mysql-bin.000003&#x27;</span>, MASTER_LOG_POS=157;<br></code></pre></td></tr></table></figure><p>备份完全备份之后的二进制日志</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@Rocky8-11 ~]<span class="hljs-comment"># mysqlbinlog --start-position=157 /data/binlog/mysql-bin.000003 &gt; /backup/binlog.sql</span><br></code></pre></td></tr></table></figure><p>找到误操作语句，从备份中删除，若文件过大可以用sed工具：sed -i.bak ‘&#x2F;^DROP TABLE&#x2F;d’ &#x2F;backup&#x2F;binlog.sql</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"> [root@Rocky8-11 ~]<span class="hljs-comment"># vim /backup/binlog.sql </span><br><span class="hljs-comment">### DROP TABLE `students` /* generated by server */</span><br></code></pre></td></tr></table></figure><p>测试还原</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs sh">mysql&gt; <span class="hljs-built_in">set</span> sql_log_bin=0;<br>mysql&gt; <span class="hljs-built_in">source</span> all-backup-2023-05-25.sql<br>mysql&gt; <span class="hljs-built_in">source</span> binlog.sql<br>mysql&gt; <span class="hljs-built_in">set</span> sql_log_bin=1;<br><br>mysql&gt; use hellodb<br>mysql&gt; show tables;<br>+-------------------+<br>| Tables_in_hellodb |<br>+-------------------+<br>| classes           |<br>| coc               |<br>| courses           |<br>| scores            |<br>| students          |<br>| teachers          |<br>| toc               |<br>+-------------------+<br>7 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br><br>mysql&gt; <span class="hljs-keyword">select</span> * from students;<br>+-------+---------------+-----+--------+---------+-----------+<br>| StuID | Name          | Age | Gender | ClassID | TeacherID |<br>+-------+---------------+-----+--------+---------+-----------+<br>|     1 | Shi Zhongyu   |  22 | M      |       2 |         3 |<br>|     2 | Shi Potian    |  22 | M      |       1 |         7 |<br>|     3 | Xie Yanke     |  53 | M      |       2 |        16 |<br>|     4 | Ding Dian     |  32 | M      |       4 |         4 |<br>|     5 | Yu Yutong     |  26 | M      |       3 |         1 |<br>|     6 | Shi Qing      |  46 | M      |       5 |      NULL |<br>|     7 | Xi Ren        |  19 | F      |       3 |      NULL |<br>|     8 | Lin Daiyu     |  17 | F      |       7 |      NULL |<br>|     9 | Ren Yingying  |  20 | F      |       6 |      NULL |<br>|    10 | Yue Lingshan  |  19 | F      |       3 |      NULL |<br>|    11 | Yuan Chengzhi |  23 | M      |       6 |      NULL |<br>|    12 | Wen Qingqing  |  19 | F      |       1 |      NULL |<br>|    13 | Tian Boguang  |  33 | M      |       2 |      NULL |<br>|    14 | Lu Wushuang   |  17 | F      |       3 |      NULL |<br>|    15 | Duan Yu       |  19 | M      |       4 |      NULL |<br>|    16 | Xu Zhu        |  21 | M      |       1 |      NULL |<br>|    17 | Lin Chong     |  25 | M      |       4 |      NULL |<br>|    18 | Hua Rong      |  23 | M      |       7 |      NULL |<br>|    19 | Xue Baochai   |  18 | F      |       6 |      NULL |<br>|    20 | Diao Chan     |  19 | F      |       7 |      NULL |<br>|    21 | Huang Yueying |  22 | F      |       6 |      NULL |<br>|    22 | Xiao Qiao     |  20 | F      |       1 |      NULL |<br>|    23 | Ma Chao       |  23 | M      |       4 |      NULL |<br>|    24 | Xu Xian       |  27 | M      |    NULL |      NULL |<br>|    25 | Sun Dasheng   | 100 | M      |    NULL |      NULL |<br>|    26 | x1            |  20 | M      |    NULL |      NULL |<br>|    27 | y2            |  22 | M      |    NULL |      NULL |<br>+-------+---------------+-----+--------+---------+-----------+<br>27 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br><br>mysql&gt; <span class="hljs-keyword">select</span> * from teachers;<br>+-----+---------------+-----+--------+<br>| TID | Name          | Age | Gender |<br>+-----+---------------+-----+--------+<br>|   1 | Song Jiang    |  45 | M      |<br>|   2 | Zhang Sanfeng |  94 | M      |<br>|   3 | Miejue Shitai |  77 | F      |<br>|   4 | Lin Chaoying  |  93 | F      |<br>|   5 | A1            |  30 | M      |<br>|   6 | b2            |  33 | M      |<br>+-----+---------------+-----+--------+<br>6 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br><br>mysql&gt; <br></code></pre></td></tr></table></figure><h3 id="XtraBackup备份工具"><a href="#XtraBackup备份工具" class="headerlink" title="XtraBackup备份工具"></a>XtraBackup备份工具</h3><p>官网：<a href="https://www.percona.com/downloads">https://www.percona.com/downloads</a></p><p>特点：</p><ul><li>备份还原过程快速、可靠</li><li>备份过程不会打断正在执行的事务</li><li>能够基于压缩等功能节约磁盘空间和流量</li><li>自动实现备份检验</li><li>开源、免费</li></ul><p>安装：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">[root@Rocky8-11 ~]<span class="hljs-comment"># yum install -y percona-xtrabackup-80-8.0.33-27.1.el8.x86_64.rpm</span><br></code></pre></td></tr></table></figure><p>注意：</p><ul><li>备份文件父路径必须存在</li><li>还原时必须停止数据库服务</li><li>还原时目标数据目录必须为空，除非指定innobackuppex –force-non-empty-directorires，否则–copy-back不会覆盖</li><li>还原后文件属性会被保留，须调整文件属主属组</li></ul><h4 id="案例：利用xtrabackup，实现数据库增量备份及还原"><a href="#案例：利用xtrabackup，实现数据库增量备份及还原" class="headerlink" title="案例：利用xtrabackup，实现数据库增量备份及还原"></a>案例：利用xtrabackup，实现数据库增量备份及还原</h4><p>备份：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><code class="hljs sh">[root@Rocky8-11 ~]<span class="hljs-comment"># mysql </span><br>03:31:17(root@localhost) [(none)] show databases;<br>+--------------------+<br>| Database           |<br>+--------------------+<br>| hellodb            |<br>| information_schema |<br>| mysql              |<br>| performance_schema |<br>| sys                |<br>+--------------------+<br>5 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.02 sec)<br><br><span class="hljs-comment">## 安装，创建备份目录</span><br>[root@Rocky8-11 ~]<span class="hljs-comment"># yum install -y percona-xtrabackup-80-8.0.33-27.1.el8.x86_64.rpm</span><br>[root@Rocky8-11 ~]<span class="hljs-comment"># mkdir /backup</span><br><br><span class="hljs-comment">## 完全备份</span><br>[root@Rocky8-11 ~]<span class="hljs-comment"># xtrabackup  -uroot -p  --backup --target-dir=/backup/base</span><br>[root@Rocky8-11 ~]<span class="hljs-comment"># ll /backup</span><br>total 4<br>drwxr-x--- 6 root root 4096 May 26 15:34 base<br><br><span class="hljs-comment">## 第一次增加修改数据</span><br>03:36:18(root@localhost) [hellodb] insert students (name,age,gender) value (<span class="hljs-string">&#x27;X1&#x27;</span>,20,<span class="hljs-string">&#x27;M&#x27;</span>);<br>Query OK, 1 row affected (0.01 sec)<br><br>03:36:33(root@localhost) [hellodb] insert students (name,age,gender) value (<span class="hljs-string">&#x27;Y1&#x27;</span>,23,<span class="hljs-string">&#x27;M&#x27;</span>);<br>Query OK, 1 row affected (0.00 sec)<br><br><span class="hljs-comment">## 第一次增量备份，备份目录/backup/inc1,相对于/backup/base做增量备份</span><br>[root@Rocky8-11 ~]<span class="hljs-comment"># xtrabackup  -uroot -p  --backup --target-dir=/backup/inc1 --incremental-basedir=/backup/base</span><br>[root@Rocky8-11 ~]<span class="hljs-comment"># ll /backup</span><br>total 8<br>drwxr-x--- 6 root root 4096 May 26 15:34 base<br>drwxr-x--- 6 root root 4096 May 26 15:39 inc1<br><br><span class="hljs-comment">## 第二次增加修改数据</span><br>03:42:03(root@localhost) [hellodb] insert teachers (name,age,gender) values (<span class="hljs-string">&#x27;A1&#x27;</span>,30,<span class="hljs-string">&#x27;M&#x27;</span>);<br>Query OK, 1 row affected (0.02 sec)<br><br>03:42:57(root@localhost) [hellodb] insert teachers (name,age,gender) values (<span class="hljs-string">&#x27;B2&#x27;</span>,36,<span class="hljs-string">&#x27;F&#x27;</span>);<br>Query OK, 1 row affected (0.01 sec)<br><br><span class="hljs-comment">## 第二次增量备份，备份目录/backup/inc2,相对于/backup/inc1做增量备份</span><br>[root@Rocky8-11 ~]<span class="hljs-comment"># xtrabackup  -uroot -p  --backup --target-dir=/backup/inc2 --incremental-basedir=/backup/inc1</span><br>[root@Rocky8-11 ~]<span class="hljs-comment"># ll /backup</span><br>total 12<br>drwxr-x--- 6 root root 4096 May 26 15:34 base<br>drwxr-x--- 6 root root 4096 May 26 15:39 inc1<br>drwxr-x--- 6 root root 4096 May 26 15:44 inc2<br><br><span class="hljs-comment">## 可以查看备份目录的文件信息：（innodb_from_lsn、innodb_to_lsn）</span><br>[root@Rocky8-11 ~]<span class="hljs-comment"># cat /backup/base/xtrabackup_info </span><br>uuid = ba0a28c7-fb97-11ed-985c-000c29bb093a<br>name = <br>tool_name = xtrabackup<br>tool_command = -uroot -p=... --backup --target-dir=/backup/base<br>tool_version = 8.0.33-27<br>ibbackup_version = 8.0.33-27<br>server_version = 8.0.32<br>start_time = 2023-05-26 15:34:17<br>end_time = 2023-05-26 15:34:19<br>lock_time = 0<br>binlog_pos = filename <span class="hljs-string">&#x27;binlog.000003&#x27;</span>, position <span class="hljs-string">&#x27;157&#x27;</span><br>innodb_from_lsn = 0<br>innodb_to_lsn = 19586280<br>partial = N<br>incremental = N<br>format = file<br>compressed = N<br>encrypted = N<br><br>[root@Rocky8-11 ~]<span class="hljs-comment"># cat /backup/inc1/xtrabackup_info </span><br>uuid = 615f869f-fb98-11ed-985c-000c29bb093a<br>name = <br>tool_name = xtrabackup<br>tool_command = -uroot -p=... --backup --target-dir=/backup/inc1 --incremental-basedir=/backup/base<br>tool_version = 8.0.33-27<br>ibbackup_version = 8.0.33-27<br>server_version = 8.0.32<br>start_time = 2023-05-26 15:38:57<br>end_time = 2023-05-26 15:39:00<br>lock_time = 0<br>binlog_pos = filename <span class="hljs-string">&#x27;binlog.000004&#x27;</span>, position <span class="hljs-string">&#x27;157&#x27;</span><br>innodb_from_lsn = 19586280<br>innodb_to_lsn = 19587049<br>partial = N<br>incremental = Y<br>format = file<br>compressed = N<br>encrypted = N<br><br>[root@Rocky8-11 ~]<span class="hljs-comment"># cat /backup/inc2/xtrabackup_info </span><br>uuid = 298b2cfc-fb99-11ed-985c-000c29bb093a<br>name = <br>tool_name = xtrabackup<br>tool_command = -uroot -p=... --backup --target-dir=/backup/inc2 --incremental-basedir=/backup/inc1<br>tool_version = 8.0.33-27<br>ibbackup_version = 8.0.33-27<br>server_version = 8.0.32<br>start_time = 2023-05-26 15:44:34<br>end_time = 2023-05-26 15:44:36<br>lock_time = 0<br>binlog_pos = filename <span class="hljs-string">&#x27;binlog.000005&#x27;</span>, position <span class="hljs-string">&#x27;157&#x27;</span><br>innodb_from_lsn = 19587049<br>innodb_to_lsn = 19590016<br>partial = N<br>incremental = Y<br>format = file<br>compressed = N<br>encrypted = N<br><br></code></pre></td></tr></table></figure><p>还原：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><code class="hljs sh">[root@Rocky8-11 ~]<span class="hljs-comment"># rsync  -avr /backup/ 10.0.0.12:/backup/</span><br><br><span class="hljs-comment">## 安装软件包，不启动mysql服务</span><br>[root@Rocky8-12 ~]<span class="hljs-comment"># yum install -y mysql-server</span><br>[root@Rocky8-12 ~]<span class="hljs-comment"># yum install -y percona-xtrabackup-80-8.0.33-27.1.el8.x86_64.rpm</span><br><br><span class="hljs-comment">## 预准备完全备份，--apply-log-only 阻止回滚未完成的事务</span><br>[root@Rocky8-12 ~]<span class="hljs-comment"># xtrabackup --prepare --apply-log-only --target-dir=/backup/base</span><br><br><span class="hljs-comment">## 合并第一次增量备份到完全备份</span><br>[root@Rocky8-12 ~]<span class="hljs-comment"># xtrabackup --prepare --apply-log-only --target-dir=/backup/base --incremental-dir=/backup/inc1</span><br><br><span class="hljs-comment">## 合并第二次增量备份到完全备份，最后一次增量备份不需要加选项--apply-log-only</span><br>[root@Rocky8-12 ~]<span class="hljs-comment"># xtrabackup --prepare --target-dir=/backup/base --incremental-dir=/backup/inc2</span><br><br><span class="hljs-comment">## 将文件复制到数据目录</span><br>[root@Rocky8-12 ~]<span class="hljs-comment"># rm -f /var/lib/mysql/*</span><br>[root@Rocky8-12 ~]<span class="hljs-comment"># xtrabackup --copy-back --target-dir=/backup/base</span><br>[root@Rocky8-12 ~]<span class="hljs-comment"># chown -R mysql.mysql /var/lib/mysql</span><br>[root@Rocky8-12 ~]<span class="hljs-comment"># systemctl start mysqld</span><br><br><span class="hljs-comment">## 检查还原的数据 </span><br>mysql&gt; show databases;<br>+--------------------+<br>| Database           |<br>+--------------------+<br>| hellodb            |<br>| information_schema |<br>| mysql              |<br>| performance_schema |<br>| sys                |<br>+--------------------+<br>5 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.02 sec)<br><br>mysql&gt; <span class="hljs-keyword">select</span> * from teachers;<br>+-----+---------------+-----+--------+<br>| TID | Name          | Age | Gender |<br>+-----+---------------+-----+--------+<br>|   1 | Song Jiang    |  45 | M      |<br>|   2 | Zhang Sanfeng |  94 | M      |<br>|   3 | Miejue Shitai |  77 | F      |<br>|   4 | Lin Chaoying  |  93 | F      |<br>|   5 | A1            |  30 | M      |<br>|   6 | B2            |  36 | F      |<br>+-----+---------------+-----+--------+<br>6 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br><br>mysql&gt; <span class="hljs-keyword">select</span> * from students;<br>+-------+---------------+-----+--------+---------+-----------+<br>| StuID | Name          | Age | Gender | ClassID | TeacherID |<br>+-------+---------------+-----+--------+---------+-----------+<br>|     1 | Shi Zhongyu   |  22 | M      |       2 |         3 |<br>|     2 | Shi Potian    |  22 | M      |       1 |         7 |<br>|     3 | Xie Yanke     |  53 | M      |       2 |        16 |<br>|     4 | Ding Dian     |  32 | M      |       4 |         4 |<br>|     5 | Yu Yutong     |  26 | M      |       3 |         1 |<br>|     6 | Shi Qing      |  46 | M      |       5 |      NULL |<br>|     7 | Xi Ren        |  19 | F      |       3 |      NULL |<br>|     8 | Lin Daiyu     |  17 | F      |       7 |      NULL |<br>|     9 | Ren Yingying  |  20 | F      |       6 |      NULL |<br>|    10 | Yue Lingshan  |  19 | F      |       3 |      NULL |<br>|    11 | Yuan Chengzhi |  23 | M      |       6 |      NULL |<br>|    12 | Wen Qingqing  |  19 | F      |       1 |      NULL |<br>|    13 | Tian Boguang  |  33 | M      |       2 |      NULL |<br>|    14 | Lu Wushuang   |  17 | F      |       3 |      NULL |<br>|    15 | Duan Yu       |  19 | M      |       4 |      NULL |<br>|    16 | Xu Zhu        |  21 | M      |       1 |      NULL |<br>|    17 | Lin Chong     |  25 | M      |       4 |      NULL |<br>|    18 | Hua Rong      |  23 | M      |       7 |      NULL |<br>|    19 | Xue Baochai   |  18 | F      |       6 |      NULL |<br>|    20 | Diao Chan     |  19 | F      |       7 |      NULL |<br>|    21 | Huang Yueying |  22 | F      |       6 |      NULL |<br>|    22 | Xiao Qiao     |  20 | F      |       1 |      NULL |<br>|    23 | Ma Chao       |  23 | M      |       4 |      NULL |<br>|    24 | Xu Xian       |  27 | M      |    NULL |      NULL |<br>|    25 | Sun Dasheng   | 100 | M      |    NULL |      NULL |<br>|    26 | X1            |  20 | M      |    NULL |      NULL |<br>|    27 | Y1            |  23 | M      |    NULL |      NULL |<br>+-------+---------------+-----+--------+---------+-----------+<br>27 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.01 sec)<br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>MySQL</category>
      
    </categories>
    
    
    <tags>
      
      <tag>MariaDB</tag>
      
      <tag>MySQL</tag>
      
      <tag>Backup</tag>
      
      <tag>XtraBackup</tag>
      
      <tag>MysqlDump</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MySQL二进制日志</title>
    <link href="/2023/05/11/MySQL%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%97%A5%E5%BF%97/"/>
    <url>/2023/05/11/MySQL%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%97%A5%E5%BF%97/</url>
    
    <content type="html"><![CDATA[<h3 id="二进制日志（归档日志，还原数据库使用）"><a href="#二进制日志（归档日志，还原数据库使用）" class="headerlink" title="二进制日志（归档日志，还原数据库使用）"></a>二进制日志（归档日志，还原数据库使用）</h3><blockquote><p>记录导致数据改变或潜在导致数据改变的SQL语句</p><p>记录已提交的日志</p><p>不依赖于存储引擎类型</p><p>功能：通过重放日志文件中的事件来生成数据副本</p><p>注意：建议二进制日志与数据文件分开存放</p></blockquote><h4 id="三种日志格式"><a href="#三种日志格式" class="headerlink" title="三种日志格式"></a>三种日志格式</h4><ul><li>基于‘语句’记录：statement，记录语句，日志量较少。（MariaDB 10.2.3版以下默认）</li><li>基于‘行’记录：row，记录数据，日志量较大，更加安全，建议使用的格式。（MySQL 8.0默认格式）</li><li>混合模式：mixed，让系统自行判定该基于哪种方式进行。（MariaDB 10.2.4及以上默认）</li></ul><p>查看数据库使用的格式：</p><p>mysql:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">07:40:41(root@localhost) [(none)] show variables like <span class="hljs-string">&#x27;binlog_format&#x27;</span>;<br>+---------------+-------+<br>| Variable_name | Value |<br>+---------------+-------+<br>| binlog_format | ROW   |<br>+---------------+-------+<br>1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.01 sec)<br></code></pre></td></tr></table></figure><p>mariadb:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">MariaDB [(none)]&gt; show variables like <span class="hljs-string">&#x27;binlog_format&#x27;</span>;<br>+---------------+-------+<br>| Variable_name | Value |<br>+---------------+-------+<br>| binlog_format | MIXED |<br>+---------------+-------+<br>1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.001 sec)<br></code></pre></td></tr></table></figure><h4 id="日志文件构成"><a href="#日志文件构成" class="headerlink" title="日志文件构成"></a>日志文件构成</h4><blockquote><p>日志文件：mysql-bin.000001,mysql-bin.000002, 二进制格式</p><p>索引文件：mysql-bin.index 文本格式，记录已有的二进制日志文件列表</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@Rocky8-11 ~]<span class="hljs-comment"># ll /var/lib/mysql/binlog*</span><br>-rw-r----- 1 mysql mysql   180 May 10 20:43 /var/lib/mysql/binlog.000001<br>-rw-r----- 1 mysql mysql   180 May 10 20:52 /var/lib/mysql/binlog.000002<br>-rw-r----- 1 mysql mysql   180 May 10 20:52 /var/lib/mysql/binlog.000003<br>-rw-r----- 1 mysql mysql 11866 May 10 21:37 /var/lib/mysql/binlog.000004<br>-rw-r----- 1 mysql mysql   157 May 11 17:03 /var/lib/mysql/binlog.000005<br>-rw-r----- 1 mysql mysql    80 May 11 17:03 /var/lib/mysql/binlog.index<br></code></pre></td></tr></table></figure><p>查看二进制日志文件列表及大小</p><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">04:53:48(root<span class="hljs-meta">@localhost)</span> [(none)] show binary logs;<br>+---------------+-----------+-----------+<br>|<span class="hljs-string"> Log_name      </span>|<span class="hljs-string"> File_size </span>|<span class="hljs-string"> Encrypted </span>|<br>+---------------+-----------+-----------+<br>|<span class="hljs-string"> binlog.000001 </span>|<span class="hljs-string">       180 </span>|<span class="hljs-string"> No        </span>|<br>|<span class="hljs-string"> binlog.000002 </span>|<span class="hljs-string">       180 </span>|<span class="hljs-string"> No        </span>|<br>|<span class="hljs-string"> binlog.000003 </span>|<span class="hljs-string">       180 </span>|<span class="hljs-string"> No        </span>|<br>|<span class="hljs-string"> binlog.000004 </span>|<span class="hljs-string">     11866 </span>|<span class="hljs-string"> No        </span>|<br>|<span class="hljs-string"> binlog.000005 </span>|<span class="hljs-string">       201 </span>|<span class="hljs-string"> No        </span>|<br>|<span class="hljs-string"> binlog.000006 </span>|<span class="hljs-string">       180 </span>|<span class="hljs-string"> No        </span>|<br>|<span class="hljs-string"> binlog.000007 </span>|<span class="hljs-string">       687 </span>|<span class="hljs-string"> No        </span>|<br>+---------------+-----------+-----------+<br>7 rows in set (0.00 sec)<br></code></pre></td></tr></table></figure><p>查看当前正在使用中的二进制日志文件</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">04:52:09(root@localhost) [(none)] show master status;<br><span class="hljs-code">+---------------+</span>----------<span class="hljs-code">+--------------+</span>------------------<span class="hljs-code">+-------------------+</span><br><span class="hljs-section">| File          | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |</span><br><span class="hljs-section">+---------------+----------+--------------+------------------+-------------------+</span><br><span class="hljs-section">| binlog.000007 |      687 |              |                  |                   |</span><br><span class="hljs-section">+---------------+----------+--------------+------------------+-------------------+</span><br>1 row in set (0.00 sec)<br></code></pre></td></tr></table></figure><p>切换二进制日志文件</p><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs gcode"><span class="hljs-number">02</span>:<span class="hljs-number">51</span>:<span class="hljs-number">29</span><span class="hljs-comment">(root@localhost)</span> [<span class="hljs-comment">(none)</span>] flush logs;<br>Query OK, <span class="hljs-number">0</span> rows affected <span class="hljs-comment">(0.03 sec)</span><br></code></pre></td></tr></table></figure><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs autoit">[root<span class="hljs-symbol">@Rocky8</span><span class="hljs-number">-11</span> ~]<span class="hljs-meta"># mysqladmin  flush-binary-log</span><br>[root<span class="hljs-symbol">@Rocky8</span><span class="hljs-number">-11</span> ~]<span class="hljs-meta"># mysqladmin  flush-logs</span><br></code></pre></td></tr></table></figure><h4 id="二进制日志相关变量"><a href="#二进制日志相关变量" class="headerlink" title="二进制日志相关变量"></a>二进制日志相关变量</h4><blockquote><p>sql_log_bin&#x3D;ON|OFF：是否记录二进制日志，默认on,支持动态修改，系统变量，支持set命令修改（在恢复数据库时临时关闭）</p><p>log_bin&#x3D;&#x2F;PATH&#x2F;BIN_LOG_FILE：指定文件位置，默认off,表示不启用二进制日志功能</p><p>上述两项都开启才可以启用二进制日志</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash">08:03:21(root@localhost) [(none)] show variables like <span class="hljs-string">&#x27;%log_bin%&#x27;</span>;<br>+---------------------------------+-----------------------------+<br>| Variable_name                   | Value                       |<br>+---------------------------------+-----------------------------+<br>| log_bin                         | ON                          |          <br>| log_bin_basename                | /var/lib/mysql/binlog       |<br>| log_bin_index                   | /var/lib/mysql/binlog.index |<br>| log_bin_trust_function_creators | OFF                         |<br>| log_bin_use_v1_row_events       | OFF                         |<br>| sql_log_bin                     | ON                          |<br>+---------------------------------+-----------------------------+<br>6 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs bash">08:02:02(root@localhost) [(none)] show variables like <span class="hljs-string">&#x27;%binlog%&#x27;</span>;<br>+------------------------------------------------+----------------------+<br>| Variable_name                                  | Value                |<br>+------------------------------------------------+----------------------+<br>| binlog_cache_size                              | 32768                |        <span class="hljs-comment">## 每次事务中保存日志记录的缓存大小</span><br>| binlog_checksum                                | CRC32                |<br>| binlog_direct_non_transactional_updates        | OFF                  |<br>| binlog_encryption                              | OFF                  |<br>| binlog_error_action                            | ABORT_SERVER         |<br>| binlog_expire_logs_auto_purge                  | ON                   |<br>| binlog_expire_logs_seconds                     | 2592000              |<br>| binlog_format                                  | ROW                  |        <span class="hljs-comment">## 二进制日志记录的格式</span><br>| binlog_group_commit_sync_delay                 | 0                    |<br>| binlog_group_commit_sync_no_delay_count        | 0                    |<br>| binlog_gtid_simple_recovery                    | ON                   |<br>| binlog_max_flush_queue_time                    | 0                    |<br>| binlog_order_commits                           | ON                   |<br>| binlog_rotate_encryption_master_key_at_startup | OFF                  |<br>| binlog_row_event_max_size                      | 8192                 |<br>| binlog_row_image                               | FULL                 |<br>| binlog_row_metadata                            | MINIMAL              |<br>| binlog_row_value_options                       |                      |<br>| binlog_rows_query_log_events                   | OFF                  |<br>| binlog_stmt_cache_size                         | 32768                |<br>| binlog_transaction_compression                 | OFF                  |<br>| binlog_transaction_compression_level_zstd      | 3                    |<br>| binlog_transaction_dependency_history_size     | 25000                |<br>| binlog_transaction_dependency_tracking         | COMMIT_ORDER         |<br>| innodb_api_enable_binlog                       | OFF                  |<br>| log_statements_unsafe_for_binlog               | ON                   |<br>| max_binlog_cache_size                          | 18446744073709547520 |        <span class="hljs-comment">## 限制用于缓存多事务查询的字节大小</span><br>| max_binlog_size                                | 1073741824           |        <span class="hljs-comment">## 单个日志文件的最大体积</span><br>| max_binlog_stmt_cache_size                     | 18446744073709547520 |<br>| sync_binlog                                    | 1                    |        <span class="hljs-comment">## 设定是否启动即时同步磁盘功能</span><br>+------------------------------------------------+----------------------+<br>30 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.02 sec)<br></code></pre></td></tr></table></figure><p>二进制日志自动删除的天数，默认0，不自动删除</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">08:11:16(root@localhost) [(none)] show variables like <span class="hljs-string">&#x27;expire_logs_days&#x27;</span>;<br>+------------------+-------+<br>| Variable_name    | Value |<br>+------------------+-------+<br>| expire_logs_days | 0     |       <br>+------------------+-------+<br>1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.01 sec)<br></code></pre></td></tr></table></figure><h4 id="修改二进制日志路径"><a href="#修改二进制日志路径" class="headerlink" title="修改二进制日志路径"></a>修改二进制日志路径</h4><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs tap">[root@Rocky8-11 ~]<span class="hljs-comment"># mkdir -p /data/binlog/</span><br>[root@Rocky8-11 ~]<span class="hljs-comment"># chown mysql. /data/binlog/</span><br>[root@Rocky8-11 ~]<span class="hljs-comment"># ll /data</span><br>total 0<br>drwxr-xr-x<span class="hljs-number"> 2 </span>mysql mysql<span class="hljs-number"> 6 </span>May<span class="hljs-number"> 17 </span>15:25 binlog<br><br>[root@Rocky8-11 ~]<span class="hljs-comment"># vim /etc/my.cnf</span><br>[mysqld]<br>log_bin=/data/binlog/mysql-bin<br><span class="hljs-comment">## mysql-bin 为二进制日志的文件名头</span><br><br>[root@Rocky8-11 ~]<span class="hljs-comment"># systemctl restart mysqld</span><br>[root@Rocky8-11 ~]<span class="hljs-comment"># ll /data/binlog</span><br>total 8<br>-rw-r-----<span class="hljs-number"> 1 </span>mysql mysql<span class="hljs-number"> 157 </span>May<span class="hljs-number"> 17 </span>16:12 mysql-bin.000001<br>-rw-r-----<span class="hljs-number"> 1 </span>mysql mysql <span class="hljs-number"> 30 </span>May<span class="hljs-number"> 17 </span>16:12 mysql-bin.index<br></code></pre></td></tr></table></figure><h4 id="查看二进制日志内容"><a href="#查看二进制日志内容" class="headerlink" title="查看二进制日志内容"></a>查看二进制日志内容</h4><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">04:16:45(root<span class="hljs-meta">@localhost)</span> [(none)] show binlog events in &#x27;mysql-bin.000001&#x27;;<br>+------------------+-----+----------------+-----------+-------------+-----------------------------------+<br>|<span class="hljs-string"> Log_name         </span>|<span class="hljs-string"> Pos </span>|<span class="hljs-string"> Event_type     </span>|<span class="hljs-string"> Server_id </span>|<span class="hljs-string"> End_log_pos </span>|<span class="hljs-string"> Info                              </span>|<br>+------------------+-----+----------------+-----------+-------------+-----------------------------------+<br>|<span class="hljs-string"> mysql-bin.000001 </span>|<span class="hljs-string">   4 </span>|<span class="hljs-string"> Format_desc    </span>|<span class="hljs-string">         1 </span>|<span class="hljs-string">         126 </span>|<span class="hljs-string"> Server ver: 8.0.30, Binlog ver: 4 </span>|<br>|<span class="hljs-string"> mysql-bin.000001 </span>|<span class="hljs-string"> 126 </span>|<span class="hljs-string"> Previous_gtids </span>|<span class="hljs-string">         1 </span>|<span class="hljs-string">         157 </span>|<span class="hljs-string">                                   </span>|<br>+------------------+-----+----------------+-----------+-------------+-----------------------------------+<br>2 rows in set (0.00 sec)<br></code></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs php">[root@Rocky8-<span class="hljs-number">11</span> ~]<span class="hljs-comment"># mysqlbinlog  /data/binlog/mysql-bin.000001 </span><br><span class="hljs-comment"># The proper term is pseudo_replica_mode, but we use this compatibility alias</span><br><span class="hljs-comment"># to make the statement usable on server versions 8.0.24 and older.</span><br><span class="hljs-comment">/*!50530 SET @<span class="hljs-doctag">@SESSION</span>.PSEUDO_SLAVE_MODE=1*/</span>;<br><span class="hljs-comment">/*!50003 SET <span class="hljs-doctag">@OLD</span>_COMPLETION_TYPE=@<span class="hljs-doctag">@COMPLETION</span>_TYPE,COMPLETION_TYPE=0*/</span>;<br>DELIMITER <span class="hljs-comment">/*!*/</span>;<br><span class="hljs-comment"># at 4</span><br><span class="hljs-comment">#230517 16:12:50 server id 1  end_log_pos 126 CRC32 0x6ac5be4e Start: binlog v 4, server v 8.0.30 created 230517 16:12:50 at startup</span><br><span class="hljs-comment"># Warning: this binlog is either in use or was not closed properly.</span><br>ROLLBACK<span class="hljs-comment">/*!*/</span>;<br>BINLOG <span class="hljs-string">&#x27;</span><br><span class="hljs-string">goxkZA8BAAAAegAAAH4AAAABAAQAOC4wLjMwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span><br><span class="hljs-string">AAAAAAAAAAAAAAAAAACCjGRkEwANAAgAAAAABAAEAAAAYgAEGggAAAAICAgCAAAACgoKKioAEjQA</span><br><span class="hljs-string">CigAAU6+xWo=</span><br><span class="hljs-string">&#x27;</span><span class="hljs-comment">/*!*/</span>;<br><span class="hljs-comment"># at 126</span><br><span class="hljs-comment">#230517 16:12:50 server id 1  end_log_pos 157 CRC32 0x3a5441b0 Previous-GTIDs</span><br><span class="hljs-comment"># [empty]</span><br>SET @@SESSION.GTID_NEXT= <span class="hljs-string">&#x27;AUTOMATIC&#x27;</span> <span class="hljs-comment">/* added by mysqlbinlog */</span> <span class="hljs-comment">/*!*/</span>;<br>DELIMITER ;<br><span class="hljs-comment"># End of log file</span><br><span class="hljs-comment">/*!50003 SET COMPLETION_TYPE=<span class="hljs-doctag">@OLD</span>_COMPLETION_TYPE*/</span>;<br><span class="hljs-comment">/*!50530 SET @<span class="hljs-doctag">@SESSION</span>.PSEUDO_SLAVE_MODE=0*/</span>;<br></code></pre></td></tr></table></figure><h5 id="加-v-选项，可查看到行语句"><a href="#加-v-选项，可查看到行语句" class="headerlink" title="加-v 选项，可查看到行语句"></a>加-v 选项，可查看到行语句</h5><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs autoit">[root<span class="hljs-symbol">@Rocky8</span><span class="hljs-number">-11</span> ~]<span class="hljs-meta"># mysqlbinlog  /data/binlog/mysql-bin.000001  -v</span><br></code></pre></td></tr></table></figure><h4 id="部分日志导出，可用于恢复部分数据："><a href="#部分日志导出，可用于恢复部分数据：" class="headerlink" title="部分日志导出，可用于恢复部分数据："></a>部分日志导出，可用于恢复部分数据：</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs php">[root@Rocky8-<span class="hljs-number">11</span> ~]<span class="hljs-comment"># mysqlbinlog  /data/binlog/mysql-bin.000001  --start-position=999  --stop-position=1171  -v</span><br><span class="hljs-comment"># The proper term is pseudo_replica_mode, but we use this compatibility alias</span><br><span class="hljs-comment"># to make the statement usable on server versions 8.0.24 and older.</span><br><span class="hljs-comment">/*!50530 SET @<span class="hljs-doctag">@SESSION</span>.PSEUDO_SLAVE_MODE=1*/</span>;<br><span class="hljs-comment">/*!50003 SET <span class="hljs-doctag">@OLD</span>_COMPLETION_TYPE=@<span class="hljs-doctag">@COMPLETION</span>_TYPE,COMPLETION_TYPE=0*/</span>;<br>DELIMITER <span class="hljs-comment">/*!*/</span>;<br><span class="hljs-comment"># at 157</span><br><span class="hljs-comment">#230517 16:12:50 server id 1  end_log_pos 126 CRC32 0x6ac5be4e Start: binlog v 4, server v 8.0.30 created 230517 16:12:50 at startup</span><br><span class="hljs-comment"># Warning: this binlog is either in use or was not closed properly.</span><br>ROLLBACK<span class="hljs-comment">/*!*/</span>;<br>BINLOG <span class="hljs-string">&#x27;</span><br><span class="hljs-string">goxkZA8BAAAAegAAAH4AAAABAAQAOC4wLjMwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span><br><span class="hljs-string">AAAAAAAAAAAAAAAAAACCjGRkEwANAAgAAAAABAAEAAAAYgAEGggAAAAICAgCAAAACgoKKioAEjQA</span><br><span class="hljs-string">CigAAU6+xWo=</span><br><span class="hljs-string">&#x27;</span><span class="hljs-comment">/*!*/</span>;<br><span class="hljs-comment"># at 999</span><br><span class="hljs-comment">#230517 16:41:31 server id 1  end_log_pos 1066 CRC32 0x157cc5fd Table_map: `hellodb`.`teachers` mapped to number 96</span><br><span class="hljs-comment"># at 1066</span><br><span class="hljs-comment">#230517 16:41:31 server id 1  end_log_pos 1140 CRC32 0x57369f8a Update_rows: table id 96 flags: STMT_END_F</span><br><br>BINLOG <span class="hljs-string">&#x27;</span><br><span class="hljs-string">O5NkZBMBAAAAQwAAACoEAAAAAGAAAAAAAAEAB2hlbGxvZGIACHRlYWNoZXJzAAQCDwH+BCwB9wEI</span><br><span class="hljs-string">AQHAAgEh/cV8FQ==</span><br><span class="hljs-string">O5NkZB8BAAAASgAAAHQEAAAAAGAAAAAAAAEAAgAE//8ABAAMAExpbiBDaGFveWluZyoBAAQADABM</span><br><span class="hljs-string">aW4gQ2hhb3lpbmcoAYqfNlc=</span><br><span class="hljs-string">&#x27;</span><span class="hljs-comment">/*!*/</span>;<br><span class="hljs-comment">### UPDATE `hellodb`.`teachers`</span><br><span class="hljs-comment">### WHERE</span><br><span class="hljs-comment">###   @1=4</span><br><span class="hljs-comment">###   @2=&#x27;Lin Chaoying&#x27;</span><br><span class="hljs-comment">###   @3=42</span><br><span class="hljs-comment">###   @4=1</span><br><span class="hljs-comment">### SET</span><br><span class="hljs-comment">###   @1=4</span><br><span class="hljs-comment">###   @2=&#x27;Lin Chaoying&#x27;</span><br><span class="hljs-comment">###   @3=40</span><br><span class="hljs-comment">###   @4=1</span><br><span class="hljs-comment"># at 1140</span><br><span class="hljs-comment">#230517 16:41:31 server id 1  end_log_pos 1171 CRC32 0x60c0cb3b Xid = 33</span><br>COMMIT<span class="hljs-comment">/*!*/</span>;<br>SET @@SESSION.GTID_NEXT= <span class="hljs-string">&#x27;AUTOMATIC&#x27;</span> <span class="hljs-comment">/* added by mysqlbinlog */</span> <span class="hljs-comment">/*!*/</span>;<br>DELIMITER ;<br><span class="hljs-comment"># End of log file</span><br><span class="hljs-comment">/*!50003 SET COMPLETION_TYPE=<span class="hljs-doctag">@OLD</span>_COMPLETION_TYPE*/</span>;<br><span class="hljs-comment">/*!50530 SET @<span class="hljs-doctag">@SESSION</span>.PSEUDO_SLAVE_MODE=0*/</span>;<br><br><br>[root@Rocky8-<span class="hljs-number">11</span> ~]<span class="hljs-comment"># mysqlbinlog  /data/binlog/mysql-bin.000001  --start-position=999  --stop-position=1171  &gt; binlog.log </span><br>[root@Rocky8-<span class="hljs-number">11</span> ~]<span class="hljs-comment"># mysql &lt; binlog.log</span><br></code></pre></td></tr></table></figure><h4 id="持续性同步备份二进制日志到另一台服务器"><a href="#持续性同步备份二进制日志到另一台服务器" class="headerlink" title="持续性同步备份二进制日志到另一台服务器"></a>持续性同步备份二进制日志到另一台服务器</h4><p>1、建立同步用户、授权</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-number">05</span>:<span class="hljs-number">03</span>:<span class="hljs-number">10</span>(root@localhost) [(<span class="hljs-keyword">none</span>)] <span class="hljs-keyword">create</span> <span class="hljs-keyword">user</span> backbinlog@<span class="hljs-string">&#x27;10.0.0.%&#x27;</span> identified <span class="hljs-keyword">by</span> <span class="hljs-string">&#x27;123456&#x27;</span>;<br>Query OK, <span class="hljs-number">0</span> <span class="hljs-keyword">rows</span> affected (<span class="hljs-number">0.03</span> sec)<br><br><span class="hljs-number">05</span>:<span class="hljs-number">04</span>:<span class="hljs-number">06</span>(root@localhost) [(<span class="hljs-keyword">none</span>)] <span class="hljs-keyword">grant</span> <span class="hljs-keyword">all</span> <span class="hljs-keyword">on</span> *.* <span class="hljs-keyword">to</span> backbinlog@<span class="hljs-string">&#x27;10.0.0.%&#x27;</span>;<br>Query OK, <span class="hljs-number">0</span> <span class="hljs-keyword">rows</span> affected (<span class="hljs-number">0.02</span> sec)<br><br><span class="hljs-number">05</span>:<span class="hljs-number">04</span>:<span class="hljs-number">25</span>(root@localhost) [(<span class="hljs-keyword">none</span>)] <span class="hljs-keyword">show</span> master logs;<br>+<span class="hljs-comment">------------------+-----------+-----------+</span><br>| Log_name         | File_size | <span class="hljs-keyword">Encrypted</span> |<br>+<span class="hljs-comment">------------------+-----------+-----------+</span><br>| mysql-bin<span class="hljs-number">.000001</span> |      <span class="hljs-number">2375</span> | <span class="hljs-keyword">No</span>        |<br>+<span class="hljs-comment">------------------+-----------+-----------+</span><br><span class="hljs-number">1</span> <span class="hljs-keyword">row</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">set</span> (<span class="hljs-number">0.00</span> sec)<br></code></pre></td></tr></table></figure><p>2、同步（备份服务器）</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs routeros">[root@Rocky8-13 ~]# mysqlbinlog -R <span class="hljs-attribute">--host</span>=10.0.0.11 <span class="hljs-attribute">--user</span>=backbinlog <span class="hljs-attribute">--password</span>=123456 --raw --stop-never mysql-bin.000001<br>mysqlbinlog: [<span class="hljs-built_in">Warning</span>] Using a password on the command line<span class="hljs-built_in"> interface </span>can be insecure.<br><br><br></code></pre></td></tr></table></figure><h4 id="删除二进制日志（可删除时间比较久的无用日志）"><a href="#删除二进制日志（可删除时间比较久的无用日志）" class="headerlink" title="删除二进制日志（可删除时间比较久的无用日志）"></a>删除二进制日志（可删除时间比较久的无用日志）</h4><p>从 mysql-bin.000002 开始保留，mysql-bin.000002 以前的删除：</p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs tap">05:18:41(root@localhost) [(none)] purge master logs to &#x27;mysql-bin.000002&#x27;;<br>Query OK,<span class="hljs-number"> 0 </span>rows affected (0.00 sec)<br><br>[root@Rocky8-11 ~]<span class="hljs-comment"># ll /data/binlog/</span><br>total 8<br>-rw-r-----<span class="hljs-number"> 1 </span>mysql mysql<span class="hljs-number"> 495 </span>May<span class="hljs-number"> 17 </span>17:17 mysql-bin.000002<br>-rw-r-----<span class="hljs-number"> 1 </span>mysql mysql <span class="hljs-number"> 30 </span>May<span class="hljs-number"> 17 </span>17:21 mysql-bin.index<br></code></pre></td></tr></table></figure><h4 id="清空所有日志（重新生成第000001号日志文件）"><a href="#清空所有日志（重新生成第000001号日志文件）" class="headerlink" title="清空所有日志（重新生成第000001号日志文件）"></a>清空所有日志（重新生成第000001号日志文件）</h4><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs tap">05:21:34(root@localhost) [(none)] reset master;<br>Query OK,<span class="hljs-number"> 0 </span>rows affected (0.04 sec)<br><br>[root@Rocky8-11 ~]<span class="hljs-comment"># ll /data/binlog/</span><br>total 8<br>-rw-r-----<span class="hljs-number"> 1 </span>mysql mysql<span class="hljs-number"> 157 </span>May<span class="hljs-number"> 17 </span>17:24 mysql-bin.000001<br>-rw-r-----<span class="hljs-number"> 1 </span>mysql mysql <span class="hljs-number"> 30 </span>May<span class="hljs-number"> 17 </span>17:24 mysql-bin.index<br></code></pre></td></tr></table></figure><h4 id="mariadb-10-3-开启二进制日志"><a href="#mariadb-10-3-开启二进制日志" class="headerlink" title="mariadb 10.3 开启二进制日志"></a>mariadb 10.3 开启二进制日志</h4><p>创建存放二进制的目录，更改权限</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs swift">[root<span class="hljs-meta">@Rocky8</span><span class="hljs-operator">-</span><span class="hljs-number">12</span> <span class="hljs-regexp">/]# mkdir -p /</span>data<span class="hljs-operator">/</span>binlog<br>[root<span class="hljs-meta">@Rocky8</span><span class="hljs-operator">-</span><span class="hljs-number">12</span> <span class="hljs-regexp">/]# chown mysql. /</span>data<span class="hljs-regexp">/binlog/</span><br>total <span class="hljs-number">0</span><br>drwxr<span class="hljs-operator">-</span>xr<span class="hljs-operator">-</span>x <span class="hljs-number">2</span> mysql mysql <span class="hljs-number">53</span> <span class="hljs-type">May</span> <span class="hljs-number">23</span> <span class="hljs-number">14</span>:<span class="hljs-number">12</span> binlog<br></code></pre></td></tr></table></figure><p>更改配置文件</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[root@Rocky8-12 ~]</span><span class="hljs-comment"># vim /etc/my.cnf</span><br><span class="hljs-section">[mysqld]</span><br><span class="hljs-attr">log_bin</span> = /data/binlog/mysql-bin<br></code></pre></td></tr></table></figure><p>重新启动mariadb服务</p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs tap">[root@Rocky8-12 ~]<span class="hljs-comment"># systemctl restart mariadb.service</span><br>[root@Rocky8-12 ~]<span class="hljs-comment"># ll /data/binlog/</span><br>total 12<br>-rw-rw----<span class="hljs-number"> 1 </span>mysql mysql<span class="hljs-number"> 351 </span>May<span class="hljs-number"> 23 </span>14:17 mysql-bin.000001<br>-rw-rw----<span class="hljs-number"> 1 </span>mysql mysql<span class="hljs-number"> 328 </span>May<span class="hljs-number"> 23 </span>14:17 mysql-bin.000002<br>-rw-rw----<span class="hljs-number"> 1 </span>mysql mysql <span class="hljs-number"> 60 </span>May<span class="hljs-number"> 23 </span>14:17 mysql-bin.index<br></code></pre></td></tr></table></figure><p>查询binlog状态(sql_log_bin、log_bin)</p><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">MariaDB [(none)]&gt; show variables like &#x27;%log_bin%&#x27;;<br>+---------------------------------+------------------------------+<br>|<span class="hljs-string"> Variable_name                   </span>|<span class="hljs-string"> Value                        </span>|<br>+---------------------------------+------------------------------+<br>|<span class="hljs-string"> log_bin                         </span>|<span class="hljs-string"> ON                           </span>|<br>|<span class="hljs-string"> log_bin_basename                </span>|<span class="hljs-string"> /data/binlog/mysql-bin       </span>|<br>|<span class="hljs-string"> log_bin_compress                </span>|<span class="hljs-string"> OFF                          </span>|<br>|<span class="hljs-string"> log_bin_compress_min_len        </span>|<span class="hljs-string"> 256                          </span>|<br>|<span class="hljs-string"> log_bin_index                   </span>|<span class="hljs-string"> /data/binlog/mysql-bin.index </span>|<br>|<span class="hljs-string"> log_bin_trust_function_creators </span>|<span class="hljs-string"> OFF                          </span>|<br>|<span class="hljs-string"> sql_log_bin                     </span>|<span class="hljs-string"> ON                           </span>|<br>+---------------------------------+------------------------------+<br>7 rows in set (0.002 sec)<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>MySQL</category>
      
    </categories>
    
    
    <tags>
      
      <tag>MariaDB</tag>
      
      <tag>MySQL</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MySQL基础知识</title>
    <link href="/2023/05/11/MySQL%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/"/>
    <url>/2023/05/11/MySQL%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/</url>
    
    <content type="html"><![CDATA[<h3 id="1、MySQL帮助命令"><a href="#1、MySQL帮助命令" class="headerlink" title="1、MySQL帮助命令"></a>1、MySQL帮助命令</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs bash">mysql&gt; <span class="hljs-built_in">help</span> <br><br>For information about MySQL products and services, visit:<br>   http://www.mysql.com/<br>For developer information, including the MySQL Reference Manual, visit:<br>   http://dev.mysql.com/<br>To buy MySQL Enterprise support, training, or other products, visit:<br>   https://shop.mysql.com/<br><br>List of all MySQL commands:<br>Note that all text commands must be first on line and end with <span class="hljs-string">&#x27;;&#x27;</span><br>?         (\?) Synonym <span class="hljs-keyword">for</span> `<span class="hljs-built_in">help</span><span class="hljs-string">&#x27;.</span><br><span class="hljs-string">clear     (\c) Clear the current input statement.</span><br><span class="hljs-string">connect   (\r) Reconnect to the server. Optional arguments are db and host.</span><br><span class="hljs-string">delimiter (\d) Set statement delimiter.</span><br><span class="hljs-string">edit      (\e) Edit command with $EDITOR.</span><br><span class="hljs-string">ego       (\G) Send command to mysql server, display result vertically.</span><br><span class="hljs-string">exit      (\q) Exit mysql. Same as quit.</span><br><span class="hljs-string">go        (\g) Send command to mysql server.</span><br><span class="hljs-string">help      (\h) Display this help.</span><br><span class="hljs-string">nopager   (\n) Disable pager, print to stdout.</span><br><span class="hljs-string">notee     (\t) Don&#x27;</span>t write into outfile.<br>pager     (\P) Set PAGER [to_pager]. Print the query results via PAGER.<br><span class="hljs-built_in">print</span>     (\p) Print current <span class="hljs-built_in">command</span>.<br>prompt    (\R) Change your mysql prompt.<br>quit      (\q) Quit mysql.<br><span class="hljs-built_in">rehash</span>    (\<span class="hljs-comment">#) Rebuild completion hash.</span><br><span class="hljs-built_in">source</span>    (\.) Execute an SQL script file. Takes a file name as an argument.<br>status    (\s) Get status information from the server.<br>system    (\!) Execute a system shell <span class="hljs-built_in">command</span>.<br><span class="hljs-built_in">tee</span>       (\T) Set outfile [to_outfile]. Append everything into given outfile.<br>use       (\u) Use another database. Takes database name as argument.<br>charset   (\C) Switch to another charset. Might be needed <span class="hljs-keyword">for</span> processing binlog with multi-byte charsets.<br>warnings  (\W) Show warnings after every statement.<br>nowarning (\w) Don<span class="hljs-string">&#x27;t show warnings after every statement.</span><br><span class="hljs-string">resetconnection(\x) Clean session context.</span><br><span class="hljs-string">query_attributes Sets string parameters (name1 value1 name2 value2 ...) for the next query to pick up.</span><br><span class="hljs-string">ssl_session_data_print Serializes the current SSL session data to stdout or file</span><br><span class="hljs-string"></span><br><span class="hljs-string">For server side help, type &#x27;</span><span class="hljs-built_in">help</span> contents<span class="hljs-string">&#x27;</span><br></code></pre></td></tr></table></figure><h3 id="2、查看数据库"><a href="#2、查看数据库" class="headerlink" title="2、查看数据库"></a>2、查看数据库</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">mysql&gt; show databases;<br>+--------------------+<br>| Database           |<br>+--------------------+<br>| information_schema |<br>| mysql              |<br>| performance_schema |<br>| sys                |<br>+--------------------+<br>4 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.01 sec)<br><br></code></pre></td></tr></table></figure><h3 id="3、查看当前数据库"><a href="#3、查看当前数据库" class="headerlink" title="3、查看当前数据库"></a>3、查看当前数据库</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">mysql&gt; <span class="hljs-keyword">select</span>  database();<br>+------------+<br>| database() |<br>+------------+<br>| mysql      |<br>+------------+<br>1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br></code></pre></td></tr></table></figure><h3 id="4、查看当前用户"><a href="#4、查看当前用户" class="headerlink" title="4、查看当前用户"></a>4、查看当前用户</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">mysql&gt; <span class="hljs-keyword">select</span>  user();<br>+----------------+<br>| user()         |<br>+----------------+<br>| root@localhost |<br>+----------------+<br>1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br></code></pre></td></tr></table></figure><h3 id="5、修改提示符"><a href="#5、修改提示符" class="headerlink" title="5、修改提示符"></a>5、修改提示符</h3><blockquote><p>临时修改 </p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@Rocky8-11 ~]<span class="hljs-comment"># export MYSQL_PS1=&quot;\\r:\\m:\\s(\\u@\\h) [\\d]\\_&quot;</span><br><br>[root@Rocky8-11 ~]<span class="hljs-comment"># mysql -uroot -p654321</span><br>mysql: [Warning] Using a password on the <span class="hljs-built_in">command</span> line interface can be insecure.<br>Welcome to the MySQL monitor.  Commands end with ; or \g.<br>Your MySQL connection <span class="hljs-built_in">id</span> is 32<br>Server version: 8.0.30 Source distribution<br><br>Copyright (c) 2000, 2022, Oracle and/or its affiliates.<br><br>Oracle is a registered trademark of Oracle Corporation and/or its<br>affiliates. Other names may be trademarks of their respective<br>owners.<br><br>Type <span class="hljs-string">&#x27;help;&#x27;</span> or <span class="hljs-string">&#x27;\h&#x27;</span> <span class="hljs-keyword">for</span> <span class="hljs-built_in">help</span>. Type <span class="hljs-string">&#x27;\c&#x27;</span> to clear the current input statement.<br><br>03:49:30(root@localhost) [(none)] <br></code></pre></td></tr></table></figure><blockquote><p>永久修改</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@Rocky8-11 ~]<span class="hljs-comment"># vim /etc/my.cnf.d/mysql-clients.cnf</span><br>[mysql]<br>prompt=<span class="hljs-string">&quot;\\r:\\m:\\s(\\u@\\h) [\\d]\\_&quot;</span><br> <br>[root@Rocky8-11 ~]<span class="hljs-comment"># mysql --print-defaults -v</span><br>mysql would have been started with the following arguments:<br>--prompt=\r:\m:\s(\u@\h) [\d]\_ -v <br><br>[root@Rocky8-11 ~]<span class="hljs-comment"># mysql -uroot -p654321</span><br>mysql: [Warning] Using a password on the <span class="hljs-built_in">command</span> line interface can be insecure.<br>Welcome to the MySQL monitor.  Commands end with ; or \g.<br>Your MySQL connection <span class="hljs-built_in">id</span> is 8<br>Server version: 8.0.30 Source distribution<br><br>Copyright (c) 2000, 2022, Oracle and/or its affiliates.<br><br>Oracle is a registered trademark of Oracle Corporation and/or its<br>affiliates. Other names may be trademarks of their respective<br>owners.<br><br>Type <span class="hljs-string">&#x27;help;&#x27;</span> or <span class="hljs-string">&#x27;\h&#x27;</span> <span class="hljs-keyword">for</span> <span class="hljs-built_in">help</span>. Type <span class="hljs-string">&#x27;\c&#x27;</span> to clear the current input statement.<br><br>03:56:00(root@localhost) [(none)] <br></code></pre></td></tr></table></figure><h3 id="6、MySQL自动登录"><a href="#6、MySQL自动登录" class="headerlink" title="6、MySQL自动登录"></a>6、MySQL自动登录</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@Rocky8-11 ~]<span class="hljs-comment"># vim /etc/my.cnf.d/mysql-clients.cnf</span><br>[client]<br>user=root<br>password=654321<br></code></pre></td></tr></table></figure><h3 id="7、MySQL用户账号"><a href="#7、MySQL用户账号" class="headerlink" title="7、MySQL用户账号"></a>7、MySQL用户账号</h3><blockquote><p>MySQL用户账号由两部分组成</p><p>‘USERNAME‘@’HOST’</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@<span class="hljs-string">&#x27;localhost&#x27;</span>          <span class="hljs-comment">## 本地登录账号</span><br>xcjyc@<span class="hljs-string">&#x27;10.0.0.11&#x27;</span>         <span class="hljs-comment">## 指定IP</span><br>xcjyc@<span class="hljs-string">&#x27;10.0.0.%&#x27;</span>          <span class="hljs-comment">## 匹配指定网段 </span><br>xcjyc@<span class="hljs-string">&#x27;%&#x27;</span>                 <span class="hljs-comment">## 匹配所有地址</span><br></code></pre></td></tr></table></figure><h3 id="8、创建用户-授权"><a href="#8、创建用户-授权" class="headerlink" title="8、创建用户&#x2F;授权"></a>8、创建用户&#x2F;授权</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">04:39:29(root@localhost) [(none)]  create user <span class="hljs-built_in">test</span>@<span class="hljs-string">&#x27;10.0.0.%&#x27;</span> identified by <span class="hljs-string">&#x27;123456&#x27;</span>;<br>Query OK, 0 rows affected (0.03 sec)<br><br>04:39:44(root@localhost) [(none)] grant all on hellodb.* to <span class="hljs-built_in">test</span>@<span class="hljs-string">&#x27;10.0.0.%&#x27;</span>;<br>Query OK, 0 rows affected (0.01 sec)<br><br>早期版本一条命令创建+授权：<br>grant all on hellodb.* to <span class="hljs-built_in">test</span>@<span class="hljs-string">&#x27;10.0.0.%&#x27;</span> identified by <span class="hljs-string">&#x27;123456&#x27;</span><br></code></pre></td></tr></table></figure><h3 id="9、修改密码"><a href="#9、修改密码" class="headerlink" title="9、修改密码"></a>9、修改密码</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">mysql&gt; <span class="hljs-built_in">set</span> password <span class="hljs-keyword">for</span> root@<span class="hljs-string">&#x27;localhost&#x27;</span>=<span class="hljs-string">&#x27;654321&#x27;</span>;<br>Query OK, 0 rows affected (0.01 sec)<br><br>mysql&gt; ALTER USER root@<span class="hljs-string">&#x27;localhost&#x27;</span> IDENTIFIED BY <span class="hljs-string">&#x27;123456&#x27;</span>;<br>Query OK, 0 rows affected (0.00 sec)<br></code></pre></td></tr></table></figure><h3 id="10、遗忘root密码"><a href="#10、遗忘root密码" class="headerlink" title="10、遗忘root密码"></a>10、遗忘root密码</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@Rocky8-11 ~]<span class="hljs-comment"># vim /etc/my.cnf</span><br>[mysqld]<br>skip-grant-tables<br>skip-networking<br>[root@Rocky8-11 ~]<span class="hljs-comment"># systemctl restart mysqld</span><br>[root@Rocky8-11 ~]<span class="hljs-comment"># mysql</span><br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">mysql&gt; update mysql.user <span class="hljs-built_in">set</span> authentication_string=<span class="hljs-string">&#x27;123456&#x27;</span> <span class="hljs-built_in">where</span> user=<span class="hljs-string">&#x27;root&#x27;</span> and host=<span class="hljs-string">&#x27;localhost&#x27;</span>;<br>Query OK, 1 row affected (0.01 sec)<br>Rows matched: 1  Changed: 1  Warnings: 0<br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@Rocky8-11 ~]<span class="hljs-comment"># vim /etc/my.cnf     ## 删除参数</span><br>[root@Rocky8-11 ~]<span class="hljs-comment"># systemctl restart mysqld</span><br></code></pre></td></tr></table></figure><h3 id="11、查看当前默认的存储引擎"><a href="#11、查看当前默认的存储引擎" class="headerlink" title="11、查看当前默认的存储引擎"></a>11、查看当前默认的存储引擎</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">mysql&gt; show variables like <span class="hljs-string">&#x27;%storage_engine%&#x27;</span>;<br>+---------------------------------+-----------+<br>| Variable_name                   | Value     |<br>+---------------------------------+-----------+<br>| default_storage_engine          | InnoDB    |<br>| default_tmp_storage_engine      | InnoDB    |<br>| disabled_storage_engines        |           |<br>| internal_tmp_mem_storage_engine | TempTable |<br>+---------------------------------+-----------+<br>4 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.01 sec)<br></code></pre></td></tr></table></figure><h3 id="12、修改最大并发连接数"><a href="#12、修改最大并发连接数" class="headerlink" title="12、修改最大并发连接数"></a>12、修改最大并发连接数</h3><p>默认为151</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">mysql&gt; show variables like <span class="hljs-string">&#x27;max_connections&#x27;</span>;<br>+-----------------+-------+<br>| Variable_name   | Value |<br>+-----------------+-------+<br>| max_connections | 151   |<br>+-----------------+-------+<br>1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.01 sec)<br></code></pre></td></tr></table></figure><p>修改该变量为8000</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">mysql&gt; <span class="hljs-built_in">set</span> global max_connections=8000;<br>Query OK, 0 rows affected (0.00 sec)<br><br>mysql&gt; show variables like <span class="hljs-string">&#x27;max_connections&#x27;</span>;<br>+-----------------+-------+<br>| Variable_name   | Value |<br>+-----------------+-------+<br>| max_connections | 8000  |<br>+-----------------+-------+<br>1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br></code></pre></td></tr></table></figure><p>修改配置文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@Rocky8-11 ~]<span class="hljs-comment"># vim /etc/my.cnf</span><br>[mysqld]<br>max_connections = 8000<br><br>[service]<br>limitnofile = 65535<br><br>[root@Rocky8-11 ~]<span class="hljs-comment"># systemctl restart mysqld</span><br>[root@Rocky8-11 ~]<span class="hljs-comment"># mysql </span><br>mysql&gt; <span class="hljs-keyword">select</span> @@max_connections;<br>+-------------------+<br>| @@max_connections |<br>+-------------------+<br>|              8000 |<br>+-------------------+<br>1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br></code></pre></td></tr></table></figure><h3 id="13、查看数据库表结构"><a href="#13、查看数据库表结构" class="headerlink" title="13、查看数据库表结构"></a>13、查看数据库表结构</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash">mysql&gt; desc students;<br>+-----------+------------------+------+-----+---------+----------------+<br>| Field     | Type             | Null | Key | Default | Extra          |<br>+-----------+------------------+------+-----+---------+----------------+<br>| StuID     | int unsigned     | NO   | PRI | NULL    | auto_increment |<br>| Name      | varchar(50)      | NO   |     | NULL    |                |<br>| Age       | tinyint unsigned | NO   |     | NULL    |                |<br>| Gender    | enum(<span class="hljs-string">&#x27;F&#x27;</span>,<span class="hljs-string">&#x27;M&#x27;</span>)    | NO   |     | NULL    |                |<br>| ClassID   | tinyint unsigned | YES  |     | NULL    |                |<br>| TeacherID | int unsigned     | YES  |     | NULL    |                |<br>+-----------+------------------+------+-----+---------+----------------+<br>6 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.01 sec)<br></code></pre></td></tr></table></figure><h3 id="14、查看索引信息"><a href="#14、查看索引信息" class="headerlink" title="14、查看索引信息"></a>14、查看索引信息</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs bash">09:19:06(root@localhost) [hellodb] show index from students\G<br>*************************** 1. row ***************************<br>        Table: students<br>   Non_unique: 0<br>     Key_name: PRIMARY<br> Seq_in_index: 1<br>  Column_name: StuID<br>    Collation: A<br>  Cardinality: 25<br>     Sub_part: NULL<br>       Packed: NULL<br>         Null: <br>   Index_type: BTREE<br>      Comment: <br>Index_comment: <br>      Visible: YES<br>   Expression: NULL<br>1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br><br><br></code></pre></td></tr></table></figure><h3 id="15、创建索引"><a href="#15、创建索引" class="headerlink" title="15、创建索引"></a>15、创建索引</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs bash">09:23:00(root@localhost) [hellodb] create index idx_name on students(name(10));<br>Query OK, 0 rows affected (0.08 sec)<br>Records: 0  Duplicates: 0  Warnings: 0<br><br>09:24:11(root@localhost) [hellodb] show indexes from students\G<br>*************************** 1. row ***************************<br>        Table: students<br>   Non_unique: 0<br>     Key_name: PRIMARY<br> Seq_in_index: 1<br>  Column_name: StuID<br>    Collation: A<br>  Cardinality: 25<br>     Sub_part: NULL<br>       Packed: NULL<br>         Null: <br>   Index_type: BTREE<br>      Comment: <br>Index_comment: <br>      Visible: YES<br>   Expression: NULL<br>*************************** 2. row ***************************<br>        Table: students<br>   Non_unique: 1<br>     Key_name: idx_name<br> Seq_in_index: 1<br>  Column_name: Name<br>    Collation: A<br>  Cardinality: 25<br>     Sub_part: 10<br>       Packed: NULL<br>         Null: <br>   Index_type: BTREE<br>      Comment: <br>Index_comment: <br>      Visible: YES<br>   Expression: NULL<br>2 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.01 sec)<br></code></pre></td></tr></table></figure><h3 id="16、Profile工具"><a href="#16、Profile工具" class="headerlink" title="16、Profile工具"></a>16、Profile工具</h3><blockquote><p>打开Profile选项后，会显示语句执行的详细过程</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs bash">09:26:02(root@localhost) [hellodb] <span class="hljs-built_in">set</span> profiling = on<br>09:28:20(root@localhost) [hellodb] show profiles;<br>Empty <span class="hljs-built_in">set</span>, 1 warning (0.00 sec)<br>09:28:30(root@localhost) [hellodb] show indexes from students\G<br>*************************** 1. row ***************************<br>        Table: students<br>   Non_unique: 0<br>     Key_name: PRIMARY<br> Seq_in_index: 1<br>  Column_name: StuID<br>    Collation: A<br>  Cardinality: 25<br>     Sub_part: NULL<br>       Packed: NULL<br>         Null: <br>   Index_type: BTREE<br>      Comment: <br>Index_comment: <br>      Visible: YES<br>   Expression: NULL<br>*************************** 2. row ***************************<br>        Table: students<br>   Non_unique: 1<br>     Key_name: idx_name<br> Seq_in_index: 1<br>  Column_name: Name<br>    Collation: A<br>  Cardinality: 25<br>     Sub_part: 10<br>       Packed: NULL<br>         Null: <br>   Index_type: BTREE<br>      Comment: <br>Index_comment: <br>      Visible: YES<br>   Expression: NULL<br>2 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.01 sec)<br><br>09:28:39(root@localhost) [hellodb] show profiles;<br>+----------+------------+----------------------------+<br>| Query_ID | Duration   | Query                      |<br>+----------+------------+----------------------------+<br>|        1 | 0.00853900 | show indexes from students |<br>+----------+------------+----------------------------+<br>1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span>, 1 warning (0.00 sec)<br></code></pre></td></tr></table></figure><blockquote><p>查看详细执行步骤和时长：</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs bash">09:31:05(root@localhost) [hellodb] show profile <span class="hljs-keyword">for</span> query 1;<br>+--------------------------------+----------+<br>| Status                         | Duration |<br>+--------------------------------+----------+<br>| starting                       | 0.000726 |<br>| Executing hook on transaction  | 0.000018 |<br>| starting                       | 0.000426 |<br>| checking permissions           | 0.000023 |<br>| checking permissions           | 0.000010 |<br>| Opening tables                 | 0.004917 |<br>| init                           | 0.000036 |<br>| System lock                    | 0.000023 |<br>| optimizing                     | 0.000142 |<br>| statistics                     | 0.000375 |<br>| preparing                      | 0.000065 |<br>| Creating tmp table             | 0.000475 |<br>| executing                      | 0.000385 |<br>| checking permissions           | 0.000592 |<br>| end                            | 0.000020 |<br>| query end                      | 0.000009 |<br>| waiting <span class="hljs-keyword">for</span> handler commit     | 0.000050 |<br>| closing tables                 | 0.000099 |<br>| freeing items                  | 0.000128 |<br>| cleaning up                    | 0.000021 |<br>+--------------------------------+----------+<br>20 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span>, 1 warning (0.00 sec)<br></code></pre></td></tr></table></figure><blockquote><p>查看CPU消耗</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs bash">09:31:13(root@localhost) [hellodb] show profile cpu <span class="hljs-keyword">for</span> query 1;<br>+--------------------------------+----------+----------+------------+<br>| Status                         | Duration | CPU_user | CPU_system |<br>+--------------------------------+----------+----------+------------+<br>| starting                       | 0.000726 | 0.000713 |   0.000000 |<br>| Executing hook on transaction  | 0.000018 | 0.000015 |   0.000000 |<br>| starting                       | 0.000426 | 0.000429 |   0.000000 |<br>| checking permissions           | 0.000023 | 0.000021 |   0.000000 |<br>| checking permissions           | 0.000010 | 0.000010 |   0.000000 |<br>| Opening tables                 | 0.004917 | 0.004928 |   0.000000 |<br>| init                           | 0.000036 | 0.000032 |   0.000000 |<br>| System lock                    | 0.000023 | 0.000023 |   0.000000 |<br>| optimizing                     | 0.000142 | 0.000144 |   0.000000 |<br>| statistics                     | 0.000375 | 0.000365 |   0.000000 |<br>| preparing                      | 0.000065 | 0.000064 |   0.000000 |<br>| Creating tmp table             | 0.000475 | 0.000477 |   0.000000 |<br>| executing                      | 0.000385 | 0.000373 |   0.000000 |<br>| checking permissions           | 0.000592 | 0.000591 |   0.000000 |<br>| end                            | 0.000020 | 0.000018 |   0.000000 |<br>| query end                      | 0.000009 | 0.000009 |   0.000000 |<br>| waiting <span class="hljs-keyword">for</span> handler commit     | 0.000050 | 0.000050 |   0.000000 |<br>| closing tables                 | 0.000099 | 0.000099 |   0.000000 |<br>| freeing items                  | 0.000128 | 0.000122 |   0.000000 |<br>| cleaning up                    | 0.000021 | 0.000019 |   0.000000 |<br>+--------------------------------+----------+----------+------------+<br>20 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span>, 1 warning (0.00 sec)<br></code></pre></td></tr></table></figure><h3 id="17、事务日志"><a href="#17、事务日志" class="headerlink" title="17、事务日志"></a>17、事务日志</h3><blockquote><p>redo log：记录某数据块被修改后的值，数据更新前先记录redolog，可以用来恢复未写入datafile的已成功事务更新的数据</p><p>undo log：保存与执行的操作相反的操作，即记录某数据被修改前的值，可以用来在事务失败时进行rollback(回退)</p><p>事务型存储引擎自行管理和使用，建议与数据文件分开存放</p><p>事务日志文件根据设置的日志组文件成员个数和日志文件大小，循环覆盖写入日志文件</p></blockquote><p>事务日志相关配置：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash">05:07:25(root@localhost) [(none)] show variables like <span class="hljs-string">&#x27;%innodb_log%&#x27;</span>;<br>+------------------------------------+----------+<br>| Variable_name                      | Value    |<br>+------------------------------------+----------+<br>| innodb_log_buffer_size             | 16777216 |<br>| innodb_log_checksums               | ON       |<br>| innodb_log_compressed_pages        | ON       |<br>| innodb_log_file_size               | 50331648 |      <span class="hljs-comment">## 每个日志文件大小</span><br>| innodb_log_files_in_group          | 2        |      <span class="hljs-comment">## 日志组文件成员个数</span><br>| innodb_log_group_home_dir          | ./       |      <span class="hljs-comment">## 事务日志文件路径</span><br>| innodb_log_spin_cpu_abs_lwm        | 80       |<br>| innodb_log_spin_cpu_pct_hwm        | 50       |<br>| innodb_log_wait_for_flush_spin_hwm | 400      |<br>| innodb_log_write_ahead_size        | 8192     |<br>| innodb_log_writer_threads          | ON       |<br>+------------------------------------+----------+<br>11 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br></code></pre></td></tr></table></figure><p>事务日志性能优化：</p><blockquote><p>1  默认值，日志缓冲区将写入日志文件，并在每次事务后执行刷新到磁盘。</p><p>0  提交时没有写磁盘的操作，每秒执行一次将日志缓冲区提交的事务写入刷新到磁盘，可提供更好的性能，但服务器崩溃可能丢失最后一秒的事务</p><p>2  每次提交都会写入OS的缓冲区，但每秒会进行一次刷新到磁盘文件，性能比0略差，可能会丢失最后一秒的数据，</p><p>建议：OS比mysql进程稳定，高并发业务选择配置2。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">05:13:38(root@localhost) [(none)] <span class="hljs-keyword">select</span> @@innodb_flush_log_at_trx_commit;<br>+----------------------------------+<br>| @@innodb_flush_log_at_trx_commit |<br>+----------------------------------+<br>|                                1 |<br>+----------------------------------+<br>1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br></code></pre></td></tr></table></figure><h3 id="18、错误日志"><a href="#18、错误日志" class="headerlink" title="18、错误日志"></a>18、错误日志</h3><p>错误日志的路径</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">05:13:50(root@localhost) [(none)] show GLOBAL VARIABLES LIKE <span class="hljs-string">&#x27;log_error&#x27;</span>;<br>+---------------+---------------------------+<br>| Variable_name | Value                     |<br>+---------------+---------------------------+<br>| log_error     | /var/log/mysql/mysqld.log |<br>+---------------+---------------------------+<br>1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br></code></pre></td></tr></table></figure><h3 id="19、通用日志"><a href="#19、通用日志" class="headerlink" title="19、通用日志"></a>19、通用日志</h3><p>默认没有启用通用日志</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">05:25:31(root@localhost) [(none)] <span class="hljs-keyword">select</span> @@general_log;<br>+---------------+<br>| @@general_log |<br>+---------------+<br>|             0 |<br>+---------------+<br>1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br></code></pre></td></tr></table></figure><p> 启用通用日志</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">05:25:35(root@localhost) [(none)] <span class="hljs-built_in">set</span> global general_log=1;<br>Query OK, 0 rows affected (0.01 sec)<br><br>05:26:28(root@localhost) [(none)] <span class="hljs-keyword">select</span> @@general_log;<br>+---------------+<br>| @@general_log |<br>+---------------+<br>|             1 |<br>+---------------+<br>1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br></code></pre></td></tr></table></figure><p>通用日志存放类型（可以存放在文件或表中）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">05:26:36(root@localhost) [(none)] show global variables like <span class="hljs-string">&#x27;log_output&#x27;</span>;<br>+---------------+-------+<br>| Variable_name | Value |<br>+---------------+-------+<br>| log_output    | FILE  |<br>+---------------+-------+<br>1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.01 sec)<br></code></pre></td></tr></table></figure><p>通用日志文件路径</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">05:27:52(root@localhost) [(none)] <span class="hljs-keyword">select</span> @@general_log_file;<br>+------------------------------+<br>| @@general_log_file           |<br>+------------------------------+<br>| /var/lib/mysql/Rocky8-11.<span class="hljs-built_in">log</span> |<br>+------------------------------+<br>1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.01 sec)<br></code></pre></td></tr></table></figure><h3 id="20、慢查询日志"><a href="#20、慢查询日志" class="headerlink" title="20、慢查询日志"></a>20、慢查询日志</h3><blockquote><p>慢查询日志记录执行查询时长超出指定时长的操作 </p></blockquote><p>慢查询分析工具：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@Rocky8-11 ~]<span class="hljs-comment"># mysqldumpslow --help </span><br>Usage: mysqldumpslow [ OPTS... ] [ LOGS... ]<br><br>Parse and summarize the MySQL slow query <span class="hljs-built_in">log</span>. Options are<br><br>  --verbose    verbose<br>  --debug      debug<br>  --<span class="hljs-built_in">help</span>       write this text to standard output<br><br>  -v           verbose<br>  -d           debug<br>  -s ORDER     what to <span class="hljs-built_in">sort</span> by (al, at, ar, c, l, r, t), <span class="hljs-string">&#x27;at&#x27;</span> is default<br>                al: average lock time<br>                ar: average rows sent<br>                at: average query time<br>                 c: count<br>                 l: lock time<br>                 r: rows sent<br>                 t: query time  <br>  -r           reverse the <span class="hljs-built_in">sort</span> order (largest last instead of first)<br>  -t NUM       just show the top n queries<br>  -a           don<span class="hljs-string">&#x27;t abstract all numbers to N and strings to &#x27;</span>S<span class="hljs-string">&#x27;</span><br><span class="hljs-string">  -n NUM       abstract numbers with at least n digits within names</span><br><span class="hljs-string">  -g PATTERN   grep: only consider stmts that include this string</span><br><span class="hljs-string">  -h HOSTNAME  hostname of db server for *-slow.log filename (can be wildcard),</span><br><span class="hljs-string">               default is &#x27;</span>*<span class="hljs-string">&#x27;, i.e. match all</span><br><span class="hljs-string">  -i NAME      name of server instance (if using mysql.server startup script)</span><br><span class="hljs-string">  -l           don&#x27;</span>t subtract lock time from total time<br></code></pre></td></tr></table></figure><p>示例：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@Rocky8-11 ~]<span class="hljs-comment"># mysqldumpslow -s c -t 2 /var/lib/mysql/slow.log</span><br></code></pre></td></tr></table></figure><h3 id="21、MySQL可用选项列表及当前值"><a href="#21、MySQL可用选项列表及当前值" class="headerlink" title="21、MySQL可用选项列表及当前值"></a>21、MySQL可用选项列表及当前值</h3><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-selector-attr">[root@Rocky8-11 ~]</span># mysqld <span class="hljs-attr">--verbose</span> <span class="hljs-attr">--help</span><br></code></pre></td></tr></table></figure><h3 id="22、MySQL当前服务启动选项"><a href="#22、MySQL当前服务启动选项" class="headerlink" title="22、MySQL当前服务启动选项"></a>22、MySQL当前服务启动选项</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros">[root@Rocky8-11 ~]# mysqld --print-defaults<br>/usr/libexec/mysqld would have been started with the following arguments:<br><span class="hljs-attribute">--default_authentication_plugin</span>=mysql_native_password <span class="hljs-attribute">--datadir</span>=/var/lib/mysql <span class="hljs-attribute">--socket</span>=/var/lib/mysql/mysql.sock <span class="hljs-attribute">--log-error</span>=/var/log/mysql/mysqld.log <span class="hljs-attribute">--pid-file</span>=/run/mysqld/mysqld.pid <span class="hljs-attribute">--max_connections</span>=8000 <br></code></pre></td></tr></table></figure><p>命令行中设置：</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs swift">[root<span class="hljs-meta">@Rocky8</span><span class="hljs-operator">-</span><span class="hljs-number">11</span> <span class="hljs-operator">~</span>]# <span class="hljs-regexp">/usr/</span>bin<span class="hljs-operator">/</span>mysqld_safe <span class="hljs-operator">--</span>skip<span class="hljs-operator">-</span>name<span class="hljs-operator">-</span>resolve<span class="hljs-operator">=</span><span class="hljs-number">1</span><br>[root<span class="hljs-meta">@Rocky8</span><span class="hljs-operator">-</span><span class="hljs-number">11</span> <span class="hljs-operator">~</span>]# <span class="hljs-regexp">/usr/</span>libexec<span class="hljs-regexp">/myslqd --basedir=/</span>usr<br></code></pre></td></tr></table></figure><p>配置文件设置：</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs csharp">[<span class="hljs-meta">root@Rocky8-11 ~</span>]<span class="hljs-meta"># vim /etc/my.cnf</span><br>[<span class="hljs-meta">mysqld</span>]<br>skip_name_resolve=<span class="hljs-number">1</span><br>skip-grant-tables<br></code></pre></td></tr></table></figure><h3 id="23、查看global系统变量"><a href="#23、查看global系统变量" class="headerlink" title="23、查看global系统变量"></a>23、查看global系统变量</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-number">02</span>:<span class="hljs-number">16</span>:<span class="hljs-number">22</span>(root<span class="hljs-variable">@localhost</span>) [(<span class="hljs-keyword">none</span>)] <span class="hljs-keyword">show</span> <span class="hljs-keyword">global</span> variables;<br></code></pre></td></tr></table></figure><p>查看指定变量</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs less">02:18:36(root@localhost) [(<span class="hljs-attribute">none)] show variables like &#x27;变量&#x27;;</span><br><span class="hljs-attribute">02</span>:<span class="hljs-number">20</span>:<span class="hljs-number">01</span>(root<span class="hljs-variable">@localhost</span>) [(none)] select @@变量;<br></code></pre></td></tr></table></figure><p>查看选项和部分变量：</p><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs autoit">[root<span class="hljs-symbol">@Rocky8</span><span class="hljs-number">-11</span> ~]<span class="hljs-meta"># mysqladmin variables</span><br></code></pre></td></tr></table></figure><p>修改变量：set</p><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs coq">help <span class="hljs-built_in">set</span><br>SET variable = expr [, variable = expr] ...<br><br>variable: &#123;<br>    user_var_name<br>  | <span class="hljs-type">param_name</span><br>  | <span class="hljs-type">local_var_name</span><br>  | <span class="hljs-type">&#123;GLOBAL</span> | <span class="hljs-type">@@GLOBAL</span>.&#125; system_var_name<br>  | <span class="hljs-type">&#123;PERSIST</span> | <span class="hljs-type">@@PERSIST</span>.&#125; system_var_name<br>  | <span class="hljs-type">&#123;PERSIST_ONLY</span> | <span class="hljs-type">@@PERSIST_ONLY</span>.&#125; system_var_name<br>  | <span class="hljs-type">[SESSION</span> | <span class="hljs-type">@@SESSION</span>. | <span class="hljs-type">@@] system_var_name</span><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs routeros">02:24:45(root@localhost) [(none)] <span class="hljs-built_in">set</span> <span class="hljs-attribute">character_set_results</span>=<span class="hljs-string">&#x27;utf8mb4&#x27;</span>;<br>Query OK, 0 rows affected (0.01 sec)<br></code></pre></td></tr></table></figure><blockquote><p>character_set_results不是服务器选项，写入配置文件将导致服务无法启动</p></blockquote><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs stylus">vim /etc/my<span class="hljs-selector-class">.cnf</span>.d/mysql-server<span class="hljs-selector-class">.cnf</span><br><span class="hljs-selector-attr">[mysqld]</span><br>character_set_results=utf8mb4<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>MySQL</category>
      
    </categories>
    
    
    <tags>
      
      <tag>MariaDB</tag>
      
      <tag>MySQL</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MySQL安装初始化</title>
    <link href="/2023/05/05/MySQL%E5%AE%89%E8%A3%85%E5%88%9D%E5%A7%8B%E5%8C%96/"/>
    <url>/2023/05/05/MySQL%E5%AE%89%E8%A3%85%E5%88%9D%E5%A7%8B%E5%8C%96/</url>
    
    <content type="html"><![CDATA[<h2 id="一、yum安装MySQL-MariaDB"><a href="#一、yum安装MySQL-MariaDB" class="headerlink" title="一、yum安装MySQL&#x2F;MariaDB"></a>一、yum安装MySQL&#x2F;MariaDB</h2><h3 id="1、下载安装MySQL源"><a href="#1、下载安装MySQL源" class="headerlink" title="1、下载安装MySQL源"></a>1、下载安装MySQL源</h3><p><a href="https://dev.mysql.com/downloads/repo/yum/">https://dev.mysql.com/downloads/repo/yum/</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@Rocky8-11 ~]<span class="hljs-comment"># wget  https://dev.mysql.com/get/mysql80-community-release-el8-5.noarch.rpm</span><br>[root@Rocky8-11 ~]<span class="hljs-comment"># ls </span><br>anaconda-ks.cfg  mysql80-community-release-el8-5.noarch.rpm<br>[root@Rocky8-11 ~]<span class="hljs-comment"># yum install mysql80-community-release-el8-5.noarch.rpm</span><br><br>[root@Rocky8-11 ~]<span class="hljs-comment"># yum repolist </span><br>repo <span class="hljs-built_in">id</span>                                                                 repo name<br>appstream                                                               Rocky Linux 8 - AppStream<br>baseos                                                                  Rocky Linux 8 - BaseOS<br>epel                                                                    Extra Packages <span class="hljs-keyword">for</span> Enterprise Linux 8 - x86_64<br>extras                                                                  Rocky Linux 8 - Extras<br>mysql-connectors-community                                              MySQL Connectors Community<br>mysql-tools-community                                                   MySQL Tools Community<br>mysql80-community                                                       MySQL 8.0 Community Server<br></code></pre></td></tr></table></figure><h3 id="2、yum安装MySQL-8-0"><a href="#2、yum安装MySQL-8-0" class="headerlink" title="2、yum安装MySQL 8.0"></a>2、yum安装MySQL 8.0</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@Rocky8-11 ~]<span class="hljs-comment"># yum search mysql-server</span><br>Last metadata expiration check: 21:29:53 ago on Sat 06 May 2023 04:36:41 PM CST.<br>========= Name Exactly Matched: mysql-server =========<br>mysql-server.x86_64 : The MySQL server and related files<br><br>[root@Rocky8-11 ~]<span class="hljs-comment"># yum install -y mysql-server</span><br>Installed:<br>  checkpolicy-2.9-1.el8.x86_64                                                     mariadb-connector-c-config-3.1.11-2.el8_3.noarch                  <br>  mecab-0.996-2.module+el8.6.0+1057+4d6a1721.x86_64                                mysql-8.0.30-1.module+el8.6.0+1057+4d6a1721.x86_64                <br>  mysql-common-8.0.30-1.module+el8.6.0+1057+4d6a1721.x86_64                        mysql-errmsg-8.0.30-1.module+el8.6.0+1057+4d6a1721.x86_64          <br>  mysql-server-8.0.30-1.module+el8.6.0+1057+4d6a1721.x86_64                        policycoreutils-python-utils-2.9-20.el8.noarch                    <br>  protobuf-lite-3.5.0-15.el8.x86_64                                                python3-audit-3.0.7-4.el8.x86_64                                  <br>  python3-libsemanage-2.9-9.el8.x86_64                                             python3-policycoreutils-2.9-20.el8.noarch                           <br>  python3-setools-4.3.0-3.el8.x86_64                                              <br>Complete!<br><br>[root@Rocky8-11 ~]<span class="hljs-comment"># systemctl enable --now mysqld</span><br>Created symlink /etc/systemd/system/multi-user.target.wants/mysqld.service → /usr/lib/systemd/system/mysqld.service.<br><br>[root@Rocky8-11 ~]<span class="hljs-comment"># ss -ntl </span><br>State              Recv-Q             Send-Q                      Local Address:Port                       Peer Address:Port             Process<br>LISTEN             0                  128                               0.0.0.0:111                             0.0.0.0:*                       <br>LISTEN             0                  128                               0.0.0.0:22                              0.0.0.0:*                       <br>LISTEN             0                  70                                      *:33060                                 *:*                       <br>LISTEN             0                  128                                     *:3306                                  *:*                       <br>LISTEN             0                  128                                  [::]:111                                [::]:*                       <br>LISTEN             0                  128                                  [::]:22                                 [::]:*                                    <br><br></code></pre></td></tr></table></figure><h3 id="3、查询初始密码，查询数据库运行状态"><a href="#3、查询初始密码，查询数据库运行状态" class="headerlink" title="3、查询初始密码，查询数据库运行状态"></a>3、查询初始密码，查询数据库运行状态</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@Rocky8-11 ~]<span class="hljs-comment"># grep password /var/log/mysql/mysqld.log </span><br>2023-04-27T12:31:35.953177Z 6 [Warning] [MY-010453] [Server] root@localhost is created with an empty password ! Please consider switching off the --initialize-insecure option.<br><br>[root@Rocky8-11 ~]<span class="hljs-comment"># mysql </span><br>Welcome to the MySQL monitor.  Commands end with ; or \g.<br>Your MySQL connection <span class="hljs-built_in">id</span> is 8<br>Server version: 8.0.30 Source distribution<br><br>Copyright (c) 2000, 2022, Oracle and/or its affiliates.<br><br>Oracle is a registered trademark of Oracle Corporation and/or its<br>affiliates. Other names may be trademarks of their respective<br>owners.<br><br>Type <span class="hljs-string">&#x27;help;&#x27;</span> or <span class="hljs-string">&#x27;\h&#x27;</span> <span class="hljs-keyword">for</span> <span class="hljs-built_in">help</span>. Type <span class="hljs-string">&#x27;\c&#x27;</span> to clear the current input statement.<br><br>mysql&gt; status<br>--------------<br>mysql  Ver 8.0.30 <span class="hljs-keyword">for</span> Linux on x86_64 (Source distribution)<br><br>Connection <span class="hljs-built_in">id</span>:8<br>Current database:<br>Current user:root@localhost<br>SSL:Not <span class="hljs-keyword">in</span> use<br>Current pager:stdout<br>Using outfile:<span class="hljs-string">&#x27;&#x27;</span><br>Using delimiter:;<br>Server version:8.0.30 Source distribution<br>Protocol version:10<br>Connection:Localhost via UNIX socket<br>Server characterset:utf8mb4<br>Db     characterset:utf8mb4<br>Client characterset:utf8mb4<br>Conn.  characterset:utf8mb4<br>UNIX socket:/var/lib/mysql/mysql.sock<br>Binary data as:Hexadecimal<br>Uptime:6 min 7 sec<br><br>Threads: 2  Questions: 5  Slow queries: 0  Opens: 120  Flush tables: 3  Open tables: 36  Queries per second avg: 0.013<br>--------------<br><br></code></pre></td></tr></table></figure><h3 id="4、修改密码"><a href="#4、修改密码" class="headerlink" title="4、修改密码"></a>4、修改密码</h3><p>方法一：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">mysql&gt; alter user root@<span class="hljs-string">&#x27;localhost&#x27;</span> identified by <span class="hljs-string">&#x27;123456&#x27;</span>;<br>Query OK, 0 rows affected (0.00 sec)<br><br>mysql&gt; <br></code></pre></td></tr></table></figure><p>方法二：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@Rocky8-11 ~]<span class="hljs-comment"># mysqladmin -uroot -p&#x27;123456&#x27; password &#x27;654321&#x27;</span><br>mysqladmin: [Warning] Using a password on the <span class="hljs-built_in">command</span> line interface can be insecure.<br>Warning: Since password will be sent to server <span class="hljs-keyword">in</span> plain text, use ssl connection to ensure password safety.<br></code></pre></td></tr></table></figure><p>用新密码登录mysql:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@Rocky8-11 ~]<span class="hljs-comment"># mysql -uroot -p654321</span><br>mysql: [Warning] Using a password on the <span class="hljs-built_in">command</span> line interface can be insecure.<br>Welcome to the MySQL monitor.  Commands end with ; or \g.<br>Your MySQL connection <span class="hljs-built_in">id</span> is 10<br>Server version: 8.0.30 Source distribution<br><br>Copyright (c) 2000, 2022, Oracle and/or its affiliates.<br><br>Oracle is a registered trademark of Oracle Corporation and/or its<br>affiliates. Other names may be trademarks of their respective<br>owners.<br><br>Type <span class="hljs-string">&#x27;help;&#x27;</span> or <span class="hljs-string">&#x27;\h&#x27;</span> <span class="hljs-keyword">for</span> <span class="hljs-built_in">help</span>. Type <span class="hljs-string">&#x27;\c&#x27;</span> to clear the current input statement.<br><br>mysql&gt; <br></code></pre></td></tr></table></figure><h3 id="5、下载安装MariaDB源"><a href="#5、下载安装MariaDB源" class="headerlink" title="5、下载安装MariaDB源"></a>5、下载安装MariaDB源</h3><p><a href="https://mariadb.org/download/?t=repo-config&d=CentOS+7&v=10.11&r_m=aliyun">https://mariadb.org/download/?t=repo-config&amp;d=CentOS+7&amp;v=10.11&amp;r_m=aliyun</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@Rocky8-12 ~]<span class="hljs-comment"># cat /etc/yum.repos.d/mariadb.repo</span><br><span class="hljs-comment"># MariaDB 10.11 CentOS repository list - created 2023-05-07 06:47 UTC</span><br><span class="hljs-comment"># https://mariadb.org/download/</span><br>[mariadb]<br>name = MariaDB<br><span class="hljs-comment"># rpm.mariadb.org is a dynamic mirror if your preferred mirror goes offline. See https://mariadb.org/mirrorbits/ for details.</span><br><span class="hljs-comment"># baseurl = https://rpm.mariadb.org/10.11/centos/$releasever/$basearch</span><br>baseurl = https://mirrors.aliyun.com/mariadb/yum/10.11/centos/<span class="hljs-variable">$releasever</span>/<span class="hljs-variable">$basearch</span><br>module_hotfixes = 1<br><span class="hljs-comment"># gpgkey = https://rpm.mariadb.org/RPM-GPG-KEY-MariaDB</span><br>gpgkey = https://mirrors.aliyun.com/mariadb/yum/RPM-GPG-KEY-MariaDB<br>gpgcheck = 1<br></code></pre></td></tr></table></figure><h3 id="6、yum安装MariaDB"><a href="#6、yum安装MariaDB" class="headerlink" title="6、yum安装MariaDB"></a>6、yum安装MariaDB</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@Rocky8-12 ~]<span class="hljs-comment"># yum search  MariaDB-server </span><br>MariaDB                                                                     224 kB/s | 483 kB     00:02    <br>Last metadata expiration check: 0:00:01 ago on Sun 07 May 2023 02:53:17 PM CST.<br>========= Name Exactly Matched: MariaDB-server =========<br>MariaDB-server.x86_64 : MariaDB database server binaries<br>============= Name &amp; Summary Matched: MariaDB-server ==========<br>MariaDB-server-debuginfo.x86_64 : Debug information <span class="hljs-keyword">for</span> package MariaDB-server<br>========== Name Matched: MariaDB-server ==========<br>mariadb-server.x86_64 : The MariaDB server and related files<br>mariadb-server-galera.x86_64 : The configuration files and scripts <span class="hljs-keyword">for</span> galera replication<br>mariadb-server-utils.x86_64 : Non-essential server utilities <span class="hljs-keyword">for</span> MariaDB/MySQL applications<br><br>[root@Rocky8-12 ~]<span class="hljs-comment"># yum install -y mariadb-server</span><br><br>Installed:<br>  MariaDB-client-10.11.2-1.el8.x86_64          MariaDB-common-10.11.2-1.el8.x86_64                        MariaDB-server-10.11.2-1.el8.x86_64<br>  MariaDB-shared-10.11.2-1.el8.x86_64          boost-program-options-1.66.0-13.el8.x86_64                 galera-4-26.4.14-1.el8.x86_64<br>  libpmem-1.6.1-1.el8.x86_64                   perl-DBI-1.641-4.module+el8.6.0+891+677074cb.x86_64        perl-Math-BigInt-1:1.9998.11-7.el8.noarch <br>  perl-Math-Complex-1.59-421.el8.noarch        socat-1.7.4.1-1.el8.x86_64                                   <br><br>Complete!<br><br>[root@Rocky8-12 ~]<span class="hljs-comment"># systemctl enable --now mariadb</span><br>Created symlink /etc/systemd/system/multi-user.target.wants/mariadb.service → /usr/lib/systemd/system/mariadb.service.<br><br>[root@Rocky8-12 ~]<span class="hljs-comment"># mysql </span><br>Welcome to the MariaDB monitor.  Commands end with ; or \g.<br>Your MariaDB connection <span class="hljs-built_in">id</span> is 3<br>Server version: 10.11.2-MariaDB MariaDB Server<br><br>Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.<br><br>Type <span class="hljs-string">&#x27;help;&#x27;</span> or <span class="hljs-string">&#x27;\h&#x27;</span> <span class="hljs-keyword">for</span> <span class="hljs-built_in">help</span>. Type <span class="hljs-string">&#x27;\c&#x27;</span> to clear the current input statement.<br><br>MariaDB [(none)]&gt; <br>MariaDB [(none)]&gt; status<br>--------------<br>mysql  Ver 15.1 Distrib 10.11.2-MariaDB, <span class="hljs-keyword">for</span> Linux (x86_64) using readline 5.1<br><br>Connection <span class="hljs-built_in">id</span>:3<br>Current database:<br>Current user:root@localhost<br>SSL:Not <span class="hljs-keyword">in</span> use<br>Current pager:stdout<br>Using outfile:<span class="hljs-string">&#x27;&#x27;</span><br>Using delimiter:;<br>Server:MariaDB<br>Server version:10.11.2-MariaDB MariaDB Server<br>Protocol version:10<br>Connection:Localhost via UNIX socket<br>Server characterset:latin1<br>Db     characterset:latin1<br>Client characterset:utf8mb3<br>Conn.  characterset:utf8mb3<br>UNIX socket:/var/lib/mysql/mysql.sock<br>Uptime:1 min 15 sec<br><br>Threads: 1  Questions: 4  Slow queries: 0  Opens: 17  Open tables: 10  Queries per second avg: 0.053<br>--------------<br><br>MariaDB [(none)]&gt; <br></code></pre></td></tr></table></figure><h2 id="二、二进制安装MySQL-8-0"><a href="#二、二进制安装MySQL-8-0" class="headerlink" title="二、二进制安装MySQL 8.0"></a>二、二进制安装MySQL 8.0</h2><h3 id="1、安装环境包"><a href="#1、安装环境包" class="headerlink" title="1、安装环境包"></a>1、安装环境包</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@Rocky8-11 ~]<span class="hljs-comment"># yum install -y libaio numactl-libs</span><br></code></pre></td></tr></table></figure><h3 id="2、准备用户"><a href="#2、准备用户" class="headerlink" title="2、准备用户"></a>2、准备用户</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@Rocky8-11 ~]<span class="hljs-comment"># groupadd  mysql </span><br>[root@Rocky8-11 ~]<span class="hljs-comment"># useradd -r -g mysql -s /bin/false mysql</span><br></code></pre></td></tr></table></figure><h3 id="3、准备二进制程序"><a href="#3、准备二进制程序" class="headerlink" title="3、准备二进制程序"></a>3、准备二进制程序</h3><p><a href="https://dev.mysql.com/downloads/mysql/">https://dev.mysql.com/downloads/mysql/</a></p><p><img src="https://xcj-typora-img.oss-cn-hangzhou.aliyuncs.com/img/20230509213749.png" alt="20230509213749"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@Rocky8-11 ~]<span class="hljs-comment"># wget https://cdn.mysql.com//Downloads/MySQL-8.0/mysql-8.0.33-linux-glibc2.28-x86_64.tar.gz</span><br>[root@Rocky8-11 ~]<span class="hljs-comment"># tar xf mysql-8.0.33-linux-glibc2.28-x86_64.tar.gz -C /usr/local</span><br>[root@Rocky8-11 ~]<span class="hljs-comment"># cd /usr/local/</span><br>[root@Rocky8-11 <span class="hljs-built_in">local</span>]<span class="hljs-comment"># ln -s mysql-8.0.33-linux-glibc2.28-x86_64/ mysql </span><br>[root@Rocky8-11 <span class="hljs-built_in">local</span>]<span class="hljs-comment"># chown  -R mysql.mysql /usr/local/mysql/</span><br>[root@Rocky8-11 <span class="hljs-built_in">local</span>]<span class="hljs-comment"># mkdir -p /data/mysql</span><br><br>[root@Rocky8-11 <span class="hljs-built_in">local</span>]<span class="hljs-comment"># ll </span><br>total 0<br>drwxr-xr-x. 2 root  root    6 Oct 11  2021 bin<br>drwxr-xr-x. 2 root  root    6 Oct 11  2021 etc<br>drwxr-xr-x. 2 root  root    6 Oct 11  2021 games<br>drwxr-xr-x. 2 root  root    6 Oct 11  2021 include<br>drwxr-xr-x. 2 root  root    6 Oct 11  2021 lib<br>drwxr-xr-x. 3 root  root   17 May  6 13:15 lib64<br>drwxr-xr-x. 2 root  root    6 Oct 11  2021 libexec<br>lrwxrwxrwx  1 root  root   36 May  9 22:38 mysql -&gt; mysql-8.0.33-linux-glibc2.28-x86_64/<br>drwxr-xr-x  9 mysql mysql 129 May  9 22:31 mysql-8.0.33-linux-glibc2.28-x86_64<br>drwxr-xr-x. 2 root  root    6 Oct 11  2021 sbin<br>drwxr-xr-x. 5 root  root   49 May  6 13:15 share<br>drwxr-xr-x. 2 root  root    6 Oct 11  2021 src<br></code></pre></td></tr></table></figure><h3 id="4、准备PATH环境"><a href="#4、准备PATH环境" class="headerlink" title="4、准备PATH环境"></a>4、准备PATH环境</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@Rocky8-11 <span class="hljs-built_in">local</span>]<span class="hljs-comment"># echo &#x27;PATH=/usr/local/mysql/bin:$PATH&#x27; &gt; /etc/profile.d/mysql.sh</span><br>[root@Rocky8-11 <span class="hljs-built_in">local</span>]<span class="hljs-comment"># . /etc/profile.d/mysql.sh </span><br>[root@Rocky8-11 <span class="hljs-built_in">local</span>]<span class="hljs-comment"># echo $PATH</span><br>/usr/local/mysql/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/root/bin<br></code></pre></td></tr></table></figure><h3 id="5、准备配置文件"><a href="#5、准备配置文件" class="headerlink" title="5、准备配置文件"></a>5、准备配置文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@Rocky8-11 <span class="hljs-built_in">local</span>]<span class="hljs-comment"># cat /etc/my.cnf</span><br>[mysqld]<br>datadir=/data/mysql<br>skip_name_resolve=1<br>socket=/data/mysql/mysql.sock<br>log-error=/data/mysql/mysql.log<br>pid-file=/data/mysql/mysql.pid<br><br>[client]<br>socket=/data/mysql/mysql.sock<br></code></pre></td></tr></table></figure><h3 id="6、初始化数据库"><a href="#6、初始化数据库" class="headerlink" title="6、初始化数据库"></a>6、初始化数据库</h3><blockquote><p>方法一：生成随机密码</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@Rocky8-11 ~]<span class="hljs-comment"># mysqld --initialize  --user=mysql  --datadir=/data/mysql</span><br>[root@Rocky8-11 ~]<span class="hljs-comment"># grep password /data/mysql/mysql.log</span><br>2023-05-09T14:54:51.466558Z 6 [Note] [MY-010454] [Server] A temporary password is generated <span class="hljs-keyword">for</span> root@localhost: su,V+SoSl1uj<br><br>[root@Rocky8-11 ~]<span class="hljs-comment"># awk &#x27;/temporary password/&#123;print $NF&#125;&#x27; /data/mysql/mysql.log</span><br>su,V+SoSl1uj<br></code></pre></td></tr></table></figure><blockquote><p>方法二：生成空密码</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@Rocky8-11 ~]<span class="hljs-comment"># mysql --initialize-insecure --user=mysql --datadir=/data/mysql</span><br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@Rocky8-11 ~]<span class="hljs-comment"># ls /data/mysql/</span><br> auto.cnf     client-cert.pem     <span class="hljs-string">&#x27;#ib_16384_1.dblwr&#x27;</span>  <span class="hljs-string">&#x27;#innodb_redo&#x27;</span>   mysql.ibd            private_key.pem   server-key.pem   undo_002<br> ca-key.pem   client-key.pem       ib_buffer_pool      <span class="hljs-string">&#x27;#innodb_temp&#x27;</span>   mysql.log            public_key.pem    sys<br> ca.pem      <span class="hljs-string">&#x27;#ib_16384_0.dblwr&#x27;</span>   ibdata1              mysql           performance_schema   server-cert.pem   undo_001<br></code></pre></td></tr></table></figure><h3 id="7、准备服务脚本并启动"><a href="#7、准备服务脚本并启动" class="headerlink" title="7、准备服务脚本并启动"></a>7、准备服务脚本并启动</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@Rocky8-11 ~]<span class="hljs-comment"># cp /usr/local/mysql/support-files/mysql.server  /etc/init.d/mysqld</span><br>[root@Rocky8-11 ~]<span class="hljs-comment"># chkconfig --add mysqld</span><br>[root@Rocky8-11 ~]<span class="hljs-comment"># service mysqld start </span><br>Starting MySQL...                                          [  OK  ]<br>[root@Rocky8-11 ~]<span class="hljs-comment"># ss -ntl </span><br>State              Recv-Q             Send-Q            Local Address:Port                    Peer Address:Port             Process             <br>LISTEN             0                  128                     0.0.0.0:111                          0.0.0.0:*                                    <br>LISTEN             0                  128                     0.0.0.0:22                           0.0.0.0:*                                    <br>LISTEN             0                  70                            *:33060                              *:*                                    <br>LISTEN             0                  128                           *:3306                               *:*                                    <br>LISTEN             0                  128                        [::]:111                             [::]:*                                    <br>LISTEN             0                  128                        [::]:22                              [::]:*        <br></code></pre></td></tr></table></figure><h3 id="8、修改root密码"><a href="#8、修改root密码" class="headerlink" title="8、修改root密码"></a>8、修改root密码</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@Rocky8-11 ~]<span class="hljs-comment"># mysqladmin -uroot -p&#x27;su,V+SoSl1uj&#x27; password 123456</span><br>mysqladmin: [Warning] Using a password on the <span class="hljs-built_in">command</span> line interface can be insecure.<br>Warning: Since password will be sent to server <span class="hljs-keyword">in</span> plain text, use ssl connection to ensure password safety.<br></code></pre></td></tr></table></figure><h3 id="9、登录测试"><a href="#9、登录测试" class="headerlink" title="9、登录测试"></a>9、登录测试</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@Rocky8-11 ~]<span class="hljs-comment"># mysql -uroot -p123456</span><br>mysql: [Warning] Using a password on the <span class="hljs-built_in">command</span> line interface can be insecure.<br>Welcome to the MySQL monitor.  Commands end with ; or \g.<br>Your MySQL connection <span class="hljs-built_in">id</span> is 9<br>Server version: 8.0.33 MySQL Community Server - GPL<br><br>Copyright (c) 2000, 2023, Oracle and/or its affiliates.<br><br>Oracle is a registered trademark of Oracle Corporation and/or its<br>affiliates. Other names may be trademarks of their respective<br>owners.<br><br>Type <span class="hljs-string">&#x27;help;&#x27;</span> or <span class="hljs-string">&#x27;\h&#x27;</span> <span class="hljs-keyword">for</span> <span class="hljs-built_in">help</span>. Type <span class="hljs-string">&#x27;\c&#x27;</span> to clear the current input statement.<br><br>mysql&gt; <br>mysql&gt; show databases;<br>+--------------------+<br>| Database           |<br>+--------------------+<br>| information_schema |<br>| mysql              |<br>| performance_schema |<br>| sys                |<br>+--------------------+<br>4 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.02 sec)<br><br>mysql&gt; <br></code></pre></td></tr></table></figure><h2 id="MySQL安装加固脚本-老版mysql使用"><a href="#MySQL安装加固脚本-老版mysql使用" class="headerlink" title="MySQL安装加固脚本(老版mysql使用)"></a>MySQL安装加固脚本(老版mysql使用)</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@Rocky8-11 ~]<span class="hljs-comment"># mysql_secure_installation </span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>MySQL</category>
      
    </categories>
    
    
    <tags>
      
      <tag>MariaDB</tag>
      
      <tag>init</tag>
      
      <tag>MySQL</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Shell快捷键</title>
    <link href="/2022/11/09/Shell%E5%BF%AB%E6%8D%B7%E9%94%AE/"/>
    <url>/2022/11/09/Shell%E5%BF%AB%E6%8D%B7%E9%94%AE/</url>
    
    <content type="html"><![CDATA[<h1 id="Shell快捷键："><a href="#Shell快捷键：" class="headerlink" title="Shell快捷键："></a>Shell快捷键：</h1><p>Ctrl + a   ————切换到命令行开始</p><p>Ctrl + e   ————切换到命令行末尾</p><p>Ctrl + l    ————清除屏幕内容，等同于clear命令</p><p>Ctrl + u   ————清除&#x2F;剪切光标之前的内容</p><p>Ctrl + k   ————清除&#x2F;剪切光标之后的内容</p><p>Ctrl + y   ————粘贴刚才所删除的字符</p><p>Ctrl + r   ————在历史命令中查找，输入关键字就能调出以前的命令</p><p>Ctrl + c   ————终止命令</p><p>Ctrl + d   ————退出shell，相当于logout命令</p><table><thead><tr><th></th><th>行首</th><th>行尾</th><th>前一个单词</th><th>后一个单词</th></tr></thead><tbody><tr><td>移动</td><td>ctrl + a (home)</td><td>ctrl + e (end)</td><td>ctrl + 方向键左 （alt + f）</td><td>ctrl + 方向键右 (alt + b)</td></tr><tr><td>删除</td><td>ctrl + u (删当前到行首)</td><td>ctrl + k (删当前到行尾)</td><td>ctrl + w (删除至词首)</td><td>alt + d (删除至词尾)</td></tr><tr><td></td><td></td><td></td><td></td><td></td></tr></tbody></table>]]></content>
    
    
    <categories>
      
      <category>Linux基础</category>
      
    </categories>
    
    
    <tags>
      
      <tag>shell</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>正则表达式</title>
    <link href="/2022/11/08/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/"/>
    <url>/2022/11/08/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/</url>
    
    <content type="html"><![CDATA[<h3 id="一、校验数字的表达式"><a href="#一、校验数字的表达式" class="headerlink" title="一、校验数字的表达式"></a><strong>一、校验数字的表达式</strong></h3><p><strong>数字</strong>：^[0-9]* </p><p><strong>n位的数字</strong>：^\d{n} </p><p><strong>至少n位的数字</strong>：^\d{n,} </p><p><strong>m-n位的数字</strong>：^\d{m,n} </p><p><strong>零和非零开头的数字</strong>：^(0|[1-9][0-9]*) </p><p><strong>非零开头的最多带两位小数的数字</strong>：^([1-9][0-9]*)+(.[0-9]{1,2})? </p><p><strong>带1-2位小数的正数或负数</strong>：^(-)?\d+(.\d{1,2})? </p><p><strong>正数、负数、和小数</strong>：^(-|+)?\d+(.\d+)? </p><p><strong>有两位小数的正实数</strong>：^[0-9]+(.[0-9]{2})? </p><p><strong>有1~3位小数的正实数</strong>：^[0-9]+(.[0-9]{1,3})? </p><p><strong>非零的正整数：</strong>^[1-9]\d*  或 ^([1-9][0-9]<em>){1,3}  或 ^+?[1-9][0-9]</em> </p><p><strong>非零的负整数</strong>：^-[1-9][]0-9”*  或 ^-[1-9]\d* </p><p><strong>非负整数</strong>：^\d+  或 ^[1-9]\d*|0 </p><p><strong>非正整数</strong>：^-[1-9]\d*|0  或 ^((-\d+)|(0+)) </p><p><strong>非负浮点数</strong>：^\d+(.\d+)?  或 ^[1-9]\d<em>.\d</em>|0.\d*[1-9]\d*|0?.0+|0 </p><p><strong>非正浮点数</strong>：^((-\d+(.\d+)?)|(0+(.0+)?))  或 ^(-([1-9]\d<em>.\d</em>|0.\d*[1-9]\d*))|0?.0+|0 </p><p><strong>正浮点数</strong>：^[1-9]\d<em>.\d</em>|0.\d*[1-9]\d*  或 ^(([0-9]+.[0-9]<em>[1-9][0-9]</em>)|([0-9]<em>[1-9][0-9]<em>.[0-9]+)|([0-9]</em>[1-9][0-9]</em>)) </p><p><strong>负浮点数</strong>：^-([1-9]\d<em>.\d</em>|0.\d*[1-9]\d*)  或 ^(-(([0-9]+.[0-9]<em>[1-9][0-9]</em>)|([0-9]<em>[1-9][0-9]<em>.[0-9]+)|([0-9]</em>[1-9][0-9]</em>))) </p><p><strong>浮点数</strong>：^(-?\d+)(.\d+)?  或 ^-?([1-9]\d<em>.\d</em>|0.\d*[1-9]\d*|0?.0+|0) </p><h3 id="二、校验字符的表达式"><a href="#二、校验字符的表达式" class="headerlink" title="二、校验字符的表达式"></a><strong>二、校验字符的表达式</strong></h3><p><strong>汉字</strong>：^[\u4e00-\u9fa5]{0,} </p><p><strong>英文和数字</strong>：^[A-Za-z0-9]+  或 ^[A-Za-z0-9]{4,40} </p><p><strong>长度为3-20的所有字符</strong>：^.{3,20} </p><p><strong>由26个英文字母组成的字符串</strong>：^[A-Za-z]+ </p><p><strong>由26个大写英文字母组成的字符串</strong>：^[A-Z]+ </p><p><strong>由26个小写英文字母组成的字符串</strong>：^[a-z]+ </p><p><strong>由数字和26个英文字母组成的字符串</strong>：^[A-Za-z0-9]+ </p><p><strong>由数字、26个英文字母或者下划线组成的字符串</strong>：^\w+  或 ^\w{3,20}</p><p><strong>中文、英文、数字包括下划线</strong>：^[\u4E00-\u9FA5A-Za-z0-9_]+ </p><p><strong>中文、英文、数字但不包括下划线等符号</strong>：^[\u4E00-\u9FA5A-Za-z0-9]+  或 ^[\u4E00-\u9FA5A-Za-z0-9]{2,20} </p><p><strong>其它</strong></p><p>.*匹配除 \n 以外的任何字符。&#x2F;[\u4E00-\u9FA5]&#x2F; 汉字&#x2F;[\uFF00-\uFFFF]&#x2F; 全角符号&#x2F;[\u0000-\u00FF]&#x2F; 半角符号</p><h3 id="三、特殊需求表达式"><a href="#三、特殊需求表达式" class="headerlink" title="三、特殊需求表达式"></a><strong>三、特殊需求表达式</strong></h3><p><strong>Email 地址</strong>：^\w+([-+.]\w+)*@\w+([-.]\w+)<em>.\w+([-.]\w+)</em> </p><p><strong>域名</strong>：[a-zA-Z0-9][-a-zA-Z0-9]{0,62}(&#x2F;.[a-zA-Z0-9][-a-zA-Z0-9]{0,62})+&#x2F;.?</p><p><strong>InternetURL</strong>：[a-zA-z]+:&#x2F;&#x2F;[^\s]* 或 ^http:&#x2F;&#x2F;([\w-]+.)+[\w-]+(&#x2F;[\w-.&#x2F;?%&amp;&#x3D;]*)? </p><p><strong>手机号码</strong>：^(13[0-9]|14[5|7]|15[0|1|2|3|5|6|7|8|9]|18[0|1|2|3|5|6|7|8|9])\d{8} </p><p><strong>电话号码</strong>(“XXX-XXXXXXX”、”XXXX-XXXXXXXX”、”XXX-XXXXXXX”、”XXX-XXXXXXXX”、”XXXXXXX”和”XXXXXXXX)：^((\d{3,4}-)|\d{3.4}-)?\d{7,8} </p><p><strong>国内电话号码</strong>(0511-4405222、021-87888822)：\d{3}-\d{8}|\d{4}-\d{7}</p><p><strong>身份证号</strong>(15位、18位数字)：^\d{15}|\d{18} </p><p><strong>短身份证号码</strong>(数字、字母x结尾)：^([0-9]){7,18}(x|X)?  或 ^\d{8,18}|[0-9x]{8,18}|[0-9X]{8,18}? </p><p><strong>帐号是否合法</strong>(字母开头，允许5-16字节，允许字母数字下划线)：^[a-zA-Z][a-zA-Z0-9_]{4,15} </p><p><strong>密码</strong>(以字母开头，长度在6~18之间，只能包含字母、数字和下划线)：^[a-zA-Z]\w{5,17} </p><p><strong>强密码</strong>(必须包含大小写字母和数字的组合，不能使用特殊字符，长度在8-10之间)：^(?&#x3D;.<em>\d)(?&#x3D;.</em>[a-z])(?&#x3D;.*[A-Z]).{8,10} </p><p><strong>日期格式</strong>：^\d{4}-\d{1,2}-\d{1,2}</p><p><strong>一年的12个月</strong>(01～09和1～12)：^(0?[1-9]|1[0-2]) </p><p><strong>一个月的31天</strong>(01～09和1～31)：^((0?[1-9])|((1|2)[0-9])|30|31) </p><p><strong>钱的输入格式</strong></p><p>有四种钱的表示形式我们可以接受:”10000.00” 和 “10,000.00”, 和没有 “分” 的 “10000” 和 “10,000”：^[1-9][0-9]* </p><p>这表示任意一个不以0开头的数字,但是,这也意味着一个字符”0”不通过,所以我们采用下面的形式：^(0|[1-9][0-9]*) </p><p>一个0或者一个不以0开头的数字.我们还可以允许开头有一个负号：^(0|-?[1-9][0-9]*) </p><p>4.这表示一个0或者一个可能为负的开头不为0的数字.让用户以0开头好了.把负号的也去掉,因为钱总不能是负的吧.下面我们要加的是说明可能的小数部分：^[0-9]+(.[0-9]+)? </p><p>必须说明的是,小数点后面至少应该有1位数，所以”10.”是不通过的,但是 “10” 和 “10.2” 是通过的：^[0-9]+(.[0-9]{2})? </p><p>这样我们规定小数点后面必须有两位，如果你认为太苛刻了，可以这样：^[0-9]+(.[0-9]{1,2})? </p><p>这样就允许用户只写一位小数.下面我们该考虑数字中的 逗号 了，我们可以这样：^[0-9]{1,3}(,[0-9]{3})*(.[0-9]{1,2})? </p><p>1到3个数字,后面跟着任意个 逗号+3个数字，逗号成为可选，而不是必须：^([0-9]+|[0-9]{1,3}(,[0-9]{3})*)(.[0-9]{1,2})? </p><p>备注：这就是最终结果了,别忘了+可以用*替代如果你觉得空字符串也可以接受的话(奇怪,为什么?)最后,别忘了在用函数时去掉去掉那个反</p><p><strong>xml文件</strong>：^([a-zA-Z]+-?)+[a-zA-Z0-9]+.[x|X][m|M][l|L] </p><p><strong>中文字符的正则表达式</strong>：[\u4e00-\u9fa5]</p><p><strong>双字节字符</strong>：^\x00-\xff)</p><p><strong>空白行的正则表达式</strong>：\n\s*\r (可以用来删除空白行)</p><p><strong>HTML标记的正则表达式</strong>：&lt;(\S**?)[^&gt;]<strong>&gt;.</strong>?|&lt;.**? &#x2F;&gt; (网上流传的版本太糟糕，上面这个也仅仅能部分，对于复杂的嵌套标记依旧无能为力)</p><p><strong>首尾空白字符的正则表达式</strong>：^\s**|\s**) (可以用来删除行首行尾的空白字符(包括空格、制表符、换页符等等)，非常有用的表达式)</p><p><strong>腾讯QQ号</strong>：[1-9][0-9]{4,}(腾讯QQ号从10000开始)</p><p><strong>中国邮政编码</strong>：[1-9]\d{5}(?!\d)(中国邮政编码为6位数字)</p><p><strong>IP地址</strong>：\d+.\d+.\d+.\d+(提取IP地址时有用)</p><p><strong>IP地址</strong>：((?:(?:25[0-5]|2[0-4]\d|[01]?\d?\d).){3}(?:25[0-5]|2[0-4]\d|[01]?\d?\d))</p><p><strong>IP-v4地址</strong>：\b(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?).){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\b (提取IP地址时有用)</p><p><strong>校验IP-v6地址</strong>:</p><p>(([-9a-fA-F]{1,4}:){7,7}[-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([-9a-fA-F]{1,4}:){1,6}:[-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([-9a-fA-F]{1,4}:){1,4}(:[-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([-9a-fA-F]{1,4}:){1,2}(:[-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[-9a-fA-F]{,4}){,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[-4]|1{0,1}[0-9]){0,1}[0-9])|([-9a-fA-F]{1,4}:){1,4}:((25[-5]|(2[0-4]|1{,1}[-9]){,1}[-9])\.){3,3}(25[-5]|(2[0-4]|1{,1}[-9]){,1}[-9]))</p><p><strong>子网掩码</strong>：</p><p>((?:(?:25[-5]|2[0-4]\d|[01]?\d?\d)\.){3}(?:25[-5]|2[0-4]\d|[01]?\d?\d))</p><p><strong>校验日期</strong>:</p><p>^(?:(?!0000)[0-9]{4}-(?:(?:0[1-9]|1[0-2])-(?:0[1-9]|1[0-9]|2[0-8])|(?:0[13-9]|1[0-2])-(?:29|30)|(?:0[13578]|1[02])-31)|(?:[0-9]{2}(?:0[48]|[2468][048]|[13579][26])|(?:0[48]|[2468][048]|[13579][26])00)-02-29) (“yyyy-mm-dd“ 格式的日期校验，已考虑平闰年。)</p><p><strong>抽取注释</strong>：</p><p><strong>查找CSS属性</strong>:^\s*[a-zA-Z\-]+\s*[:]{1}\s[a-zA-Z0-9\s.#]+[;]{1}</p><p><strong>提取页面超链接</strong>:(]<em>)(href&#x3D;”https?:\&#x2F;\&#x2F;)((?!(?:(?:www\.)?’.implode(‘|(?:www\.)?’,  follow_list).’))[^” rel&#x3D;”external nofollow” ]+)”((?!.<em>\brel&#x3D;)[^&gt;]</em>)(?:[^&gt;]</em>)&gt;</p><p><strong>提取网页图片</strong>:\&lt; <em>[img][^\\&gt;]</em>[src] *&#x3D; <em>[\“\‘]{0,1}([^\“\‘\ &gt;]</em>)</p><p><strong>提取网页颜色代码</strong>:^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3}) </p><p><strong>文件扩展名效验</strong>:^([a-zA-Z]\:|\\)\\([^\\]+\\)<em>[^\&#x2F;:</em>?”&lt;&gt;|]+\.txt(l)? </p><p><strong>判断IE版本</strong>：^.*MSIE <a href="?:%5C.%5B0-9%5D+">5-8</a>?(?!.<em>Trident\&#x2F;[5-9]\.0).</em>$</p><p><img src="https://xcj-typora-img.oss-cn-hangzhou.aliyuncs.com/img/image-20221108170404708.png" alt="image-20221108170404708"></p><p><img src="https://xcj-typora-img.oss-cn-hangzhou.aliyuncs.com/img/image-20221108170422312.png" alt="image-20221108170422312"></p><p><img src="https://xcj-typora-img.oss-cn-hangzhou.aliyuncs.com/img/image-20221108170430203.png" alt="image-20221108170430203"></p><p><img src="https://xcj-typora-img.oss-cn-hangzhou.aliyuncs.com/img/image-20221108170438395.png" alt="image-20221108170438395"></p><p><img src="https://xcj-typora-img.oss-cn-hangzhou.aliyuncs.com/img/image-20221108170445037.png" alt="image-20221108170445037"></p><p><img src="https://xcj-typora-img.oss-cn-hangzhou.aliyuncs.com/img/image-20221108170452463.png" alt="image-20221108170452463"></p><p><img src="https://xcj-typora-img.oss-cn-hangzhou.aliyuncs.com/img/image-20221108170512270.png" alt="image-20221108170512270"></p><p><img src="https://xcj-typora-img.oss-cn-hangzhou.aliyuncs.com/img/image-20221108170524054.png" alt="image-20221108170524054"></p><p><img src="https://xcj-typora-img.oss-cn-hangzhou.aliyuncs.com/img/image-20221108170535655.png" alt="image-20221108170535655"></p><p><img src="https://xcj-typora-img.oss-cn-hangzhou.aliyuncs.com/img/image-20221108170544613.png" alt="image-20221108170544613"></p>]]></content>
    
    
    <categories>
      
      <category>Linux基础</category>
      
    </categories>
    
    
    <tags>
      
      <tag>正则表达式</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>shell编程实用实例</title>
    <link href="/2022/11/07/Shell%E7%BC%96%E7%A8%8B%E5%AE%9E%E7%94%A8%E5%AE%9E%E4%BE%8B/"/>
    <url>/2022/11/07/Shell%E7%BC%96%E7%A8%8B%E5%AE%9E%E7%94%A8%E5%AE%9E%E4%BE%8B/</url>
    
    <content type="html"><![CDATA[<p>(收集整理)本页所列脚本只做学习之用，请自行测试。盲目使用产生后果与作者无关。</p><h1 id="Linux实用运维脚本"><a href="#Linux实用运维脚本" class="headerlink" title="Linux实用运维脚本"></a>Linux实用运维脚本</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#列出系统中的开放端口以及运行在端口上的服务</span><br>lsof -i <br><br><span class="hljs-comment">#nc命令建立socket连接</span><br><br><span class="hljs-comment">#设置监听　nc -l 5555</span><br><span class="hljs-comment">#连接到套接字 nc 192.0.0.1 5555</span><br><br><span class="hljs-comment">#快速文件传输</span><br><span class="hljs-comment">#接收端　nc -l 5555 &gt; destination_filename</span><br><span class="hljs-comment">#发送端　nc 192.0.0.1 5555 &lt; source_filename</span><br><br><span class="hljs-comment">#找出指定目录最大的n个文件</span><br><span class="hljs-built_in">du</span> -ak target_dir | <span class="hljs-built_in">sort</span> -nrk 1 | <span class="hljs-built_in">head</span> -n 4<br><span class="hljs-comment"># du中a为递归,k为kb；sort中n为数字,r为降序,k指定列</span><br><br><span class="hljs-comment">#向终端中的所有登陆用户发送广播信息</span><br><span class="hljs-built_in">cat</span> message.txt | wall<br><br><span class="hljs-comment">#创建新的screen窗口</span><br>screen<br><br><span class="hljs-comment">#打印所有的.txt和.pdf文件</span><br>find . \( -name <span class="hljs-string">&quot;*.txt&quot;</span> -o -name <span class="hljs-string">&quot;*.pdf&quot;</span> \) -<span class="hljs-built_in">print</span><br><br><span class="hljs-comment"># -exec command &#123;&#125; \;是连用的，所有符合的都会放置在&#123;&#125;中，去执行command </span><br><br><span class="hljs-comment">#将文件分割成多个大小为10kb的文件</span><br><span class="hljs-built_in">split</span> -b 10k data.file <br><br><span class="hljs-comment">#打印两个文件的交集</span><br><span class="hljs-built_in">comm</span> A.txt B.txt -3 | sed <span class="hljs-string">&#x27;s/^\t//&#x27;</span><br><br><span class="hljs-comment">#sed移除空白行</span><br>sed <span class="hljs-string">&#x27;/^$/d&#x27;</span> file<br></code></pre></td></tr></table></figure><h1 id="mysql备份"><a href="#mysql备份" class="headerlink" title="mysql备份"></a>mysql备份</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash</span><br><br><span class="hljs-built_in">set</span> -e<br><br>USER=<span class="hljs-string">&quot;backup&quot;</span><br>PASSWORD=<span class="hljs-string">&quot;backup&quot;</span><br><span class="hljs-comment"># 数据库数据目录 #</span><br>DATA_DIR=<span class="hljs-string">&quot;/data/mysql&quot;</span><br>BIN_INDEX=<span class="hljs-variable">$DATA_DIR</span><span class="hljs-string">&quot;/mysql-bin.index&quot;</span><br><span class="hljs-comment"># 备份目录 #</span><br>BACKUP_DIR=<span class="hljs-string">&quot;/data/backup/mysql&quot;</span><br>BACKUP_LOG=<span class="hljs-string">&quot;/var/log/mysql/backup.log&quot;</span><br><br>DATE=`<span class="hljs-built_in">date</span> +<span class="hljs-string">&quot;%Y%m%d&quot;</span>`<br>TIME=`<span class="hljs-built_in">date</span> +<span class="hljs-string">&quot;%Y%m%d%H&quot;</span>`<br><br>LOG_TIME=`<span class="hljs-built_in">date</span> +<span class="hljs-string">&quot;%Y-%m-%d %H:%M:%S&quot;</span>`<br>DELETE_BINLOG_TIME=<span class="hljs-string">&quot;7 day&quot;</span><br>INCREMENT_INTERVAL=<span class="hljs-string">&quot;3 hour&quot;</span><br><br><span class="hljs-function"><span class="hljs-title">note</span></span>() &#123;<br>    <span class="hljs-built_in">printf</span> <span class="hljs-string">&quot;[<span class="hljs-variable">$LOG_TIME</span>] note: $*\n&quot;</span> &gt;&gt; <span class="hljs-variable">$BACKUP_LOG</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-title">warning</span></span>() &#123;<br>    <span class="hljs-built_in">printf</span> <span class="hljs-string">&quot;[<span class="hljs-variable">$LOG_TIME</span>] warning: $*\n&quot;</span> &gt;&gt; <span class="hljs-variable">$BACKUP_LOG</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-title">error</span></span>() &#123;<br>    <span class="hljs-built_in">printf</span> <span class="hljs-string">&quot;[<span class="hljs-variable">$LOG_TIME</span>] error: $*\n&quot;</span> &gt;&gt; <span class="hljs-variable">$BACKUP_LOG</span>;<br>    <span class="hljs-built_in">exit</span> 1;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-title">full_backup</span></span>() &#123;<br>    <span class="hljs-built_in">local</span> dbs=`<span class="hljs-built_in">ls</span> -l <span class="hljs-variable">$DATA_DIR</span> | grep <span class="hljs-string">&quot;^d&quot;</span> | awk -F <span class="hljs-string">&quot; &quot;</span> <span class="hljs-string">&#x27;&#123;print $9&#125;&#x27;</span>`<br><br>    <span class="hljs-keyword">for</span> db <span class="hljs-keyword">in</span> <span class="hljs-variable">$dbs</span><br>    <span class="hljs-keyword">do</span><br>        <span class="hljs-built_in">local</span> backup_dir=<span class="hljs-variable">$BACKUP_DIR</span><span class="hljs-string">&quot;/full/&quot;</span><span class="hljs-variable">$db</span><br>        <span class="hljs-built_in">local</span> filename=<span class="hljs-variable">$db</span><span class="hljs-string">&quot;.&quot;</span><span class="hljs-variable">$DATE</span><br>        <span class="hljs-built_in">local</span> backup_file=<span class="hljs-variable">$backup_dir</span><span class="hljs-string">&quot;/&quot;</span><span class="hljs-variable">$filename</span><span class="hljs-string">&quot;.sql&quot;</span><br><br>        <span class="hljs-keyword">if</span> [ ! -d <span class="hljs-variable">$backup_dir</span> ]<br>        <span class="hljs-keyword">then</span><br>            <span class="hljs-built_in">mkdir</span> -p <span class="hljs-variable">$backup_dir</span> || &#123; error <span class="hljs-string">&quot;创建数据库 <span class="hljs-variable">$db</span> 全量备份目录 <span class="hljs-variable">$backup_dir</span> 失败&quot;</span>; <span class="hljs-built_in">continue</span>; &#125;<br>            note <span class="hljs-string">&quot;数据库 <span class="hljs-variable">$db</span> 全量备份目录 <span class="hljs-variable">$backup_dir</span>  不存在，创建完成&quot;</span>;<br>        <span class="hljs-keyword">fi</span><br><br>        note <span class="hljs-string">&quot;full backup <span class="hljs-variable">$db</span> start ...&quot;</span><br>        mysqldump --user=<span class="hljs-variable">$&#123;USER&#125;</span> --password=<span class="hljs-variable">$&#123;PASSWORD&#125;</span> --flush-logs --skip-lock-tables --quick <span class="hljs-variable">$db</span> &gt; <span class="hljs-variable">$backup_file</span> || &#123; warning <span class="hljs-string">&quot;数据库 <span class="hljs-variable">$db</span> 备份失败&quot;</span>; <span class="hljs-built_in">continue</span>; &#125;<br><br>        <span class="hljs-built_in">cd</span> <span class="hljs-variable">$backup_dir</span><br>        tar -cPzf <span class="hljs-variable">$filename</span><span class="hljs-string">&quot;.tar.gz&quot;</span> <span class="hljs-variable">$filename</span><span class="hljs-string">&quot;.sql&quot;</span><br>        <span class="hljs-built_in">rm</span> -f <span class="hljs-variable">$backup_file</span><br>        <span class="hljs-built_in">chown</span> -fR mysql:mysql <span class="hljs-variable">$backup_dir</span><br><br>        note <span class="hljs-string">&quot;数据库 <span class="hljs-variable">$db</span> 备份成功&quot;</span>;<br>        note <span class="hljs-string">&quot;full backup <span class="hljs-variable">$db</span> end.&quot;</span><br>    <span class="hljs-keyword">done</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-title">increment_backup</span></span>() &#123;<br>    <span class="hljs-built_in">local</span> StartTime=`<span class="hljs-built_in">date</span> <span class="hljs-string">&quot;-d <span class="hljs-variable">$INCREMENT_INTERVAL</span> ago&quot;</span> +<span class="hljs-string">&quot;%Y-%m-%d %H:%M:%S&quot;</span>`<br>    <span class="hljs-built_in">local</span> DELETE_BINLOG_END_TIME=`<span class="hljs-built_in">date</span> <span class="hljs-string">&quot;-d <span class="hljs-variable">$DELETE_BINLOG_TIME</span> ago&quot;</span> +<span class="hljs-string">&quot;%Y-%m-%d %H:%M:%S&quot;</span>`<br>    <span class="hljs-built_in">local</span> dbs=`<span class="hljs-built_in">ls</span> -l <span class="hljs-variable">$DATA_DIR</span> | grep <span class="hljs-string">&quot;^d&quot;</span> | awk -F <span class="hljs-string">&quot; &quot;</span> <span class="hljs-string">&#x27;&#123;print $9&#125;&#x27;</span>`<br><br>    mysql -u<span class="hljs-variable">$USER</span> -p<span class="hljs-variable">$PASSWORD</span> -e <span class="hljs-string">&quot;purge master logs before &#x27;<span class="hljs-variable">$DELETE_BINLOG_END_TIME</span>&#x27;&quot;</span> &amp;&amp; note <span class="hljs-string">&quot;delete <span class="hljs-variable">$DELETE_BINLOG_TIME</span> days before log&quot;</span>;<br><br>    filename=`<span class="hljs-built_in">cat</span> <span class="hljs-variable">$BIN_INDEX</span> | awk -F <span class="hljs-string">&quot;/&quot;</span> <span class="hljs-string">&#x27;&#123;print $2&#125;&#x27;</span>`<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-variable">$filename</span><br>    <span class="hljs-keyword">do</span><br>        <span class="hljs-keyword">for</span> db <span class="hljs-keyword">in</span> <span class="hljs-variable">$dbs</span><br>        <span class="hljs-keyword">do</span><br>            <span class="hljs-built_in">local</span> backup_dir=<span class="hljs-variable">$BACKUP_DIR</span><span class="hljs-string">&quot;/increment/&quot;</span><span class="hljs-variable">$db</span><br>            <span class="hljs-built_in">local</span> filename=<span class="hljs-variable">$db</span><span class="hljs-string">&quot;.&quot;</span><span class="hljs-variable">$TIME</span><br>            <span class="hljs-built_in">local</span> backup_file=<span class="hljs-variable">$backup_dir</span><span class="hljs-string">&quot;/&quot;</span><span class="hljs-variable">$filename</span><span class="hljs-string">&quot;.sql&quot;</span><br><br>            <span class="hljs-keyword">if</span> [ ! -d <span class="hljs-variable">$backup_dir</span> ]<br>            <span class="hljs-keyword">then</span><br>                <span class="hljs-built_in">mkdir</span> -p <span class="hljs-variable">$backup_dir</span> || &#123; error <span class="hljs-string">&quot;创建数据库 <span class="hljs-variable">$db</span> 增量备份目录 <span class="hljs-variable">$backup_dir</span> 失败&quot;</span>; <span class="hljs-built_in">continue</span>; &#125;<br>                note <span class="hljs-string">&quot;数据库 <span class="hljs-variable">$db</span> 增量备份目录 <span class="hljs-variable">$backup_dir</span>  不存在，创建完成&quot;</span>;<br>            <span class="hljs-keyword">fi</span><br><br>            note <span class="hljs-string">&quot;increment backup <span class="hljs-variable">$db</span> form time <span class="hljs-variable">$StartTime</span> start ...&quot;</span><br><br>            mysqlbinlog -d <span class="hljs-variable">$db</span> --start-datetime=<span class="hljs-string">&quot;<span class="hljs-variable">$StartTime</span>&quot;</span> <span class="hljs-variable">$DATA_DIR</span>/<span class="hljs-variable">$i</span> &gt;&gt; <span class="hljs-variable">$backup_file</span> || &#123; warning <span class="hljs-string">&quot;数据库 <span class="hljs-variable">$db</span> 备份失败&quot;</span>; <span class="hljs-built_in">continue</span>; &#125;<br><br>            note <span class="hljs-string">&quot;increment backup <span class="hljs-variable">$db</span> end.&quot;</span><br>        <span class="hljs-keyword">done</span><br>    <span class="hljs-keyword">done</span><br><br>    <span class="hljs-keyword">for</span> db <span class="hljs-keyword">in</span> <span class="hljs-variable">$dbs</span><br>    <span class="hljs-keyword">do</span><br>        <span class="hljs-built_in">local</span> backup_dir=<span class="hljs-variable">$BACKUP_DIR</span><span class="hljs-string">&quot;/increment/&quot;</span><span class="hljs-variable">$db</span><br>        <span class="hljs-built_in">local</span> filename=<span class="hljs-variable">$db</span><span class="hljs-string">&quot;.&quot;</span><span class="hljs-variable">$TIME</span><br>        <span class="hljs-built_in">local</span> backup_file=<span class="hljs-variable">$backup_dir</span><span class="hljs-string">&quot;/&quot;</span><span class="hljs-variable">$filename</span><span class="hljs-string">&quot;.sql&quot;</span><br><br>        <span class="hljs-built_in">cd</span> <span class="hljs-variable">$backup_dir</span><br>        tar -cPzf <span class="hljs-variable">$filename</span><span class="hljs-string">&quot;.tar.gz&quot;</span> <span class="hljs-variable">$filename</span><span class="hljs-string">&quot;.sql&quot;</span><br>        <span class="hljs-built_in">rm</span> -f <span class="hljs-variable">$backup_file</span><br><br>        note <span class="hljs-string">&quot;数据库 <span class="hljs-variable">$db</span> 备份成功&quot;</span>;<br>    <span class="hljs-keyword">done</span><br>&#125;<br><br><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;<span class="hljs-variable">$1</span>&quot;</span> <span class="hljs-keyword">in</span><br>    full)<br>        full_backup<br>    ;;<br>    increment)<br>        increment_backup<br>    ;;<br>    *)<br>        <span class="hljs-built_in">exit</span> 2<br>    ;;<br><span class="hljs-keyword">esac</span><br><br><span class="hljs-built_in">exit</span> 1<br></code></pre></td></tr></table></figure><h1 id="目录备份"><a href="#目录备份" class="headerlink" title="目录备份"></a>目录备份</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># 时间</span><br>DATE=$(<span class="hljs-built_in">date</span> <span class="hljs-string">&#x27;+%Y-%m-%d_%H_%M_%S&#x27;</span>)<br><span class="hljs-comment"># 备份目录 </span><br>BACKUPDIR=<span class="hljs-string">&quot;/home/backups&quot;</span><br><span class="hljs-comment"># 需要备份的目录</span><br>SORFILE=/opt<br><span class="hljs-comment"># 目标文件名</span><br>DESFILE=/home/backups/<span class="hljs-variable">$SORFILE</span>.$(<span class="hljs-built_in">date</span> <span class="hljs-string">&#x27;+%Y-%m-%d_%H_%M_%S&#x27;</span>).zip<br><br>[ ! -d <span class="hljs-variable">$BACKUPDIR</span> ] &amp;&amp; <span class="hljs-built_in">mkdir</span> -p <span class="hljs-variable">$BACKUPDIR</span><br><span class="hljs-built_in">cd</span> <span class="hljs-variable">$BACKUPDIR</span><br><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;start backup <span class="hljs-variable">$SORFILE</span> ...&quot;</span><br><span class="hljs-built_in">sleep</span> 3<br><span class="hljs-comment">#echo &quot;$DESFILE&quot;</span><br><br><br><span class="hljs-comment">#tar cvf $DESFILE $SORFILE</span><br><span class="hljs-comment">#gzip -f .zip $DESFILE</span><br>zip -r <span class="hljs-variable">$DESFILE</span> <span class="hljs-variable">$SORFILE</span> &amp;&gt;/dev/null<br><span class="hljs-keyword">if</span> [ <span class="hljs-string">&quot;$?&quot;</span> == <span class="hljs-string">&quot;0&quot;</span> ]<br><span class="hljs-keyword">then</span><br>   <span class="hljs-built_in">echo</span> $(<span class="hljs-built_in">date</span> +%Y-%m-%d)<span class="hljs-string">&quot; zip sucess&quot;</span>&gt;&gt;backup.log<br><span class="hljs-keyword">else</span><br>   <span class="hljs-built_in">echo</span> $(<span class="hljs-built_in">date</span> +%Y-%m-%d)<span class="hljs-string">&quot; zip failed&quot;</span>&gt;&gt;backup.log<br>   <span class="hljs-built_in">exit</span> 0<br><span class="hljs-keyword">fi</span><br><br><span class="hljs-comment"># 删除3天前的备份</span><br>find <span class="hljs-variable">$BACKUPDIR</span> -<span class="hljs-built_in">type</span> f -ctime +3 | xargs <span class="hljs-built_in">rm</span> -rf<br></code></pre></td></tr></table></figure><h1 id="PING查询"><a href="#PING查询" class="headerlink" title="PING查询"></a>PING查询</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash</span><br><span class="hljs-comment">#用途：根据网络配置对网络地址192.168.0进行修改，检查是否是活动状态</span><br><br><span class="hljs-comment">#&#123;start..end&#125;shell扩展生成一组地址</span><br><span class="hljs-keyword">for</span> ip <span class="hljs-keyword">in</span> 192.168.0.&#123;1..255&#125;<br><span class="hljs-keyword">do</span> <br>    (<br>    ping <span class="hljs-variable">$ip</span> -c 2 &amp;&gt; /dev/null <br>    <span class="hljs-comment"># &gt; 标准输出重定向，和1&gt;一致</span><br>    <span class="hljs-comment"># 2&gt;&amp;1 将标准错误输出　重定向　到标准输出</span><br>    <span class="hljs-comment"># &amp;&gt;file 将标准输出和标准错误输出都重定向到文件filename中</span><br><br>    <span class="hljs-keyword">if</span> [ $? -eq 0 ];<span class="hljs-keyword">then</span><br>        <span class="hljs-built_in">echo</span> <span class="hljs-variable">$ip</span> is alive<br>    <span class="hljs-keyword">fi</span><br>    )&amp;<br><span class="hljs-keyword">done</span><br><span class="hljs-built_in">wait</span><br><span class="hljs-comment">#并行ping,加速</span><br></code></pre></td></tr></table></figure><h1 id="磁盘IO检查"><a href="#磁盘IO检查" class="headerlink" title="磁盘IO检查"></a>磁盘IO检查</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#文件级IO分析,查看当前文件由哪些进程打开</span><br>lsof   <br><span class="hljs-built_in">ls</span> /proc/pid/fd<br><br><span class="hljs-comment">#利用 sar 报告磁盘 I/O 信息DEV 正在监视的块设备 tps 每秒钟物理设备的 I/O 传输总量 rd_sec/s 每秒从设备读取的扇区数量 wr_sec/s 每秒向设备写入的扇区数量 avgrq-sz I/O 请求的平均扇区数</span><br><span class="hljs-comment">#avgqu-sz I/O 请求的平均队列长度 await I/O 请求的平均等待时间，单位为毫秒 svctm I/O 请求的平均服务时间，单位为毫秒 %util I/O 请求所占用的时间的百分比，即设备利用率</span><br>sar -pd 10 3 <br><br><span class="hljs-comment">#iotop  top的io版</span><br>iotop<br><br><span class="hljs-comment">#查看页面缓存信息 其中的Cached 指用于pagecache的内存大小（diskcache-SwapCache）。随着写入缓存页，Dirty 的值会增加 一旦开始把缓存页写入硬盘,Writeback的值会增加直到写入结束。</span><br><span class="hljs-built_in">cat</span> /proc/meminfo <br><br><span class="hljs-comment">#查看有多少个pdflush进程 Linux 用pdflush进程把数据从缓存页写入硬盘</span><br><span class="hljs-comment">#pdflush的行为受/proc/sys/vm中的参数的控制/proc/sys/vm/dirty_writeback_centisecs (default 500): 1/100秒, 多长时间唤醒pdflush将缓存页数据写入硬盘。默认5秒唤醒2个（更多个）线程。如果wrteback的时间长于dirty_writeback_centisecs的时间，可能会出问题</span><br><span class="hljs-built_in">cat</span> /proc/sys/vm/nr_pdflush_threads<br><br><span class="hljs-comment">#查看I/O 调度器</span><br><span class="hljs-comment">#调度算法</span><br><span class="hljs-comment">#noop anticipatory deadline [cfq] </span><br><span class="hljs-comment">#deadline :    deadline 算法保证对既定的IO请求以最小的延迟时间。</span><br><span class="hljs-comment">#anticipatory：有个IO发生后，如果又有进程请求IO，则产生一个默认6ms猜测时间，猜测下一个进程请求IO是干什么。这对于随机读取会造成较大的延时。对数据库应用很糟糕，而对于Web Server等则会表现不错。</span><br><span class="hljs-comment">#cfq:        对每个进程维护一个IO队列，各个进程发来的IO请求会被cfq以轮循方式处理，对每一个IO请求都是公平。适合离散读的应用。</span><br><span class="hljs-comment">#noop:        对所有IO请求都用FIFO队列形式处理。默认IO不会存在性能问题。</span><br><span class="hljs-built_in">cat</span> /sys/block/[disk]/queue/scheduler<br><br><br><span class="hljs-comment">#改变IO调度器</span><br>$ <span class="hljs-built_in">echo</span> deadline &gt; /sys/block/sdX/queue/scheduler<br><span class="hljs-comment">#提高调度器请求队列的</span><br>$ <span class="hljs-built_in">echo</span> 4096 &gt; /sys/block/sdX/queue/nr_requests<br></code></pre></td></tr></table></figure><p>性能相关</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">##iostat是查看磁盘活动统计情况</span><br><br><span class="hljs-comment">##显示所有设备负载情况 r/s:  每秒完成的读 I/O 设备次数。即 rio/s；w/s:  每秒完成的写 I/O 设备次数。即 wio/s等</span><br>iostat <br><br><span class="hljs-comment">##每隔2秒刷新磁盘IO信息，并且每次显示3次</span><br>iostat 2 3<br><br><span class="hljs-comment">#显示某个磁盘的IO信息</span><br>iostat -d sda1<br><br><span class="hljs-comment">##显示tty和cpu信息</span><br>iostat -t<br><br><span class="hljs-comment">##以M为单位显示磁盘IO信息</span><br>iostat -m<br><br><span class="hljs-comment">##查看TPS和吞吐量信息  kB_read/s：每秒从设备（drive expressed）读取的数据量；kB_wrtn/s：每秒向设备（drive expressed）写入的数据量；kB_read：读取的总数据量；kB_wrtn：写入的总数量数据量；</span><br>iostat -d -k 1 1<br><br><span class="hljs-comment">#查看设备使用率（%util）、响应时间（await）</span><br>iostat -d -x -k 1 1<br><br><span class="hljs-comment">#查看CPU状态</span><br>iostat -c 1 3<br><br><span class="hljs-comment">#统计进程(pid)的stat,进程的stat自然包括进程的IO状况</span><br>pidstat<br><br><span class="hljs-comment">#只显示IO</span><br>pidstat -d  1 <br><br><span class="hljs-comment">#-d IO 信息,-r 缺页及内存信息-u CPU使用率-t 以线程为统计单位1  1秒统计一次</span><br>pidstat -u -r -d -t 1<br><span class="hljs-comment">#查看当前系统load</span><br><span class="hljs-built_in">uptime</span><br><br><span class="hljs-comment">#查看系统状态和每个进程的系统资源使用状况</span><br>top<br><br><span class="hljs-comment">#可视化显示CPU的使用状况</span><br>htop<br><br><span class="hljs-comment">#查看每个CPU的负载信息</span><br>mpstat -P ALL 1<br><br><span class="hljs-comment">#每隔1秒查看磁盘IO的统计信息</span><br>iostat -xkdz 1<br><br><span class="hljs-comment">#每隔一秒查看虚拟内存的使用信息</span><br>vmstat 1<br><br><span class="hljs-comment">#查看内存使用统计信息</span><br>free<br><br><span class="hljs-comment">#查看网络使用信息</span><br>nicstat -z 1<br><br><span class="hljs-comment">#类似vmstat的显示优化的工具</span><br>dstat 1<br><br><span class="hljs-comment">#查看系统活动状态，比如系统分页统计，块设备IO统计等</span><br>sar<br><br><span class="hljs-comment">#网络连接状态查看</span><br>netstat -s<br><br><span class="hljs-comment">#进程资源使用信息查看</span><br>pidstat 1<br>pidstat -d 1<br><br><span class="hljs-comment">#查看某个进程的系统调用信息 -p后面是进程id，-tttT 进程系统后的系统调用时间</span><br>strace -tttT -p 12670<br><span class="hljs-comment">#统计IO设备输入输出的系统调用信息</span><br>strace -c <span class="hljs-built_in">dd</span> <span class="hljs-keyword">if</span>=/dev/zero of=/dev/null bs=512 count=1024k<br><br><br><span class="hljs-comment">#tcpdump 查看网络数据包</span><br>tcpdump -nr /tmp/out.tcpdump<br><br><span class="hljs-comment">#块设备的读写事件信息统计</span><br>btrace /dev/sdb <br><br><span class="hljs-comment">#iotop查看某个进程的IO操作统计信息</span><br>iotop -bod5<br><br><span class="hljs-comment">#slabtop 查看内核 slab内存分配器的使用信息</span><br>slabtop -sc<br><br><span class="hljs-comment">#系统参数设置</span><br>sysctl -a<br><br><span class="hljs-comment">#系统性能指标统计信息</span><br>perf <span class="hljs-built_in">stat</span> gzip file1<br><span class="hljs-comment">#系统cpu活动状态查看</span><br>perf record -a -g -F 997 <span class="hljs-built_in">sleep</span> 10<br><br></code></pre></td></tr></table></figure><p>进程相关</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">## processes  进程管理</span><br><br><span class="hljs-comment">##ps查看当前系统执行的线程列表，进行瞬间状态，不是连续状态，连续状态需要使用top名称查看  更多常用参数请使用 man ps查看</span><br>ps<br><br><span class="hljs-comment">##显示所有进程详细信息</span><br>ps aux<br><br><span class="hljs-comment">##-u 显示某个用户的进程列表</span><br>ps -f -u www-data <br><br><span class="hljs-comment">## -C 通过名字或者命令搜索进程</span><br>ps -C apache2<br><br><span class="hljs-comment">## --sort  根据进程cpu使用率降序排列，查看前5个进程  -pcpu表示降序  pcpu升序</span><br>ps aux --<span class="hljs-built_in">sort</span>=-pcpu | <span class="hljs-built_in">head</span> -5 <br><br><span class="hljs-comment">##-f 用树结构显示进程的层次关系，父子进程情况下</span><br>ps -f --forest -C apache2 <br><br><span class="hljs-comment">##显示一个父进程的所有子进程</span><br>ps -o pid,<span class="hljs-built_in">uname</span>,<span class="hljs-built_in">comm</span> -C apache2<br>ps --ppid 2359 <br><br><span class="hljs-comment">##显示一个进程的所有线程  -L 参数</span><br>ps -p 3150 -L <br><br><span class="hljs-comment">##显示进程的执行时间 -o参数</span><br>ps -e -o pid,<span class="hljs-built_in">comm</span>,etime <br><br><span class="hljs-comment">##watch命令可以用来实时捕捉ps显示进程</span><br>watch -n 1 <span class="hljs-string">&#x27;ps -e -o pid,uname,cmd,pmem,pcpu --sort=-pmem,-pcpu | head -15&#x27;</span> <br><br><span class="hljs-comment">##jobs 查看后台运行的进程  jobs命令执行的结果，＋表示是一个当前的作业，减号表是是一个当前作业之后的一个作业，jobs -l选项可显示所有任务的PID,jobs的状态可以是running, stopped, Terminated,但是如果任务被终止了（kill），shell 从当前的shell环境已知的列表中删除任务的进程标识；也就是说，jobs命令显示的是当前shell环境中所起的后台正在运行或者被挂起的任务信息</span><br><span class="hljs-built_in">jobs</span><br><br><span class="hljs-comment">##查看后台运营的进程号</span><br><span class="hljs-built_in">jobs</span> -p<br><br><span class="hljs-comment">##查看现在被终止或者退出的进程号</span><br><span class="hljs-built_in">jobs</span> -n<br><br><br><span class="hljs-comment">##kill命令 终止一个前台进程可以使用Ctrl+C键   kill  通过top或者ps获取进程id号  kill [-s 信号 | -p ] [ -a ] 进程号 ...</span><br><span class="hljs-comment">##发送指定的信号到相应进程。不指定型号将发送SIGTERM（15）终止指定进程。关闭进程号12的进程</span><br><span class="hljs-built_in">kill</span> 12<br><br><br><span class="hljs-comment">##等同于在前台运行PID为123的进程时按下Ctrl+C键</span><br><span class="hljs-built_in">kill</span> -2 123<br><br><span class="hljs-comment">##如果任无法终止该程序可用“-KILL” 参数，其发送的信号为SIGKILL(9) ，将强制结束进程  </span><br><span class="hljs-built_in">kill</span> -9 123<br><br><span class="hljs-comment">##列出所有信号名称</span><br><span class="hljs-comment">##HUP    1    终端断线</span><br><span class="hljs-comment">##INT     2    中断（同 Ctrl + C）</span><br><span class="hljs-comment">##QUIT    3    退出（同 Ctrl + \）</span><br><span class="hljs-comment">##TERM   15    终止</span><br><span class="hljs-comment">##KILL    9    强制终止</span><br><span class="hljs-comment">##CONT   18    继续（与STOP相反， fg/bg命令）</span><br><span class="hljs-comment">##STOP    19    暂停（同 Ctrl + Z）</span><br><span class="hljs-built_in">kill</span> -l<br><br><span class="hljs-comment">##得到指定信号的数值</span><br><span class="hljs-built_in">kill</span> -l KILL<br><br><span class="hljs-comment">##杀死指定用户所有进程</span><br><span class="hljs-built_in">kill</span> -u peidalinux<br><span class="hljs-built_in">kill</span> -9 $(ps -ef | grep peidalinux) <br><br><span class="hljs-comment">##将后台中的命令调至前台继续运行  将进程123调至前台执行</span><br><span class="hljs-built_in">fg</span> 123<br><br><span class="hljs-comment">##将一个在后台暂停的命令，变成继续执行</span><br><span class="hljs-built_in">bg</span>  123<br><br><span class="hljs-comment">##该命令可以在你退出帐户/关闭终端之后继续运行相应的进程。nohup就是不挂起的意思  下面输出被重定向到myout.file文件中</span><br><span class="hljs-built_in">nohup</span> <span class="hljs-built_in">command</span> &gt; myout.file 2&gt;&amp;1 &amp;<br><br><span class="hljs-comment">##at：计划任务，在特定的时间执行某项工作，在特定的时间执行一次。</span><br><span class="hljs-comment">## 格式：at HH:MM YYYY-MM-DD //HH（小时）:MM（分钟） YYYY（年）-MM（月份）-DD（日）</span><br><span class="hljs-comment">##HH[am pm]+D(天) days //HH（小时）[am（上午）pm（下午）]+days（天）</span><br>at 12:00（时间） //at命令设定12:00执行一项操作<br><span class="hljs-comment">#at&gt;useradd aaa //在at命令里设定添加用户aaa</span><br><span class="hljs-comment">#ctrl+d //退出at命令</span><br><span class="hljs-comment">#tail -f /etc/passwd //查看/etc/passwd文件后十行是否增加了一个用户aaa</span><br><br><span class="hljs-comment">##计划任务设定后，在没有执行之前我们可以用atq命令来查看系统没有执行工作任务。</span><br>atq<br><br><span class="hljs-comment">##启动计划任务后，如果不想启动设定好的计划任务可以使用atrm命令删除。</span><br>atrm 1 //删除计划任务1<br><br><span class="hljs-comment">##pstree命令：列出当前的进程，以及它们的树状结构  格式：pstree [选项] [pid|user]</span><br>pstree<br><br><span class="hljs-comment">##nice命令：改变程序执行的优先权等级 应用程序优先权值的范围从-20～19，数字越小，优先权就越高。一般情况下，普通应用程序的优先权值（CPU使用权值）都是0，如果让常用程序拥有较高的优先权等级，自然启动和运行速度都会快些。需要注意的是普通用户只能在0～19之间调整应用程序的优先权值，只有超级用户有权调整更高的优先权值（从-20～19）。</span><br><span class="hljs-built_in">nice</span> [-n &lt;优先等级&gt;][--<span class="hljs-built_in">help</span>][--version][命令]<br><span class="hljs-built_in">nice</span> -n 5 <span class="hljs-built_in">ls</span><br><br><span class="hljs-comment">##sleep命令：使进程暂停执行一段时间</span><br><span class="hljs-built_in">date</span>;<span class="hljs-built_in">sleep</span> 1m;<span class="hljs-built_in">date</span><br><br><br><span class="hljs-comment">##renice命令 renice命令允许用户修改一个正在运行进程的优先权。利用renice命令可以在命令执行时调整其优先权。</span><br><span class="hljs-comment">##其中，参数number与nice命令的number意义相同。（1） 用户只能对自己所有的进程使用renice命令。（2） root用户可以在任何进程上使用renice命令。（3） 只有root用户才能提高进程的优先权</span><br>renice -5 -p 5200  <span class="hljs-comment">#PID为5200的进程nice设为-5 </span><br><br><span class="hljs-comment">##pmap命令用于显示一个或多个进程的内存状态。其报告进程的地址空间和内存状态信息 #pmap PID </span><br>pmap 20367<br></code></pre></td></tr></table></figure><h1 id="javadump-sh"><a href="#javadump-sh" class="headerlink" title="javadump.sh"></a>javadump.sh</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/sh</span><br><br>DUMP_PIDS=`ps  --no-heading -C java -f --width 1000 |awk <span class="hljs-string">&#x27;&#123;print $2&#125;&#x27;</span>`<br><span class="hljs-keyword">if</span> [ -z <span class="hljs-string">&quot;<span class="hljs-variable">$DUMP_PIDS</span>&quot;</span> ]; <span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;The server <span class="hljs-variable">$HOST_NAME</span> is not started!&quot;</span><br>    <span class="hljs-built_in">exit</span> 1;<br><span class="hljs-keyword">fi</span><br><br>DUMP_ROOT=~/dump<br><span class="hljs-keyword">if</span> [ ! -d <span class="hljs-variable">$DUMP_ROOT</span> ]; <span class="hljs-keyword">then</span><br>  <span class="hljs-built_in">mkdir</span> <span class="hljs-variable">$DUMP_ROOT</span><br><span class="hljs-keyword">fi</span><br><br>DUMP_DATE=`<span class="hljs-built_in">date</span> +%Y%m%d%H%M%S`<br>DUMP_DIR=<span class="hljs-variable">$DUMP_ROOT</span>/dump-<span class="hljs-variable">$DUMP_DATE</span><br><span class="hljs-keyword">if</span> [ ! -d <span class="hljs-variable">$DUMP_DIR</span> ]; <span class="hljs-keyword">then</span><br>  <span class="hljs-built_in">mkdir</span> <span class="hljs-variable">$DUMP_DIR</span><br><span class="hljs-keyword">fi</span><br><br><span class="hljs-keyword">for</span> PID <span class="hljs-keyword">in</span> <span class="hljs-variable">$DUMP_PIDS</span> ; <span class="hljs-keyword">do</span><br><span class="hljs-comment">#Full thread dump 用来查线程占用，死锁等问题</span><br>  <span class="hljs-variable">$JAVA_HOME</span>/bin/jstack <span class="hljs-variable">$PID</span> &gt; <span class="hljs-variable">$DUMP_DIR</span>/jstack-<span class="hljs-variable">$PID</span>.dump 2&gt;&amp;1<br>  <span class="hljs-built_in">echo</span> -e <span class="hljs-string">&quot;.\c&quot;</span><br><span class="hljs-comment">#打印出一个给定的Java进程、Java core文件或远程Debug服务器的Java配置信息，具体包括Java系统属性和JVM命令行参数。</span><br>  <span class="hljs-variable">$JAVA_HOME</span>/bin/jinfo <span class="hljs-variable">$PID</span> &gt; <span class="hljs-variable">$DUMP_DIR</span>/jinfo-<span class="hljs-variable">$PID</span>.dump 2&gt;&amp;1<br>  <span class="hljs-built_in">echo</span> -e <span class="hljs-string">&quot;.\c&quot;</span><br><span class="hljs-comment">#jstat能够动态打印jvm(Java Virtual Machine Statistics Monitoring Tool)的相关统计信息。如young gc执行的次数、full gc执行的次数，各个内存分区的空间大小和可使用量等信息。</span><br>  <span class="hljs-variable">$JAVA_HOME</span>/bin/jstat -gcutil <span class="hljs-variable">$PID</span> &gt; <span class="hljs-variable">$DUMP_DIR</span>/jstat-gcutil-<span class="hljs-variable">$PID</span>.dump 2&gt;&amp;1<br>  <span class="hljs-built_in">echo</span> -e <span class="hljs-string">&quot;.\c&quot;</span><br>  <span class="hljs-variable">$JAVA_HOME</span>/bin/jstat -gccapacity <span class="hljs-variable">$PID</span> &gt; <span class="hljs-variable">$DUMP_DIR</span>/jstat-gccapacity-<span class="hljs-variable">$PID</span>.dump 2&gt;&amp;1<br>  <span class="hljs-built_in">echo</span> -e <span class="hljs-string">&quot;.\c&quot;</span><br><span class="hljs-comment">#未指定选项时，jmap打印共享对象的映射。对每个目标VM加载的共享对象，其起始地址、映射大小及共享对象文件的完整路径将被打印出来，  </span><br>  <span class="hljs-variable">$JAVA_HOME</span>/bin/jmap <span class="hljs-variable">$PID</span> &gt; <span class="hljs-variable">$DUMP_DIR</span>/jmap-<span class="hljs-variable">$PID</span>.dump 2&gt;&amp;1<br>  <span class="hljs-built_in">echo</span> -e <span class="hljs-string">&quot;.\c&quot;</span><br><span class="hljs-comment">#-heap打印堆情况的概要信息，包括堆配置，各堆空间的容量、已使用和空闲情况  </span><br>  <span class="hljs-variable">$JAVA_HOME</span>/bin/jmap -heap <span class="hljs-variable">$PID</span> &gt; <span class="hljs-variable">$DUMP_DIR</span>/jmap-heap-<span class="hljs-variable">$PID</span>.dump 2&gt;&amp;1<br>  <span class="hljs-built_in">echo</span> -e <span class="hljs-string">&quot;.\c&quot;</span><br><span class="hljs-comment">#-dump将jvm的堆中内存信息输出到一个文件中,然后可以通过eclipse memory analyzer进行分析</span><br><span class="hljs-comment">#注意：这个jmap使用的时候jvm是处在假死状态的，只能在服务瘫痪的时候为了解决问题来使用，否则会造成服务中断。</span><br>  <span class="hljs-variable">$JAVA_HOME</span>/bin/jmap -dump:format=b,file=<span class="hljs-variable">$DUMP_DIR</span>/jmap-dump-<span class="hljs-variable">$PID</span>.dump <span class="hljs-variable">$PID</span> 2&gt;&amp;1<br>  <span class="hljs-built_in">echo</span> -e <span class="hljs-string">&quot;.\c&quot;</span><br><span class="hljs-comment">#显示被进程打开的文件信息</span><br><span class="hljs-keyword">if</span> [ -r /usr/sbin/lsof ]; <span class="hljs-keyword">then</span><br>  /usr/sbin/lsof -p <span class="hljs-variable">$PID</span> &gt; <span class="hljs-variable">$DUMP_DIR</span>/lsof-<span class="hljs-variable">$PID</span>.dump<br>  <span class="hljs-built_in">echo</span> -e <span class="hljs-string">&quot;.\c&quot;</span><br>  <span class="hljs-keyword">fi</span><br><span class="hljs-keyword">done</span><br><span class="hljs-comment">#主要负责收集、汇报与存储系统运行信息的。</span><br><span class="hljs-keyword">if</span> [ -r /usr/bin/sar ]; <span class="hljs-keyword">then</span><br>/usr/bin/sar &gt; <span class="hljs-variable">$DUMP_DIR</span>/sar.dump<br><span class="hljs-built_in">echo</span> -e <span class="hljs-string">&quot;.\c&quot;</span><br><span class="hljs-keyword">fi</span><br><span class="hljs-comment">#主要负责收集、汇报与存储系统运行信息的。</span><br><span class="hljs-keyword">if</span> [ -r /usr/bin/uptime ]; <span class="hljs-keyword">then</span><br>/usr/bin/uptime &gt; <span class="hljs-variable">$DUMP_DIR</span>/uptime.dump<br><span class="hljs-built_in">echo</span> -e <span class="hljs-string">&quot;.\c&quot;</span><br><span class="hljs-keyword">fi</span><br><span class="hljs-comment">#内存查看</span><br><span class="hljs-keyword">if</span> [ -r /usr/bin/free ]; <span class="hljs-keyword">then</span><br>/usr/bin/free -t &gt; <span class="hljs-variable">$DUMP_DIR</span>/free.dump<br><span class="hljs-built_in">echo</span> -e <span class="hljs-string">&quot;.\c&quot;</span><br><span class="hljs-keyword">fi</span><br><span class="hljs-comment">#可以得到关于进程、内存、内存分页、堵塞IO、traps及CPU活动的信息。</span><br><span class="hljs-keyword">if</span> [ -r /usr/bin/vmstat ]; <span class="hljs-keyword">then</span><br>/usr/bin/vmstat &gt; <span class="hljs-variable">$DUMP_DIR</span>/vmstat.dump<br><span class="hljs-built_in">echo</span> -e <span class="hljs-string">&quot;.\c&quot;</span><br><span class="hljs-keyword">fi</span><br><span class="hljs-comment">#报告与CPU相关的一些统计信息</span><br><span class="hljs-keyword">if</span> [ -r /usr/bin/mpstat ]; <span class="hljs-keyword">then</span><br>/usr/bin/mpstat &gt; <span class="hljs-variable">$DUMP_DIR</span>/mpstat.dump<br><span class="hljs-built_in">echo</span> -e <span class="hljs-string">&quot;.\c&quot;</span><br><span class="hljs-keyword">fi</span><br><span class="hljs-comment">#报告与IO相关的一些统计信息</span><br><span class="hljs-keyword">if</span> [ -r /usr/bin/iostat ]; <span class="hljs-keyword">then</span><br>/usr/bin/iostat &gt; <span class="hljs-variable">$DUMP_DIR</span>/iostat.dump<br><span class="hljs-built_in">echo</span> -e <span class="hljs-string">&quot;.\c&quot;</span><br><span class="hljs-keyword">fi</span><br><span class="hljs-comment">#报告与网络相关的一些统计信息</span><br><span class="hljs-keyword">if</span> [ -r /bin/netstat ]; <span class="hljs-keyword">then</span><br>/bin/netstat &gt; <span class="hljs-variable">$DUMP_DIR</span>/netstat.dump<br><span class="hljs-built_in">echo</span> -e <span class="hljs-string">&quot;.\c&quot;</span><br><span class="hljs-keyword">fi</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;OK!&quot;</span><br></code></pre></td></tr></table></figure><h1 id="常用工具安装"><a href="#常用工具安装" class="headerlink" title="常用工具安装"></a>常用工具安装</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/usr/bin/env bash</span><br><br><span class="hljs-comment"># ---------------------------------------------------------------------------------</span><br><span class="hljs-comment"># 控制台颜色</span><br>BLACK=<span class="hljs-string">&quot;\033[1;30m&quot;</span><br>RED=<span class="hljs-string">&quot;\033[1;31m&quot;</span><br>GREEN=<span class="hljs-string">&quot;\033[1;32m&quot;</span><br>YELLOW=<span class="hljs-string">&quot;\033[1;33m&quot;</span><br>BLUE=<span class="hljs-string">&quot;\033[1;34m&quot;</span><br>PURPLE=<span class="hljs-string">&quot;\033[1;35m&quot;</span><br>CYAN=<span class="hljs-string">&quot;\033[1;36m&quot;</span><br>RESET=<span class="hljs-string">&quot;<span class="hljs-subst">$(tput sgr0)</span>&quot;</span><br><span class="hljs-comment"># ---------------------------------------------------------------------------------</span><br><br><span class="hljs-built_in">printf</span> <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;BLUE&#125;</span>\n&quot;</span><br><span class="hljs-built_in">cat</span> &lt;&lt; <span class="hljs-string">EOF</span><br><span class="hljs-string">###################################################################################</span><br><span class="hljs-string"># 安装常用命令工具</span><br><span class="hljs-string"># 命令工具清单如下：</span><br><span class="hljs-string"># 核心工具：df、du、chkconfig</span><br><span class="hljs-string"># 网络工具：ifconfig、netstat、route、iptables</span><br><span class="hljs-string"># IP工具：ip、ss、ping、tracepath、traceroute</span><br><span class="hljs-string"># DNS工具：dig、host、nslookup、whois</span><br><span class="hljs-string"># 端口工具：lsof、nc、telnet</span><br><span class="hljs-string"># 下载工具：curl、wget</span><br><span class="hljs-string"># 编辑工具：emacs、vim</span><br><span class="hljs-string"># 流量工具：iftop、nethogs</span><br><span class="hljs-string"># 抓包工具：tcpdump</span><br><span class="hljs-string"># 压缩工具：unzip、zip</span><br><span class="hljs-string"># 版本控制工具：git、subversion</span><br><span class="hljs-string">#</span><br><span class="hljs-string">###################################################################################</span><br><span class="hljs-string">EOF</span><br><span class="hljs-built_in">printf</span> <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;RESET&#125;</span>\n&quot;</span><br><br><span class="hljs-built_in">printf</span> <span class="hljs-string">&quot;\n<span class="hljs-variable">$&#123;GREEN&#125;</span>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 安装常用命令工具开始<span class="hljs-variable">$&#123;RESET&#125;</span>\n&quot;</span><br><br><span class="hljs-comment"># 核心工具</span><br><span class="hljs-built_in">printf</span> <span class="hljs-string">&quot;\n<span class="hljs-variable">$&#123;CYAN&#125;</span>&gt;&gt;&gt;&gt; install coreutils(df、du)<span class="hljs-variable">$&#123;RESET&#125;</span>\n&quot;</span><br>yum install -y coreutils<br><span class="hljs-built_in">printf</span> <span class="hljs-string">&quot;\n<span class="hljs-variable">$&#123;CYAN&#125;</span>&gt;&gt;&gt;&gt; install chkconfig<span class="hljs-variable">$&#123;RESET&#125;</span>\n&quot;</span><br>yum install -y chkconfig<br><br><span class="hljs-comment"># 网络工具</span><br><span class="hljs-built_in">printf</span> <span class="hljs-string">&quot;\n<span class="hljs-variable">$&#123;CYAN&#125;</span>&gt;&gt;&gt;&gt; install net-tools(ifconfig、netstat、route)<span class="hljs-variable">$&#123;RESET&#125;</span>\n&quot;</span><br>yum install -y net-tools<br><span class="hljs-built_in">printf</span> <span class="hljs-string">&quot;\n<span class="hljs-variable">$&#123;CYAN&#125;</span>&gt;&gt;&gt;&gt; install iptables<span class="hljs-variable">$&#123;RESET&#125;</span>\n&quot;</span><br>yum install -y iptables<br><br><span class="hljs-comment"># IP工具</span><br><span class="hljs-built_in">printf</span> <span class="hljs-string">&quot;\n<span class="hljs-variable">$&#123;CYAN&#125;</span>&gt;&gt;&gt;&gt; install iputils(ping、tracepath)<span class="hljs-variable">$&#123;RESET&#125;</span>\n&quot;</span><br>yum install -y iputils<br><span class="hljs-built_in">printf</span> <span class="hljs-string">&quot;\n<span class="hljs-variable">$&#123;CYAN&#125;</span>&gt;&gt;&gt;&gt; install traceroute<span class="hljs-variable">$&#123;RESET&#125;</span>\n&quot;</span><br>yum install -y traceroute<br><span class="hljs-built_in">printf</span> <span class="hljs-string">&quot;\n<span class="hljs-variable">$&#123;CYAN&#125;</span>&gt;&gt;&gt;&gt; install iproute(ip、ss)<span class="hljs-variable">$&#123;RESET&#125;</span>\n&quot;</span><br>yum install -y iproute<br><br><span class="hljs-comment"># 端口工具</span><br><span class="hljs-built_in">printf</span> <span class="hljs-string">&quot;\n<span class="hljs-variable">$&#123;CYAN&#125;</span>&gt;&gt;&gt;&gt; install lsof<span class="hljs-variable">$&#123;RESET&#125;</span>\n&quot;</span><br>yum install -y lsof<br><span class="hljs-built_in">printf</span> <span class="hljs-string">&quot;\n<span class="hljs-variable">$&#123;CYAN&#125;</span>&gt;&gt;&gt;&gt; install nc<span class="hljs-variable">$&#123;RESET&#125;</span>\n&quot;</span><br>yum install -y nc<br><span class="hljs-built_in">printf</span> <span class="hljs-string">&quot;\n<span class="hljs-variable">$&#123;CYAN&#125;</span>&gt;&gt;&gt;&gt; install netstat<span class="hljs-variable">$&#123;RESET&#125;</span>\n&quot;</span><br>yum install -y netstat<br><br><span class="hljs-comment"># DNS工具</span><br><span class="hljs-built_in">printf</span> <span class="hljs-string">&quot;\n<span class="hljs-variable">$&#123;CYAN&#125;</span>&gt;&gt;&gt;&gt; install bind-utils(dig、host、nslookup)<span class="hljs-variable">$&#123;RESET&#125;</span>\n&quot;</span><br>yum install -y bind-utils<br><span class="hljs-built_in">printf</span> <span class="hljs-string">&quot;\n<span class="hljs-variable">$&#123;CYAN&#125;</span>&gt;&gt;&gt;&gt; install whois<span class="hljs-variable">$&#123;RESET&#125;</span>\n&quot;</span><br>yum install -y whois<br><br><span class="hljs-comment"># 下载工具</span><br><span class="hljs-built_in">printf</span> <span class="hljs-string">&quot;\n<span class="hljs-variable">$&#123;CYAN&#125;</span>&gt;&gt;&gt;&gt; install curl<span class="hljs-variable">$&#123;RESET&#125;</span>\n&quot;</span><br>yum install -y curl<br><span class="hljs-built_in">printf</span> <span class="hljs-string">&quot;\n<span class="hljs-variable">$&#123;CYAN&#125;</span>&gt;&gt;&gt;&gt; install wget<span class="hljs-variable">$&#123;RESET&#125;</span>\n&quot;</span><br>yum install -y wget<br><br><span class="hljs-comment"># 编辑工具</span><br><span class="hljs-built_in">printf</span> <span class="hljs-string">&quot;\n<span class="hljs-variable">$&#123;CYAN&#125;</span>&gt;&gt;&gt;&gt; install emacs<span class="hljs-variable">$&#123;RESET&#125;</span>\n&quot;</span><br>yum install -y emacs<br><span class="hljs-built_in">printf</span> <span class="hljs-string">&quot;\n<span class="hljs-variable">$&#123;CYAN&#125;</span>&gt;&gt;&gt;&gt; install vim<span class="hljs-variable">$&#123;RESET&#125;</span>\n&quot;</span><br>yum install -y vim<br><br><span class="hljs-comment"># 流量工具</span><br><span class="hljs-built_in">printf</span> <span class="hljs-string">&quot;\n<span class="hljs-variable">$&#123;CYAN&#125;</span>&gt;&gt;&gt;&gt; install iftop<span class="hljs-variable">$&#123;RESET&#125;</span>\n&quot;</span><br>yum install -y iftop<br><span class="hljs-built_in">printf</span> <span class="hljs-string">&quot;\n<span class="hljs-variable">$&#123;CYAN&#125;</span>&gt;&gt;&gt;&gt; install nethogs<span class="hljs-variable">$&#123;RESET&#125;</span>\n&quot;</span><br>yum install -y nethogs<br><br><span class="hljs-comment"># 抓包工具</span><br><span class="hljs-built_in">printf</span> <span class="hljs-string">&quot;\n<span class="hljs-variable">$&#123;CYAN&#125;</span>&gt;&gt;&gt;&gt; install tcpdump<span class="hljs-variable">$&#123;RESET&#125;</span>\n&quot;</span><br>yum install -y tcpdump<br><br><span class="hljs-comment"># 压缩工具</span><br><span class="hljs-built_in">printf</span> <span class="hljs-string">&quot;\n<span class="hljs-variable">$&#123;CYAN&#125;</span>&gt;&gt;&gt;&gt; install unzip<span class="hljs-variable">$&#123;RESET&#125;</span>\n&quot;</span><br>yum install -y unzip<br><br><span class="hljs-comment"># 版本控制工具</span><br><span class="hljs-built_in">printf</span> <span class="hljs-string">&quot;\n<span class="hljs-variable">$&#123;CYAN&#125;</span>&gt;&gt;&gt;&gt; install git<span class="hljs-variable">$&#123;RESET&#125;</span>\n&quot;</span><br>yum install -y git<br><span class="hljs-built_in">printf</span> <span class="hljs-string">&quot;\n<span class="hljs-variable">$&#123;CYAN&#125;</span>&gt;&gt;&gt;&gt; install subversion<span class="hljs-variable">$&#123;RESET&#125;</span>\n&quot;</span><br>yum install -y subversion<br><br><span class="hljs-built_in">printf</span> <span class="hljs-string">&quot;\n<span class="hljs-variable">$&#123;GREEN&#125;</span>&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; 安装常用命令工具结束<span class="hljs-variable">$&#123;RESET&#125;</span>\n&quot;</span><br></code></pre></td></tr></table></figure><h1 id="常用lib库安装"><a href="#常用lib库安装" class="headerlink" title="常用lib库安装"></a>常用lib库安装</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/usr/bin/env bash</span><br><br><span class="hljs-comment"># ---------------------------------------------------------------------------------</span><br><span class="hljs-comment"># 控制台颜色</span><br>BLACK=<span class="hljs-string">&quot;\033[1;30m&quot;</span><br>RED=<span class="hljs-string">&quot;\033[1;31m&quot;</span><br>GREEN=<span class="hljs-string">&quot;\033[1;32m&quot;</span><br>YELLOW=<span class="hljs-string">&quot;\033[1;33m&quot;</span><br>BLUE=<span class="hljs-string">&quot;\033[1;34m&quot;</span><br>PURPLE=<span class="hljs-string">&quot;\033[1;35m&quot;</span><br>CYAN=<span class="hljs-string">&quot;\033[1;36m&quot;</span><br>RESET=<span class="hljs-string">&quot;<span class="hljs-subst">$(tput sgr0)</span>&quot;</span><br><span class="hljs-comment"># ---------------------------------------------------------------------------------</span><br><br><span class="hljs-built_in">printf</span> <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;BLUE&#125;</span>\n&quot;</span><br><span class="hljs-built_in">cat</span> &lt;&lt; <span class="hljs-string">EOF</span><br><span class="hljs-string">###################################################################################</span><br><span class="hljs-string"># 安装常见 lib</span><br><span class="hljs-string"># 如果不知道命令在哪个 lib，可以使用 yum search xxx 来查找</span><br><span class="hljs-string"># lib 清单如下：</span><br><span class="hljs-string"># gcc gcc-c++ kernel-devel libtool</span><br><span class="hljs-string"># openssl openssl-devel</span><br><span class="hljs-string"># zlib zlib-devel</span><br><span class="hljs-string"># pcre</span><br><span class="hljs-string">###################################################################################</span><br><span class="hljs-string">EOF</span><br><span class="hljs-built_in">printf</span> <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;RESET&#125;</span>\n&quot;</span><br><br><span class="hljs-built_in">printf</span> <span class="hljs-string">&quot;\n<span class="hljs-variable">$&#123;GREEN&#125;</span>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 安装常见 lib 开始<span class="hljs-variable">$&#123;RESET&#125;</span>\n&quot;</span><br><br><span class="hljs-built_in">printf</span> <span class="hljs-string">&quot;\n<span class="hljs-variable">$&#123;CYAN&#125;</span>&gt;&gt;&gt;&gt; install gcc gcc-c++ kernel-devel libtool<span class="hljs-variable">$&#123;RESET&#125;</span>\n&quot;</span><br>yum -y install make gcc gcc-c++ kernel-devel libtool<br><br><span class="hljs-built_in">printf</span> <span class="hljs-string">&quot;\n<span class="hljs-variable">$&#123;CYAN&#125;</span>&gt;&gt;&gt;&gt; install openssl openssl-devel<span class="hljs-variable">$&#123;RESET&#125;</span>\n&quot;</span><br>yum -y install make openssl openssl-devel<br><br><span class="hljs-built_in">printf</span> <span class="hljs-string">&quot;\n<span class="hljs-variable">$&#123;CYAN&#125;</span>&gt;&gt;&gt;&gt; install zlib zlib-devel<span class="hljs-variable">$&#123;RESET&#125;</span>\n&quot;</span><br>yum -y install make zlib zlib-devel<br><br><span class="hljs-built_in">printf</span> <span class="hljs-string">&quot;\n<span class="hljs-variable">$&#123;CYAN&#125;</span>&gt;&gt;&gt;&gt; install pcre<span class="hljs-variable">$&#123;RESET&#125;</span>\n&quot;</span><br>yum -y install pcre<br><br><span class="hljs-built_in">printf</span> <span class="hljs-string">&quot;\n<span class="hljs-variable">$&#123;GREEN&#125;</span>&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; 安装常见 lib 结束<span class="hljs-variable">$&#123;RESET&#125;</span>\n&quot;</span><br></code></pre></td></tr></table></figure><h1 id="系统检查脚本"><a href="#系统检查脚本" class="headerlink" title="系统检查脚本"></a>系统检查脚本</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/usr/bin/env bash</span><br><br><span class="hljs-comment">##############################################################################</span><br><span class="hljs-comment"># console color</span><br>C_RESET=<span class="hljs-string">&quot;<span class="hljs-subst">$(tput sgr0)</span>&quot;</span><br>C_BLACK=<span class="hljs-string">&quot;\033[1;30m&quot;</span><br>C_RED=<span class="hljs-string">&quot;\033[1;31m&quot;</span><br>C_GREEN=<span class="hljs-string">&quot;\033[1;32m&quot;</span><br>C_YELLOW=<span class="hljs-string">&quot;\033[1;33m&quot;</span><br>C_BLUE=<span class="hljs-string">&quot;\033[1;34m&quot;</span><br>C_PURPLE=<span class="hljs-string">&quot;\033[1;35m&quot;</span><br>C_CYAN=<span class="hljs-string">&quot;\033[1;36m&quot;</span><br>C_WHITE=<span class="hljs-string">&quot;\033[1;37m&quot;</span><br><span class="hljs-comment">##############################################################################</span><br><br><span class="hljs-built_in">printf</span> <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;C_PURPLE&#125;</span>&quot;</span><br><span class="hljs-built_in">cat</span> &lt;&lt; <span class="hljs-string">EOF</span><br><span class="hljs-string">###################################################################################</span><br><span class="hljs-string"># 系统信息检查脚本</span><br><span class="hljs-string">###################################################################################</span><br><span class="hljs-string">EOF</span><br><span class="hljs-built_in">printf</span> <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;C_RESET&#125;</span>&quot;</span><br><br>[[ $(<span class="hljs-built_in">id</span> -u) -gt 0 ]] &amp;&amp; <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;请用root用户执行此脚本！&quot;</span> &amp;&amp; <span class="hljs-built_in">exit</span> 1<br>sysversion=$(rpm -q centos-release | <span class="hljs-built_in">cut</span> -d- -f3)<br>double_line=<span class="hljs-string">&quot;===============================================================&quot;</span><br>line=<span class="hljs-string">&quot;----------------------------------------------&quot;</span><br><br><span class="hljs-comment"># 打印头部信息</span><br><span class="hljs-function"><span class="hljs-title">printHeadInfo</span></span>() &#123;<br>  <span class="hljs-built_in">cat</span> &lt;&lt; <span class="hljs-string">EOF</span><br><span class="hljs-string">+---------------------------------------------------------------------------------+</span><br><span class="hljs-string">|                           欢迎使用 【系统信息检查脚本】                          |</span><br><span class="hljs-string">+---------------------------------------------------------------------------------+</span><br><span class="hljs-string">EOF</span><br>&#125;<br><br><span class="hljs-comment"># 打印尾部信息</span><br><span class="hljs-function"><span class="hljs-title">printFootInfo</span></span>() &#123;<br>  <span class="hljs-built_in">cat</span> &lt;&lt; <span class="hljs-string">EOF</span><br><span class="hljs-string">+---------------------------------------------------------------------------------+</span><br><span class="hljs-string">|                            脚本执行结束，感谢使用！|</span><br><span class="hljs-string">+---------------------------------------------------------------------------------+</span><br><span class="hljs-string">EOF</span><br>&#125;<br><br>options=( <span class="hljs-string">&quot;获取系统信息&quot;</span> <span class="hljs-string">&quot;获取服务信息&quot;</span> <span class="hljs-string">&quot;获取CPU信息&quot;</span> <span class="hljs-string">&quot;获取系统网络信息&quot;</span> <span class="hljs-string">&quot;获取系统内存信息&quot;</span> <span class="hljs-string">&quot;获取系统磁盘信息&quot;</span> <span class="hljs-string">&quot;获取CPU/内存占用TOP10&quot;</span> <span class="hljs-string">&quot;获取系统用户信息&quot;</span> <span class="hljs-string">&quot;输出所有信息&quot;</span> <span class="hljs-string">&quot;退出&quot;</span> )<br><span class="hljs-function"><span class="hljs-title">printMenu</span></span>() &#123;<br>  <span class="hljs-built_in">printf</span> <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;C_BLUE&#125;</span>&quot;</span><br>  <span class="hljs-built_in">printf</span> <span class="hljs-string">&quot;主菜单：\n&quot;</span><br>  <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;!options[@]&#125;</span>&quot;</span>; <span class="hljs-keyword">do</span><br>    index=`<span class="hljs-built_in">expr</span> <span class="hljs-variable">$&#123;i&#125;</span> + 1`<br>    val=`<span class="hljs-built_in">expr</span> <span class="hljs-variable">$&#123;index&#125;</span> % 2`<br>    <span class="hljs-built_in">printf</span> <span class="hljs-string">&quot;\t(%02d) %-30s&quot;</span> <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;index&#125;</span>&quot;</span> <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;options[$i]&#125;</span>&quot;</span><br>    <span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$&#123;val&#125;</span> -eq 0 ]]; <span class="hljs-keyword">then</span><br>      <span class="hljs-built_in">printf</span> <span class="hljs-string">&quot;\n&quot;</span><br>    <span class="hljs-keyword">fi</span><br>  <span class="hljs-keyword">done</span><br>  <span class="hljs-built_in">printf</span> <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;C_BLUE&#125;</span>请输入需要执行的指令：\n&quot;</span><br>  <span class="hljs-built_in">printf</span> <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;C_RESET&#125;</span>&quot;</span><br>&#125;<br><br><span class="hljs-comment"># 获取系统信息</span><br><span class="hljs-function"><span class="hljs-title">get_systatus_info</span></span>() &#123;<br>  sys_os=$(<span class="hljs-built_in">uname</span> -o)<br>  sys_release=$(<span class="hljs-built_in">cat</span> /etc/redhat-release)<br>  sys_kernel=$(<span class="hljs-built_in">uname</span> -r)<br>  sys_hostname=$(hostname)<br>  sys_selinux=$(getenforce)<br>  sys_lang=$(<span class="hljs-built_in">echo</span> <span class="hljs-variable">$LANG</span>)<br>  sys_lastreboot=$(<span class="hljs-built_in">who</span> -b | awk <span class="hljs-string">&#x27;&#123;print $3,$4&#125;&#x27;</span>)<br>  sys_runtime=$(<span class="hljs-built_in">uptime</span> | awk <span class="hljs-string">&#x27;&#123;print  $3,$4&#125;&#x27;</span> | <span class="hljs-built_in">cut</span> -d, -f1)<br>  sys_time=$(<span class="hljs-built_in">date</span>)<br>  sys_load=$(<span class="hljs-built_in">uptime</span> | <span class="hljs-built_in">cut</span> -d: -f5)<br><br>  <span class="hljs-built_in">cat</span> &lt;&lt; <span class="hljs-string">EOF</span><br><span class="hljs-string">【系统信息】</span><br><span class="hljs-string">系统: $&#123;sys_os&#125;</span><br><span class="hljs-string">发行版本:   $&#123;sys_release&#125;</span><br><span class="hljs-string">系统内核:   $&#123;sys_kernel&#125;</span><br><span class="hljs-string">主机名:    $&#123;sys_hostname&#125;</span><br><span class="hljs-string">selinux状态:  $&#123;sys_selinux&#125;</span><br><span class="hljs-string">系统语言:   $&#123;sys_lang&#125;</span><br><span class="hljs-string">系统当前时间: $&#123;sys_time&#125;</span><br><span class="hljs-string">系统最后重启时间:   $&#123;sys_lastreboot&#125;</span><br><span class="hljs-string">系统运行时间: $&#123;sys_runtime&#125;</span><br><span class="hljs-string">系统负载:   $&#123;sys_load&#125;</span><br><span class="hljs-string">EOF</span><br>&#125;<br><br><span class="hljs-comment"># 获取CPU信息</span><br><span class="hljs-function"><span class="hljs-title">get_cpu_info</span></span>() &#123;<br>  Physical_CPUs=$(grep <span class="hljs-string">&quot;physical id&quot;</span> /proc/cpuinfo | <span class="hljs-built_in">sort</span> | <span class="hljs-built_in">uniq</span> | <span class="hljs-built_in">wc</span> -l)<br>  Virt_CPUs=$(grep <span class="hljs-string">&quot;processor&quot;</span> /proc/cpuinfo | <span class="hljs-built_in">wc</span> -l)<br>  CPU_Kernels=$(grep <span class="hljs-string">&quot;cores&quot;</span> /proc/cpuinfo | <span class="hljs-built_in">uniq</span> | awk -F <span class="hljs-string">&#x27;: &#x27;</span> <span class="hljs-string">&#x27;&#123;print $2&#125;&#x27;</span>)<br>  CPU_Type=$(grep <span class="hljs-string">&quot;model name&quot;</span> /proc/cpuinfo | awk -F <span class="hljs-string">&#x27;: &#x27;</span> <span class="hljs-string">&#x27;&#123;print $2&#125;&#x27;</span> | <span class="hljs-built_in">sort</span> | <span class="hljs-built_in">uniq</span>)<br>  CPU_Arch=$(<span class="hljs-built_in">uname</span> -m)<br>  <span class="hljs-built_in">cat</span> &lt;&lt; <span class="hljs-string">EOF</span><br><span class="hljs-string">【CPU信息】</span><br><span class="hljs-string">物理CPU个数:$Physical_CPUs</span><br><span class="hljs-string">逻辑CPU个数:$Virt_CPUs</span><br><span class="hljs-string">每CPU核心数:$CPU_Kernels</span><br><span class="hljs-string">CPU型号:$CPU_Type</span><br><span class="hljs-string">CPU架构:$CPU_Arch</span><br><span class="hljs-string">EOF</span><br>&#125;<br><br><span class="hljs-comment"># 获取服务信息</span><br><span class="hljs-function"><span class="hljs-title">get_service_info</span></span>() &#123;<br>  port_listen=$(netstat -lntup | grep -v <span class="hljs-string">&quot;Active Internet&quot;</span>)<br>  kernel_config=$(sysctl -p 2&gt; /dev/null)<br>  <span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$&#123;sysversion&#125;</span> -gt 6 ]]; <span class="hljs-keyword">then</span><br>    service_config=$(systemctl list-unit-files --<span class="hljs-built_in">type</span>=service --state=enabled | grep <span class="hljs-string">&quot;enabled&quot;</span>)<br>    run_service=$(systemctl list-units --<span class="hljs-built_in">type</span>=service --state=running | grep <span class="hljs-string">&quot;.service&quot;</span>)<br>  <span class="hljs-keyword">else</span><br>    service_config=$(/sbin/chkconfig | grep -E <span class="hljs-string">&quot;:on|:启用&quot;</span> | column -t)<br>    run_service=$(/sbin/service --status-all | grep -E <span class="hljs-string">&quot;running&quot;</span>)<br>  <span class="hljs-keyword">fi</span><br>  <span class="hljs-built_in">cat</span> &lt;&lt; <span class="hljs-string">EOF</span><br><span class="hljs-string">【服务信息】</span><br><span class="hljs-string">$&#123;service_config&#125;</span><br><span class="hljs-string">  $&#123;line&#125;</span><br><span class="hljs-string">运行的服务:</span><br><span class="hljs-string">$&#123;run_service&#125;</span><br><span class="hljs-string">  $&#123;line&#125;</span><br><span class="hljs-string">监听端口:</span><br><span class="hljs-string">$&#123;port_listen&#125;</span><br><span class="hljs-string">  $&#123;line&#125;</span><br><span class="hljs-string">内核参考配置:</span><br><span class="hljs-string">$&#123;kernel_config&#125;</span><br><span class="hljs-string">EOF</span><br>&#125;<br><br><span class="hljs-comment"># 获取系统内存信息</span><br><span class="hljs-function"><span class="hljs-title">get_mem_info</span></span>() &#123;<br>  check_mem=$(free -m)<br>  MemTotal=$(grep MemTotal /proc/meminfo | awk <span class="hljs-string">&#x27;&#123;print $2&#125;&#x27;</span>) <span class="hljs-comment">#KB</span><br>  MemFree=$(grep MemFree /proc/meminfo | awk <span class="hljs-string">&#x27;&#123;print $2&#125;&#x27;</span>) <span class="hljs-comment">#KB</span><br>  <span class="hljs-built_in">let</span> MemUsed=MemTotal-MemFree<br>  MemPercent=$(awk <span class="hljs-string">&quot;BEGIN &#123;if(<span class="hljs-variable">$MemTotal</span>==0)&#123;printf 100&#125;else&#123;printf \&quot;%.2f\&quot;,<span class="hljs-variable">$MemUsed</span>*100/<span class="hljs-variable">$MemTotal</span>&#125;&#125;&quot;</span>)<br>  report_MemTotal=<span class="hljs-string">&quot;<span class="hljs-subst">$((MemTotal/1024)</span>)&quot;</span> <span class="hljs-string">&quot;MB&quot;</span> <span class="hljs-comment">#内存总容量(MB)</span><br>  report_MemFree=<span class="hljs-string">&quot;<span class="hljs-subst">$((MemFree/1024)</span>)&quot;</span> <span class="hljs-string">&quot;MB&quot;</span> <span class="hljs-comment">#内存剩余(MB)</span><br>  report_MemUsedPercent=$(free | sed -n <span class="hljs-string">&#x27;2p&#x27;</span> | gawk <span class="hljs-string">&#x27;x = int(( $3 / $2 ) * 100) &#123;print x&#125;&#x27;</span> | sed <span class="hljs-string">&#x27;s/$/%/&#x27;</span>)<br><br>  <span class="hljs-built_in">cat</span> &lt;&lt; <span class="hljs-string">EOF</span><br><span class="hljs-string">【内存信息】</span><br><span class="hljs-string">内存总容量(MB): $&#123;report_MemTotal&#125;</span><br><span class="hljs-string">内存剩余量(MB):$&#123;report_MemFree&#125;</span><br><span class="hljs-string">内存使用率: $&#123;report_MemUsedPercent&#125;</span><br><span class="hljs-string">EOF</span><br>&#125;<br><br><span class="hljs-comment"># 获取系统网络信息</span><br><span class="hljs-function"><span class="hljs-title">get_net_info</span></span>() &#123;<br>  pri_ipadd=$(ip addr | awk <span class="hljs-string">&#x27;/^[0-9]+: / &#123;&#125;; /inet.*global/ &#123;print gensub(/(.*)\/(.*)/, &quot;\\1&quot;, &quot;g&quot;, $2)&#125;&#x27;</span>)<br>  pub_ipadd=$(curl ifconfig.me -s)<br>  gateway=$(ip route | grep default | awk <span class="hljs-string">&#x27;&#123;print $3&#125;&#x27;</span>)<br>  mac_info=$(ip <span class="hljs-built_in">link</span> | egrep -v <span class="hljs-string">&quot;lo&quot;</span> | grep <span class="hljs-built_in">link</span> | awk <span class="hljs-string">&#x27;&#123;print $2&#125;&#x27;</span>)<br>  dns_config=$(egrep -v <span class="hljs-string">&quot;^$|^#&quot;</span> /etc/resolv.conf)<br>  route_info=$(route -n)<br>  <span class="hljs-built_in">cat</span> &lt;&lt; <span class="hljs-string">EOF</span><br><span class="hljs-string">【网络信息】</span><br><span class="hljs-string">系统公网地址:$&#123;pub_ipadd&#125;</span><br><span class="hljs-string">系统私网地址:$&#123;pri_ipadd&#125;</span><br><span class="hljs-string">网关地址:$&#123;gateway&#125;</span><br><span class="hljs-string">MAC地址:$&#123;mac_info&#125;</span><br><span class="hljs-string">路由信息:</span><br><span class="hljs-string">$&#123;route_info&#125;</span><br><span class="hljs-string">DNS 信息:</span><br><span class="hljs-string">$&#123;dns_config&#125;</span><br><span class="hljs-string">EOF</span><br>&#125;<br><br><span class="hljs-comment"># 获取系统磁盘信息</span><br><span class="hljs-function"><span class="hljs-title">get_disk_info</span></span>() &#123;<br>  disk_info=$(fdisk -l | grep <span class="hljs-string">&quot;Disk /dev&quot;</span> | <span class="hljs-built_in">cut</span> -d, -f1)<br>  disk_use=$(<span class="hljs-built_in">df</span> -hTP | awk <span class="hljs-string">&#x27;$2!=&quot;tmpfs&quot;&#123;print&#125;&#x27;</span>)<br>  disk_percent=$(free | sed -n <span class="hljs-string">&#x27;2p&#x27;</span> | gawk <span class="hljs-string">&#x27;x = int(( $3 / $2 ) * 100) &#123;print x&#125;&#x27;</span> | sed <span class="hljs-string">&#x27;s/$/%/&#x27;</span>)<br>  disk_inode=$(<span class="hljs-built_in">df</span> -hiP | awk <span class="hljs-string">&#x27;$1!=&quot;tmpfs&quot;&#123;print&#125;&#x27;</span>)<br><br>  <span class="hljs-built_in">cat</span> &lt;&lt; <span class="hljs-string">EOF</span><br><span class="hljs-string">【磁盘信息】</span><br><span class="hljs-string">$&#123;disk_info&#125;</span><br><span class="hljs-string">磁盘使用: $&#123;disk_use&#125;</span><br><span class="hljs-string">磁盘使用百分比: $&#123;disk_percent&#125;</span><br><span class="hljs-string">inode信息: $&#123;disk_inode&#125;</span><br><span class="hljs-string">EOF</span><br>&#125;<br><br><span class="hljs-comment"># 获取系统用户信息</span><br><span class="hljs-function"><span class="hljs-title">get_sys_user</span></span>() &#123;<br>  login_user=$(awk -F: <span class="hljs-string">&#x27;&#123;if ($NF==&quot;/bin/bash&quot;) print $0&#125;&#x27;</span> /etc/passwd)<br>  ssh_config=$(egrep -v <span class="hljs-string">&quot;^#|^$&quot;</span> /etc/ssh/sshd_config)<br>  sudo_config=$(egrep -v <span class="hljs-string">&quot;^#|^$&quot;</span> /etc/sudoers | grep -v <span class="hljs-string">&quot;^Defaults&quot;</span>)<br>  host_config=$(egrep -v <span class="hljs-string">&quot;^#|^$&quot;</span> /etc/hosts)<br>  crond_config=$(<span class="hljs-keyword">for</span> cronuser <span class="hljs-keyword">in</span> /var/spool/cron/*; <span class="hljs-keyword">do</span><br>    <span class="hljs-built_in">ls</span> <span class="hljs-variable">$&#123;cronuser&#125;</span> 2&gt; /dev/null | <span class="hljs-built_in">cut</span> -d/ -f5; egrep -v <span class="hljs-string">&quot;^$|^#&quot;</span> <span class="hljs-variable">$&#123;cronuser&#125;</span> 2&gt; /dev/null;<br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;&quot;</span>;<br>  <span class="hljs-keyword">done</span>)<br>  <span class="hljs-built_in">cat</span> &lt;&lt; <span class="hljs-string">EOF</span><br><span class="hljs-string">【用户信息】</span><br><span class="hljs-string">系统登录用户:</span><br><span class="hljs-string">$&#123;login_user&#125;</span><br><span class="hljs-string">  $&#123;line&#125;</span><br><span class="hljs-string">ssh 配置信息:</span><br><span class="hljs-string">$&#123;ssh_config&#125;</span><br><span class="hljs-string">  $&#123;line&#125;</span><br><span class="hljs-string">sudo 配置用户:</span><br><span class="hljs-string">$&#123;sudo_config&#125;</span><br><span class="hljs-string">  $&#123;line&#125;</span><br><span class="hljs-string">定时任务配置:</span><br><span class="hljs-string">$&#123;crond_config&#125;</span><br><span class="hljs-string">  $&#123;line&#125;</span><br><span class="hljs-string">hosts 信息:</span><br><span class="hljs-string">$&#123;host_config&#125;</span><br><span class="hljs-string">EOF</span><br>&#125;<br><br><span class="hljs-comment"># 获取CPU/内存占用TOP10</span><br><span class="hljs-function"><span class="hljs-title">get_process_top_info</span></span>() &#123;<br><br>  top_title=$(top -b n1 | <span class="hljs-built_in">head</span> -7 | <span class="hljs-built_in">tail</span> -1)<br>  cpu_top10=$(top -b n1 | <span class="hljs-built_in">head</span> -17 | <span class="hljs-built_in">tail</span> -11)<br>  mem_top10=$(top -b n1 | <span class="hljs-built_in">head</span> -17 | <span class="hljs-built_in">tail</span> -10 | <span class="hljs-built_in">sort</span> -k10 -r)<br><br>  <span class="hljs-built_in">cat</span> &lt;&lt; <span class="hljs-string">EOF</span><br><span class="hljs-string">【TOP10】</span><br><span class="hljs-string">CPU占用TOP10:</span><br><span class="hljs-string">$&#123;cpu_top10&#125;</span><br><span class="hljs-string">内存占用TOP10:</span><br><span class="hljs-string">$&#123;top_title&#125;</span><br><span class="hljs-string">  $&#123;mem_top10&#125;</span><br><span class="hljs-string">EOF</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-title">show_dead_process</span></span>() &#123;<br>  <span class="hljs-built_in">printf</span> <span class="hljs-string">&quot;僵尸进程：\n&quot;</span><br>  ps -al | gawk <span class="hljs-string">&#x27;&#123;print $2,$4&#125;&#x27;</span> | grep Z<br>&#125;<br><br><span class="hljs-function"><span class="hljs-title">get_all_info</span></span>() &#123;<br>  get_systatus_info<br>  <span class="hljs-built_in">echo</span> <span class="hljs-variable">$&#123;double_line&#125;</span><br>  get_service_info<br>  <span class="hljs-built_in">echo</span> <span class="hljs-variable">$&#123;double_line&#125;</span><br>  get_cpu_info<br>  <span class="hljs-built_in">echo</span> <span class="hljs-variable">$&#123;double_line&#125;</span><br>  get_net_info<br>  <span class="hljs-built_in">echo</span> <span class="hljs-variable">$&#123;double_line&#125;</span><br>  get_mem_info<br>  <span class="hljs-built_in">echo</span> <span class="hljs-variable">$&#123;double_line&#125;</span><br>  get_disk_info<br>  <span class="hljs-built_in">echo</span> <span class="hljs-variable">$&#123;double_line&#125;</span><br>  get_process_top_info<br>  <span class="hljs-built_in">echo</span> <span class="hljs-variable">$&#123;double_line&#125;</span><br>  get_sys_user<br>&#125;<br><br><span class="hljs-function"><span class="hljs-title">main</span></span>() &#123;<br>  <span class="hljs-keyword">while</span> [[ 1 ]]<br>  <span class="hljs-keyword">do</span><br>    printMenu<br>    <span class="hljs-built_in">read</span> option<br>    <span class="hljs-built_in">local</span> index=$[ <span class="hljs-variable">$&#123;option&#125;</span> - 1 ]<br>    <span class="hljs-keyword">case</span> <span class="hljs-variable">$&#123;options[<span class="hljs-variable">$&#123;index&#125;</span>]&#125;</span> <span class="hljs-keyword">in</span><br>      <span class="hljs-string">&quot;获取系统信息&quot;</span>)<br>        get_systatus_info ;;<br>      <span class="hljs-string">&quot;获取服务信息&quot;</span>)<br>        get_service_info ;;<br>      <span class="hljs-string">&quot;获取CPU信息&quot;</span>)<br>        get_cpu_info ;;<br>      <span class="hljs-string">&quot;获取系统网络信息&quot;</span>)<br>        get_net_info ;;<br>      <span class="hljs-string">&quot;获取系统内存信息&quot;</span>)<br>        get_mem_info ;;<br>      <span class="hljs-string">&quot;获取系统磁盘信息&quot;</span>)<br>        get_disk_info ;;<br>      <span class="hljs-string">&quot;获取CPU/内存占用TOP10&quot;</span>)<br>        get_process_top_info ;;<br>      <span class="hljs-string">&quot;获取系统用户信息&quot;</span>)<br>        get_sys_user ;;<br>      <span class="hljs-string">&quot;输出所有信息&quot;</span>)<br>        get_all_info &gt; sys.log<br>        <span class="hljs-built_in">printf</span> <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;C_GREEN&#125;</span>信息已经输出到 sys.log 中。<span class="hljs-variable">$&#123;C_RESET&#125;</span>\n\n&quot;</span><br>      ;;<br>      <span class="hljs-string">&quot;退出&quot;</span>)<br>        <span class="hljs-built_in">exit</span> ;;<br>      *)<br>        clear<br>        <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;抱歉，不支持此选项&quot;</span> ;;<br>    <span class="hljs-keyword">esac</span><br>  <span class="hljs-keyword">done</span><br>&#125;<br><br><span class="hljs-comment">######################################## MAIN ########################################</span><br>printHeadInfo<br>main<br>printFootInfo<br><span class="hljs-built_in">printf</span> <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;C_RESET&#125;</span>&quot;</span><br></code></pre></td></tr></table></figure><h1 id="sed进阶"><a href="#sed进阶" class="headerlink" title="sed进阶"></a>sed进阶</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash</span><br><br><span class="hljs-comment">#多个空格只保留一个</span><br><span class="hljs-comment">#sed &#x27;/./,/^$/!d&#x27; test</span><br><br><span class="hljs-comment">#删除开头的空白行</span><br><span class="hljs-comment">#sed &#x27;/./,$!d&#x27; test</span><br><br><span class="hljs-comment">#删除结尾的空白行</span><br>sed <span class="hljs-string">&#x27;&#123;</span><br><span class="hljs-string">:start</span><br><span class="hljs-string">/^\n*$/&#123;$d; N; b start&#125;</span><br><span class="hljs-string">&#125;&#x27;</span> <span class="hljs-built_in">test</span><br><br><span class="hljs-comment">#删除html标签</span><br><span class="hljs-comment">#有问题</span><br><span class="hljs-comment">#s/&lt;.*&gt;//g</span><br><br><span class="hljs-comment">#sed &#x27;s/&lt;[^&gt;]*&gt;//g&#x27; test1</span><br><br><span class="hljs-comment">#sed &#x27;s/&lt;[^&gt;]*&gt;//g;/^$/d&#x27; test1</span><br><br><br><span class="hljs-comment">#and符号，代表替换命令中的匹配模式，不管预定义模式是什么文本，都可以用and符号替换，and符号会提取匹配替换命令中指定替换模式中的所有字符串</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;The cat sleeps in his hat&quot;</span> | sed <span class="hljs-string">&#x27;s/.at/&quot;&amp;&quot;/g&#x27;</span><br><br><span class="hljs-comment">#替换单独的单词</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;The System Administrator manual&quot;</span> | sed <span class="hljs-string">&#x27;s/\(System\) Administrator/\1 user/&#x27;</span><br><br><span class="hljs-comment">#在长数字中插入逗号</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;1234567&quot;</span> | sed <span class="hljs-string">&#x27;&#123;:start; s/\(.*[0-9]\)\([0-9]\&#123;3\&#125;\)/\1,\2/; t start&#125;&#x27;</span><br><br><span class="hljs-comment">#给文件中的行编号</span><br>sed <span class="hljs-string">&#x27;=&#x27;</span> <span class="hljs-built_in">test</span> | sed <span class="hljs-string">&#x27;N; s/\n/ /&#x27;</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Linux基础</category>
      
    </categories>
    
    
    <tags>
      
      <tag>shell</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Linux的常用命令详解</title>
    <link href="/2022/11/07/Linux%E7%9A%84%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%E8%AF%A6%E8%A7%A3/"/>
    <url>/2022/11/07/Linux%E7%9A%84%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%E8%AF%A6%E8%A7%A3/</url>
    
    <content type="html"><![CDATA[<p><img src="https://xcj-typora-img.oss-cn-hangzhou.aliyuncs.com/img/c4c1627cc457.png" alt="c4c1627cc457"></p><h2 id="1-帮助命令"><a href="#1-帮助命令" class="headerlink" title="1.帮助命令"></a>1.帮助命令</h2><h3 id="1-1-help命令"><a href="#1-1-help命令" class="headerlink" title="1.1 help命令"></a>1.1 help命令</h3><p>语法格式： 命令 –help </p><p>作用: 查看某个命令的帮助信息 </p><p>示例: </p><ul><li>ls –help     查看ls命令的帮助信息 </li><li>netstat –help    查看netstat命令的帮助信息</li></ul><h3 id="1-2-man命令"><a href="#1-2-man命令" class="headerlink" title="1.2 man命令"></a>1.2 man命令</h3><p>语法格式： man 命令  </p><p>作用: 查看某个命令的帮助手册   </p><p>示例:       </p><ul><li><p>man ls         查看ls命令的帮助手册      </p></li><li><p>man netstat    查看netstat命令的帮助手册</p></li></ul><h2 id="2-路径切换及查看"><a href="#2-路径切换及查看" class="headerlink" title="2.路径切换及查看"></a>2.路径切换及查看</h2><h3 id="2-1-cd命令"><a href="#2-1-cd命令" class="headerlink" title="2.1 cd命令"></a>2.1 cd命令</h3><p>语法格式： cd 目录  </p><p>作用: 切换到目录中   </p><p>示例:       </p><ul><li>cd &#x2F;opt       切换到&#x2F;opt目录下      </li><li>cd ~  切换到用户目录      </li><li>cd -  切换到上一次访问的目录      </li><li>cd .. 切换到上一次所在的目录</li></ul><h3 id="2-2-pwd命令"><a href="#2-2-pwd命令" class="headerlink" title="2.2 pwd命令"></a>2.2 pwd命令</h3><p>语法格式： pwd  </p><p>作用: 查看当前所在路径   </p><p>示例:       </p><ul><li>pwd  查看当前路径，会将当前路径回显</li></ul><h3 id="2-3-ls命令"><a href="#2-3-ls命令" class="headerlink" title="2.3 ls命令"></a>2.3 ls命令</h3><p>语法格式： ls [-la] [文件&#x2F;目录]  </p><p>作用: 查看当前路径下的文件和目录，若后带有文件或目录，则只查看当前文件或目录   </p><p>示例:       </p><ul><li>ls  查看当前路径下所有的文件或目录      </li><li>ls -l 查看当前路径下所有的文件或目录的详细信息      </li><li>ls -a 查看当前路径下所有的文件或目录,将隐藏文件显示出来      </li><li>ls -l a.log  查看当前路径下a.log下的详细信息</li></ul><h3 id="2-4-find命令"><a href="#2-4-find命令" class="headerlink" title="2.4 find命令"></a>2.4 find命令</h3><p>语法格式： find [路径] [参数] [匹配模式]  </p><p>作用: 可以根据给定的路径和表达式查找的文件或目录   </p><p>示例:       </p><ul><li><p>find &#x2F; -name “*.txt”   查询根目录下所有以.txt结尾的文件 。      </p></li><li><p>find &#x2F;test -perm  644  查询&#x2F;test目录下权限为644的所有文件      </p></li><li><p>find . -type f     查询当前目录下所有的文件      </p></li><li><p>find . -type f -name “abc”   查询当前目录下所有文件中包含abc字符的文件      </p></li><li><p>find . -type f | sort     查询当前目录下所有文件并排序      </p></li><li><p>find . -type d         查询当前目录下所有目录      find . -size 10M</p></li></ul><h2 id="3-文件-目录操作"><a href="#3-文件-目录操作" class="headerlink" title="3.文件|目录操作"></a>3.文件|目录操作</h2><h3 id="3-1-文件和目录的基本操作"><a href="#3-1-文件和目录的基本操作" class="headerlink" title="3.1 文件和目录的基本操作"></a>3.1 文件和目录的基本操作</h3><h4 id="3-1-1-touch命令"><a href="#3-1-1-touch命令" class="headerlink" title="3.1.1 touch命令"></a>3.1.1 touch命令</h4><p>语法格式： touch 文件名  </p><p>作用: 创建一个文件   </p><p>示例:       </p><ul><li>touch a.log   创建一个a.log文件。</li></ul><h4 id="3-1-2-ln命令"><a href="#3-1-2-ln命令" class="headerlink" title="3.1.2 ln命令"></a>3.1.2 ln命令</h4><p>语法格式：     ln 源文件名 硬链接文件名    ln -s 源文件名 软连接文件名  </p><p>作用: 创建文件链接   </p><p>示例:       </p><ul><li>ln a.txt a.txt.link   为a.txt创建一个硬链接文件a.txt.link。      </li><li>ln -s a.txt a.txt.link  为a.txt创建一个软连接文件 。</li></ul><p>备注：    </p><ul><li>软链接文件：就像Windows中快捷方式一样，只是源文件的一个指向，删除软连接文件，源文件任存在。    </li><li>硬链接文件：比如当前目录下有2个文件，这2个文件除了名字不一样其他的一模一样，但是占用的实际磁盘空间还是只有1M，改变任何一个文件的内容另一个文件也会跟着改变；</li></ul><h4 id="3-1-3-mkdir-命令"><a href="#3-1-3-mkdir-命令" class="headerlink" title="3.1.3 mkdir 命令"></a>3.1.3 mkdir 命令</h4><p>语法格式： mkdir 目录名  </p><p>作用: 创建一个目录   </p><p>示例:       </p><ul><li>mkdir test   创建一个test的目录。      </li><li>mkdir -p test  若存在test，则不创建；若不存在，则创建      </li><li>mkidr -p test&#x2F;a&#x2F;b  创建test目录，其下再创建a目录，a目录再创建b目录 。</li></ul><h4 id="3-1-4-rm命令"><a href="#3-1-4-rm命令" class="headerlink" title="3.1.4 rm命令"></a>3.1.4 rm命令</h4><p>语法格式： rm [-rf] 文件|目录  </p><p>作用: 删除文件或目录   </p><p>示例:      </p><ul><li>rm a.txt   删除a.txt,删除前询问 。      </li><li>rm -f a.txt  直接删除a.txt ,不在询问 。      </li><li>rm -r test  删除test目录，删除前询问      </li><li>rm -rf test  直接删除test目录，不在询问 。</li></ul><p>备注：任何的删除操作都是危险的动作，慎用 。</p><h4 id="3-1-5-mv命令"><a href="#3-1-5-mv命令" class="headerlink" title="3.1.5 mv命令"></a>3.1.5 mv命令</h4><p>语法格式： mv 源文件|目录 目标文件|目标目录  </p><p>作用: 有两层意思，分别为：    </p><ul><li>进行重命名文件或目录    </li><li>进行移动文件或目录到目的目录 。</li></ul><p>示例:       </p><ul><li>mv a.txt b.txt   修改文件名a.txt为b.txt 。      </li><li>mv a.txt test&#x2F;   移动a.txt 到test目录下      </li><li>mv abc bcd       重命名目录abc为bcd .      </li><li>mv abc bcd&#x2F;       移动abc目录到bcd下 。</li></ul><h4 id="3-1-6-cp命令"><a href="#3-1-6-cp命令" class="headerlink" title="3.1.6 cp命令"></a>3.1.6 cp命令</h4><p>语法格式： cp [-rf] 源文件|目录 目标文件|目录  </p><p>作用: 拷贝文件或目录为另一个文件或目录 。       </p><p>示例:       </p><ul><li>cp a.txt b.txt  拷贝a.txt为b.txt ,若b.txt以存在，则提示是否继续拷贝 。      </li><li>cp -f a.txt b.txt 拷贝a.txt为b.txt ,即使b.txt以前就存在，也是直接覆盖 。      </li><li>cp -r abc bcd 拷贝abc目录为bcd ,若abc存在，则提示是否继续拷贝 。      </li><li>cp -rf abc bcd 拷贝abc目录为bcd ,即使abc存在，则也是直接覆盖 。</li></ul><h3 id="3-2-文件压缩与解压缩"><a href="#3-2-文件压缩与解压缩" class="headerlink" title="3.2 文件压缩与解压缩"></a>3.2 文件压缩与解压缩</h3><h4 id="3-2-1-zipinfo命令"><a href="#3-2-1-zipinfo命令" class="headerlink" title="3.2.1 zipinfo命令"></a>3.2.1 zipinfo命令</h4><p>语法格式： zipinfo zip文件  </p><p>作用:  查看zip文件里的信息。       </p><p>示例:       </p><ul><li>zipinfo  abc.zip  查看abc.zip里的文件信息 。      </li><li>zipinfo -v abc.zip 显示abc.zip里的每个文件的信息 。</li></ul><h4 id="3-2-2-zip命令"><a href="#3-2-2-zip命令" class="headerlink" title="3.2.2 zip命令"></a>3.2.2 zip命令</h4><p>语法格式： zip 压缩文件 文件|目录  </p><p>作用:  将目标文件或目录进行压缩。       </p><p>示例:       </p><ul><li>zip a.zip a.txt  将a.txt进行压缩形成a.zip 。      </li><li>zip a.zip test&#x2F; 将test目录下的所有文件和目录压缩到a.zip 。</li></ul><h4 id="3-2-3-gzip命令"><a href="#3-2-3-gzip命令" class="headerlink" title="3.2.3. gzip命令"></a>3.2.3. gzip命令</h4><p>语法格式： gzip [-d] 文件|目录  </p><p>作用:  压缩|解压缩文件或目录       </p><p>示例:       </p><ul><li>gzip a.txt  将a.txt压缩为a.txt.gz ,注意压缩后源文件已不存在。      </li><li>gzip -d a.txt.gz 解压a.txt.gz文件</li></ul><h4 id="3-2-4-unzip命令"><a href="#3-2-4-unzip命令" class="headerlink" title="3.2.4 unzip命令"></a>3.2.4 unzip命令</h4><p>语法格式： unzip  文件  </p><p>作用:  解压缩文件       </p><p>示例:       </p><ul><li>unzip  a.zip       解压文件</li></ul><h4 id="3-2-5-gunzip命令"><a href="#3-2-5-gunzip命令" class="headerlink" title="3.2.5 gunzip命令"></a>3.2.5 gunzip命令</h4><p>语法格式： gunzip 压缩文件  </p><p>作用:  解压压缩文件       </p><p>示例:       </p><ul><li>gunzip a.txt.gz  解压a.txt.gz     guzip  test.tar.gz  解压test.tar.gz</li></ul><h4 id="3-2-6-tar命令"><a href="#3-2-6-tar命令" class="headerlink" title="3.2.6 tar命令"></a>3.2.6 tar命令</h4><p>语法格式： tar [-c|xzvf] 文件|压缩文件  </p><p>作用:  进行归档并创建压缩文件 或 进行解压归档压缩文档         </p><p>示例:       </p><ul><li>tar -cvzf a.tar  a.txt     将文件a.txt进行压缩并归档      </li><li>tar -xvzf a.tar .   解压a.tar文件到当前目录 。</li></ul><h3 id="3-3-文件传输"><a href="#3-3-文件传输" class="headerlink" title="3.3 文件传输"></a>3.3 文件传输</h3><h4 id="3-3-1-tftp命令"><a href="#3-3-1-tftp命令" class="headerlink" title="3.3.1 tftp命令"></a>3.3.1 tftp命令</h4><p>语法格式： tftp 远程主机  </p><p>作用:  连接远程主机，上传或下载文件       </p><p>示例: (需连接到远程主机)      </p><ul><li>get a.txt     下载a.txt文件     </li><li>put a.txt     上传a.txt到远程主机</li></ul><h4 id="3-3-2-curl命令"><a href="#3-3-2-curl命令" class="headerlink" title="3.3.2 curl命令"></a>3.3.2 curl命令</h4><p>语法格式： curl url  </p><p>作用:  进行文件下载或者请求http协议数据       </p><p>示例:       </p><ul><li>curl  <a href="http://www.baidu.com/">http://www.baidu.com</a>    请求百度      </li><li>curl -o baidu.html <a href="http://www.baidu.com/">http://www.baidu.com</a>    将请求到的数据保存到baidu.html中 。</li></ul><h4 id="3-3-3-scp命令"><a href="#3-3-3-scp命令" class="headerlink" title="3.3.3 scp命令"></a>3.3.3 scp命令</h4><p>语法格式： scp 远程主机账号@远程IP地址 本地目录  </p><p>作用:  登录远程主机进行拷贝文件或目录       </p><p>示例:       </p><ul><li>scp <a href="mailto:&#114;&#111;&#111;&#116;&#64;&#49;&#x39;&#50;&#46;&#49;&#54;&#x38;&#x2e;&#x31;&#x32;&#x2e;&#49;&#49;">&#114;&#111;&#111;&#116;&#64;&#49;&#x39;&#50;&#46;&#49;&#54;&#x38;&#x2e;&#x31;&#x32;&#x2e;&#49;&#49;</a>:&#x2F;soft&#x2F;test.tar.gz &#x2F;tools&#x2F;   将远程主机目录下的&#x2F;soft&#x2F;test.tar.gz 拷贝到本地目录下的tools&#x2F;下      </li><li>scp <a href="mailto:&#x72;&#x6f;&#x6f;&#x74;&#x40;&#x31;&#x39;&#50;&#46;&#49;&#54;&#56;&#46;&#x31;&#x32;&#x2e;&#x31;&#x31;">&#x72;&#x6f;&#x6f;&#x74;&#x40;&#x31;&#x39;&#50;&#46;&#49;&#54;&#56;&#46;&#x31;&#x32;&#x2e;&#x31;&#x31;</a>:&#x2F;soft&#x2F; &#x2F;tools&#x2F;  将远程主机目录soft 拷贝到本地目录的tools&#x2F;下 。</li></ul><h4 id="3-3-4-rcp命令"><a href="#3-3-4-rcp命令" class="headerlink" title="3.3.4 rcp命令"></a>3.3.4 rcp命令</h4><p>语法格式： scp 主机1 主机2  </p><p>作用:  远程主机间的文件或目录相互拷贝       </p><p>示例:        </p><ul><li>rcp test 192.168.128.169:&#x2F;test   拷贝当前目录下的test 到192.168.128.169的&#x2F;test目录下       </li><li>rcp <a href="mailto:&#x72;&#x6f;&#x6f;&#x74;&#x40;&#49;&#57;&#50;&#x2e;&#x31;&#x36;&#x38;&#x2e;&#49;&#50;&#56;&#46;&#x31;&#x36;&#x39;">&#x72;&#x6f;&#x6f;&#x74;&#x40;&#49;&#57;&#50;&#x2e;&#x31;&#x36;&#x38;&#x2e;&#49;&#50;&#56;&#46;&#x31;&#x36;&#x39;</a>:.&#x2F;test  &#x2F;test 复制远程目录到本地的&#x2F;test下</li></ul><h3 id="3-4-文件属性查看"><a href="#3-4-文件属性查看" class="headerlink" title="3.4 文件属性查看"></a>3.4 文件属性查看</h3><h4 id="3-4-1-file命令"><a href="#3-4-1-file命令" class="headerlink" title="3.4.1 file命令"></a>3.4.1 file命令</h4><p>语法格式： file 文件名  </p><p>作用:  查看文件的类型       </p><p>示例:        </p><ul><li>file a.txt    查看a.txt是什么类型       </li><li>file abc      查看abc是什么类型</li></ul><h4 id="3-4-2-du命令"><a href="#3-4-2-du命令" class="headerlink" title="3.4.2 du命令"></a>3.4.2 du命令</h4><p>语法格式： du 文件名  </p><p>作用:  查看文件的大小       </p><p>示例:        </p><ul><li>du a.txt    查看a.txt的文件大小，以k为单位      </li><li>du -h a.txt       查看a.txt的文件大小，以M为单位</li></ul><h3 id="3-5-文件目录权限设置"><a href="#3-5-文件目录权限设置" class="headerlink" title="3.5 文件目录权限设置"></a>3.5 文件目录权限设置</h3><h4 id="3-5-1-chmod命令"><a href="#3-5-1-chmod命令" class="headerlink" title="3.5.1 chmod命令"></a>3.5.1 chmod命令</h4><p>语法格式： 有两种用法    </p><ul><li>chmod [u&#x2F;g&#x2F;o&#x2F;a][+&#x2F;-&#x2F;&#x3D;] rwx 文件&#x2F;目录   +:增加权限，-取消权限， &#x3D;设定权限    </li><li>chmod 数字 文件&#x2F;目录      作用:  为文件或目录设置权限。</li></ul><p>示例:        </p><ul><li>chmod a&#x3D;rw a.txt  为所有者设置读写权限 。      </li><li>chmod 644 a.txt  为所有者设置读权限，为用户设置写权限。</li><li></li></ul><h2 id="4-文本内容查看及过滤"><a href="#4-文本内容查看及过滤" class="headerlink" title="4.文本内容查看及过滤"></a>4.文本内容查看及过滤</h2><h3 id="4-1-文本内容查看"><a href="#4-1-文本内容查看" class="headerlink" title="4.1 文本内容查看"></a>4.1 文本内容查看</h3><h4 id="4-1-1-cat命令"><a href="#4-1-1-cat命令" class="headerlink" title="4.1.1 cat命令"></a>4.1.1 cat命令</h4><p>语法格式： cat 文件名  </p><p>作用:  查看文本内容，会将内容全部显示。       </p><p>示例:        </p><ul><li>cat a.txt  显示a.txt里的内容。</li></ul><h4 id="4-1-2-more命令"><a href="#4-1-2-more命令" class="headerlink" title="4.1.2 more命令"></a>4.1.2 more命令</h4><p>语法格式： more 文件名  </p><p>作用:  百分比显示文件内容，按Enter继续。       </p><p>示例:        </p><ul><li>more a.txt  若只有一页，则全部显示，否则按百分比显示。</li></ul><h4 id="4-1-3-tail命令"><a href="#4-1-3-tail命令" class="headerlink" title="4.1.3 tail命令"></a>4.1.3 tail命令</h4><p>语法格式：        </p><ul><li>tail 文件名         查看文本内容        </li><li>tail -n 数量 文件名       只显示倒数的几行        </li><li>tail -f 文件名           实时的查看文件写入的信息</li></ul><p>作用:  查看文本内容，       </p><p>示例:        </p><ul><li>tail a.txt  查看文件内容，和cat效果一样 。       </li><li>tail -n 2 a.txt  显示a.txt最后两行        </li><li>tail -f a.txt    实时监控a.txt文本内容。</li></ul><h4 id="4-1-4-head命令"><a href="#4-1-4-head命令" class="headerlink" title="4.1.4 head命令"></a>4.1.4 head命令</h4><p>语法格式：     </p><ul><li>head 文件名    </li><li>head -n 数量 文件名</li></ul><p>作用:  查看文本内容。      </p><p>示例:        </p><ul><li>head a.txt   查看文本内容，和cat效果一样。       </li><li>head -n 2 a.txt  查看文本的前两行 。</li></ul><h3 id="4-2-文本内容筛选过滤"><a href="#4-2-文本内容筛选过滤" class="headerlink" title="4.2 文本内容筛选过滤"></a>4.2 文本内容筛选过滤</h3><h4 id="4-2-1-grep命令"><a href="#4-2-1-grep命令" class="headerlink" title="4.2.1 grep命令"></a>4.2.1 grep命令</h4><p>语法格式： grep [选项] [模式] 文件  </p><p>作用:  文本搜索工具。       </p><p>示例:       </p><ul><li>grep “aaa” a.txt   从a.txt中搜索aaa字符的行       </li><li>grep -v “aaa” a.txt  从a.txt中不包含aaa的行        </li><li>grep -n “aaa” a.txt  从a.txt中搜索aaa字符的行,并在前面加上行号       </li><li>grep -i “aaa” a.txt  从a.txt中搜索aaa字符的行,其中忽略aaa的大小写       </li><li>grep -e “a*” a.txt  从a.txt中搜索匹配a字符的行       </li><li>ps -ef |grep “mysql”  查看mysql的进程</li></ul><h4 id="4-2-2-sed命令"><a href="#4-2-2-sed命令" class="headerlink" title="4.2.2 sed命令"></a>4.2.2 sed命令</h4><p>语法格式： sed [选项]  文件  </p><p>作用:  文本编辑工具。       </p><p>示例:        </p><ul><li>sed -n ‘2p’ a.txt   从a.txt中的第二行内容       </li><li>sed ‘3,5d’ a.txt     删除a.txt中第3到5行的内容，(注：源文件内容不变，只是回显内容会删除)       </li><li>sed ‘&#x2F;aaa&#x2F;d’ a.txt  删除匹配aaa的行，从a.txt中 。</li></ul><h4 id="4-2-3-awk命令"><a href="#4-2-3-awk命令" class="headerlink" title="4.2.3 awk命令"></a>4.2.3 awk命令</h4><p>语法格式： awk [选项]  文件  </p><p>作用:  文本分析工具。       </p><p>示例:        </p><ul><li>awk ‘{print $5}’ a.txt   显示a.txt中第5列的内容       </li><li>awk ‘NR &lt;&#x3D;2 {print $1,$3,$5}’ a.txt  显示前两行内容，每行只显示第1,3,5列 。       </li><li>awk ‘&#x2F;^d&#x2F; {print $1,$9}’ a.txt 显示以d开头的行，每行只显示第一，九列 。</li></ul><h4 id="4-2-4-cut命令"><a href="#4-2-4-cut命令" class="headerlink" title="4.2.4 cut命令"></a>4.2.4 cut命令</h4><p>语法格式： cut 选项 文件  </p><p>作用:  用于剪切字符。       </p><p>示例:        </p><ul><li>cut -c 1-3 a.txt 只输出每行第一到第三的字符       </li><li>cut -f4 -d” “ a.txt 显示第四列，以空格为分隔符</li></ul><h4 id="4-2-5-col命令"><a href="#4-2-5-col命令" class="headerlink" title="4.2.5 col命令"></a>4.2.5 col命令</h4><p>语法格式： col 选项 文件  </p><p>作用:  用于过滤字符。       </p><p>示例:        </p><ul><li>man ls | col-b &gt; ls_help  过滤掉ls手册中的控制字符并输出到文件</li></ul><h3 id="4-3-文本编辑"><a href="#4-3-文本编辑" class="headerlink" title="4.3 文本编辑"></a>4.3 文本编辑</h3><h4 id="4-3-1-vi-vim命令"><a href="#4-3-1-vi-vim命令" class="headerlink" title="4.3.1 vi&#x2F;vim命令"></a>4.3.1 vi&#x2F;vim命令</h4><p>语法格式： vi&#x2F;vim  文件  </p><p>作用:  用于编辑文件。       </p><p>示例:         </p><ul><li>vi a.txt  编辑a.txt,可以进行修改里面的内容       </li><li>vim a.txt  编辑a.txt,可以进行修改里面的内容</li></ul><h3 id="4-4-输出重定向"><a href="#4-4-输出重定向" class="headerlink" title="4.4 输出重定向"></a>4.4 输出重定向</h3><h4 id="4-4-1-命令"><a href="#4-4-1-命令" class="headerlink" title="4.4.1 &gt;命令"></a>4.4.1 &gt;命令</h4><p>语法格式： &gt;  文件  </p><p>作用:  将内容输出到文件，若文件中有内容则覆盖。若文件不存在，则创建文件       </p><p>示例:         </p><ul><li>ll &gt; a.txt  查看详细后输出到a.txt 。       </li><li>cat a.txt &gt; b.txt  将a.txt中的内容添加到b.txt中 。</li></ul><h4 id="4-4-2-命令"><a href="#4-4-2-命令" class="headerlink" title="4.4.2 &gt;&gt;命令"></a>4.4.2 &gt;&gt;命令</h4><p>语法格式： &gt;&gt;  文件  </p><p>作用:  将内容追加到文件，若文件中有内容则追加。若文件不存在，则创建文件       </p><p>示例:         </p><ul><li>ll &gt;&gt; a.txt  查看详细后追加到a.txt 。       </li><li>cat a.txt &gt;&gt; b.txt  将a.txt中的内容添加到b.txt中 。</li></ul><h4 id="4-4-3-tee命令"><a href="#4-4-3-tee命令" class="headerlink" title="4.4.3 tee命令"></a>4.4.3 tee命令</h4><p>语法格式： tee  文件  </p><p>作用:  将内容输出到文件并输出内容显示在控制台上。若文件不存在，则创建文件，一般需要和管道符(|)一起使用。       </p><p>示例:         </p><ul><li>cat a.txt | tee b.txt  将a.txt中的内容添加到b.txt中，同时将添加内容回显到控制台上 。</li></ul><h3 id="4-5-文本内容处理"><a href="#4-5-文本内容处理" class="headerlink" title="4.5 文本内容处理"></a>4.5 文本内容处理</h3><h4 id="4-5-1-join命令"><a href="#4-5-1-join命令" class="headerlink" title="4.5.1 join命令"></a>4.5.1 join命令</h4><p>语法格式： join  文件1 文件2  </p><p>作用:  用于将两个文件中，指定栏目内容相同的行连接起来       </p><p>示例:         </p><ul><li>join a.txt b.txt  若第一行相同，将后面的内容连接起来 。</li></ul><h4 id="4-5-2-split命令"><a href="#4-5-2-split命令" class="headerlink" title="4.5.2 split命令"></a>4.5.2 split命令</h4><p>语法格式： split 数量 文件  </p><p>作用:  用于将一个文件分割成数个       </p><p>示例:        </p><ul><li>split -5 c.txt  按每5行显示分隔出一个文件。</li></ul><h4 id="4-5-3-uniq命令"><a href="#4-5-3-uniq命令" class="headerlink" title="4.5.3 uniq命令"></a>4.5.3 uniq命令</h4><p>语法格式： uniq  文件  </p><p>作用:  用于检查及删除文本文件中重复出现的行列，注意：重复的行一定是相邻的行，若不相邻不会删除       </p><p>示例:         </p><ul><li>uniq d.txt  将d.txt中相邻重复的行去掉 。       </li><li>uniq d.txt | sort  将d.txt中相邻重复的行去掉并排序</li></ul><p>备注： 此命令经常和sort命令结合使用，用于去重和排序。</p><h4 id="4-5-4-sort命令"><a href="#4-5-4-sort命令" class="headerlink" title="4.5.4 sort命令"></a>4.5.4 sort命令</h4><p>语法格式： sort  文件  </p><p>作用:  对文本内容进行排序       </p><p>示例:         </p><ul><li>sort a.txt  将a.txt中的内容进行排序，默认为升序。      </li><li>sort -r a.txt 将a.txt中的内容进行相反顺序排序       </li><li>uniq d.txt | sort -r 将d.txt中相邻重复的行去掉并倒序排序</li></ul><h4 id="4-5-5-paste命令"><a href="#4-5-5-paste命令" class="headerlink" title="4.5.5 paste命令"></a>4.5.5 paste命令</h4><p>语法格式： paste  文件1 文件2 …  </p><p>作用:  用于合并文件的列。       </p><p>示例:         </p><ul><li>cat a.txt b.txt  将两个文件的列合并起来显示 。</li></ul><h2 id="5-用户-组操作"><a href="#5-用户-组操作" class="headerlink" title="5.用户|组操作"></a>5.用户|组操作</h2><h3 id="5-1-用户增删改"><a href="#5-1-用户增删改" class="headerlink" title="5.1 用户增删改"></a>5.1 用户增删改</h3><h4 id="5-1-1-useradd命令"><a href="#5-1-1-useradd命令" class="headerlink" title="5.1.1 useradd命令"></a>5.1.1 useradd命令</h4><p>语法格式： useradd 新用户  </p><p>作用:  创建用户       </p><p>示例:         </p><ul><li>useradd test   创建test用户       </li><li>useradd -d &#x2F;home&#x2F;test  test  创建test用户，并指定test用户的家目录为home&#x2F;test       </li><li>useradd -u 666 test  为test用户指定uid为666</li></ul><h4 id="5-1-2-adduser命令"><a href="#5-1-2-adduser命令" class="headerlink" title="5.1.2 adduser命令"></a>5.1.2 adduser命令</h4><p>语法格式： adduser 新用户  </p><p>作用:  创建用户       </p><p>示例:         </p><ul><li>adduser test   创建test用户       </li><li>adduser -d &#x2F;home&#x2F;test  test  创建test用户，并指定test用户的家目录为home&#x2F;test       </li><li>adduser -u 666 test  为test用户指定uid为666</li></ul><h4 id="5-1-3-userdel命令"><a href="#5-1-3-userdel命令" class="headerlink" title="5.1.3 userdel命令"></a>5.1.3 userdel命令</h4><p>语法格式： userdel 用户  </p><p>作用:  删除用户       </p><p>示例:         </p><ul><li>userdel test  删除test用户       </li><li>userdel -r test  删除test用户及其家目录</li></ul><h4 id="5-1-4-usermod命令"><a href="#5-1-4-usermod命令" class="headerlink" title="5.1.4 usermod命令"></a>5.1.4 usermod命令</h4><p>语法格式： usermod 用户  </p><p>作用:  修改用户       </p><p>示例:         </p><ul><li>usermod -l test1 test   将用户test修改为test1       </li><li>usermod -d &#x2F;home&#x2F;test00  test  将用户test的家目录修改为&#x2F;home&#x2F;test00       </li><li>usermod -L test    锁定test用户的密码       usermod -U test    解锁test用户的密码</li></ul><h3 id="5-2-用户设置密码"><a href="#5-2-用户设置密码" class="headerlink" title="5.2 用户设置密码"></a>5.2 用户设置密码</h3><h4 id="5-2-1-passwd命令"><a href="#5-2-1-passwd命令" class="headerlink" title="5.2.1 passwd命令"></a>5.2.1 passwd命令</h4><p>语法格式： passwd 用户  </p><p>作用:  修改用户密码，输入命令回车后会引到用户设置新密码 。       </p><p>示例:         </p><ul><li>passwd test   修改用户密码</li></ul><h3 id="5-3-组的增删改"><a href="#5-3-组的增删改" class="headerlink" title="5.3 组的增删改"></a>5.3 组的增删改</h3><h4 id="5-3-1-groupadd命令"><a href="#5-3-1-groupadd命令" class="headerlink" title="5.3.1 groupadd命令"></a>5.3.1 groupadd命令</h4><p>语法格式： groupadd 用户组  </p><p>作用:  添加用户组       </p><p>示例:         </p><ul><li>groupadd  test  添加用户组为test       </li><li>groupadd -g 9999 test  为创建用户组test并设置gid为9999</li></ul><h4 id="5-3-2-groupdel命令"><a href="#5-3-2-groupdel命令" class="headerlink" title="5.3.2 groupdel命令"></a>5.3.2 groupdel命令</h4><p>语法格式： groupdel 用户组  </p><p>作用:  删除用户组       </p><p>示例:         </p><ul><li>groupdel test  删除用户组test</li></ul><h4 id="5-3-3-groupmod"><a href="#5-3-3-groupmod" class="headerlink" title="5.3.3 groupmod"></a>5.3.3 groupmod</h4><p>语法格式： groupmod 用户组  </p><p>作用:  修改用户组       </p><p>示例:         </p><ul><li>groupmod -n root test   更改test用户组为root</li></ul><h3 id="5-4-文件设置用户权限"><a href="#5-4-文件设置用户权限" class="headerlink" title="5.4 文件设置用户权限"></a>5.4 文件设置用户权限</h3><h4 id="5-4-1-chown命令"><a href="#5-4-1-chown命令" class="headerlink" title="5.4.1 chown命令"></a>5.4.1 chown命令</h4><p>语法格式： chown 文件|目录 用户|用户组  </p><p>作用:  更改文件目录的用户或用户组       </p><p>示例:         </p><ul><li>chown root &#x2F;test&#x2F;a.txt  把a.txt的所有者设置为root       </li><li>chown root:root &#x2F;test&#x2F;a.txt  把a.txt的所有者设置为root,组设置为root       </li><li>chown -R test:test *   把当前目录下的所有文件都设置为test用户和test用户组</li></ul><h3 id="5-5-切换用户"><a href="#5-5-切换用户" class="headerlink" title="5.5 切换用户"></a>5.5 切换用户</h3><h4 id="5-5-1-su命令"><a href="#5-5-1-su命令" class="headerlink" title="5.5.1 su命令"></a>5.5.1 su命令</h4><p>语法格式： su [-] 用户  </p><p>作用:  切换用户       </p><p>示例:         </p><ul><li>su test  切换当前用户为test用户         </li><li>su - test 切换当前用户为test用户   备注： 第一次切换时需要输入密码</li></ul><h2 id="6-任务管理器"><a href="#6-任务管理器" class="headerlink" title="6.任务管理器"></a>6.任务管理器</h2><h3 id="6-1-进程"><a href="#6-1-进程" class="headerlink" title="6.1 进程"></a>6.1 进程</h3><h4 id="6-1-ps命令"><a href="#6-1-ps命令" class="headerlink" title="6.1 ps命令"></a>6.1 ps命令</h4><p>语法格式： ps [参数]  </p><p>作用:  显示当前系统的进程状态       </p><p>示例:         </p><ul><li>ps -ef  显示所有进程       </li><li>ps -aux  显示所有进程       </li><li>ps -ef | grep mysql  查看mysql进程       </li><li>ps -u root 显示root用户进程。</li></ul><h4 id="6-2-kill-命令"><a href="#6-2-kill-命令" class="headerlink" title="6.2 kill 命令"></a>6.2 kill 命令</h4><p>语法格式： kill [参数]  </p><p>作用:  杀掉系统中执行的程序(进程)       </p><p>示例:         </p><ul><li>kill 319877  杀掉进程319877       </li><li>kill -9  319877  强制杀掉进程319877</li></ul><h3 id="6-2-系统资源"><a href="#6-2-系统资源" class="headerlink" title="6.2 系统资源"></a>6.2 系统资源</h3><h4 id="6-2-1-top命令"><a href="#6-2-1-top命令" class="headerlink" title="6.2.1 top命令"></a>6.2.1 top命令</h4><p>语法格式： top [参数]  </p><p>作用:  显示系统中各个进程的资源占用情况       </p><p>示例:         </p><ul><li>top   查看系统各个进程的资源占用，比如CPU ，内存信息。         </li><li>top -n 5  动态更新5次结束       top -d 5  每隔5秒更新一次</li></ul><h4 id="6-2-2-vmstat命令"><a href="#6-2-2-vmstat命令" class="headerlink" title="6.2.2 vmstat命令"></a>6.2.2 vmstat命令</h4><p>语法格式： vmstat [参数]  </p><p>作用:  显示虚拟内存状态       </p><p>示例:          </p><ul><li>vmstat   显示内存信息          </li><li>vmstat  -s  以列表形式显示内存        </li><li>vmstat 2  每隔2秒刷新一次</li></ul><h4 id="6-2-3-free命令"><a href="#6-2-3-free命令" class="headerlink" title="6.2.3 free命令"></a>6.2.3 free命令</h4><p>语法格式： free [参数]  </p><p>作用:  查看系统内存信息       </p><p>示例:         </p><ul><li>free  显示内存信息，默认以kb为单位         </li><li>free -m  显示内存信息，以mb为单位       </li><li>free -g  显示内存信息，以gb为单位</li></ul><h4 id="6-2-4-df命令"><a href="#6-2-4-df命令" class="headerlink" title="6.2.4 df命令"></a>6.2.4 df命令</h4><p>语法格式：  df [参数] 分区  </p><p>作用:  查看磁盘占用空间       </p><p>示例:          </p><ul><li>df   查看各分区在磁盘占用情况        </li><li>df -h  以比较容易阅读方式查看磁盘使用情况        </li><li>df &#x2F;dev&#x2F;shm  查看该挂载点下的使用情况</li></ul><h4 id="6-2-5-fdisk命令"><a href="#6-2-5-fdisk命令" class="headerlink" title="6.2.5 fdisk命令"></a>6.2.5 fdisk命令</h4><p>语法格式： fdisk [参数]  </p><p>作用:  进行磁盘分区管理       </p><p>示例:         </p><ul><li>fdisk -l  查看所有分区情况</li></ul><h4 id="6-2-6-netstat命令"><a href="#6-2-6-netstat命令" class="headerlink" title="6.2.6 netstat命令"></a>6.2.6 netstat命令</h4><p>语法格式： netstat [参数]  </p><p>作用:  显示各种网络信息       </p><p>示例:         </p><ul><li>netstat   查看各网络信息        </li><li>netstat -an | grep 3306  查看3306端口的使用情况</li></ul><h3 id="6-3-服务"><a href="#6-3-服务" class="headerlink" title="6.3 服务"></a>6.3 服务</h3><h4 id="6-3-1-service命令（RHEL6）"><a href="#6-3-1-service命令（RHEL6）" class="headerlink" title="6.3.1 service命令（RHEL6）"></a>6.3.1 service命令（RHEL6）</h4><p>语法格式： service [参数]  </p><p>作用:  服务管理       </p><p>示例:         </p><ul><li>service –status-all   查看所有服务的运行状态         </li><li>service  mysql  start  启动mysql       </li><li>service  mysql  stop   停止mysql       </li><li>service  mysql  restart  重启mysql</li></ul><h4 id="6-3-2-systemctl命令（RHEL7）"><a href="#6-3-2-systemctl命令（RHEL7）" class="headerlink" title="6.3.2 systemctl命令（RHEL7）"></a>6.3.2 systemctl命令（RHEL7）</h4><p>语法格式： systemctl [选项] [服务]  </p><p>作用:  对服务进行管理，如启动&#x2F;重启&#x2F;停止&#x2F;查看服务       </p><p>示例:         </p><ul><li>systemctl status httpd.service  查看http服务状态       </li><li>systemctl start httpd.service   启动http服务       </li><li>systemctl stop  httpd.service   停止http服务       </li><li>systemctl restart httpd.service  重启http服务       </li><li>systemctl status firewalld  查看防火墙状态       </li><li>systemctl start firewalld  开启防火墙       </li><li>systemctl stop firewalld   关闭防火墙</li></ul><h4 id="6-3-3-chkconfig命令"><a href="#6-3-3-chkconfig命令" class="headerlink" title="6.3.3 chkconfig命令"></a>6.3.3 chkconfig命令</h4><p>语法格式： chkconfig [参数]  </p><p>作用:  更新（启动或停止）和查询系统服务的运行级信息       </p><p>示例:          </p><ul><li>chkconfig -list  显示所有运行级系统服务的运行状态信息（on或off）        </li><li>chkconfig –add httpd     增加httpd服务       </li><li>chkconfig –del httpd     删除httpd服务</li></ul><h2 id="7-网络管理"><a href="#7-网络管理" class="headerlink" title="7.网络管理"></a>7.网络管理</h2><h3 id="7-1-ifconfig命令"><a href="#7-1-ifconfig命令" class="headerlink" title="7.1 ifconfig命令"></a>7.1 ifconfig命令</h3><p>语法格式：ifconfig   </p><p>作用:  查看或设置网络设备      </p><p>示例:         </p><ul><li>ifconfig  查看网络信息，比如IP地址       </li><li>ifconfig eth0 down   关闭eth0的网卡        </li><li>ifconfig eth0 up      开启eth0的网卡       </li><li>ifconfig eth0 hw ether 00:AA:BB:CC:DD:EE  修改Mac地址       </li><li>ifconfig eth0 add 32ffe:3840:320:2007::2&#x2F;64      为网卡配置IPV6地址      </li><li>ifconfig eth0 del 32ffe:3840:320:2007::2&#x2F;64    删除网卡的IPV6地址     </li><li>ifconfig eth0 192.168.128.169   修改ip地址为192.168.128.169      </li><li>ifconfig eth0 192.168.128.169 netmask 255.255.255.0   修改IP和子网掩码     </li><li>ifconfig eth0 192.168.1.56 netmask 255.255.255.0 broadcast 192.168.1.255  修改ip，子网掩码及网关</li></ul><h3 id="7-2-ping命令"><a href="#7-2-ping命令" class="headerlink" title="7.2 ping命令"></a>7.2 ping命令</h3><p>语法格式： ping IP地址  </p><p>作用:  确认是否和某主机的网络相同       </p><p>示例:         </p><ul><li>ping 192.168.12.12  确认是否能连通到192.168.12.12       </li><li>ping <a href="http://www.baidu.com/">www.baidu.com</a>  确认是否能正常访问百度       </li><li>ping -c 4 <a href="http://www.baidu.com/">www.baidu.com</a>  只ping四次      </li><li>ping -c 4 -i 2 <a href="http://www.baidu.com/">www.baidu.com</a>  只ping四次，每次间隔2s</li></ul><h3 id="7-3-firewall-cmd命令"><a href="#7-3-firewall-cmd命令" class="headerlink" title="7.3 firewall-cmd命令"></a>7.3 firewall-cmd命令</h3><p>语法格式： firewall-cmd [参数]  </p><p>作用:  防火墙端口管理       </p><p>示例:         </p><ul><li>firewall-cmd –state  查看当前防火墙的运行状态       </li><li>firewall-cmd –zone&#x3D;public –list-ports  查看所有放行的端口       </li><li>firewall-cmd –reload  重新加载修改的配置       </li><li>firewall-cmd –query-port&#x3D;8888&#x2F;tcp  查询端口8888是否被开放       </li><li>firewall-cmd –add-port&#x3D;8888&#x2F;tcp   开启8888端口通过防火墙       </li><li>firewall-cmd –permanent –remove-port&#x3D;123&#x2F;tcp  关闭123端口        </li><li>firewall-cmd –add-port&#x3D;8888&#x2F;tcp   开启8888端口通过防火墙       </li><li>firewall-cmd –permanent –remove-port&#x3D;123&#x2F;tcp  关闭123端口</li></ul><h2 id="8-安装更新配置"><a href="#8-安装更新配置" class="headerlink" title="8.安装更新配置"></a>8.安装更新配置</h2><h3 id="8-1-yum命令"><a href="#8-1-yum命令" class="headerlink" title="8.1 yum命令"></a>8.1 yum命令</h3><p>语法格式： yum [选项]  </p><p>作用:  rpm的软件包管理器       </p><p>示例:         </p><ul><li>yum install mysql   安装mysql       </li><li>yum remove mysql    卸载mysql        </li><li>yum clean  mysql    清除缓存目录下的安装包       </li><li>yum install      全部安装       </li><li>yum update       全部更新       </li><li>yum update mysql    更新mysql       </li><li>yum info  mysql    显示mysql安装包信息       </li><li>yum list  mysql    显示mysql安装包信息       </li><li>yum list        显示所有已安装包和可安装包</li></ul><h3 id="8-2-sh命令"><a href="#8-2-sh命令" class="headerlink" title="8.2 sh命令"></a>8.2 sh命令</h3><p>语法格式： sh  可执行文件  </p><p>作用:  运行可执行文件，一般都是shell脚本       </p><p>示例:         </p><ul><li>sh a.sh    运行a.sh文件，       </li><li>sh -x a.sh  运行并调试a.sh脚本</li></ul><h2 id="9-系统相关"><a href="#9-系统相关" class="headerlink" title="9.系统相关"></a>9.系统相关</h2><h3 id="9-1-环境变量"><a href="#9-1-环境变量" class="headerlink" title="9.1 环境变量"></a>9.1 环境变量</h3><h4 id="9-1-1-set命令"><a href="#9-1-1-set命令" class="headerlink" title="9.1.1 set命令"></a>9.1.1 set命令</h4><p>语法格式： set [参数]  </p><p>作用:  显示当前shell的变量，包括当前用户的变量;       </p><p>示例:         </p><ul><li>abcd&#x3D;100       </li><li>set | grep abcd   显示abcd的变量值</li></ul><h4 id="9-1-2-unset命令"><a href="#9-1-2-unset命令" class="headerlink" title="9.1.2 unset命令"></a>9.1.2 unset命令</h4><p>语法格式： unset [参数]  </p><p>作用:  删除shell变量的值       </p><p>示例:         </p><ul><li>abcd&#x3D;100       </li><li>unset abcd   删除abcd的变量值</li></ul><h4 id="9-1-3-env命令"><a href="#9-1-3-env命令" class="headerlink" title="9.1.3 env命令"></a>9.1.3 env命令</h4><p>语法格式： env [参数]  </p><p>作用:  设置或显示当前环境变量       </p><p>示例:         </p><ul><li>env   显示当前环境变量       </li><li>env abcd&#x3D;10   定义环境变量       </li><li>env -u  abcd  删除已经定义的环境变量abcd</li></ul><h4 id="9-1-4-export命令"><a href="#9-1-4-export命令" class="headerlink" title="9.1.4 export命令"></a>9.1.4 export命令</h4><p>语法格式： export [参数]  </p><p>作用:  设置或显示环境变量       </p><p>示例:         </p><ul><li>export  显示当前环境变量       </li><li>export abcd&#x3D;101  定义环境变量</li></ul><h3 id="9-2-重启与关机"><a href="#9-2-重启与关机" class="headerlink" title="9.2 重启与关机"></a>9.2 重启与关机</h3><h4 id="9-2-1-shutdown命令"><a href="#9-2-1-shutdown命令" class="headerlink" title="9.2.1 shutdown命令"></a>9.2.1 shutdown命令</h4><p>语法格式： shutdown [参数]  </p><p>作用:  关闭或重启       </p><p>示例:         </p><ul><li>shutdown -h now     立即关机       </li><li>shutdown -r now      立即重启       </li><li>shutdown -h 22:30   22:30关机</li></ul><h4 id="9-2-2-reboot命令"><a href="#9-2-2-reboot命令" class="headerlink" title="9.2.2 reboot命令"></a>9.2.2 reboot命令</h4><p>语法格式： reboot [参数]  </p><p>作用:  重启计算机       </p><p>示例:         </p><ul><li>reboot  重启</li></ul><h4 id="9-2-3-poweroff命令"><a href="#9-2-3-poweroff命令" class="headerlink" title="9.2.3 poweroff命令"></a>9.2.3 poweroff命令</h4><p>语法格式： poweroff [参数]  </p><p>作用:  关闭计算机       </p><p>示例:         </p><ul><li>poweroff   关闭计算机及电源</li></ul><h4 id="9-2-4-halt命令"><a href="#9-2-4-halt命令" class="headerlink" title="9.2.4 halt命令"></a>9.2.4 halt命令</h4><p>语法格式： halt   </p><p>作用:  关闭操作系统       </p><p>示例:         </p><ul><li>halt    关闭系统       </li><li>halt -p  关闭计算机及电源，等同于poweroff       </li><li>halt -f  强制关机</li></ul><h4 id="9-2-5-exit命令"><a href="#9-2-5-exit命令" class="headerlink" title="9.2.5 exit命令"></a>9.2.5 exit命令</h4><p>语法格式： exit  </p><p>作用:  退出当前执行的shell       </p><p>示例:         </p><ul><li>exit  退出当前shell</li></ul><h3 id="9-3-查看系统信息"><a href="#9-3-查看系统信息" class="headerlink" title="9.3 查看系统信息"></a>9.3 查看系统信息</h3><h4 id="9-3-1-uname命令"><a href="#9-3-1-uname命令" class="headerlink" title="9.3.1 uname命令"></a>9.3.1 uname命令</h4><p>语法格式： uname [参数]  </p><p>作用:  显示系统相关信息       </p><p>示例:         </p><ul><li>uname    显示当前系统       </li><li>uname -an  显示系统的详细信息       </li><li>uname -r   显示内核信息       </li><li>uname -i   显示当前架构</li></ul><h4 id="9-3-2-date命令"><a href="#9-3-2-date命令" class="headerlink" title="9.3.2 date命令"></a>9.3.2 date命令</h4><p>语法格式： date [参数]  </p><p>作用:  显示或设定时间       </p><p>示例:         </p><ul><li>date   查看当前时间       </li><li>date -s “2021-04-04 22:38:56”  设置时间为2021-04-04 22:38:56</li></ul><h4 id="9-3-3-last命令"><a href="#9-3-3-last命令" class="headerlink" title="9.3.3 last命令"></a>9.3.3 last命令</h4><p>语法格式： last   </p><p>作用:  显示最近用户或终端的登录情况       </p><p>示例:         </p><ul><li>last   显示最近用户的登录情况</li></ul><h4 id="9-3-4-history命令"><a href="#9-3-4-history命令" class="headerlink" title="9.3.4 history命令"></a>9.3.4 history命令</h4><p>语法格式： history [参数]  </p><p>作用:  查看历史输入命令       </p><p>示例:         </p><ul><li>history  查看历史命令       </li><li>history  | grep “sed”   查看输入过sed命令       </li><li>history -5  查看最近的5条命令</li></ul><h4 id="9-3-5-who命令"><a href="#9-3-5-who命令" class="headerlink" title="9.3.5 who命令"></a>9.3.5 who命令</h4><p>语法格式： who [参数]  </p><p>作用:  查看当前登录用户信息       </p><p>示例:         </p><ul><li>who   查看登录用户信息       </li><li>who -H  带标题显示        </li><li>who -b  输出系统最近启动时间</li></ul><h3 id="9-4-定时任务"><a href="#9-4-定时任务" class="headerlink" title="9.4 定时任务"></a>9.4 定时任务</h3><h4 id="9-4-1-crontab命令"><a href="#9-4-1-crontab命令" class="headerlink" title="9.4.1 crontab命令"></a>9.4.1 crontab命令</h4><p>语法格式：crontab [参数]   </p><p>作用:  任务调度       </p><p>示例:         </p><ul><li>crontab -l  查看当前计划任务       </li><li>crontab -e  创建计划任务，打开后，需要以按照如下格式编辑</li></ul><p>备注  </p><p>设置格式： minute(分)  hour(小时)  day(天)  month(月)  week(周)  command(命令)     </p><p>设置范围： </p><ul><li>minute   是从0到59之间的任何整数 </li><li>hour     是从0到23之间的任何整数 </li><li>day    是从1到31之间的任何整数 </li><li>month    是从1到12之间的任何整数 </li><li>week     是从0到7之间的任何整数，其中0或7代表星期日 </li><li>command  要执行的命令，可以是系统命令，也可以是自己编写的脚本文件 若某列没有设置，则使用*代替 。</li></ul><p>举例： </p><ul><li><ul><li>1 * *  tar -czvf bk.tar.gz &#x2F;log_bakup      每天进行一次归档备份</li></ul></li></ul><h3 id="9-5-运行管理员权限"><a href="#9-5-运行管理员权限" class="headerlink" title="9.5 运行管理员权限"></a>9.5 运行管理员权限</h3><h4 id="9-5-1-sudo命令"><a href="#9-5-1-sudo命令" class="headerlink" title="9.5.1 sudo命令"></a>9.5.1 sudo命令</h4><p>语法格式： sudo [命令]  </p><p>作用:  运行以管理员权限运行命令,一般是非root用户进行操作       </p><p>示例:  (假设当前账号为test)       </p><ul><li>sudo mkdir abc  创建abc目录 。</li></ul><h3 id="9-6-其它"><a href="#9-6-其它" class="headerlink" title="9.6 其它"></a>9.6 其它</h3><h4 id="9-6-1-clear命令"><a href="#9-6-1-clear命令" class="headerlink" title="9.6.1 clear命令"></a>9.6.1 clear命令</h4><p>语法格式： clear  </p><p>作用:  清屏操作，也可以使用快捷键Ctrl + L       </p><p>示例:         </p><ul><li>clear  清屏</li></ul><h4 id="9-6-2-echo命令"><a href="#9-6-2-echo命令" class="headerlink" title="9.6.2 echo命令"></a>9.6.2 echo命令</h4><p>语法格式： echo [变量]  </p><p>作用:  输出变量值       </p><p>示例:         </p><ul><li>echo  $abc  输出变量abc的值，需要提前定义abc的值       </li><li>echo  <code>pwd</code>  显示当前路径</li></ul>]]></content>
    
    
    <categories>
      
      <category>Linux基础</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Linux</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Linux最全基础命令</title>
    <link href="/2022/11/07/Linux%E6%9C%80%E5%85%A8%E5%9F%BA%E7%A1%80%E5%91%BD%E4%BB%A4/"/>
    <url>/2022/11/07/Linux%E6%9C%80%E5%85%A8%E5%9F%BA%E7%A1%80%E5%91%BD%E4%BB%A4/</url>
    
    <content type="html"><![CDATA[<h2 id="系统信息"><a href="#系统信息" class="headerlink" title="系统信息"></a><strong>系统信息</strong></h2><p>arch                                                     显示机器的处理器架构(1) </p><p>uname -m 显示机器的处理器架构(2) </p><p>uname -r显示正在使用的内核版本 </p><p>dmidecode -q显示硬件系统部件 - (SMBIOS &#x2F; DMI) </p><p>hdparm -i &#x2F;dev&#x2F;hda罗列一个磁盘的架构特性 </p><p>hdparm -tT &#x2F;dev&#x2F;sda在磁盘上执行测试性读取操作 </p><p>cat &#x2F;proc&#x2F;cpuinfo显示CPU info的信息 </p><p>cat &#x2F;proc&#x2F;interrupts显示中断 </p><p>cat &#x2F;proc&#x2F;meminfo 校验内存使用 </p><p>cat &#x2F;proc&#x2F;swaps 显示哪些swap被使用 </p><p>cat &#x2F;proc&#x2F;version 显示内核的版本 </p><p>cat &#x2F;proc&#x2F;net&#x2F;dev 显示网络适配器及统计 </p><p>cat &#x2F;proc&#x2F;mounts 显示已加载的文件系统 </p><p>lspci -tv 罗列 PCI 设备 </p><p>lsusb -tv 显示 USB 设备 </p><p>date 显示系统日期 </p><p>cal 2007 显示2007年的日历表 </p><p>date 041217002007.00 设置日期和时间 - 月日时分年.秒 </p><p>clock -w 将时间修改保存到 BIOS </p><p>netstat -nplt 查看端口</p><h2 id="关机-系统的关机、重启以及登出"><a href="#关机-系统的关机、重启以及登出" class="headerlink" title="关机 (系统的关机、重启以及登出 )"></a><strong>关机 (系统的关机、重启以及登出 )</strong></h2><p>shutdown -h now 关闭系统(1) </p><p>init 0 关闭系统(2) </p><p>telinit 0 关闭系统(3) </p><p>shutdown -h hours:minutes &amp; 按预定时间关闭系统 </p><p>shutdown -c 取消按预定时间关闭系统 </p><p>shutdown -r now 重启(1) </p><p>reboot 重启(2) </p><p>logout 注销 </p><h2 id="文件和目录"><a href="#文件和目录" class="headerlink" title="文件和目录"></a><strong>文件和目录</strong></h2><p>cd &#x2F;home 进入 ‘&#x2F; home’ 目录’ </p><p>cd .. 返回上一级目录 </p><p>cd ..&#x2F;.. 返回上两级目录 </p><p>cd ~user1 进入个人的主目录 </p><p>cd - 返回上次所在的目录 </p><p>pwd 显示工作路径 </p><p>ls 查看目录中的文件 </p><p>ls -F 查看目录中的文件 </p><p>ls -l 显示文件和目录的详细资料 </p><p>ls -a 显示隐藏文件 </p><p>ls <em>[0-9]</em> 显示包含数字的文件名和目录名 </p><p>tree 显示文件和目录由根目录开始的树形结构(1) </p><p>lstree 显示文件和目录由根目录开始的树形结构(2) </p><p>mkdir dir1 创建一个叫做 ‘dir1’ 的目录’ </p><p>mkdir dir1 dir2 同时创建两个目录 </p><p>mkdir -p &#x2F;tmp&#x2F;dir1&#x2F;dir2 创建一个目录树 </p><p>rm -f file1 删除一个叫做 ‘file1’ 的文件’ </p><p>rmdir dir1 删除一个叫做 ‘dir1’ 的目录’ </p><p>rm -rf dir1 删除一个叫做 ‘dir1’ 的目录并同时删除其内容 </p><p>rm -rf dir1 dir2 同时删除两个目录及它们的内容 </p><p>mv dir1 new_dir 重命名&#x2F;移动 一个目录 </p><p>cp file1 file2 复制一个文件 </p><p>cp dir&#x2F;* . 复制一个目录下的所有文件到当前工作目录 </p><p>cp -a &#x2F;tmp&#x2F;dir1 . 复制一个目录到当前工作目录 </p><p>cp -a dir1 dir2 复制一个目录 </p><p>ln -s file1 lnk1 创建一个指向文件或目录的软链接 </p><p>ln file1 lnk1 创建一个指向文件或目录的物理链接 </p><p>touch -t 0712250000 file1 修改一个文件或目录的时间戳 - </p><p>(YYMMDDhhmm) </p><p>file file1 outputs the mime type of the file as text </p><p>iconv -l 列出已知的编码 </p><p>iconv -f fromEncoding -t toEncoding inputFile &gt; outputFile creates a new from the given input file by assuming it is encoded in fromEncoding and converting it to toEncoding. </p><p>find . -maxdepth 1 -name *.jpg -print -exec convert “{}” -resize 80x60 “thumbs&#x2F;{}” ; batch resize files in the current directory and send them to a thumbnails directory (requires convert from Imagemagick) </p><h2 id="文件搜索"><a href="#文件搜索" class="headerlink" title="文件搜索"></a><strong>文件搜索</strong></h2><p>find &#x2F; -name file1 从 ‘&#x2F;‘ 开始进入根文件系统搜索文件和目录 </p><p>find &#x2F; -user user1 搜索属于用户 ‘user1’ 的文件和目录 </p><p>find &#x2F;home&#x2F;user1 -name *.bin 在目录 ‘&#x2F; home&#x2F;user1’ 中搜索带有’.bin’ 结尾的文件 </p><p>find &#x2F;usr&#x2F;bin -type f -atime +100 搜索在过去100天内未被使用过的执行文件 </p><p>find &#x2F;usr&#x2F;bin -type f -mtime -10 搜索在10天内被创建或者修改过的文件 </p><p>find &#x2F; -name *.rpm -exec chmod 755 ‘{}’ ; 搜索以 ‘.rpm’ 结尾的文件并定义其权限 </p><p>find &#x2F; -xdev -name *.rpm 搜索以 ‘.rpm’ 结尾的文件，忽略光驱、捷盘等可移动设备 </p><p>locate *.ps 寻找以 ‘.ps’ 结尾的文件 - 先运行 ‘updatedb’ 命令 </p><p>whereis halt 显示一个二进制文件、源码或man的位置 </p><p>which halt 显示一个二进制文件或可执行文件的完整路径 </p><h2 id="挂载一个文件系统"><a href="#挂载一个文件系统" class="headerlink" title="挂载一个文件系统"></a><strong>挂载一个文件系统</strong></h2><p>mount &#x2F;dev&#x2F;hda2 &#x2F;mnt&#x2F;hda2 挂载一个叫做hda2的盘 - 确定目录 ‘&#x2F; mnt&#x2F;hda2’ 已经存在 </p><p>umount &#x2F;dev&#x2F;hda2 卸载一个叫做hda2的盘 - 先从挂载点 ‘&#x2F; mnt&#x2F;hda2’ 退出 </p><p>fuser -km &#x2F;mnt&#x2F;hda2 当设备繁忙时强制卸载 </p><p>umount -n &#x2F;mnt&#x2F;hda2 运行卸载操作而不写入 &#x2F;etc&#x2F;mtab 文件- 当文件为只读或当磁盘写满时非常有用 </p><p>mount &#x2F;dev&#x2F;fd0 &#x2F;mnt&#x2F;floppy 挂载一个软盘 </p><p>mount &#x2F;dev&#x2F;cdrom &#x2F;mnt&#x2F;cdrom 挂载一个cdrom或dvdrom </p><p>mount &#x2F;dev&#x2F;hdc &#x2F;mnt&#x2F;cdrecorder 挂载一个cdrw或dvdrom </p><p>mount &#x2F;dev&#x2F;hdb &#x2F;mnt&#x2F;cdrecorder 挂载一个cdrw或dvdrom </p><p>mount -o loop file.iso &#x2F;mnt&#x2F;cdrom 挂载一个文件或ISO镜像文件 </p><p>mount -t vfat &#x2F;dev&#x2F;hda5 &#x2F;mnt&#x2F;hda5 挂载一个Windows FAT32文件系统 </p><p>mount &#x2F;dev&#x2F;sda1 &#x2F;mnt&#x2F;usbdisk 挂载一个usb 捷盘或闪存设备 </p><p>mount -t smbfs -o username&#x3D;user,password&#x3D;pass &#x2F;&#x2F;WinClient&#x2F;share &#x2F;mnt&#x2F;share 挂载一个windows网络共享 </p><h2 id="磁盘空间"><a href="#磁盘空间" class="headerlink" title="磁盘空间"></a><strong>磁盘空间</strong></h2><p>df -h 显示已经挂载的分区列表 </p><p>ls -lSr |more 以尺寸大小排列文件和目录 </p><p>du -sh dir1 估算目录 ‘dir1’ 已经使用的磁盘空间’ </p><p>du -sk * | sort -rn 以容量大小为依据依次显示文件和目录的大小 </p><p>rpm -q -a –qf ‘%10{SIZE}t%{NAME}n’ | sort -k1,1n 以大小为依据依次显示已安装的rpm包所使用的空间 (fedora, redhat类系统) </p><p>dpkg-query -W -f&#x3D;’${Installed-Size;10}t${Package}n’ | sort -k1,1n 以大小为依据显示已安装的deb包所使用的空间 (ubuntu, debian类系统) </p><h2 id="用户和群组"><a href="#用户和群组" class="headerlink" title="用户和群组"></a><strong>用户和群组</strong></h2><p>groupadd group_name 创建一个新用户组 </p><p>groupdel group_name 删除一个用户组 </p><p>groupmod -n new_group_name old_group_name 重命名一个用户组 </p><p>useradd -c “Name Surname “ -g admin -d &#x2F;home&#x2F;user1 -s &#x2F;bin&#x2F;bash user1 创建一个属于 “admin” 用户组的用户 </p><p>useradd user1 创建一个新用户 </p><p>userdel -r user1 删除一个用户 ( ‘-r’ 排除主目录) </p><p>usermod -c “User FTP” -g system -d &#x2F;ftp&#x2F;user1 -s &#x2F;bin&#x2F;nologin user1 修改用户属性 </p><p>passwd 修改口令 </p><p>passwd user1 修改一个用户的口令 (只允许root执行) </p><p>chage -E 2005-12-31 user1 设置用户口令的失效期限 </p><p>pwck 检查 ‘&#x2F;etc&#x2F;passwd’ 的文件格式和语法修正以及存在的用户 </p><p>grpck 检查 ‘&#x2F;etc&#x2F;passwd’ 的文件格式和语法修正以及存在的群组 </p><p>newgrp group_name 登陆进一个新的群组以改变新创建文件的预设群组 </p><h2 id="文件的权限-使用-“-”-设置权限，使用-“-“-用于取消"><a href="#文件的权限-使用-“-”-设置权限，使用-“-“-用于取消" class="headerlink" title="文件的权限 - 使用 “+” 设置权限，使用 “-“ 用于取消"></a><strong>文件的权限 - 使用 “+” 设置权限，使用 “-“ 用于取消</strong></h2><p>ls -lh 显示权限 </p><p>ls &#x2F;tmp | pr -T5 -W$COLUMNS 将终端划分成5栏显示 </p><p>chmod ugo+rwx directory1 设置目录的所有人(u)、群组(g)以及其他人(o)以读（r ）、写(w)和执行(x)的权限 </p><p>chmod go-rwx directory1 删除群组(g)与其他人(o)对目录的读写执行权限 </p><p>chown user1 file1 改变一个文件的所有人属性 </p><p>chown -R user1 directory1 改变一个目录的所有人属性并同时改变改目录下所有文件的属性 </p><p>chgrp group1 file1 改变文件的群组 </p><p>chown user1:group1 file1 改变一个文件的所有人和群组属性 </p><p>find &#x2F; -perm -u+s 罗列一个系统中所有使用了SUID控制的文件 </p><p>chmod u+s &#x2F;bin&#x2F;file1 设置一个二进制文件的 SUID 位 - 运行该文件的用户也被赋予和所有者同样的权限 </p><p>chmod u-s &#x2F;bin&#x2F;file1 禁用一个二进制文件的 SUID位 </p><p>chmod g+s &#x2F;home&#x2F;public 设置一个目录的SGID 位 - 类似SUID ，不过这是针对目录的 </p><p>chmod g-s &#x2F;home&#x2F;public 禁用一个目录的 SGID 位 </p><p>chmod o+t &#x2F;home&#x2F;public 设置一个文件的 STIKY 位 - 只允许合法所有人删除文件 </p><p>chmod o-t &#x2F;home&#x2F;public 禁用一个目录的 STIKY 位 </p><h2 id="文件的特殊属性-使用-“-”-设置权限，使用-“-“-用于取消"><a href="#文件的特殊属性-使用-“-”-设置权限，使用-“-“-用于取消" class="headerlink" title="文件的特殊属性 - 使用 “+” 设置权限，使用 “-“ 用于取消"></a><strong>文件的特殊属性 - 使用 “+” 设置权限，使用 “-“ 用于取消</strong></h2><p>chattr +a file1 只允许以追加方式读写文件 </p><p>chattr +c file1 允许这个文件能被内核自动压缩&#x2F;解压 </p><p>chattr +d file1 在进行文件系统备份时，dump程序将忽略这个文件 </p><p>chattr +i file1 设置成不可变的文件，不能被删除、修改、重命名或者链接 </p><p>chattr +s file1 允许一个文件被安全地删除 </p><p>chattr +S file1 一旦应用程序对这个文件执行了写操作，使系统立刻把修改的结果写到磁盘 </p><p>chattr +u file1 若文件被删除，系统会允许你在以后恢复这个被删除的文件 </p><p>lsattr 显示特殊的属性 </p><h2 id="打包和压缩文件"><a href="#打包和压缩文件" class="headerlink" title="打包和压缩文件"></a><strong>打包和压缩文件</strong></h2><p>bunzip2 file1.bz2 解压一个叫做 ‘file1.bz2’的文件 </p><p>bzip2 file1 压缩一个叫做 ‘file1’ 的文件 </p><p>gunzip file1.gz 解压一个叫做 ‘file1.gz’的文件 </p><p>gzip file1 压缩一个叫做 ‘file1’的文件 </p><p>gzip -9 file1 最大程度压缩 </p><p>rar a file1.rar test_file 创建一个叫做 ‘file1.rar’ 的包 </p><p>rar a file1.rar file1 file2 dir1 同时压缩 ‘file1’, ‘file2’ 以及目录 ‘dir1’ </p><p>rar x file1.rar 解压rar包 </p><p>unrar x file1.rar 解压rar包 </p><p>tar -cvf archive.tar file1 创建一个非压缩的 tarball </p><p>tar -cvf archive.tar file1 file2 dir1 创建一个包含了 ‘file1’, ‘file2’ 以及 ‘dir1’的档案文件 </p><p>tar -tf archive.tar 显示一个包中的内容 </p><p>tar -xvf archive.tar 释放一个包 </p><p>tar -xvf archive.tar -C &#x2F;tmp 将压缩包释放到 &#x2F;tmp目录下 </p><p>tar -cvfj archive.tar.bz2 dir1 创建一个bzip2格式的压缩包 </p><p>tar -xvfj archive.tar.bz2 解压一个bzip2格式的压缩包 </p><p>tar -cvfz archive.tar.gz dir1 创建一个gzip格式的压缩包 </p><p>tar -xvfz archive.tar.gz 解压一个gzip格式的压缩包 </p><p>zip file1.zip file1 创建一个zip格式的压缩包 </p><p>zip -r file1.zip file1 file2 dir1 将几个文件和目录同时压缩成一个zip格式的压缩包 </p><p>unzip file1.zip 解压一个zip格式压缩包 </p><h2 id="RPM-包-（Fedora-Redhat及类似系统）"><a href="#RPM-包-（Fedora-Redhat及类似系统）" class="headerlink" title="RPM 包 - （Fedora, Redhat及类似系统）"></a><strong>RPM 包 - （Fedora, Redhat及类似系统）</strong></h2><p>rpm -ivh package.rpm 安装一个rpm包 </p><p>rpm -ivh –nodeeps package.rpm 安装一个rpm包而忽略依赖关系警告 </p><p>rpm -U package.rpm 更新一个rpm包但不改变其配置文件 </p><p>rpm -F package.rpm 更新一个确定已经安装的rpm包 </p><p>rpm -e package_name.rpm 删除一个rpm包 </p><p>rpm -qa 显示系统中所有已经安装的rpm包 </p><p>rpm -qa | grep httpd 显示所有名称中包含 “httpd” 字样的rpm包 </p><p>rpm -qi package_name 获取一个已安装包的特殊信息 </p><p>rpm -qg “System Environment&#x2F;Daemons” 显示一个组件的rpm包 </p><p>rpm -ql package_name 显示一个已经安装的rpm包提供的文件列表 </p><p>rpm -qc package_name 显示一个已经安装的rpm包提供的配置文件列表 </p><p>rpm -q package_name –whatrequires 显示与一个rpm包存在依赖关系的列表 </p><p>rpm -q package_name –whatprovides 显示一个rpm包所占的体积 </p><p>rpm -q package_name –scripts 显示在安装&#x2F;删除期间所执行的脚本l </p><p>rpm -q package_name –changelog 显示一个rpm包的修改历史 </p><p>rpm -qf &#x2F;etc&#x2F;httpd&#x2F;conf&#x2F;httpd.conf 确认所给的文件由哪个rpm包所提供 </p><p>rpm -qp package.rpm -l 显示由一个尚未安装的rpm包提供的文件列表 </p><p>rpm –import &#x2F;media&#x2F;cdrom&#x2F;RPM-GPG-KEY 导入公钥数字证书 </p><p>rpm –checksig package.rpm 确认一个rpm包的完整性 </p><p>rpm -qa gpg-pubkey 确认已安装的所有rpm包的完整性 </p><p>rpm -V package_name 检查文件尺寸、 许可、类型、所有者、群组、MD5检查以及最后修改时间 </p><p>rpm -Va 检查系统中所有已安装的rpm包- 小心使用 </p><p>rpm -Vp package.rpm 确认一个rpm包还未安装 </p><p>rpm2cpio package.rpm | cpio –extract –make-directories <em>bin</em> 从一个rpm包运行可执行文件 </p><p>rpm -ivh &#x2F;usr&#x2F;src&#x2F;redhat&#x2F;RPMS&#x2F;<code>arch</code>&#x2F;package.rpm 从一个rpm源码安装一个构建好的包 </p><p>rpmbuild –rebuild package_name.src.rpm 从一个rpm源码构建一个 rpm 包 </p><h2 id="YUM-软件包升级器-（Fedora-RedHat及类似系统）"><a href="#YUM-软件包升级器-（Fedora-RedHat及类似系统）" class="headerlink" title="YUM 软件包升级器 - （Fedora, RedHat及类似系统）"></a><strong>YUM 软件包升级器 - （Fedora, RedHat及类似系统）</strong></h2><p>yum install package_name 下载并安装一个rpm包 </p><p>yum localinstall package_name.rpm 将安装一个rpm包，使用你自己的软件仓库为你解决所有依赖关系 </p><p>yum update package_name.rpm 更新当前系统中所有安装的rpm包 </p><p>yum update package_name 更新一个rpm包 </p><p>yum remove package_name 删除一个rpm包 </p><p>yum list 列出当前系统中安装的所有包 </p><p>yum search package_name 在rpm仓库中搜寻软件包 </p><p>yum clean packages 清理rpm缓存删除下载的包 </p><p>yum clean headers 删除所有头文件 </p><p>yum clean all 删除所有缓存的包和头文件 </p><h2 id="DEB-包-Debian-Ubuntu-以及类似系统"><a href="#DEB-包-Debian-Ubuntu-以及类似系统" class="headerlink" title="DEB 包 (Debian, Ubuntu 以及类似系统)"></a><strong>DEB 包 (Debian, Ubuntu 以及类似系统)</strong></h2><p>dpkg -i package.deb 安装&#x2F;更新一个 deb 包 </p><p>dpkg -r package_name 从系统删除一个 deb 包 </p><p>dpkg -l 显示系统中所有已经安装的 deb 包 </p><p>dpkg -l | grep httpd 显示所有名称中包含 “httpd” 字样的deb包 </p><p>dpkg -s package_name 获得已经安装在系统中一个特殊包的信息 </p><p>dpkg -L package_name 显示系统中已经安装的一个deb包所提供的文件列表 </p><p>dpkg –contents package.deb 显示尚未安装的一个包所提供的文件列表 </p><p>dpkg -S &#x2F;bin&#x2F;ping 确认所给的文件由哪个deb包提供 </p><h2 id="APT-软件工具-Debian-Ubuntu-以及类似系统"><a href="#APT-软件工具-Debian-Ubuntu-以及类似系统" class="headerlink" title="APT 软件工具 (Debian, Ubuntu 以及类似系统)"></a><strong>APT 软件工具 (Debian, Ubuntu 以及类似系统)</strong></h2><p>apt-get install package_name 安装&#x2F;更新一个 deb 包 </p><p>apt-cdrom install package_name 从光盘安装&#x2F;更新一个 deb 包 </p><p>apt-get update 升级列表中的软件包 </p><p>apt-get upgrade 升级所有已安装的软件 </p><p>apt-get remove package_name 从系统删除一个deb包 </p><p>apt-get check 确认依赖的软件仓库正确 </p><p>apt-get clean 从下载的软件包中清理缓存 </p><p>apt-cache search searched-package 返回包含所要搜索字符串的软件包名称 </p><h2 id="查看文件内容"><a href="#查看文件内容" class="headerlink" title="查看文件内容"></a><strong>查看文件内容</strong></h2><p>cat file1 从第一个字节开始正向查看文件的内容 </p><p>tac file1 从最后一行开始反向查看一个文件的内容 </p><p>more file1 查看一个长文件的内容 </p><p>less file1 类似于 ‘more’ 命令，但是它允许在文件中和正向操作一样的反向操作 </p><p>head -2 file1 查看一个文件的前两行 </p><p>tail -2 file1 查看一个文件的最后两行 </p><p>tail -f &#x2F;var&#x2F;log&#x2F;messages 实时查看被添加到一个文件中的内容 </p><h2 id="文本处理"><a href="#文本处理" class="headerlink" title="文本处理"></a><strong>文本处理</strong></h2><p>cat file1 file2 … | command &lt;&gt; file1_in.txt_or_file1_out.txt general syntax for text manipulation using PIPE, STDIN and STDOUT </p><p>cat file1 | command( sed, grep, awk, grep, etc…) &gt; result.txt 合并一个文件的详细说明文本，并将简介写入一个新文件中 </p><p>cat file1 | command( sed, grep, awk, grep, etc…) &gt;&gt; result.txt 合并一个文件的详细说明文本，并将简介写入一个已有的文件中 </p><p>grep Aug &#x2F;var&#x2F;log&#x2F;messages 在文件 ‘&#x2F;var&#x2F;log&#x2F;messages’中查找关键词”Aug” </p><p>grep ^Aug &#x2F;var&#x2F;log&#x2F;messages 在文件 ‘&#x2F;var&#x2F;log&#x2F;messages’中查找以”Aug”开始的词汇 </p><p>grep [0-9] &#x2F;var&#x2F;log&#x2F;messages 选择 ‘&#x2F;var&#x2F;log&#x2F;messages’ 文件中所有包含数字的行 </p><p>grep Aug -R &#x2F;var&#x2F;log&#x2F;* 在目录 ‘&#x2F;var&#x2F;log’ 及随后的目录中搜索字符串”Aug” </p><p>sed ‘s&#x2F;stringa1&#x2F;stringa2&#x2F;g’ example.txt 将example.txt文件中的 “string1” 替换成 “string2” </p><p>sed ‘&#x2F;^$&#x2F;d’ example.txt 从example.txt文件中删除所有空白行 </p><p>sed ‘&#x2F; *#&#x2F;d; &#x2F;^$&#x2F;d’ example.txt 从example.txt文件中删除所有注释和空白行 </p><p>echo ‘esempio’ | tr ‘[:lower:]’ ‘[:upper:]’ 合并上下单元格内容 </p><p>sed -e ‘1d’ result.txt 从文件example.txt 中排除第一行 </p><p>sed -n ‘&#x2F;stringa1&#x2F;p’ 查看只包含词汇 “string1”的行 </p><p>sed -e ‘s&#x2F; *$&#x2F;&#x2F;‘ example.txt 删除每一行最后的空白字符 </p><p>sed -e ‘s&#x2F;stringa1&#x2F;&#x2F;g’ example.txt 从文档中只删除词汇 “string1” 并保留剩余全部 </p><p>sed -n ‘1,5p;5q’ example.txt 查看从第一行到第5行内容 </p><p>sed -n ‘5p;5q’ example.txt 查看第5行 </p><p>sed -e ‘s&#x2F;00*&#x2F;0&#x2F;g’ example.txt 用单个零替换多个零 </p><p>cat -n file1 标示文件的行数 </p><p>cat example.txt | awk ‘NR%2&#x3D;&#x3D;1’ 删除example.txt文件中的所有偶数行 </p><p>echo a b c | awk ‘{print $1}’ 查看一行第一栏 </p><p>echo a b c | awk ‘{print $1,$3}’ 查看一行的第一和第三栏 </p><p>paste file1 file2 合并两个文件或两栏的内容 </p><p>paste -d ‘+’ file1 file2 合并两个文件或两栏的内容，中间用”+”区分 </p><p>sort file1 file2 排序两个文件的内容 </p><p>sort file1 file2 | uniq 取出两个文件的并集(重复的行只保留一份) </p><p>sort file1 file2 | uniq -u 删除交集，留下其他的行 </p><p>sort file1 file2 | uniq -d 取出两个文件的交集(只留下同时存在于两个文件中的文件) </p><p>comm -1 file1 file2 比较两个文件的内容只删除 ‘file1’ 所包含的内容 </p><p>comm -2 file1 file2 比较两个文件的内容只删除 ‘file2’ 所包含的内容 </p><p>comm -3 file1 file2 比较两个文件的内容只删除两个文件共有的部分 </p><h2 id="字符设置和文件格式转换"><a href="#字符设置和文件格式转换" class="headerlink" title="字符设置和文件格式转换"></a><strong>字符设置和文件格式转换</strong></h2><p>dos2unix filedos.txt fileunix.txt 将一个文本文件的格式从MSDOS转换成UNIX </p><p>unix2dos fileunix.txt filedos.txt 将一个文本文件的格式从UNIX转换成MSDOS </p><p>recode ..HTML &lt; page.txt &gt; page.html 将一个文本文件转换成html </p><p>recode -l | more 显示所有允许的转换格式 </p><h2 id="文件系统分析"><a href="#文件系统分析" class="headerlink" title="文件系统分析"></a><strong>文件系统分析</strong></h2><p>badblocks -v &#x2F;dev&#x2F;hda1 检查磁盘hda1上的坏磁块 </p><p>fsck &#x2F;dev&#x2F;hda1 修复&#x2F;检查hda1磁盘上linux文件系统的完整性 </p><p>fsck.ext2 &#x2F;dev&#x2F;hda1 修复&#x2F;检查hda1磁盘上ext2文件系统的完整性 </p><p>e2fsck &#x2F;dev&#x2F;hda1 修复&#x2F;检查hda1磁盘上ext2文件系统的完整性 </p><p>e2fsck -j &#x2F;dev&#x2F;hda1 修复&#x2F;检查hda1磁盘上ext3文件系统的完整性 </p><p>fsck.ext3 &#x2F;dev&#x2F;hda1 修复&#x2F;检查hda1磁盘上ext3文件系统的完整性 </p><p>fsck.vfat &#x2F;dev&#x2F;hda1 修复&#x2F;检查hda1磁盘上fat文件系统的完整性 </p><p>fsck.msdos &#x2F;dev&#x2F;hda1 修复&#x2F;检查hda1磁盘上dos文件系统的完整性 </p><p>dosfsck &#x2F;dev&#x2F;hda1 修复&#x2F;检查hda1磁盘上dos文件系统的完整性 </p><h2 id="初始化一个文件系统"><a href="#初始化一个文件系统" class="headerlink" title="初始化一个文件系统"></a><strong>初始化一个文件系统</strong></h2><p>mkfs &#x2F;dev&#x2F;hda1 在hda1分区创建一个文件系统 </p><p>mke2fs &#x2F;dev&#x2F;hda1 在hda1分区创建一个linux ext2的文件系统 </p><p>mke2fs -j &#x2F;dev&#x2F;hda1 在hda1分区创建一个linux ext3(日志型)的文件系统 </p><p>mkfs -t vfat 32 -F &#x2F;dev&#x2F;hda1 创建一个 FAT32 文件系统 </p><p>fdformat -n &#x2F;dev&#x2F;fd0 格式化一个软盘 </p><p>mkswap &#x2F;dev&#x2F;hda3 创建一个swap文件系统 </p><h2 id="SWAP文件系统"><a href="#SWAP文件系统" class="headerlink" title="SWAP文件系统"></a><strong>SWAP文件系统</strong></h2><p>mkswap &#x2F;dev&#x2F;hda3 创建一个swap文件系统 </p><p>swapon &#x2F;dev&#x2F;hda3 启用一个新的swap文件系统 </p><p>swapon &#x2F;dev&#x2F;hda2 &#x2F;dev&#x2F;hdb3 启用两个swap分区 </p><h2 id="备份"><a href="#备份" class="headerlink" title="备份"></a><strong>备份</strong></h2><p>dump -0aj -f &#x2F;tmp&#x2F;home0.bak &#x2F;home 制作一个 ‘&#x2F;home’ 目录的完整备份 </p><p>dump -1aj -f &#x2F;tmp&#x2F;home0.bak &#x2F;home 制作一个 ‘&#x2F;home’ 目录的交互式备份 </p><p>restore -if &#x2F;tmp&#x2F;home0.bak 还原一个交互式备份 </p><p>rsync -rogpav –delete &#x2F;home &#x2F;tmp 同步两边的目录 </p><p>rsync -rogpav -e ssh –delete &#x2F;home ip_address:&#x2F;tmp 通过SSH通道rsync </p><p>rsync -az -e ssh –delete ip_addr:&#x2F;home&#x2F;public &#x2F;home&#x2F;local 通过ssh和压缩将一个远程目录同步到本地目录 </p><p>rsync -az -e ssh –delete &#x2F;home&#x2F;local ip_addr:&#x2F;home&#x2F;public 通过ssh和压缩将本地目录同步到远程目录 </p><p>dd bs&#x3D;1M if&#x3D;&#x2F;dev&#x2F;hda | gzip | ssh user@ip_addr ‘dd of&#x3D;hda.gz’ 通过ssh在远程主机上执行一次备份本地磁盘的操作 </p><p>dd if&#x3D;&#x2F;dev&#x2F;sda of&#x3D;&#x2F;tmp&#x2F;file1 备份磁盘内容到一个文件 </p><p>tar -Puf backup.tar &#x2F;home&#x2F;user 执行一次对 ‘&#x2F;home&#x2F;user’ 目录的交互式备份操作 </p><p>( cd &#x2F;tmp&#x2F;local&#x2F; &amp;&amp; tar c . ) | ssh -C user@ip_addr ‘cd &#x2F;home&#x2F;share&#x2F; &amp;&amp; tar x -p’ 通过ssh在远程目录中复制一个目录内容 </p><p>( tar c &#x2F;home ) | ssh -C user@ip_addr ‘cd &#x2F;home&#x2F;backup-home &amp;&amp; tar x -p’ 通过ssh在远程目录中复制一个本地目录 </p><p>tar cf - . | (cd &#x2F;tmp&#x2F;backup ; tar xf - ) 本地将一个目录复制到另一个地方，保留原有权限及链接 </p><p>find &#x2F;home&#x2F;user1 -name ‘*.txt’ | xargs cp -av –target-directory&#x3D;&#x2F;home&#x2F;backup&#x2F; –parents 从一个目录查找并复制所有以 ‘.txt’ 结尾的文件到另一个目录 </p><p>find &#x2F;var&#x2F;log -name ‘*.log’ | tar cv –files-from&#x3D;- | bzip2 &gt; log.tar.bz2 查找所有以 ‘.log’ 结尾的文件并做成一个bzip包 </p><p>dd if&#x3D;&#x2F;dev&#x2F;hda of&#x3D;&#x2F;dev&#x2F;fd0 bs&#x3D;512 count&#x3D;1 做一个将 MBR (Master Boot Record)内容复制到软盘的动作 </p><p>dd if&#x3D;&#x2F;dev&#x2F;fd0 of&#x3D;&#x2F;dev&#x2F;hda bs&#x3D;512 count&#x3D;1 从已经保存到软盘的备份中恢复MBR内容 </p><h2 id="光盘"><a href="#光盘" class="headerlink" title="光盘"></a><strong>光盘</strong></h2><p>cdrecord -v gracetime&#x3D;2 dev&#x3D;&#x2F;dev&#x2F;cdrom -eject blank&#x3D;fast -force 清空一个可复写的光盘内容 </p><p>mkisofs &#x2F;dev&#x2F;cdrom &gt; cd.iso 在磁盘上创建一个光盘的iso镜像文件 </p><p>mkisofs &#x2F;dev&#x2F;cdrom | gzip &gt; cd_iso.gz 在磁盘上创建一个压缩了的光盘iso镜像文件 </p><p>mkisofs -J -allow-leading-dots -R -V “Label CD” -iso-level 4 -o .&#x2F;cd.iso data_cd 创建一个目录的iso镜像文件 </p><p>cdrecord -v dev&#x3D;&#x2F;dev&#x2F;cdrom cd.iso 刻录一个ISO镜像文件 </p><p>gzip -dc cd_iso.gz | cdrecord dev&#x3D;&#x2F;dev&#x2F;cdrom - 刻录一个压缩了的ISO镜像文件 </p><p>mount -o loop cd.iso &#x2F;mnt&#x2F;iso 挂载一个ISO镜像文件 </p><p>cd-paranoia -B 从一个CD光盘转录音轨到 wav 文件中 </p><p>cd-paranoia – “-3” 从一个CD光盘转录音轨到 wav 文件中（参数-3） </p><p>cdrecord –scanbus 扫描总线以识别scsi通道 </p><p>dd if&#x3D;&#x2F;dev&#x2F;hdc | md5sum 校验一个设备的md5sum编码，例如一张 CD </p><h2 id="网络-（以太网和WIFI无线）"><a href="#网络-（以太网和WIFI无线）" class="headerlink" title="网络 - （以太网和WIFI无线）"></a><strong>网络 - （以太网和WIFI无线）</strong></h2><p>ifconfig eth0 显示一个以太网卡的配置 </p><p>ifup eth0 启用一个 ‘eth0’ 网络设备 </p><p>ifdown eth0 禁用一个 ‘eth0’ 网络设备 </p><p>ifconfig eth0 192.168.1.1 netmask 255.255.255.0 控制IP地址 </p><p>ifconfig eth0 promisc 设置 ‘eth0’ 成混杂模式以嗅探数据包 (sniffing) </p><p>dhclient eth0 以dhcp模式启用 ‘eth0’ </p>]]></content>
    
    
    <categories>
      
      <category>Linux基础</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Linux</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Linux安装初始化</title>
    <link href="/2022/11/06/Linux%E5%88%9D%E5%A7%8B%E5%8C%96%E6%93%8D%E4%BD%9C/"/>
    <url>/2022/11/06/Linux%E5%88%9D%E5%A7%8B%E5%8C%96%E6%93%8D%E4%BD%9C/</url>
    
    <content type="html"><![CDATA[<h2 id="Linux-各种命名规范"><a href="#Linux-各种命名规范" class="headerlink" title="Linux 各种命名规范"></a>Linux 各种命名规范</h2><p>1、文件名不能包括反斜线字符   “&#x2F;” “NUL(空)”，其它字符均可。<br>2、主机名不支持下划线字符  “_”，可使用字母、数字、横线组合，部分软件对主机名有特殊要求。</p><h2 id="命令帮助"><a href="#命令帮助" class="headerlink" title="命令帮助"></a>命令帮助</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@tencent ~]<span class="hljs-comment"># which  ls </span><br><span class="hljs-built_in">alias</span> <span class="hljs-built_in">ls</span>=<span class="hljs-string">&#x27;ls --color=auto&#x27;</span><br>/usr/bin/ls<br><br>[root@tencent ~]<span class="hljs-comment"># type trap</span><br><span class="hljs-built_in">trap</span> is a shell <span class="hljs-built_in">builtin</span><br>[root@tencent ~]<span class="hljs-comment"># help trap </span><br><br>[root@tencent ~]<span class="hljs-comment"># type vim </span><br>vim is /usr/bin/vim<br>[root@tencent ~]<span class="hljs-comment"># vim --help / -h </span><br>[root@tencent ~]<span class="hljs-comment"># man vim </span><br><br>[root@tencent ~]<span class="hljs-comment"># whatis ls </span><br><span class="hljs-built_in">ls</span> (1)               - list directory contents<br><span class="hljs-built_in">ls</span> (1p)              - list directory contents<br></code></pre></td></tr></table></figure><h2 id="Rocky-Linux-安装后必需所做的初始化操作"><a href="#Rocky-Linux-安装后必需所做的初始化操作" class="headerlink" title="Rocky Linux 安装后必需所做的初始化操作"></a>Rocky Linux 安装后必需所做的初始化操作</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#关闭SELinux </span><br>sed -i <span class="hljs-string">&#x27;/^SELINUX=/c SELINUX=disabled&#x27;</span> /etc/selinux/config<br><br><span class="hljs-comment">#关闭防火墙</span><br>systemctl <span class="hljs-built_in">disable</span> --now firewalld <br><br><span class="hljs-comment">#支持光盘,/misc/cd对应就是光盘内容</span><br>yum -y install autofs<br>systemctl <span class="hljs-built_in">enable</span> --now autofs<br><br><span class="hljs-comment">#配置yum 仓库</span><br><span class="hljs-comment">#系统源（改为阿里源并备份）</span><br>sed -e <span class="hljs-string">&#x27;s|^mirrorlist=|#mirrorlist=|g&#x27;</span> \<br>    -e <span class="hljs-string">&#x27;s|^#baseurl=http://dl.rockylinux.org/$contentdir|baseurl=https://mirrors.aliyun.com/rockylinux|g&#x27;</span> \<br>    -i.bak \<br>    /etc/yum.repos.d/Rocky*.repo<br>yum makecache<br>yum list<br><br><span class="hljs-comment">#EPEL源(Rocky8/CentOS8)</span><br>yum install -y https://mirrors.aliyun.com/epel/epel-release-latest-8.noarch.rpm<br>sed -i <span class="hljs-string">&#x27;s|^#baseurl=https://download.example/pub|baseurl=https://mirrors.aliyun.com|&#x27;</span> /etc/yum.repos.d/epel*<br>sed -i <span class="hljs-string">&#x27;s|^metalink|#metalink|&#x27;</span> /etc/yum.repos.d/epel*<br><br><span class="hljs-comment">#修改网卡名称</span><br>[root@rocky8 ~]<span class="hljs-comment">#sed -ri &#x27;/GRUB_CMDLINE_LINUX=/s#(.*)&quot;$#\1 net.ifnames=0&quot;#&#x27; /etc/default/grub</span><br>[root@rocky8 ~]<span class="hljs-comment">#grub2-mkconfig -o /boot/grub2/grub.cfg </span><br>[root@rocky8 ~]<span class="hljs-comment">#reboot</span><br><span class="hljs-comment">#配置网卡地址：</span><br>[root@rocky ~]<span class="hljs-comment"># mv   /etc/sysconfig/network-scripts/ifcfg-xxxxx  ifcfg-xxxxx.bak</span><br>[root@rocky ~]<span class="hljs-comment"># vim   /etc/sysconfig/network-scripts/ifcfg-eth0</span><br>DEVICE=eth0<br>NAME=eth0<br>BOOTPROTO=static<br>IPADDR=10.0.0.129<br>PERFIX=24<br>GATEWAY=10.0.0.2<br>DNS1=223.5.5.5<br>DNS2=180.76.76.76<br>[root@rocky ~]<span class="hljs-comment"># nmcli connection reload </span><br>[root@rocky ~]<span class="hljs-comment"># nmcli connection up eth0</span><br><br><span class="hljs-comment">#最小化安装系统后，建议安装常用软件</span><br>yum -y install autofs  vim vim-enhanced tcpdump autofs chrony lrzsz tree telnet ftp lftp  bash-completion net-tools postfix wget bzip2 zip unzip xz lsof mlocate man-pages rsync gcc  autoconf gcc-c++  iotop nfs-utils openssl-devel pcre-devel systemd-devel tmux dos2unix redhat-lsb-core<br><br></code></pre></td></tr></table></figure><h2 id="Ubuntu开启root远程登录功能"><a href="#Ubuntu开启root远程登录功能" class="headerlink" title="Ubuntu开启root远程登录功能"></a>Ubuntu开启root远程登录功能</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">sudo -i<br>passwd root<br>sed -i <span class="hljs-string">&#x27;/PermitRootLogin/c PermitRootLogin yes&#x27;</span> /etc/ssh/sshd_config<br>systemctl restart sshd<br></code></pre></td></tr></table></figure><h2 id="网络检查命令"><a href="#网络检查命令" class="headerlink" title="网络检查命令"></a>网络检查命令</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">监听端口：ss   -ntlp<br>监听端口：losf -i  :port<br>IP地址：ip  a <br>网关：  route  -n <br>DNS：  <span class="hljs-built_in">cat</span>  /etc/resolv.conf<br></code></pre></td></tr></table></figure><h2 id="CentOS6设置主机名"><a href="#CentOS6设置主机名" class="headerlink" title="CentOS6设置主机名"></a>CentOS6设置主机名</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@x-z ~]<span class="hljs-comment"># vim /etc/sysconfig/network</span><br>[root@x-z ~]<span class="hljs-comment"># hostname x-z.top</span><br></code></pre></td></tr></table></figure><h2 id="CentOS7设置主机名"><a href="#CentOS7设置主机名" class="headerlink" title="CentOS7设置主机名"></a>CentOS7设置主机名</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@x-z ~]<span class="hljs-comment"># hostnamectl set-hostname x-z.top</span><br></code></pre></td></tr></table></figure><h4 id=""><a href="#" class="headerlink" title=""></a></h4>]]></content>
    
    
    <categories>
      
      <category>Linux基础</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Linux</tag>
      
      <tag>MariaDB</tag>
      
      <tag>init</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Linux常用命令</title>
    <link href="/2022/11/06/Linux%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/"/>
    <url>/2022/11/06/Linux%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/</url>
    
    <content type="html"><![CDATA[<p>在开发中常用的一些命令。</p><p>1）目录切换</p><p>2）对目录（文件夹）的操作</p><p>3）对文件的操作</p><p>4）文件的压缩、解压</p><p>5）软件的安装</p><p>6）权限的操作</p><p>7）防火墙端口的开启</p><p>8）一些其他的命令</p><p>执行以下命令时需要注意自己对应系统的版本，不同的版本会稍有差别。</p><h2 id="1、目录切换"><a href="#1、目录切换" class="headerlink" title="1、目录切换"></a><strong>1、目录切换</strong></h2><p>cd &#x2F; 切换到根目录</p><p>cd ~ 切换到用户跟目录</p><p>cd ..&#x2F;    切换到上一级目录</p><p>cd - 切换到上次访问目录</p><p>cd etc   切换到当前目录下的etc目录</p><h2 id="2、目录的操作命令（增删改查）"><a href="#2、目录的操作命令（增删改查）" class="headerlink" title="2、目录的操作命令（增删改查）"></a><strong>2、目录的操作命令（增删改查）</strong></h2><h4 id="（1）新增目录"><a href="#（1）新增目录" class="headerlink" title="（1）新增目录"></a><strong>（1）新增目录</strong></h4><p>​    mkdir xxx (xxx为自己为目录取的名字)</p><p>​       mkdir  -p   xxx 递归创建</p><h4 id="（2）查看目录"><a href="#（2）查看目录" class="headerlink" title="（2）查看目录"></a><strong>（2）查看目录</strong></h4><p>​    ls[-a|-l]</p><p>​    ls -a 查看当前目录下的所有目录，以及隐藏目录</p><p>​    ls -l 查看当前目录下的所有目录的详细信息    缩写成ll</p><h4 id="（3）搜索目录"><a href="#（3）搜索目录" class="headerlink" title="（3）搜索目录"></a><strong>（3）搜索目录</strong></h4><p>​     find &#x2F;root -name <em>test</em></p><h4 id="（4）修改目录"><a href="#（4）修改目录" class="headerlink" title="（4）修改目录"></a><strong>（4）修改目录</strong></h4><p>​     mv xxx aaa  (xxx 旧目录名，aaa新目录名) mv同样可以修改文件及压缩包的名字</p><h4 id="（5）移动目录"><a href="#（5）移动目录" class="headerlink" title="（5）移动目录"></a><strong>（5）移动目录</strong></h4><p>​     mv yyy &#x2F;root (yyy需要修改目录。&#x2F;root 剪切到的位置)</p><h4 id="（6）复制目录及文件"><a href="#（6）复制目录及文件" class="headerlink" title="（6）复制目录及文件"></a><strong>（6）复制目录及文件</strong></h4><p>​     cp -r aaa &#x2F;  (将aaa目录复制到根目录下)</p><p>  cp tt.zip &#x2F;  (将tt.zip复制到根目录下)</p><h4 id="（7）删除目录"><a href="#（7）删除目录" class="headerlink" title="（7）删除目录"></a><strong>（7）删除目录</strong></h4><p>​    rm删除文件</p><p>​    rm -r   删除目录</p><p>​     <strong>rm-rf   强制删除目录 （就可以用本句去删除任何东西，常用这句就行了）</strong></p><h2 id="3、文件的操作命令"><a href="#3、文件的操作命令" class="headerlink" title="3、文件的操作命令"></a><strong>3、文件的操作命令</strong></h2><h4 id="（1）新建文件"><a href="#（1）新建文件" class="headerlink" title="（1）新建文件"></a><strong>（1）新建文件</strong></h4><p>​     touch test.txt (Linux 下是可以不加文件的后缀名的，加上文件名是为了开发者分辨文件)</p><h4 id="（2）查看文件"><a href="#（2）查看文件" class="headerlink" title="（2）查看文件"></a><strong>（2）查看文件</strong></h4><p>​     cat&#x2F;more&#x2F;less&#x2F;tail</p><p>​     cat  使用cat可以比较方便的查看较小的文件。用cat查看文件直接显示的文件的最后一屏</p><p>​     more  使用more查看文件，回车翻一行，空格翻一页，Q结束查看，只能往下查看</p><p>​     less 使用less可以用more的方式查看，但是可以使用pg up ,pg down 向上向下翻</p><p>​     tail  使用tail查看文件的后几行</p><p>​       tail -10 xxx.txt 查看文件的后10行</p><p>​       tail -f xxx.txt 动态监控文件 crtl+ c 退出</p><h4 id="（3）修改文件"><a href="#（3）修改文件" class="headerlink" title="（3）修改文件"></a><strong>（3）修改文件</strong></h4><p>​     vim       按 i  a  o （I  A  O）进入编辑模式</p><p>​     vim文件名–&gt;进入文件–&gt;命令模式–&gt;按i进入编辑模式–&gt;编辑文件–&gt;按Esc进入底行模式–&gt;输入:–&gt;</p><p>​     输入命令 wq（保存并退出） 输入q! (不保存，强制退出)</p><h4 id="（4）删除文件"><a href="#（4）删除文件" class="headerlink" title="（4）删除文件"></a><strong>（4）删除文件</strong></h4><p>​     rm -rf   xxx.txt</p><h2 id="4、压缩文件的操作命令"><a href="#4、压缩文件的操作命令" class="headerlink" title="4、压缩文件的操作命令"></a><strong>4、压缩文件的操作命令</strong></h2><h4 id="（1）压缩"><a href="#（1）压缩" class="headerlink" title="（1）压缩"></a><strong>（1）压缩</strong></h4><p>​     tar -zcvf 打包后的名称 打包前的名称</p><p>​     tar -zcvf xxx.tar.gz .&#x2F;*    (.&#x2F;*表示当前目录下的所有文件)</p><h4 id="（2）解压"><a href="#（2）解压" class="headerlink" title="（2）解压"></a><strong>（2）解压</strong></h4><p>​     tar-xvf 包名    解压到当前的目录</p><p>​     tar-xvf 包名 -C 目标目录  解压到指定的目标目录</p><h2 id="5、安装软件"><a href="#5、安装软件" class="headerlink" title="5、安装软件"></a><strong>5、安装软件</strong></h2><h4 id="（1）yam"><a href="#（1）yam" class="headerlink" title="（1）yam"></a><strong>（1）yam</strong></h4><p><strong>1）安装Linux的源包软件</strong></p><p>yum install packagexx</p><p><strong>2）查看所有安装的软件</strong></p><p>yum list</p><p><strong>3）卸载软件</strong></p><p>yum remove xx(xx为查询看到的结果)</p><h4 id="（2）rpm"><a href="#（2）rpm" class="headerlink" title="（2）rpm"></a><strong>（2）rpm</strong></h4><p><strong>1）安装</strong></p><p>rpm -ivh package</p><p><strong>2） 查询</strong></p><p>rpm -qa | grep str(str为需要查询的字符串)</p><p><strong>3） 卸载</strong></p><p>rpm -e –nodeps xxx（xxx为上面查询到的结果）</p><p>ps：一般也卸载了之后也需要删除相应的文件夹（目录）</p><p>find &#x2F; -name str查看残留的文件夹</p><h2 id="6、其他常用命令"><a href="#6、其他常用命令" class="headerlink" title="6、其他常用命令"></a><strong>6、其他常用命令</strong></h2><h4 id="（1）显示当前目录的路径"><a href="#（1）显示当前目录的路径" class="headerlink" title="（1）显示当前目录的路径"></a><strong>（1）显示当前目录的路径</strong></h4><p>​     pwd</p><h4 id="（2）搜索命令"><a href="#（2）搜索命令" class="headerlink" title="（2）搜索命令"></a><strong>（2）搜索命令</strong></h4><p>​     grep xx  要搜索的字符串，要搜索的文件</p><p>​     grep xx test.txt    在test.txt中搜索xx字符串</p><h4 id="（3）管道命令"><a href="#（3）管道命令" class="headerlink" title="（3）管道命令"></a><strong>（3）管道命令</strong></h4><p>​     |</p><p>​     将上次一的命令作为下一次的输入</p><h4 id="（4）查看进程"><a href="#（4）查看进程" class="headerlink" title="（4）查看进程"></a><strong>（4）查看进程</strong></h4><p>​     ps- ef</p><p>​     与管道结合</p><p>​     ps-ef | grep mysql  从所有进程中搜索包含mysql的内容</p><h4 id="（5）杀死进程"><a href="#（5）杀死进程" class="headerlink" title="（5）杀死进程"></a><strong>（5）杀死进程</strong></h4><p>​     kill -9 pid       （pid为进程ID）</p><h4 id="（6）网络配置"><a href="#（6）网络配置" class="headerlink" title="（6）网络配置"></a><strong>（6）网络配置</strong></h4><p>​     1）查看ip地址</p><p>​     ifconfig</p><p>​     2）查看端口状态</p><p>​     netstat -a</p><p>​      3）查询端口占用情况</p><p>​     netstat -tulpn</p><h2 id="7、Linux-的权限命令"><a href="#7、Linux-的权限命令" class="headerlink" title="7、Linux 的权限命令"></a><strong>7、Linux 的权限命令</strong></h2><p>​    -rwxrwxr–</p><p>​    一共10个位</p><p>​    第一个类型</p><p>​    第一个3位 属主权限</p><p>​    第二个3位 属组权限</p><p>​    第三个3位 其他权限用户</p><p>​    r 读取权</p><p>​    w写入权</p><p>​    x 执行权</p><h4 id="（1）修改权限"><a href="#（1）修改权限" class="headerlink" title="（1）修改权限"></a><strong>（1）修改权限</strong></h4><p>​    chmod u&#x3D;rwx,g&#x3D;rw,o&#x3D;r sudo.conf   (sudo.conf为文件名)</p><p>u主权限</p><p>g 组权限</p><p>o其他权限</p><h4 id="（2）修改所属主，组"><a href="#（2）修改所属主，组" class="headerlink" title="（2）修改所属主，组"></a><strong>（2）修改所属主，组</strong></h4><p>​    chown -R mysql mysql&#x2F; 将mysql文件下的所有文件及文件夹的所属主修改为mysql</p><p>​    chgrp -R mysql mysql&#x2F; 将mysql文件下的所有文件及文件夹的所属组修改为mysql</p><h2 id="8、系统信息、用户"><a href="#8、系统信息、用户" class="headerlink" title="8、系统信息、用户"></a><strong>8、系统信息、用户</strong></h2><h4 id="（1）查看系统版本"><a href="#（1）查看系统版本" class="headerlink" title="（1）查看系统版本"></a><strong>（1）查看系统版本</strong></h4><p>​     cat &#x2F;proc&#x2F;version    cat &#x2F;etc&#x2F;os-release</p><p>[root@x-z ~]# cat &#x2F;etc&#x2F;os-release </p><p>NAME&#x3D;”CentOS Stream”</p><p>VERSION&#x3D;”8”</p><p>ID&#x3D;”centos”</p><p>ID_LIKE&#x3D;”rhel fedora”</p><p>VERSION_ID&#x3D;”8”</p><p>PLATFORM_ID&#x3D;”platform:el8”</p><p>PRETTY_NAME&#x3D;”CentOS Stream 8”</p><p>ANSI_COLOR&#x3D;”0;31”</p><p>CPE_NAME&#x3D;”cpe:&#x2F;o:centos:centos:8”</p><p>HOME_URL&#x3D;”<a href="https://centos.org/">https://centos.org/</a>“</p><p>BUG_REPORT_URL&#x3D;”<a href="https://bugzilla.redhat.com/">https://bugzilla.redhat.com/</a>“</p><p>REDHAT_SUPPORT_PRODUCT&#x3D;”Red Hat Enterprise Linux 8”</p><p>REDHAT_SUPPORT_PRODUCT_VERSION&#x3D;”CentOS Stream”</p><h4 id="（2）查看开机自动启动的服务使用chkconfig命令"><a href="#（2）查看开机自动启动的服务使用chkconfig命令" class="headerlink" title="（2）查看开机自动启动的服务使用chkconfig命令"></a><strong>（2）查看开机自动启动的服务使用chkconfig命令</strong></h4><p>​     chkconfig –list</p><h4 id="（3）修改密码"><a href="#（3）修改密码" class="headerlink" title="（3）修改密码"></a><strong>（3）修改密码</strong></h4><p>​     passwd</p><h2 id="9、配置防火墙"><a href="#9、配置防火墙" class="headerlink" title="9、配置防火墙"></a><strong>9、配置防火墙</strong></h2><h4 id="（1）安装防火墙"><a href="#（1）安装防火墙" class="headerlink" title="（1）安装防火墙"></a><strong>（1）安装防火墙</strong></h4><p>​     yum install firewalld</p><h4 id="（2）启动防火墙"><a href="#（2）启动防火墙" class="headerlink" title="（2）启动防火墙"></a><strong>（2）启动防火墙</strong></h4><p>​    systemctl start firewalld</p><h4 id="（3）开机自启动"><a href="#（3）开机自启动" class="headerlink" title="（3）开机自启动"></a><strong>（3）开机自启动</strong></h4><p>​    systemctl enable firewalld</p><h4 id="（4）关闭防火墙"><a href="#（4）关闭防火墙" class="headerlink" title="（4）关闭防火墙"></a><strong>（4）关闭防火墙</strong></h4><p>​    systemctl stop firewalld</p><h4 id="（5）关闭开机自启动"><a href="#（5）关闭开机自启动" class="headerlink" title="（5）关闭开机自启动"></a><strong>（5）关闭开机自启动</strong></h4><p>​    systemctl disable firewalld</p><h4 id="（6）查看防火墙运行状态"><a href="#（6）查看防火墙运行状态" class="headerlink" title="（6）查看防火墙运行状态"></a><strong>（6）查看防火墙运行状态</strong></h4><p>​    firewall-cmd –state  或者 systemctl status firewalld.service</p><h4 id="（7）重启防火墙"><a href="#（7）重启防火墙" class="headerlink" title="（7）重启防火墙"></a><strong>（7）重启防火墙</strong></h4><p>​    firewall-cmd –reload 或者systemctl [start|stop|restart] firewalld.service </p><h4 id="（8）查看帮助"><a href="#（8）查看帮助" class="headerlink" title="（8）查看帮助"></a><strong>（8）查看帮助</strong></h4><p>​    firewall-cmd –help</p><h2 id="10、配置防火墙端口"><a href="#10、配置防火墙端口" class="headerlink" title="10、配置防火墙端口"></a><strong>10、配置防火墙端口</strong></h2><h4 id="（1）开放端口"><a href="#（1）开放端口" class="headerlink" title="（1）开放端口"></a><strong>（1）开放端口</strong></h4><p>​    firewall-cmd –permanent –zone&#x3D;public –add-port&#x3D;8080&#x2F;tcp</p><p>​    –permanent永久开放8080端口</p><h4 id="（2）关闭端口（执行成功）"><a href="#（2）关闭端口（执行成功）" class="headerlink" title="（2）关闭端口（执行成功）"></a><strong>（2）关闭端口（执行成功）</strong></h4><p>​    firewall-cmd –zone&#x3D;public –remove-port&#x3D;8080&#x2F;tcp</p><h4 id="（3）查询端口是否开放"><a href="#（3）查询端口是否开放" class="headerlink" title="（3）查询端口是否开放"></a><strong>（3）查询端口是否开放</strong></h4><p>​    firewall-cmd –query-port&#x3D;8080&#x2F;tcp</p><h4 id="（4）查询所有用户开放的端口"><a href="#（4）查询所有用户开放的端口" class="headerlink" title="（4）查询所有用户开放的端口"></a><strong>（4）查询所有用户开放的端口</strong></h4><p>firewall-cmd –list-ports</p><p><strong>–zone #作用域</strong></p><p><strong>–add-port&#x3D;80&#x2F;tcp  #添加端口，格式为：端口&#x2F;通讯协议</strong></p><p><strong>–permanent  #永久生效，没有此参数重启后失效</strong></p><p>每次关闭开启就需要reload</p><p>firewall-cmd –reload</p>]]></content>
    
    
    <categories>
      
      <category>Linux基础</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Linux</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Typora图床配置</title>
    <link href="/2022/08/12/Typora%E5%9B%BE%E5%BA%8A%E9%85%8D%E7%BD%AE/"/>
    <url>/2022/08/12/Typora%E5%9B%BE%E5%BA%8A%E9%85%8D%E7%BD%AE/</url>
    
    <content type="html"><![CDATA[<h3 id="阿里云css图床："><a href="#阿里云css图床：" class="headerlink" title="阿里云css图床："></a>阿里云css图床：</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs javascript">&#123;<br>  <span class="hljs-string">&quot;picBed&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;uploader&quot;</span>: <span class="hljs-string">&quot;aliyun&quot;</span>,<br>    <span class="hljs-string">&quot;aliyun&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;accessKeyId&quot;</span>: <span class="hljs-string">&quot; &quot;</span>, <span class="hljs-comment">//key </span><br>      <span class="hljs-string">&quot;accessKeySecret&quot;</span>: <span class="hljs-string">&quot; &quot;</span>, <span class="hljs-comment">//key</span><br>      <span class="hljs-string">&quot;bucket&quot;</span>: <span class="hljs-string">&quot; &quot;</span>, <span class="hljs-comment">//存储空间名</span><br>      <span class="hljs-string">&quot;area&quot;</span>: <span class="hljs-string">&quot; &quot;</span>, <span class="hljs-comment">//存储区域代号</span><br>      <span class="hljs-string">&quot;path&quot;</span>: <span class="hljs-string">&quot;img/&quot;</span>, <span class="hljs-comment">//自定义存储路径</span><br>      <span class="hljs-string">&quot;customUrl&quot;</span>: <span class="hljs-string">&quot; &quot;</span>, <span class="hljs-comment">//自定义域名，注意要加 http://或者 https://</span><br>      <span class="hljs-string">&quot;options&quot;</span>: <span class="hljs-string">&quot;&quot;</span> <span class="hljs-comment">//针对图片的一些后缀处理参数 PicGo 2.2.0+ PicGo-Core 1.4.0+</span><br>    &#125;<br>  &#125;,<br>  <span class="hljs-string">&quot;picgoPlugins&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;picgo-plugin-github-plus&quot;</span>: <span class="hljs-literal">true</span><br>  &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h3 id="gitee图床："><a href="#gitee图床：" class="headerlink" title="gitee图床："></a>gitee图床：</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs javascript">&#123;<br>  <span class="hljs-string">&quot;picBed&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;current&quot;</span>: <span class="hljs-string">&quot;gitee&quot;</span>,<br>    <span class="hljs-string">&quot;gitee&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;repo&quot;</span>: <span class="hljs-string">&quot; &quot;</span>, <span class="hljs-comment">//仓库名</span><br>      <span class="hljs-string">&quot;branch&quot;</span>: <span class="hljs-string">&quot;master&quot;</span>, <span class="hljs-comment">//分支</span><br>      <span class="hljs-string">&quot;token&quot;</span>: <span class="hljs-string">&quot; &quot;</span>,  <span class="hljs-comment">//token密钥</span><br>      <span class="hljs-string">&quot;path&quot;</span>: <span class="hljs-string">&quot;img&quot;</span>,<br>      <span class="hljs-string">&quot;customPath&quot;</span>: <span class="hljs-string">&quot;yearMonth&quot;</span>,<br>      <span class="hljs-string">&quot;customUrl&quot;</span>: <span class="hljs-string">&quot; &quot;</span>  <span class="hljs-comment">//自定义域名</span><br>    &#125;<br>  &#125;,<br>  <span class="hljs-string">&quot;picgoPlugins&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;picgo-plugin-gitee-uploader&quot;</span>: <span class="hljs-literal">true</span>,<br>    <span class="hljs-string">&quot;picgo-plugin-github-plus&quot;</span>: <span class="hljs-literal">true</span>,<br>    <span class="hljs-string">&quot;picgo-plugin-super-prefix&quot;</span>: <span class="hljs-literal">true</span><br>  &#125;,<br>  <span class="hljs-string">&quot;picgo-plugin-gitee-uploader&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;lastSync&quot;</span>: <span class="hljs-string">&quot;2022-11-05 08:28:07&quot;</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>MarkDown</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Typora</tag>
      
      <tag>MarkDown</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>华为数通命令清单</title>
    <link href="/2022/06/12/%E5%8D%8E%E4%B8%BA%E6%95%B0%E9%80%9A%E5%91%BD%E4%BB%A4%E6%B8%85%E5%8D%95/"/>
    <url>/2022/06/12/%E5%8D%8E%E4%B8%BA%E6%95%B0%E9%80%9A%E5%91%BD%E4%BB%A4%E6%B8%85%E5%8D%95/</url>
    
    <content type="html"><![CDATA[<h2 id="华为命令符"><a href="#华为命令符" class="headerlink" title="华为命令符"></a>华为命令符</h2><p>从用户视图切换到系统视图 <strong>system–view</strong></p><p>从系统视图切换到用户视图 <strong>quit</strong></p><p>连入接口命令 <strong>interface</strong></p><ul><li>IP地址、子网掩码配置命令 <strong>ip address</strong></li><li>接口IP信息查看命令 <strong>display ip interface brief</strong></li><li>IPv4路由表信息查询命令 <strong>display ip routing–table</strong></li><li>配置完成退回视图界面命令 <strong>return</strong></li></ul><p>命令自动补全快捷键【Tab】</p><p>快捷键查看命令 <strong>display hotkey</strong></p><p>路由名称修改命令 <strong>sysname</strong></p><p>设置路由器时钟命令 <strong>clock datetime</strong></p><p>设置路由器时区命令 <strong>clock timezone(时区）{add|minus}（偏移时间）[正向偏移add ；负向偏</strong><br><strong>移minus]</strong></p><p>登录标题修改命令 <strong>header login</strong></p><ul><li>​                 header login information “ ”</li></ul><p>登录成功后标题设置命令 <strong>header shell</strong></p><ul><li>​                 header shell information “ ”</li></ul><p>路由信息查看命令 <strong>display version</strong></p><p>路由当前配置查看命令 <strong>display current–configuration</strong></p><p>接口状态查询命令 <strong>display interface</strong></p><ul><li>​                 gigabitethernet0&#x2F;0&#x2F;0</li></ul><p>设备当前配置情况查看命令：<strong>display current-configuration</strong></p><h2 id="光标操作"><a href="#光标操作" class="headerlink" title="光标操作"></a>光标操作</h2><ul><li>退格键<strong>BackSpace</strong>删除光标位置的前一个字符，光标左移；若已经到达命令起始位置，则停止</li><li>左光标键或**&lt;Ctrl+B&gt;**光标向左移动一个字符位置；若已经到达命令起始位置，则停止 。</li><li>右光标键或**&lt;Ctrl+F&gt;**光标向右移动一个字符位置；若已经到达命令起始位置，则停止。</li><li>删除键<strong>Delete</strong>删除光标所在位置的一个字符,光标位置保持不动，光标后方字符向左移动一个字符位置；若已经到达命令尾部，则停止</li><li>上光标键<strong>【Ctrl+P】</strong>显示上一条历史命令。如果需显示更早的历史命令，可以重复使用该功能键。</li><li>下光标键<strong>【Ctrl+N】</strong>显示下一条历史命令，课重复使用该功能键</li></ul><h2 id="快捷键"><a href="#快捷键" class="headerlink" title="快捷键"></a>快捷键</h2><ul><li><p>Ctrl+A 将光标移动到当前行的开始</p></li><li><p>Ctrl+E 将光标移动到当前行的末尾</p></li><li><p>Ctrl+N 将光标向下移动一行</p></li><li><p>Ctrl+P 将光标向上移动一行</p></li><li><p>Ctrl+C 停止当前正在执行的功能</p></li><li><p>Ctrl+ F 返回到用户视图，相当于return命令</p></li><li><p>{Tab}键 部分帮助的功能，输入不完整的关键字后按下Tａｂ键，系统自动补全关键字</p></li></ul><p>设备当前支持用户界面信息查看命令： <strong>display user-interface</strong></p><p>用户界面切换命令：<strong>user-interface</strong>(用户界面相对编号)（用户界面可选参数）</p><p>在对应的用户视图下对用户权限配置命令: <strong>user privilege level</strong> (用户级别)</p><p>配置用户界面验证方式的命令：<strong>authentication-mode{aaa|none|password}</strong></p><h2 id="配置VTY为aaa验证方式的用户名和密码"><a href="#配置VTY为aaa验证方式的用户名和密码" class="headerlink" title="配置VTY为aaa验证方式的用户名和密码"></a>配置VTY为aaa验证方式的用户名和密码</h2><ul><li>命令：<strong>aaa</strong></li><li>命令：<strong>local-user (用户名) password cipher (密码)</strong></li><li>命令：<strong>local-user (用户名) service-type telnet(代指接入类型)</strong></li></ul><p>配置用户权限命令：</p><ul><li><strong>local-user (用户名) password cipher (密码) privilege level(权限) ；</strong></li><li><strong>local-user(用户名) privilege level(权限)</strong></li></ul><p>配置Console用户界面为Password验证命令：</p><ul><li><strong>set authentication password cipher (密码)</strong></li></ul><p>Console用户配置信息查看命令：<strong>display current-configuration</strong></p><p>手动保存当前配置命令：<strong>save【configuration-file】</strong>参数configuration-file为指定的配置文件名，格式必须是”*.cfg”或”*.zip”周期性自动保存的设置</p><h2 id="用户视图命令："><a href="#用户视图命令：" class="headerlink" title="用户视图命令："></a>用户视图命令：</h2><p>开启周期性自动保存命令：<strong>autosave interval on</strong></p><p>设置自动保存周期命令：<strong>autosave interval time</strong> 参数time为指定周期的时间周期（参数：time取值应大于10 min）</p><p>开启定时自动保存命令:<strong>autosave time on</strong></p><p>设置定时保存命令:<strong>autosave time time-value</strong> 参数time-value为自动保存的时间点</p><p>下次启动的配置文件夹设置命令:<strong>startup saved-configuration</strong> configuration-file 参数configuration-file为指定配置文件</p><p>当前配置与下次启动配置文件差异查看命令：<strong>compare configuration</strong></p><p>查看当前文件下命令：<strong>dir[&#x2F;all][ filename|directory]</strong> all表示查看当前命令下的文件和目录，参数filename表示待查看文件的名称；</p><p>directory表示待查看目录的路径</p><p>所在目录查询命令：<strong>pwd</strong></p><p>新建目录的命令：**mkdir  **directory 参数directory表示需要创建的目录(创建文件夹)</p><p>复制并重命名文件：<strong>copy source-fliename destinction-filename</strong> 参数source-fliename表示被复制文件的路径及源文件名：</p><p>destinction-filename表示目标文件的路径及其目标文件名。</p><p>修改当前工作路径命令：<strong>cd directory</strong></p><p>删除文件命令：**delete 【&#x2F;unreserved】[&#x2F;force]**filename</p><ul><li>&#x2F;unerserved表示彻底删除指定文件，删除的文件将不可恢复</li><li>&#x2F;force 表示无需确认直接删除文件</li><li>参数filename表示删除的文件名</li></ul><p>注解：如果不适用&#x2F;unreserved,则delete命令删除的文件将被保存到回收站中。</p><p>恢复回收站中的文件命令：<strong>undelete</strong></p><p>彻底删除回收站中的所有文件命令：<strong>reset recycle-bin</strong></p><p>TFTP文件传输命令：<strong>tftp</strong>   tftp-server{get|put}source-filename[destination-filename]</p><p>参数 tftp-server表示TFTP服务器的IP地址；get表示从TFTP服务器下载文件到TFTP客户端；Put表示TFTP客户端上传文件到TFTP服务器。source-filename表示源文件名；destination-filename表示目标文件名。</p><h2 id="TELNET"><a href="#TELNET" class="headerlink" title="TELNET"></a>TELNET</h2><p>配置Telnet的验证方式为密码验证方式： <strong>authentication-mode password</strong></p><p>ste authentication password cipher (密码)</p><p>远程登录设备命令：<strong>Telnet</strong> ip-address 参数ip-address为登录设备IP地址</p><h2 id="FTP"><a href="#FTP" class="headerlink" title="FTP"></a>FTP</h2><p>建立FTP连接命令：<strong>ftp</strong>host-ip 【port-nuber】 参数host-ip表示FTP服务器的IP地址；port-number表示FTP服务器的端口号。</p><p>从FTP服务器下载文件到FTP客户端命令：<strong>get source-filename</strong>【destination-filename】</p><p>从FTP客户端上传文件到FTP服务器命令：<strong>put source-filename</strong>【destination-filename】</p><p>查看FTP服务器文件夹状态查询命令：<strong>ls</strong></p><p>查看设备当前设置的下次启动时所用的启动文件情况命令：<strong>display startup</strong></p><p>设置下次启动使用的系统软件文件的命令：<strong>startup system-software</strong> system-file 参数system-file表示指定的系统软件文件名</p><p>Telnet登录方式：<strong>tnlnet ip-address</strong> 参数ip-address表示ip地址</p><p>查看已经登录信息命令：<strong>display users</strong></p><h2 id="SSH"><a href="#SSH" class="headerlink" title="SSH"></a>SSH</h2><p>生成本地RSA主机秘钥命令：<strong>rsa local-key-pair create</strong></p><p>新建SSH用户命令：<strong>ssh user (用户名) authentication-type password（代指类型）</strong></p><p>在ssh服务端查看ssh用户配置命令：<strong>display ssh user-information</strong> (用户名)</p><p>开启ssh服务命令：<strong>stelnet server enable</strong> （服务开启命令)</p><p>首次启用认证命令：<strong>ssh client first-time enable</strong> 客户端命令</p><p>指定用户只支持ssh协议：<strong>protocol inbound ssh</strong></p><p>指定用户的服务类型：<strong>local-user （用户名）service-type ssh</strong></p><p>查看SSH服务器端的当前回话连接信息：<strong>display ssh server session</strong></p><p>查看ssh服务全局配置信息命令：<strong>display ssh server status</strong></p><p>查看本地秘钥对中的公钥部分命令： <strong>display rsa local-key-pair public</strong></p><h2 id="SFTP"><a href="#SFTP" class="headerlink" title="SFTP"></a>SFTP</h2><p>需配置本地用户为SSH接入类型</p><p>指定FTP用户可访问目录的命令：<strong>local-user (用户名) ftp-directory flash:</strong> (默认为空，不可不配)</p><h2 id="配置交换机双工模式"><a href="#配置交换机双工模式" class="headerlink" title="配置交换机双工模式"></a>配置交换机双工模式</h2><p>关掉自协议商双工：<strong>undo negotiation auto</strong></p><p>手工指定双工模式为全双工：<strong>duplex full</strong></p><p>以太网接口速率配置 ：<strong>speed （大小）</strong>【单位Mbit&#x2F;s】</p><h2 id="ARP及proxy-ARP"><a href="#ARP及proxy-ARP" class="headerlink" title="ARP及proxy ARP"></a>ARP及proxy ARP</h2><p>在PC机下查看主机ARP表：<strong>arp -a</strong></p><p>查看ARPb表：<strong>display arp all</strong></p><p>添加静态IP和MAC地址：<strong>arp static (IP地址)（MAC地址）</strong></p><p>开启代理ARP（Proxy ARP）:**arp-proxy enable **  接口视图下</p><h2 id="VLAN基本配置及Access接口"><a href="#VLAN基本配置及Access接口" class="headerlink" title="VLAN基本配置及Access接口"></a>VLAN基本配置及Access接口</h2><p>创建单个VLAN：<strong>vlan (参数)</strong></p><p>创建多个VLAN：<strong>vlan batch (参数1)（参数2）</strong></p><p>配置接口为Access类型接口：<strong>port link-type access</strong></p><p>配置接口的默认VLAN同时加入VLAN中 ：<strong>port default vlan (参数）</strong></p><p>查看VLAN相关信息（接口和所属vlna的对应关系）：<strong>display vlan</strong></p><h2 id="vlan基本配置-trunk"><a href="#vlan基本配置-trunk" class="headerlink" title="vlan基本配置 trunk"></a>vlan基本配置 trunk</h2><p>标记命令：<strong>description （参数）</strong></p><p>查看vlan的简单信息：<strong>display vlan summary</strong></p><p>查看vlan和接口配置情况：<strong>display port vlan</strong></p><p>设置接口为trunk接口：<strong>port link-type trunk</strong></p><p>设置trunk接口允许通过的vlan:<strong>port trunk allow-pass vlan (参数)</strong> 【可是同时设置允许多个通过 （all为全部）】</p><h2 id="Hybrid接口"><a href="#Hybrid接口" class="headerlink" title="Hybrid接口"></a>Hybrid接口</h2><p>恢复接口默认VLAN:<strong>undo port default vlan</strong></p><p>删除VLAN：<strong>undo VLAN （参数）</strong></p><p>修改接口类型为默认的Hybrid类型:<strong>port link-type hybrid</strong></p><p>配置交换机在该接口转发指定VLAN的帧:<strong>port hybrid untagged vlan（参数&#x2F;all）</strong></p><p>设置Hybrid接口的默认VLAN ID :<strong>port hybrid pvid vlan (参数)</strong></p><p>配置接口接收的VLAN tag帧:<strong>port hybrid tagged vlan (参数&#x2F;all)</strong></p><h2 id="单臂路由实VLAN间路由"><a href="#单臂路由实VLAN间路由" class="headerlink" title="单臂路由实VLAN间路由"></a>单臂路由实VLAN间路由</h2><p>配置路由端口子接口（逻辑接口）：<strong>interface gigabitethernet0&#x2F;0&#x2F;0</strong></p><p>配置子接口对一层tag报文的终极功能：<strong>dot1q termination vid （参数）</strong></p><p>开启子接口ARP广播功能：<strong>ARP broadcast</strong> <strong>enable</strong></p><p>注解：不开启此功能，将导致子接口无法主动发送ARP广播报文，以及向外转发IP报文</p><p>Ping跟踪查看命令：<strong>tracert (ip)</strong></p><h2 id="使用三层交换实现VLAN间路由"><a href="#使用三层交换实现VLAN间路由" class="headerlink" title="使用三层交换实现VLAN间路由"></a>使用三层交换实现VLAN间路由</h2><p>创建VLANif接口命令：interface VLANif （参数）</p><h2 id="GVRP配置："><a href="#GVRP配置：" class="headerlink" title="GVRP配置："></a>GVRP配置：</h2><p>开启gvrp服务：<strong>gvrp</strong></p><p>查看gvrp的使用情况：<strong>display gvrp status</strong></p><p>查看端口的gvrp统计信息：<strong>display gvrp statistics</strong></p><p>配置模式为fixed：<strong>gvrp registration fixed</strong> （接口）（）</p><p>配置模式为forbidden：<strong>gvrp registration forbidden</strong> （接口）</p><h2 id="删除配置命令：undo（参数）-参数：为配置项"><a href="#删除配置命令：undo（参数）-参数：为配置项" class="headerlink" title="删除配置命令：undo（参数） 参数：为配置项"></a>删除配置命令：<strong>undo</strong>（参数） 参数：为配置项</h2><h2 id="STP基本配置命令："><a href="#STP基本配置命令：" class="headerlink" title="STP基本配置命令："></a>STP基本配置命令：</h2><p>配置设备STP的工作模式：<strong>stp mode {mstp|rstp|stp}</strong></p><p>开启stp服务：<strong>stp enable</strong></p><p>配置桥的优先级：<strong>stp priority</strong>priority</p><p>参数：取值范围0——61440步长4096 缺省值32768 参数越小，设备被选举为根桥的可能性越大</p><p>配置设备为根桥：<strong>stp root primary</strong></p><p>配置设备为备份根桥：<strong>stp root secondary</strong> 桥有限级默认为4096 不可修改优先级</p><p>生成树的状态信息与统计信息查询：<strong>display stp</strong> [interface interface-type interface-number][brief]</p><p>配置接口的开销值：<strong>stp cost</strong> (参数)</p><p>查看设备的接口信息：<strong>display （interface-type interface-number)</strong></p><h2 id="stp定时器"><a href="#stp定时器" class="headerlink" title="stp定时器"></a>stp定时器</h2><p><strong>ping (ip) -t</strong></p><p>定时配置：<strong>stp timer (参数）</strong>（时间单位 cs）</p><p>关闭命令：<strong>shutdown</strong></p><p>配置网络直径：<strong>stp bridge-diameter(参数)</strong></p><p>边缘接口配置：<strong>stp edged-port enable</strong></p><h2 id="MSTP基础配置"><a href="#MSTP基础配置" class="headerlink" title="MSTP基础配置"></a>MSTP基础配置</h2><p>进入mst域视窗：<strong>stp region-configuration</strong></p><p>配置MST域名：<strong>region-name（参数）</strong></p><p>配置mstp的修订级别：<strong>revision-level（参数）</strong></p><p>制定VLAN的映射到mstp实例生成树 :<strong>instance (参数) VLAN （参数）</strong></p><p>激活<strong>mst:active region-configuration</strong></p><p>查看mst域配置信息：<strong>display stp region-configuration</strong></p><p>查看实例中的生成树信息：<strong>display stp instance (参数) brief</strong></p><p>配置交换机为实例中的根：<strong>stp instance （参数）priority（参数）</strong></p><h2 id="Smart-Link-与Monitor-Link配置"><a href="#Smart-Link-与Monitor-Link配置" class="headerlink" title="Smart Link 与Monitor Link配置"></a>Smart Link 与Monitor Link配置</h2><p>创建smart link组并接入窗口：<strong>smart-link group</strong> （参数）</p><p>开启smart link组功能：<strong>smart-link enable</strong></p><p>关闭生成树：<strong>stp disable</strong> 【接口命令】</p><p>配置主接口：<strong>port（nterface-type interface-number）master</strong></p><p>配置备份接口：<strong>port（nterface-type interface-number） slave</strong></p><p>开启回切功能：<strong>restore enable</strong></p><p>设置回切时间：<strong>timer wtr</strong> (参数)</p><p>查看smart link组状态：<strong>display smart-link group</strong> （参数）</p><p>启用monitor link组：<strong>monitor-link group</strong>(参数)</p><p>配置monitor link上行接口：<strong>port（nterface-type interface-number）uplink</strong></p><p>配置monitor link下行接口：<strong>port（nterface-type interface-number）downlink</strong></p><p>配置monitor link回切时间:<strong>timer recover-time (参数)</strong></p><h2 id="配置Eth-trunk链路聚合"><a href="#配置Eth-trunk链路聚合" class="headerlink" title="配置Eth-trunk链路聚合"></a>配置Eth-trunk链路聚合</h2><p>创建Eth-trunk接口：<strong>interface Eth-trunk</strong>（参数）</p><p>指定Eth-trunk为手工负载分担模式：<strong>mode manual load-balance</strong></p><p>查看Eth-trunk的接口状态：<strong>display Eth-trunk</strong>（参数）</p><p>查看Eth-trunk的接口信息：<strong>display interface Eth-trunk</strong>（参数）</p><p>查看Eth-trunk的详细信息：<strong>disp trunkmembership eth-trunk</strong>（参数）</p><p>指定Eth-trunk为静态lacp模式：<strong>mode lacp-static</strong></p><p>指定接口加入指定Eth-trunk接口：<strong>Eth-trunk</strong> （参数）</p><p>配置活动接口上线阙值：<strong>max active-linknumber</strong> (参数)</p><p>修改优先级：<strong>lacp priority</strong> (参数) 参数：可取值范围0~32768</p><h2 id="静态路由"><a href="#静态路由" class="headerlink" title="静态路由"></a>静态路由</h2><p>配置下一跳路由ip:<strong>IP route-static</strong>（目的地址IP段)(子网掩码)(目的IP)</p><p><strong>IP route-static (参数1)（参数2）（nterface-type interface-number）</strong></p><p>配置静态IP ：<strong>IP route-static</strong> 0.0.0.0 0(参数3)</p><p>配置路由表优先级：<strong>IP route-static</strong> （参数1 ）（参数2）（参数3）<strong>preference</strong>(参数)</p><p>查看静态路由信息：<strong>display ip routing-table protocol static</strong></p><p>查看路由表手动添加信息：<strong>display ip routing-table protocol static</strong></p><h2 id="OSPF区域配置"><a href="#OSPF区域配置" class="headerlink" title="OSPF区域配置"></a>OSPF区域配置</h2><p>创建ospf命令：**ospf 0(**0默认为主干区域）</p><p>创建ospf区域命令：<strong>area</strong> (区域ID)</p><p>指定ospf协议接口和接口所属区域：<strong>network （iP地址段）</strong>（ip所属网管对应子网位）</p><p>检查ospf接口通告： <strong>display ospf interface</strong></p><p>查看ospf邻居状态：<strong>display ospf peer</strong> （brief:简短的）</p><p>查看ospf路由表：<strong>display ip routing-table protocol ospf</strong></p><p>查看ospf链路状态数据库信息：<strong>display ospf lsdb</strong></p><h2 id="ospf认证与被动接口配置"><a href="#ospf认证与被动接口配置" class="headerlink" title="ospf认证与被动接口配置"></a>ospf认证与被动接口配置</h2><p>区域明文认证：<strong>authentication-mode simple plain(密码)</strong> {plain：表示明文显示}</p><p>区域密文认证：<strong>authentication-mode md5 1</strong> (密码) {1：为验证字标识符}</p><p>链路认证：<strong>ospf authentication-mode md5 1</strong> (密码)</p><p>配置被动接口，禁止接口接收和发送ospf报文：<strong>silent-interface</strong> (接口号){all}</p><h2 id="Router-ID-DR与BDR"><a href="#Router-ID-DR与BDR" class="headerlink" title="Router-ID DR与BDR"></a>Router-ID DR与BDR</h2><p>查看当前设备Router-ID:display router id</p><p>配置router-id:router id #.#.#.#</p><p>重置ospf协议进程：reset ospf process</p><p>配置ospf协议私有router-id：ospf 1 routef-id(IP地址)</p><p>ospf网络类型点到多点配置：ospf network-type p2mp</p><p>还原默认广播类型：ospf network-type broadcast</p><p>配置接口DR优先级：ospf dr-priority (参数)</p><h2 id="ospf开销值，协议优先级及计时器的修改"><a href="#ospf开销值，协议优先级及计时器的修改" class="headerlink" title="ospf开销值，协议优先级及计时器的修改"></a>ospf开销值，协议优先级及计时器的修改</h2><p>修改ospf协议优先级：prefernece (参数)</p><p>配置运行ospf协议所需开销值：ospf cost (参数)</p><p>修改hello计时器命令：ospf timer hello (参数)</p><p>修改dead计时器命令：ospf timer dead(参数)</p><h2 id="rip与ospf的配置"><a href="#rip与ospf的配置" class="headerlink" title="rip与ospf的配置"></a>rip与ospf的配置</h2><p>双向引入路由命令：import-route (参数rip&#x2F;ospf)<br>手工配置引入时的开销：imoprt-toute (参数rip&#x2F;ospf) cost 参数)<br>rip默认路由发布：default-route originate<br>ospf默认路由发布：default-route-advertise always</p><h2 id="IPV6"><a href="#IPV6" class="headerlink" title="IPV6"></a>IPV6</h2><p>开启ipv6全局功能：ipv6</p><p>在端口下开启ipv6功能：ipv6 enable</p><p>配置自动生成的链路本地地址：ipv6 address auto link-local</p><p>查看自动生成的链路本地地址：display ipv6 interface</p><p>配置ipv6命令：ipv6 address (地址)</p><p>查看配置的全局地址：display ipv6 interface (接口号)</p><p>配置结果查看命令：display ipv6 interface brief</p><p>配置ripng进程：ripng (参数)</p><p>启用接口ripng:ripng （参数）enable</p><p>查看ripng (参数)路由信息：display ripng 1 route</p><p>创建ospfv3进程（参数）:opsfv3 (参数)</p><p>配置router-ID：router id (#.#.#.#)</p><p>在接口下配置ospfv3进程区域：ospfv3 (参数) area (参数)</p><h2 id="DNCP"><a href="#DNCP" class="headerlink" title="DNCP"></a>DNCP</h2><p>开启dhcp功能：dhcp enable</p><p>开启接口dhcp服务功能：dhcp select interface</p><p>配置租期：dhcp servse lease [day ] (参数)</p><p>配置地址池中不参与分配的地址范围：dhcp server excluded -ip-address (ip段始)（ip段尾）</p><p>指定接口下dns服务器：dhcp server dns-list (ip 地址)</p><p>查看dhcp地址池中地址分布情况：display ip pool</p><p>创建一个全局地址池：ip pool (名称)</p><p>配置全局地址池分配网段范围：network（ip地址）</p><p>配置dncp客户端网关地址：gateway-list (ip地址)</p><p>开启接口的dncp功能使用全局地址池为客户端分配地址：dhcp select global</p><p>开启接口dhcp中继gon功能：dhcp select relay</p><p>指定dhcp服务器地址：dhcp reley server-ip (ip地址)</p><p>创建dhcp服务器组：dhcp server group (名称)</p><p>添加远端dhcp服务器组：dhcp-server (ip地址)</p><p>配置端口到指定的服务器组：dhcp relay server-select (名称)</p><h2 id="基本ACL"><a href="#基本ACL" class="headerlink" title="基本ACL"></a>基本ACL</h2><p>基本acl规则的命令结构：</p><p>rule [rule-id] {deny | permit} [source{source-address source-wildcard | any } | fragment |logging | time-rangetime-name]</p><p>参数说明：</p><ul><li>rule:表示这是一条规则</li><li>rele-id:表示这条规则的编号</li><li>deny | permit:表示这是一个二选一选项，表明这条规则的相关处理动作。deny表示“拒绝”；permit表示“允许”。</li><li>source:表示源ip地址信息</li><li>source-address: 表示具体的源ip地址</li><li>source-wildcard:表示与source-address相对应得匹配符</li><li>any:表示源ip地址可以是任何地址</li><li>fragment：表示该规则只对分区非首片分区报文有效</li><li>logging：表示需要将匹配上该规则的ip报文进行日志记录</li><li>time-range time-name :表示该规则的生效时间段为time-name</li></ul><p>编号区分：</p><p>2000~2999基本acl</p><p>3000~3999高级acl</p><p>4000~4999二层acl</p><p>5000~5999自定义acl</p><p>创建ACL：acl （编号）</p><p>拒接源ip地址规报文则：rule deny source （ip地址)（匹配符）</p><p>拒接目的ip地址报文规则：rule deny destination (ip地址)（匹配符）</p><p>使用报文过滤技术将acl规则应用到接口上：traffic-filter [utbound&#x2F;inbound] acl （编号）(utbound表示出站，inbound表示入站)</p><p>允许源地址的规则：rule（规则id） permit source (ip地址)（子网掩码）[any]</p><p>拒接源地址的规则：rule （规则id）deny source (ip地址)（子网掩码）[any]</p><p>查看acl（编号)的配置：display acl (编号)</p><h2 id="基础过滤工具"><a href="#基础过滤工具" class="headerlink" title="基础过滤工具"></a>基础过滤工具</h2><p>数据方向调用acl:acl(编号) [inbound&#x2F;&#x2F;utbound]</p><p>查看设备控制访问列表：display acl all</p><p>高级acl股则格式：rule （规则id） permit &#x2F; deny (协议) source （ip地址）（子网掩码) [any]</p><p>配置（filter-policy）过滤策略调用acl:filter-policy (acl编号) impory</p><p>配置前缀列表过滤路由： ip ip-prefix 1 deny (ip地址) （子网掩码） greater-equal （网络位）<br>less-equal（网络位）</p><p>注解：</p><p>greater-equal：表示大于等于</p><p>less-equal：表示小于等于</p><p>配置放行所有其它路由：ip ip-prefix 1 permit 0.0.0.0 0 less-equal 32</p><p>配置（filter-policy）过滤策略调前缀列表：filter-policy ip-prefix 1 import</p><h2 id="SNMP协议基础配置"><a href="#SNMP协议基础配置" class="headerlink" title="SNMP协议基础配置"></a>SNMP协议基础配置</h2><p>开启agent命令：snmp-agent</p><p>查看系统信息：display SNMP-agent sys-info</p><p>配置snmp版本：snmp-agent sys-info [v1&#x2F;v2c&#x2F;v3]</p><p>查看agent信息：display snmp-agent sys-info version</p><p>配置nms管理权限：</p><p>acl (编号)</p><p>限制管理设备：rule (规则编号 ) permit source （ip地址）（子网掩码）</p><p>不允许管理设备：rule （规则编号）deny source (ip地址) （子网掩码）</p><p>配置用户组，用户名，并指定使用acl: snmp-agent usm-user v3 (用户名)</p><p>（用户组）acl (编号)</p><p>查看SNMPv3的用户信息：display snmp-agent sum-user</p><p>配置Agent发送trap消息：snmp-agent target-host trap-hostname (网管名) address (目标地址池) udp-port (端口号) trap-paramsname (网管名)</p><p>开启设备告警开关：snmp-agent trap enable</p><p>设置告警消息列队长度：snmp-agent trap queue-size (参数值)</p><p>设置报文消息保存时间：snmp-agent trap life (参数值)</p><p>配置管理员联系方式：snmp-agent sys-info contact call admin (电话号码)</p><p>查看snmp Agent输出网管：display snmp-agent target-host</p><h2 id="GRE协议基本配置（tunnel隧道创建）"><a href="#GRE协议基本配置（tunnel隧道创建）" class="headerlink" title="GRE协议基本配置（tunnel隧道创建）"></a>GRE协议基本配置（tunnel隧道创建）</h2><p>创建隧道接口：interface tunnel (接口号)</p><p>指定隧道模式为gre:tunnel-protocol gre</p><p>配置接口源地址：source （ip地址）</p><p>配置 接口目标地址：destination （ip地址）</p><p>注解：一条隧道链路两端接口ip地址必须在同一个网站</p><p>注解：trunnel接口信息显示：Line protocol current state : DOWN 不知道如何启用</p><p>配置动态路由协议省略</p><h2 id="NTP"><a href="#NTP" class="headerlink" title="NTP"></a>NTP</h2><p>静态nat内部地址池到外部地址池一对一转换：nat static global (外部地址) inside （内部地址）</p><p>查看静态ntp配置信息：display nat static</p><p>配置nat outbound 外网地址池：nat addres-group 1 (头ip地址)（尾ip地址）</p><p>acl (编号)</p><p>rule （规则编号）permit source （ip地址）（子网掩码）</p><p>在接口下将acl与地址池相关联：nat outbounb (acl编号) address-group 1 no-pat</p><p>注解：只有acl规定的地址才可以使用地址池进行地址转换</p><p>查看NAT outbound信息：display nat outbound</p><p>在接口上配置Easy-ip特性，使用接口地址为转化后的地址：nat outbound (acl编号)</p><p>查看NAT Session的详细信息：display nat session protocol udp verbose</p><p>在接口指定内网服务器映射之外网，外网访问内网服务器,指定服务器通信协议类型为tcp：</p><p>命令：nat server protocol [tcp(协议类型)] global （服务器公网地址）[fcp(服务协议)] inside (服务器私网地址) [ftp(协议端口号，ftp协议默认端口号为21)]</p><p>启用nat alc功能：nat alg ftp enable</p><p>查看nat server信息：display nat server</p><h2 id="VRRP"><a href="#VRRP" class="headerlink" title="VRRP"></a>VRRP</h2><p>在接口穿件vrrp备份组：vrrp vrid (id号) virtual-ip (ip地址)</p><p>配置接口vrrp优先级：vrrp vrid (id 号) priority (参数)</p><p>查看vrrp信息：display vrrp &#x2F; brief(简要状态) &#x2F;interface (详细状态)</p><p>修改虚拟组为非抢占模式：vrrp vrid (id号) preempt-mode disable</p><p>配置上行接口监控：vrrp vrid (id号) track interface （上行接口号） reduced （参数）</p><p>vrrp接口md5认证：vrrp vrid (id号) authentication-mode md5（密码）</p><h2 id="ppp认证"><a href="#ppp认证" class="headerlink" title="ppp认证"></a>ppp认证</h2><p>设置本端的ppp协议对对端设备的认证方式为pap:ppp authentication-mode pap domain (域名)</p><p>进入aaa视图，创建认证方案：authentication-scheme (域名-id)</p><p>配置认证模式为本地认证：authentication-mode local</p><p>创建域，并进入域视图：domain （域名）</p><p>配置域的认证方式：authentication-scheme (域名-id)</p><p>在aaa视图下，配置储存在本地，对对端口认证所使用的用户名和密码</p><p>local-user （用户名） passwork cipher (密码)</p><p>local-user (用户名) service-type ppp</p><p>配置本端被对端以pap认证时本地发送的pap用户和密码</p><p>ppp pap local-user (用户名) password cipher （密码）</p><p>在接口下配置认证方式为chap:ppp authentication-mode chap</p><p>在对端接口下配置chcp认证的用户名和密码：ppp chap (用户名)</p><p>ppp chap password (密码)</p><p>在接口下配置链路层协议HDLC:link-protocol hdlc</p><h2 id="帧中继"><a href="#帧中继" class="headerlink" title="帧中继"></a>帧中继</h2><p>接口配置链路层协议为FR：link-protocol fr</p><p>允许帧中继逆向解析地址生产地址映射表：fr inarp</p><p>接口下手动配置ip地址与DLCI的静态映射：fr map ip (ip地址) （DLCI）[broadcast]</p><p>查看pvc的建立情况：display fr pvc-info</p><p>手工配置ospf邻居：peer (ip地址)</p>]]></content>
    
    
    <categories>
      
      <category>华为数通</category>
      
    </categories>
    
    
    <tags>
      
      <tag>华为数通</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>华为数通边学边记</title>
    <link href="/2022/05/12/%E5%8D%8E%E4%B8%BA%E6%95%B0%E9%80%9A%E8%BE%B9%E5%AD%A6%E8%BE%B9%E8%AE%B0/"/>
    <url>/2022/05/12/%E5%8D%8E%E4%B8%BA%E6%95%B0%E9%80%9A%E8%BE%B9%E5%AD%A6%E8%BE%B9%E8%AE%B0/</url>
    
    <content type="html"><![CDATA[<h3 id="命令行："><a href="#命令行：" class="headerlink" title="命令行："></a>命令行：</h3><p>&lt;&gt;用户视图模式，配置基本参数，调试命令，权限较小</p><p>[  ]系统视图模式，可以做高级配置</p><p>？帮助信息 int?提示出完整命令</p><p>tab补全命令</p><p>ctrl + Z 回到用户模式</p><p>system-view进入系统视图sy</p><p>quit 退出当前模式或接口qu+tab</p><p>undo 原来的命令取消一项参数设置</p><p>&lt;&gt; save保存配置</p><p>&lt;&gt; dir&#x2F;all查看硬盘文件  &#x2F;   所有文件</p><p>&lt;&gt; copy    复制</p><p>&lt;&gt; mkdir   新建目录</p><p>&lt;&gt; rmdir   删除目录</p><p>&lt;&gt; cd          cd ..</p><p>&lt;&gt; unzip   解压</p><p>&lt;&gt; more   查看文件内容</p><p>&lt;&gt; move   移动  </p><p>&lt;&gt; rename     改名</p><p>&lt;&gt; delete   **    &#x2F;unreserved     删除  &#x2F; 彻底删除</p><p>&lt;&gt; undelete   恢复删除</p><p>&lt;&gt; reset  re   清空回收站</p><p>&lt;&gt; startup saved-conf   flash:&#x2F;***  指定启动文件</p><p>&lt;&gt; reset saved-configuration    清空配置文件</p><p>&lt;&gt; reboot   重启</p><p>display在任务模式都可以使用,more 回车跑行，空格翻页，任意键中断dis</p><h3 id="通过web管理交换机"><a href="#通过web管理交换机" class="headerlink" title="通过web管理交换机"></a><strong>通过web管理交换机</strong></h3><p> http server load S2700-V100R005C01SPC100.web.zip       加载web配置操作系统</p><p> http server enable                    启动web 配置服务</p><p> int  vlanif  1                                给交换机配置ip地址 用于管理</p><p>​      ip  address  192.168.31.85  24</p><p>web登陆默认的用户名和密码：admin  admin      （可用dis cu 查看默认密码）</p><h3 id="Telnet-功能："><a href="#Telnet-功能：" class="headerlink" title="Telnet 功能："></a><strong>Telnet 功能：</strong></h3><p>[R1] aaa           进入AAA模式</p><p>  local-user aa privilege level 3 password cipher  123        建一个aa用户，权限为3，密码123</p><p>  local-user aa service-type telnet         指定aa用户服务类型为telnet</p><p>qu</p><p>user-interface vty 0 4          允许同时5个人同时使用</p><p>authentication-mode aaa    </p><p>新版telnet必须加指令：</p><ul><li>protocol inbound telnet</li></ul><h3 id="SSH功能："><a href="#SSH功能：" class="headerlink" title="SSH功能："></a><strong>SSH功能：</strong></h3><p>[Huawei]aaa</p><p>[Huawei-aaa]local-user ssh privilege level 3 password cipher aa</p><p>[Huawei-aaa]local-user aa service-type ssh</p><p>[Huawei]user-interface vty 0 4</p><p>[Huawei-ui-vty0-4]protocol inbound ssh</p><p>[Huawei-ui-vty0-4]authentication-mode aaa</p><p>[Huawei]stelnet server enable </p><h3 id="为console-口设置密码："><a href="#为console-口设置密码：" class="headerlink" title="为console 口设置密码："></a><strong>为console 口设置密码：</strong></h3><p>方式A：密码验证</p><p>user-interface con 0</p><p> authentication-mode password</p><p> set authentication password cipher  abc</p><p>设置完成后，quit 退出后 再尝试登陆</p><p>方式B：使用用户名和密码形式验证</p><p>user-interface con 0</p><p>   authentication-mode   aaa</p><p>aaa   进入aaa</p><p>​    local-user gebi privilege level 3  password simple laowang </p><p>配置用户名gebi 权限级别3级  密码laowang</p><p>​    local-user gebi service-type terminal</p><p>指定gebi帐户服务器类型是terminal </p><h3 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h3><p>&lt;&gt; undo info-center enable   关闭信息中心，防止弹出日志</p><p>​     un in en </p><p>[  ] sysname  名称为设备命名（需要系统视图模式）简写 sy</p><p>[  ] display this查看当前配置 简写dis thi</p><p>[  ] interface e0&#x2F;0&#x2F;0进入接口e0&#x2F;0&#x2F;0简写int</p><p>[  ] ip address 192.168.1.1 24为接口配置IP 掩码</p><p>[  ] shutdown进入接品，关闭、禁止该接口</p><p>&lt; &gt; reset saved-configuration   清空配置信息</p><p>&lt; &gt; startup saved-configuration   vrpcfg.zip      指定下一次启动加载的配置文件</p><p>&lt; &gt; startup system-software ******.cc           指定系统软件</p><p>language-mode chinese改变语言为中文提示需按Y确认</p><p>dis ip int brief查看路由器接口摘要信息常用</p><p>dis ip rou查看路由器路由表</p><p>dis mac-add查看交换机MAC表</p><p>dis cu显示当前所有的配置</p><p>dis saved-configuration显示保存的配置</p><p>dis tcp status查看ICP连接状态</p><p>dis version 查看系统软件版本号</p><p>dis memory-usage查看内存状态</p><p>dis mac-address查看MAC配置表</p><p>dis port vlan active </p><p>dir &#x2F;all查看flash内所有文件（包括回收站）</p><p>reset recycle-bin删除回收站文件</p><p>clear configuration interface g0&#x2F;0&#x2F;10   清除接口所有配置</p><p>reset saved-configuration      重新初始化交换机</p><h3 id="DHCP"><a href="#DHCP" class="headerlink" title="DHCP"></a><strong>DHCP</strong></h3><p>1、简单DHCP，基于接口的配置：</p><p>[ ] dhcp enable允许DHCP服务（全局启用）</p><p>[ ] int initerface e0&#x2F;0&#x2F;0   </p><p>[ ] dhcp select interface开启DHCP</p><p>[ ] dhcp server dns-list  114.114.114.114  8.8.8.8配置DNS</p><p>2、DHCP中继relay:</p><p>广播包则中继变成单播，发送到DHCP服务器。</p><p>[Huawei-Vlanif10] DHCP select relay </p><p>[Huawei-Vlanif10]DHCP relay server-ip 12.1.1.1</p><p>3、DHCP  snooping:防止非法的DHCP服务器 在接入层交换机使用。</p><p>[Huawei]dhcp snooping enable </p><p>[Huawei]int e0&#x2F;0&#x2F;2</p><p>[Huawei-Ethernet0&#x2F;0&#x2F;2]dhcp snooping trusted </p><h3 id="DHCP-调试命令："><a href="#DHCP-调试命令：" class="headerlink" title="DHCP 调试命令："></a><strong>DHCP 调试命令：</strong></h3><p>[ ] dis ip pool查看DHCP地址池信息</p><p>[ ] dis ip pool interface **** used***为pool名称不能简写</p><p>[ ] reset ip pool interface *** used</p><p>* 需首先配置好端口的IP地址</p><p>excluded-ip-address   192.168.10.2   192.168.10.19    保留&#x2F;排除  地址段</p><p>reset ip pool name 2L 192.168.9.254 192.168.9.254  清空分配过的IP 地址</p><p>static-bind ip-address 192.168.9.88 mac-address 5489-986f-1dff   静态绑定</p><p>dis dhcp snooping user-bind all      接入层交换机显示dhcp映射表</p><p>ip  source check user-bind enable    开启IP 源地址检查功能</p><p>dhcp server  ?</p><h3 id="路由器："><a href="#路由器：" class="headerlink" title="路由器："></a><strong>路由器：</strong></h3><p>int  e0&#x2F;0&#x2F;0</p><p>​    ip add 192.168.31.1  24</p><p>​    dhcp select global  配置dhcp选择从全局分配地址</p><p> dhcp  enable                      启用dhcp 功能</p><p> ip pool qq                            创建地址池qq</p><p> gateway-list 192.168.31.1           网关</p><p> network 192.168.31.0 mask 255.255.255.0          ip和掩码</p><p> dns-list 114.114.114.114 192.168.31.1                 DNS</p><p>启用loopback接口：</p><p>[R2] int loopback 0   </p><h3 id="静态路由："><a href="#静态路由：" class="headerlink" title="静态路由："></a><strong>静态路由：</strong></h3><p>[ ] ip route-static     192.168.2.0 24        12.1.1.2      去192.168.2.0网段走12.1.1.2接口</p><p>​                        目标网段 &#x2F; 掩码下一跳地址</p><p>[ ] dis ip r显示路由表</p><p>缺省（默认）路由：缺省路由是替补路由，当其它路由不可达时才会使用，适合边缘路由器。</p><p>[ ] ip route-static   0.0.0.0   0   12.1.1.2</p><p>环回接口：逻辑虚拟接口，模拟服务器，网络，用于测试。</p><p>[ ] int loopback 0启用0号环回接口 ，模拟一个网络。（范围：0.-1023）</p><p>[R1] dis cu          查看所有配置</p><p>[R1] dis ip int b    查看所有接口</p><p>[R1] dis ip rou      查看路由表</p><p>当接口down掉后，路由表消失，配置还存在</p><p>[R1] ip route-static 172.16.1.0 24 23.1.1.2 preference 55  配置静态路由，优先级55</p><p>[R2] ip route-static 192.168.1.0 24 23.1.1.1 preference 55 </p><h3 id="RIP动态路由："><a href="#RIP动态路由：" class="headerlink" title="RIP动态路由："></a><strong>RIP动态路由：</strong></h3><p>[R1] rip 1                  启用rip1进程</p><p>[R1] version 2              启用第2版协议，版本不同不兼容</p><p>[R1] network 192.168.1.0    宣告直连网段，需要是主类网络（A类，B类，C类）</p><p>[R1] dis rip 1 route        查看rip1路由</p><p>[R1] dis rip 1 neighbor     查看路由邻居</p><p>RIP加密：路由器之间都需配置才能学习路由表</p><p>​    int  xxx</p><p>​    rip authentication-mode md5 usual abc123</p><p>路由汇总：减小大型网络路由器的路由表</p><p>R3：</p><p>[R3] int gi 0&#x2F;0&#x2F;0</p><p>[R3-GI0&#x2F;0&#x2F;0] rip summary-address 3.3.0.0  255.255.252.0    掩码包括三个子网段 </p><p>RIP静默接口：减少发向用户（非路由器）的RIP报文</p><p>[R x ] RIP 1</p><p>​    silent-interface e0&#x2F;0&#x2F;0  （e0&#x2F;0&#x2F;0接口通常是接用户的接口）</p><h3 id="OSPF基本配置："><a href="#OSPF基本配置：" class="headerlink" title="OSPF基本配置："></a><strong>OSPF基本配置：</strong></h3><p>[R1] ospf 1               启动OSPF进程1</p><p>[R1-OSPF-1] area 0        进入区域0</p><p>[R1-OSPF-1-AREA-0.0.0.0] network 192.168.1.0   0.0.0.255   宣告直连网段，IP地址接反掩码</p><p>[R1-OSPF-1-AREA-0.0.0.0] network  12.1.1.0   0.0.0.255  </p><p>[R4]   可以使用接口地址进行精确宣告工作网段</p><p>  ospf1  </p><p>  area 0.0.0.0</p><p>  network 34.1.1.4 0.0.0.0</p><p>  network 4.4.4.4 0.0.0.0</p><p>重置OSPF</p><p> reset ospf process   重置OSPF进程</p><h3 id="FTP"><a href="#FTP" class="headerlink" title="FTP"></a><strong>FTP</strong></h3><p>[R1] ftp server enable        开启FTP</p><p>[R1] set default ftp-directory flash:     设置FTP主目录</p><p>[R1] aaa                                  设置FTP验证 </p><p>[R1-aaa] local-user lisi privilege level 3 password cipher 12345</p><p>[R1-aaa] local-user lisi service-type ftp </p><p> FTP 12.1.1.1      登录FTP</p><p>[ftp] get R1.ZIP       下载文件</p><p>[ftp] put R2.ZIP       传输文件</p><p><strong>Vlan</strong></p><p>[Huawei] vlan 10        创建VLAN10</p><p>[Huawei] int g0&#x2F;0&#x2F;1     进入接口</p><p>[Huawei-GigabitEthernet0&#x2F;0&#x2F;1] port link-type access      指定接口类型 </p><p>[Huawei-GigabitEthernet0&#x2F;0&#x2F;1] port default vlan 10       指定接口VLAN组</p><p>批量划入VLAN</p><p>[Huawei] port-group group-member gi0&#x2F;0&#x2F;4 to g0&#x2F;0&#x2F;20  指定接口组</p><p>[Huawei-port-group] port link-type access            指定接口类型</p><p>[Huawei-port-group] port default vlan 20 </p><p>[ ] vlan batch 10 20 30    批量创建VLAN</p><p>[ ] dis port vlan active      显示VLAN配置</p><h3 id="vlan高级配置："><a href="#vlan高级配置：" class="headerlink" title="vlan高级配置："></a><strong>vlan高级配置：</strong></h3><p>查看vlan状态命令：</p><p>[Huwaei]  display port vlan | exclude hy </p><pre><code class="hljs">          简写：dis port vlan | ex hy</code></pre><p>查看HYbird接口状态：</p><p>[Huwaei]  dis port vlan active</p><p>基于MAC的vlan</p><p>[SW2]vlan batch 10 20  创建VLAN 10 20</p><p>[SW2-vlan10]mac-vlan mac-address 0000-0000-0001   在vlan 10中指定mac </p><p>[SW2-vlan20]mac-vlan mac-address 0000-0000-0002   在vlan 20中指定mac</p><p>[SW2-GigabitEthernet0&#x2F;0&#x2F;1]port hybrid untagged vlan 10 20     检测VLAN 10 20</p><p>[SW2-GigabitEthernet0&#x2F;0&#x2F;1]mac-vlan enable        对接口开启MAC vlan</p><p>基于MAC的vlan</p><p>[SW2]VLAN 10</p><p>[SW2-vlan10]ip-subnet-vlan IP 192.168.10.0 24          vlan10的网段 </p><p>[SW2]VLAN 20</p><p>[SW2-vlan20]ip-subnet-vlan IP 192.168.20.0 24          vlan20的网段</p><p>[SW2-vlan20]INT GI 0&#x2F;0&#x2F;1</p><p>[SW2-GigabitEthernet0&#x2F;0&#x2F;1]port hybrid untagged vlan 10 20 </p><p>[SW2-GigabitEthernet0&#x2F;0&#x2F;1]ip-subnet-vlan enable </p><p>超级VLAN:</p><p>[Huawei]vlan 30</p><p>[Huawei-vlan30]aggregate-vlan </p><p>[Huawei-vlan30]access-vlan 10 20</p><p>[Huawei-vlan30]int vlanif 30</p><p>[Huawei-Vlanif30]ip address 192.168.1.1 24</p><p>相同VLAN端口隔离：相同的隔离组不能通信，</p><p>[Huawei]vlan 10</p><p>[Huawei]<strong>port-group group-member gi 0&#x2F;0&#x2F;1 to gi 0&#x2F;0&#x2F;4</strong></p><p>[Huawei-port-group]port link-type access </p><p>[Huawei-port-group]port default vlan 10</p><p>[Huawei-GigabitEthernet0&#x2F;0&#x2F;1]port-isolate enable group 1  将接口划入隔离组1</p><p>[Huawei-GigabitEthernet0&#x2F;0&#x2F;4]port-isolate enable group 1</p><h3 id="trunk"><a href="#trunk" class="headerlink" title="trunk"></a><strong>trunk</strong></h3><p>[Huawei] int g0&#x2F;0&#x2F;4</p><p>[Huawei-GigabitEthernet0&#x2F;0&#x2F;4] port link-type trunk</p><p>[Huawei-GigabitEthernet0&#x2F;0&#x2F;4] port trunk allow-pass vlan all</p><p>​                                                    华为trunk默认不允许VLAN通信</p><p>[Huawei-GigabitEthernet0&#x2F;0&#x2F;4] port trunk pvid vlan 10  修改本征vlan(PVID)</p><h3 id="HYbird-接口："><a href="#HYbird-接口：" class="headerlink" title="HYbird 接口："></a><strong>HYbird 接口：</strong></h3><p>hybird接口当作ACCESS口</p><p>[SW1]vlan 10</p><p>[SW1-GigabitEthernet0&#x2F;0&#x2F;1]port hybrid pvid vlan 10</p><p>[SW1-GigabitEthernet0&#x2F;0&#x2F;1]port hybrid untagged vlan 10</p><p>[SW1-GigabitEthernet0&#x2F;0&#x2F;1]undo port hybrid untagged vlan 1</p><p>hybird接口当作TRUNK口</p><p>SW1</p><p>[SW1-GigabitEthernet0&#x2F;0&#x2F;2]PORT hybrid tagged VLAN 10</p><p>SW2</p><p>[SW2-GigabitEthernet0&#x2F;0&#x2F;1]port hybrid tagged VLAN 10</p><p>HYbird接口特殊用法：实现VLAN间互通</p><p>[SW1]VLAN batch 10 20 30</p><p>[SW1-GigabitEthernet0&#x2F;0&#x2F;1]port hybrid pvid vlan 30</p><p>[SW1-GigabitEthernet0&#x2F;0&#x2F;1]port hybrid untagged vlan 10 20 30</p><p>[SW1-GigabitEthernet0&#x2F;0&#x2F;2]port hybrid pvid vlan 10</p><p>[SW1-GigabitEthernet0&#x2F;0&#x2F;2]port hybrid untagged vlan  10 30</p><p>[SW1-GigabitEthernet0&#x2F;0&#x2F;3]port hybrid pvid vlan 20</p><p>[SW1-GigabitEthernet0&#x2F;0&#x2F;3]port hybrid untagged vlan 20 30</p><h3 id="单臂路由："><a href="#单臂路由：" class="headerlink" title="单臂路由："></a><strong>单臂路由：</strong></h3><p>Vlan的虚拟子接口网关：</p><p>[Huawei]int e0&#x2F;0&#x2F;0.1          创建子接口.1</p><p>[Huawei-Ethernet0&#x2F;0&#x2F;0.1]ip add 192.168.10.1 24      子接口配置IP地址</p><p>[Huawei-Ethernet0&#x2F;0&#x2F;0.1]dot1q termination vid 10    和vlan 10 关联</p><p>[Huawei-Ethernet0&#x2F;0&#x2F;0.1]arp broadcast enable        开启ARP广播功能</p><p>为不同的网段配置路由协议。</p><h3 id="SVI"><a href="#SVI" class="headerlink" title="SVI:"></a><strong>SVI:</strong></h3><p>[SW1]int Vlanif 10        创建虚拟接口vlanif 10 (svi)</p><p>[SW1-Vlanif10]ip address 192.168.10.1 24  指定IP地址</p><h3 id="ACL访问控制列表-应用于不同的网段"><a href="#ACL访问控制列表-应用于不同的网段" class="headerlink" title="ACL访问控制列表:  应用于不同的网段"></a><strong>ACL访问控制列表:  应用于不同的网段</strong></h3><p>同网段 可用端口隔离：port-isolate enable group 1</p><p>基本acl（2000-2999）：只能匹配源ip地址。</p><p>高级acl（3000-3999）：可以匹配源ip、目标ip、源端口、目标端口等三层和四层的字段。</p><p>在R2上设置ACL拒绝PC1访问172.16.10.0网段</p><p>[R2]acl 2000          启用基本acl      </p><p>[R2-acl-basic-2000]rule deny source 192.168.10.1 0.0.0.0    设置一条拒绝规则</p><p>[R2]int g0&#x2F;0&#x2F;1                                              </p><p>[R2-GigabitEthernet0&#x2F;0&#x2F;1]traffic-filter outbound acl 2000    在g0&#x2F;0&#x2F;1口启用ACL2000规则</p><p>[R2]dis acl 2000           查看ACL状态</p><p>在R2上设置ACL拒绝192.168.10.0网段PING地址172.16.10.0，但允许HTTP访问</p><p>[R2]acl 3000</p><p>[R2-acl-adv-3000]rule deny icmp source 192.168.10.0 0.0.0.255 destination  172.16.10.2  0.0.0.0</p><p>[R2]int g0&#x2F;0&#x2F;01</p><p>[R2-GigabitEthernet0&#x2F;0&#x2F;1]traffic-filter outbound acl 3000</p><p>[R2]dis acl 3000</p><p>Advanced ACL 3000, 1 rule</p><p>Acl’s step is 5</p><p> rule 5 deny icmp source 192.168.10.0 0.0.0.255 destination 172.16.10.2 0 (7 matches)</p><h3 id="NAT网络地址转换："><a href="#NAT网络地址转换：" class="headerlink" title="NAT网络地址转换："></a><strong>NAT网络地址转换：</strong></h3><p>[Huawei]ip route-static 0.0.0.0 0 12.1.1.6</p><p>[Huawei]INT G0&#x2F;0&#x2F;1</p><p> dis nat session all 查看NAT转换缓存列表</p><h3 id="静态NAT-一对一"><a href="#静态NAT-一对一" class="headerlink" title="静态NAT(一对一) :"></a><strong>静态NAT(一对一) :</strong></h3><p>[Huawei-GigabitEthernet0&#x2F;0&#x2F;1]NAT static global 12.1.1.2 inside 192.168.1.2</p><p>  允许192.168.1.2 转换为公网地址12.1.1.2访问外网（包括所有协议和端口）</p><h3 id="easy-ip-nat"><a href="#easy-ip-nat" class="headerlink" title="easy ip nat"></a><strong>easy ip nat</strong></h3><p>** (一对多，对应一个或多个网段范围)：**（常用）</p><p>[Huawei]acl 2000           启用ACL2000</p><p>[Huawei-acl-basic-2000]rule permit source 192.168.1.0 0.0.0.255       匹配192.168.1.0网段</p><p>[Huawei]int g0&#x2F;0&#x2F;1         进入公网接口</p><p>[Huawei-GigabitEthernet0&#x2F;0&#x2F;1]nat outbound 2000      NAT调用ACL 2000 匹配网段     </p><h3 id="使用公网地址池NAT"><a href="#使用公网地址池NAT" class="headerlink" title="使用公网地址池NAT:"></a><strong>使用公网地址池NAT:</strong></h3><p><strong>(可以自定义转换的公网地址，支持多个公网地址，支持更多用户)</strong></p><p>[Huawei]nat address-group 1 12.1.1.2 12.1.1.3      地址池不能包含公网接口地址</p><p>[Huawei]acl 2000</p><p>[Huawei-acl-basic-2000]rule permit source 192.168.1.0 0.0.0.255</p><p>[Huawei-GigabitEthernet0&#x2F;0&#x2F;1]nat outbound 2000 address-group 1   地址池与ACL池匹配</p><h3 id="端口映射：（常用）"><a href="#端口映射：（常用）" class="headerlink" title="端口映射：（常用）"></a><strong>端口映射：（常用）</strong></h3><p>[Huawei-GigabitEthernet0&#x2F;0&#x2F;1]nat server protocol tcp global 12.1.1.5 80 inside 192.168.1.200 80</p><p>​             将内网192.168.1.200的80端口映射成12.1.1.5的80端口</p><p>[Huawei-GigabitEthernet0&#x2F;0&#x2F;1]nat server protocol tcp global 12.1.1.5 21 inside 192.168.1.200 21</p><p>​             映射FTP端口</p><p>[Huawei-GigabitEthernet0&#x2F;0&#x2F;1]nat server protocol icmp global 12.1.1.5 inside 192.168.1.200</p><p>​             允许外网PING服务器192.168.1.200</p><h3 id="VRRP"><a href="#VRRP" class="headerlink" title="VRRP:"></a><strong>VRRP:</strong></h3><p>双路由VRRP：</p><p>MASTER</p><p>[R1]int g0&#x2F;0&#x2F;0</p><p>[R1-GigabitEthernet0&#x2F;0&#x2F;0]vrrp vrid 1 virtual-ip 192.168.10.1</p><p>[R1-GigabitEthernet0&#x2F;0&#x2F;0]vrrp vrid 1 priority 105</p><p>BACKUP</p><p>[R2]int g0&#x2F;0&#x2F;0</p><p>[R2-GigabitEthernet0&#x2F;0&#x2F;0]vrrp vrid 1 virtual-ip 192.168.10.1</p><p>[sw1]dis vrrp brief </p><p>可选配置：</p><p>跟踪上连接口</p><p>[R1-GigabitEthernet0&#x2F;0&#x2F;0]vrrp vrid 1 track interface gi 0&#x2F;0&#x2F;1</p><p>配置VRRP认证</p><p>vrrp vrid 1 authentication-mode simple 123</p><p>双核心交换机VRRP:</p><p>[sw1]int vlanif 10</p><p>[sw1-Vlanif10]vrrp vrid 1 virtual-ip 192.168.10.1</p><p>[sw1-Vlanif10]vrrp vrid 1 priority 105</p><p>[SW2]int vlanif 10</p><p>[Huawei-Vlanif10]vrrp vrid 1 virtual-ip 192.168.10.1</p><p>[sw1]dis vrrp brief </p><p>VLAN20</p><p>[sw2-vlan20]int vlanif 20</p><p>[sw2-Vlanif20]ip address 192.168.20.253 24</p><p>[sw2-Vlanif20]vrrp vrid 2 virtual-ip 192.168.20.1</p><p>[sw2-Vlanif20]vrrp vrid 2 priority 105</p><h3 id="eth-trunk-二层链路聚合："><a href="#eth-trunk-二层链路聚合：" class="headerlink" title="eth-trunk 二层链路聚合："></a><strong>eth-trunk 二层链路聚合：</strong></h3><p><strong>（交换机TRUNK和ACCESS口）</strong></p><p>[SW1]int Eth-Trunk 1     创建捆绑组1</p><p>[SW1-Eth-Trunk1]mode manual load-balance     手工负载分担（默认）</p><p>[SW1-Eth-Trunk1]int gi 0&#x2F;0&#x2F;1</p><p>[SW1-GigabitEthernet0&#x2F;0&#x2F;1]eth-trunk 1      四个接口依次执行</p><p>[SW1]dis eth-trunk 1                       检查捆绑状态</p><p>[SW2]int Eth-Trunk 1</p><p>[SW2-Eth-Trunk1]trunkport gi 0&#x2F;0&#x2F;1 to 0&#x2F;0&#x2F;4    将多个接口加入捆绑组1</p><p>[SW1-Eth-Trunk1]load-balance ?              修改负载模式</p><p>  dst-ip       According to destination IP hash arithmetic</p><p>  dst-mac      According to destination MAC hash arithmetic</p><p>  src-dst-ip   According to source&#x2F;destination IP hash arithmetic</p><p>  src-dst-mac  According to source&#x2F;destination MAC hash arithmetic</p><p>  src-ip       According to source IP hash arithmetic</p><p>  src-mac      According to source MAC hash arithmetic</p><h3 id="eth-trunk-三层链路聚合"><a href="#eth-trunk-三层链路聚合" class="headerlink" title="eth-trunk 三层链路聚合"></a><strong>eth-trunk 三层链路聚合</strong></h3><p><strong>（路由器之间，需提升聚合端口为三层接口）</strong></p><p>[R1]int Eth-Trunk 1</p><p>[R1-Eth-Trunk1]undo portswitch     将二层交换接口提升为三层接口</p><p>[R1-Eth-Trunk1]ip address 12.1.1.1 24</p><p>[R1-Eth-Trunk1]int gi 0&#x2F;0&#x2F;1</p><p>[R1-GigabitEthernet0&#x2F;0&#x2F;1]eth-trunk 1</p><p>[R1-GigabitEthernet0&#x2F;0&#x2F;1]int gi 0&#x2F;0&#x2F;2</p><p>[R1-GigabitEthernet0&#x2F;0&#x2F;2]eth-trunk 1</p><p>路由之间配置路由协议，使PC间可以通信</p><p><strong>三层交换机聚合：</strong></p><p>将接口捆绑加入VLAN，配置vlanif 的ip地址</p><p>[SW1]int Eth-Trunk 1</p><p>[SW1-Eth-Trunk1]trunkport gi 0&#x2F;0&#x2F;1  0&#x2F;0&#x2F;2</p><p>[SW1]vlan  10</p><p>[SW1]int Eth-Trunk 1</p><p>[SW1-Eth-Trunk1]port link-type acc</p><p>[SW1-Eth-Trunk1]port default vlan 10</p><p>[SW1]int vlanif 10</p><p>[SW1-Vlanif10]ip address 12.1.1.1 24</p><p><strong>核心交换机与路由器链路聚合</strong></p><p>[SW1]vlan 10</p><p>[SW1]int Eth-Trunk 1</p><p>[SW1-Eth-Trunk1]trunkport gi 0&#x2F;0&#x2F;1 0&#x2F;0&#x2F;2</p><p>[SW1-Eth-Trunk1]port link-type access</p><p>[SW1-Eth-Trunk1]port default vlan 10</p><p>[SW1-vlan10]int vlanif 10</p><p>[SW1-Vlanif10]ip address 12.1.1.1 24</p><p>[R1]int Eth-Trunk 1</p><p>[R1-Eth-Trunk1]undo portswitch</p><p>[R1-Eth-Trunk1]trunkport gi 0&#x2F;0&#x2F;0 0&#x2F;0&#x2F;1</p><p>[R1-Eth-Trunk1]ip address 12.1.1.2 24</p><h3 id="LACP-模式链路聚合："><a href="#LACP-模式链路聚合：" class="headerlink" title="LACP 模式链路聚合："></a><strong>LACP 模式链路聚合：</strong></h3><p>二层链路聚合：（交换机TRUNK和ACCESS口）</p><p>[SW1]int Eth-Trunk 1     创建捆绑组1</p><p>[SW1-Eth-Trunk1]mode manual load-balance     手工负载分担（默认）</p><p>[SW1-Eth-Trunk1]int gi 0&#x2F;0&#x2F;1</p><p>[SW1-GigabitEthernet0&#x2F;0&#x2F;1]eth-trunk 1      四个接口依次执行</p><p>[SW1]dis eth-trunk 1                       检查捆绑状态</p><p>[SW2]int Eth-Trunk 1</p><p>[SW2-Eth-Trunk1]trunkport gi 0&#x2F;0&#x2F;1 to 0&#x2F;0&#x2F;4    将多个接口加入捆绑组1</p><p>[SW1-Eth-Trunk1]load-balance ?              修改负载模式</p><p>  dst-ip       According to destination IP hash arithmetic</p><p>  dst-mac      According to destination MAC hash arithmetic</p><p>  src-dst-ip   According to source&#x2F;destination IP hash arithmetic</p><p>  src-dst-mac  According to source&#x2F;destination MAC hash arithmetic</p><p>  src-ip       According to source IP hash arithmetic</p><p>  src-mac      According to source MAC hash arithmetic</p><h3 id="STP"><a href="#STP" class="headerlink" title="STP:"></a><strong>STP:</strong></h3><p>核心交换机配置为根桥：</p><p>[SW1] stp  priority  0设置核心交换机STP优先级为0，默认32768.</p><p>接入层用户接口配置为边缘端品，使接口收敛迅速：</p><p>[Huawei] port-group group-member e0&#x2F;0&#x2F;2 to e0&#x2F;0&#x2F;22            群组端口</p><p>[Huawei-port-group] stp edged-port enable </p><p><strong>mstp:.</strong></p><p>mstp:  各交换机使用相同配置每台交换机不同区域不同实例独立运行RSTP</p><p>[SW1]stp region-configuration</p><p>[SW1-mst-region]region-name aa               配置区域名称</p><p>[SW1-mst-region]instance 1 vlan 10 20 30    将VLAN 10 20 30 划入实例1</p><p>[SW1-mst-region]instance 2 vlan 40 50 60</p><p>[SW1-mst-region]active region-configuration      激活配置，使之生效</p><p>VLAN数据分流</p><p>实例1：</p><p>[SW1]STP instance 1 priority 0</p><p>[SW2]stp instance 2 priority 4096</p><p>实例2：</p><p>[SW1]STP instance 2 priority 4096</p><p>[SW2]stp instance 2 priority 0</p><h3 id="BFD"><a href="#BFD" class="headerlink" title="BFD:"></a><strong>BFD:</strong></h3><p>静态路由调用BFD</p><p>R1:</p><p>bfd 1 bind peer-ip 12.1.1.2 source-ip 12.1.1.1</p><p> discriminator local 1         本地</p><p> discriminator remote 2        对端</p><p> commit</p><p>[R1]ip route-static 2.2.2.0 255.255.255.0 12.1.1.2 preference 55 track bfd-session 1</p><p>#</p><p>R2:</p><p>bfd 1 bind peer-ip 12.1.1.1 source-ip 12.1.1.2</p><p> discriminator local 2</p><p> discriminator remote 1</p><p> commit</p><p>[R2]  ip route-static 1.1.1.0 255.255.255.0 12.1.1.1 preference 55 track bfd-session 1</p><p>#</p><p>调试命令：</p><p>[R1]dis bfd session static</p><p>[R1]dis bfd session static verbose </p><p>OSPF下启用BFD检测路由链路</p><p>[R1-ospf-1]dis thi</p><p>#</p><p>ospf 1</p><p> bfd all-interfaces enable                 在OSPF进程下启用全部接口的BFD</p><p> area 0.0.0.0</p><p>  network 1.1.1.0 0.0.0.255</p><p>  network 12.1.1.0 0.0.0.255</p><p>VRRP使用BFD检测上行链路</p><p>[R1]bfd rs bind peer-ip 21.1.1.3 source-ip 21.1.1.1 auto</p><p>[R1-Ethernet0&#x2F;0&#x2F;0]vrrp vrid 1 track bfd-session session-name rs</p><p>[R3]bfd rs bind peer-ip 21.1.1.1 source-ip 21.1.1.3 auto </p><h3 id="端口安全："><a href="#端口安全：" class="headerlink" title="端口安全："></a><strong>端口安全：</strong></h3><p>[Huawei-GigabitEthernet0&#x2F;0&#x2F;1]port-security enable              开启端口安全</p><p>[Huawei-GigabitEthernet0&#x2F;0&#x2F;1]port-security max-mac-num 2       允许MAC数量</p><p>[Huawei-GigabitEthernet0&#x2F;0&#x2F;1]port-security mac-address sticky  开启MAC绑定</p><p>[Huawei-GigabitEthernet0&#x2F;0&#x2F;1]port-security mac-address sticky 5489-981c-6e9a vlan 1    添加mac地址</p><h3 id="端口镜像："><a href="#端口镜像：" class="headerlink" title="端口镜像："></a><strong>端口镜像：</strong></h3><p>[Huawei]observe-port 1 interface gi 0&#x2F;0&#x2F;3              设置观察端口</p><p>[Huawei]int gi 0&#x2F;0&#x2F;2</p><p>[Huawei-GigabitEthernet0&#x2F;0&#x2F;2]port-mirroring to observe-port 1 both   将接口数据镜像给观察组1</p><p><strong>IP-PREFIX</strong></p><p>a.   ip ip-prefix FILTER index 10 permit 1.1.1.0 24 </p><p>该ip-prefix为精确匹配，只有1.1.1.1&#x2F;24才能permit </p><p>b.    ip ip-prefix FILTER index 10 permit 1.1.1.0 24 less-equal 32 </p><p>掩码范围在24-32之间的网络1.1.1.0才能permit </p><p>c.    ip ip-prefix FILTER index 10 permit 1.1.1.0 24 greater-equal 26 </p><p>掩码范围在26-32之间的网络1.1.1.0才能permit </p><p>d.    ip ip-prefix FILTER index 10 permit 1.1.1.0 24 greater-equal 26 less-equal 32 </p><p>掩码范围在26-32之间的网络1.1.1.0才能permit </p><p>e.    ip ip-prefix FILTER index 10 permit 0.0.0.0 8 less-equal 32 </p><p>所有掩码长度在8到32的路由都被permit </p>]]></content>
    
    
    <categories>
      
      <category>华为数通</category>
      
    </categories>
    
    
    <tags>
      
      <tag>华为数通</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
